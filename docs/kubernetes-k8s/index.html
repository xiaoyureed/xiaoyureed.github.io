<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-kubernetes-k8s">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">kubernetes-k8s ☁️ - Xiaoyureed 的网络 Wiki</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://xiaoyureed.github.io/img/logo.webp"><meta data-rh="true" name="twitter:image" content="https://xiaoyureed.github.io/img/logo.webp"><meta data-rh="true" property="og:url" content="https://xiaoyureed.github.io/docs/kubernetes-k8s"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="keywords" content="xiaoyureed"><meta data-rh="true" name="keywords" content="blog, java, spring, microservice, python, rust, typescript, react, web"><meta data-rh="true" name="keywords" content=" 半路转行的编程爱好者, 写过 Python, Rust, 现在主攻 Java 分布式系统"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="kubernetes-k8s ☁️ - Xiaoyureed 的网络 Wiki"><meta data-rh="true" name="description" content="- 1. 面试问题"><meta data-rh="true" property="og:description" content="- 1. 面试问题"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://xiaoyureed.github.io/docs/kubernetes-k8s"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/en/docs/kubernetes-k8s" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/kubernetes-k8s" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/kubernetes-k8s" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://5SAMPKXTP9-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Xiaoyureed 的网络 Wiki" href="/opensearch.xml">


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?f6da56a47f5085d1e0fedae39b8de00a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="xiaoyureed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="xiaoyureed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="xiaoyureed JSON Feed">

<link rel="icon" href="/img/logo.webp">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)">
<meta name="description" content="Xiaoyureed 的个人博客"><link rel="stylesheet" href="/assets/css/styles.d08d09a2.css">
<link rel="preload" href="/assets/js/runtime~main.831ed87f.js" as="script">
<link rel="preload" href="/assets/js/main.d4aae7e0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><a href="/docs/rust-note" target="_blank">Rust 指北, 欢迎查看...</a></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">菜单</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/archive">博客</a></li><li><a class="dropdown__link" href="/docs/intro">教程</a></li><li><a class="dropdown__link" href="/resource">导航</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--dark_i4oU"><b></b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/SpringBoot-note">Spring Boot 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/autohotkey">Autohotkey 脚本</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/blockchain">blockchain区块链</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/c-sharp-and-dot-net">C# &amp; .NET</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/chatgpt">Chatgpt Usage Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cpp">CPP and C 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cross-gfw">Cross The GFW</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cs-note">Computer Science Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/css-pre-processor">几种CSS预处理器比较选型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/data-structure-and-algorithm">Data Structure and Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/design-pattern-note">Design Pattern 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/dev-resources">开发者资源</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/distributed-system">Distributed System 分布式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docker-note-virtual-dev-env">Docker Note &amp; Other Virtual Develop Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/effective-java-reading-note">Effective Java 阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/elk-elastic-log">Distributed log collection分布式日志收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/english-note">英语学习🔥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/extjs-note">Extjs 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/git-note">Git 备忘 🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/golang-note">Golang 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/gps-gis-tracing">基于地理位置开发技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/gradle">Gradle note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/greasy-monkey">油猴插件&amp;编写脚本🐒</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/groovy-note">groovy note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/health">Health 关爱程序员健康🏥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/how-to-test-java-app">How to Test Java App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/interview-system-design">系统设计 System design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/iot">Iot 物联网</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-code-clean">Java Clean Code Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrent">Java Concurrent🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-memory-model-jmm-jvm">JMM and GC🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-note">Java Core 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/js-tutorial">JavaScript tutorial</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/kotlin">kotlin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/kubernetes-k8s">kubernetes-k8s ☁️</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/linux-note">鸟哥的 Linux 私房菜阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/low-code-platform">关于低代码平台的调研</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/mac">Mac 开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/machine-learning-ml">machine-learning-ml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/marketing-seo">Marketing SEO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/maven-note">Maven Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/message-queue">Message Queue🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/money">Investment Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/mongodb-note">MongoDB Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/monitor-system-grafana-prometheus-influxdb-hbase">monitor-system-grafana-prometheus监控🖥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/mvc-mvvm">MVC to MVVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/mybatis-note">MyBatis Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/netty-note">netty</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/nlp-natural-language-processing">nlp-natural-language-processing👄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/nodejs-yarn-npm">Nodejs, Yarn, Npm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/oracle">Oracle 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-audio-video">Audio and Video development Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-big-data-introduce">大数据开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-cache">Cache 缓存🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-computational-ad">计算广告 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-crawler-spider">网络爬虫 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-db-design-note">关系型数据库表设计🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-desktop-develop">桌面应用开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-http-restful">HTTP protocol Intro &amp; RESTful</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-reactive-programming">响应式编程 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-rpc">RPC Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/outline-about-rule-engine-note">规则引擎 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/php-note">PHP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/postgres-note">Postgres note🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/process-workflow-bpm-engine">工作流引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/protect-your-app-authentication-oauth2-jwt-https">Protect Your App 安全保护认证鉴权🔑</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/python-note">Python🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/quant-money">量化交易</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/quarkus">Quarkus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/react-note">React🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/real-time-communication-protocol">实时通信 Real-time</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/redis-note">Redis🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/regex">Regular Expression 正则🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/rust-note">Rust 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/scala-akka-play-framework">Scala 语言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/serverless">Serverless</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/service-mesh">service mesh 服务网格</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/servlet">Servlet Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/shell-bash-note">shell-bash脚本收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/spring-note">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/springcloud-note">Spring Cloud 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/springmvc-note">Spring MVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/task-schedule-note">Task Schedule</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/tcp-ip-note-p2p">TCP IP, p2p</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/tomcat-jetty-nginx">Tomcat Jetty Nginx 等 web 容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/vertx">Vertx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/video-creator">拍摄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webassembly">webassembly</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webpack-esbuild-vite-rollup">前端打包构建工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/windows-sub-system-on-linux">WSL 使用</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">kubernetes-k8s ☁️</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>kubernetes-k8s ☁️</h1></header><ul><li><a href="#1-%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98">1. 面试问题</a></li><li><a href="#%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7">开发调试工具</a></li><li><a href="#2-deploying-springcloud">2. deploying springcloud</a><ul><li><a href="#using-configmap">using configMap</a></li><li><a href="#%E9%83%A8%E7%BD%B2%E5%88%B0-k8s-%E5%90%8E%E8%BF%98%E6%98%AF%E6%9C%89%E7%BC%BA%E7%82%B9">部署到 k8s 后还是有缺点</a></li></ul></li><li><a href="#3-what-and-why">3. what and why</a><ul><li><a href="#31-k8s-%E6%98%AF%E5%81%9A%E4%BB%80%E4%B9%88%E7%9A%84">3.1. k8s 是做什么的</a></li><li><a href="#32-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8">3.2. 为什么使用:</a></li><li><a href="#33-compare-with-spring-cloud">3.3. compare with spring cloud</a></li></ul></li><li><a href="#4-%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83">4. 搭建环境</a><ul><li><a href="#41-%E7%94%9F%E4%BA%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85">4.1. 生产服务器上安装</a></li><li><a href="#42-vagrant-%E6%90%AD%E5%BB%BA-k8s-%E7%8E%AF%E5%A2%83">4.2. vagrant 搭建 k8s 环境</a></li><li><a href="#43-%E4%BC%97%E5%A4%9A%E7%9A%84%E5%8F%91%E8%A1%8C%E7%89%88">4.3. 众多的发行版</a><ul><li><a href="#431-k3s">4.3.1. k3s</a><ul><li><a href="#4311-k3d">4.3.1.1. k3d</a><ul><li><a href="#43111-%E4%BD%BF%E7%94%A8-helmchart-controller">4.3.1.1.1. 使用 helmChart controller</a></li><li><a href="#43112-%E6%93%8D%E4%BD%9C-kubeconfig">4.3.1.1.2. 操作 kubeconfig</a></li><li><a href="#43113-%E6%94%AF%E6%8C%81%E7%9A%84%E5%91%BD%E4%BB%A4">4.3.1.1.3. 支持的命令</a></li><li><a href="#43114-%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F">4.3.1.1.4. 国内镜像</a></li><li><a href="#43115-%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F">4.3.1.1.5. 导入镜像</a></li><li><a href="#43116-k3s-%E5%8C%85%E6%8B%AC%E4%BB%A5%E4%B8%8B%E4%B8%80%E4%BA%9B%E7%BB%84%E4%BB%B6">4.3.1.1.6. k3s 包括以下一些组件</a></li><li><a href="#43117-%E5%AE%8C%E6%95%B4%E7%9A%84-k3d-yml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">4.3.1.1.7. 完整的 k3d yml 配置文件</a></li><li><a href="#43118-%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA-nginx">4.3.1.1.8. 部署一个 NGINX</a></li></ul></li></ul></li><li><a href="#432-k0s">4.3.2. k0s</a></li><li><a href="#433-microk8s">4.3.3. microk8s</a></li><li><a href="#434-docker-desktop-%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8-rancher-desktop-%E6%9B%BF%E4%BB%A3">4.3.4. docker desktop (推荐使用 rancher desktop 替代)</a></li><li><a href="#435-kind-%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8-k3d-%E4%BB%A3%E6%9B%BF">4.3.5. kind (推荐使用 k3d 代替)</a></li><li><a href="#436-minikube">4.3.6. minikube</a></li></ul></li></ul></li><li><a href="#5-quickstart">5. Quickstart</a><ul><li><a href="#51-%E4%BB%A5java-%E4%B8%BA%E4%BE%8B">5.1. 以Java 为例</a></li><li><a href="#52-%E4%BB%A5-go-%E4%B8%BA%E4%BE%8B">5.2. 以 go 为例</a><ul><li><a href="#521-using-pod-directly">5.2.1. using pod directly</a></li><li><a href="#522-using-deployment">5.2.2. using deployment</a></li></ul></li></ul></li><li><a href="#6-%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84-underlying-infrastructure-%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD">6. 集群结构 underlying infrastructure 基础设施</a></li><li><a href="#7-api-%E7%AE%A1%E7%90%86%E7%9A%84%E5%90%84%E7%A7%8D%E8%B5%84%E6%BA%90">7. api 管理的各种资源</a><ul><li><a href="#71-%E5%90%84%E7%A7%8D%E8%B5%84%E6%BA%90%E7%9A%84%E5%85%B3%E7%B3%BB">7.1. 各种资源的关系</a></li><li><a href="#72-3-common-properties">7.2. 3 common properties</a><ul><li><a href="#721-metadata">7.2.1. metadata</a></li><li><a href="#722-spec">7.2.2. spec</a></li><li><a href="#723-status">7.2.3. status</a></li></ul></li><li><a href="#73-node">7.3. node</a></li><li><a href="#74-pod">7.4. pod</a></li><li><a href="#75-label">7.5. label</a><ul><li><a href="#751-label-selector-%E4%BD%BF%E7%94%A8">7.5.1. Label selector 使用</a></li></ul></li><li><a href="#76-taint%E6%B1%A1%E7%82%B9%E5%92%8C-toleration%E5%AE%B9%E5%BF%8D">7.6. Taint（污点）和 Toleration（容忍）</a><ul><li><a href="#761-taint">7.6.1. taint</a></li><li><a href="#762-toleration">7.6.2. toleration</a></li></ul></li><li><a href="#77-controllers%E5%90%84%E7%A7%8D%E6%8E%A7%E5%88%B6%E5%99%A8">7.7. controllers(各种控制器)</a><ul><li><a href="#771-rc-replica-controller-%E5%89%AF%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%99%A8">7.7.1. <del>RC (replica controller 副本控制器)</del></a></li><li><a href="#772-rs-replica-set-%E4%BB%A3%E6%9B%BF-rc">7.7.2. RS (replica set, 代替 RC)</a></li><li><a href="#773-deployment-%E7%AE%A1%E7%90%86-rs">7.7.3. Deployment (管理 RS)</a><ul><li><a href="#7731-scale-upback-%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9">7.7.3.1. scale up/back (扩容缩容)</a></li><li><a href="#7732-version-upgrade-%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7">7.7.3.2. version upgrade (版本升级)</a></li><li><a href="#7733-rolling-update-%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7">7.7.3.3. rolling update (滚动升级)</a></li><li><a href="#7734-%E5%9B%9E%E6%BB%9A-%E7%89%88%E6%9C%AC%E5%9B%9E%E9%80%80-%E6%9F%A5%E7%9C%8B%E5%8E%86%E5%8F%B2">7.7.3.4. 回滚 版本回退 查看历史</a></li><li><a href="#7735-livenessprobe-%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88">7.7.3.5. livenessProbe (存活探针)</a></li><li><a href="#7736-readinessprobe-%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88">7.7.3.6. readinessProbe (就绪探针)</a></li></ul></li><li><a href="#774-sc-stateful-set">7.7.4. SC (stateful set)</a><ul><li><a href="#7741-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96-persist">7.7.4.1. 数据持久化 persist</a></li></ul></li><li><a href="#775-ds-daemon-set-%E5%90%8E%E5%8F%B0%E6%94%AF%E6%92%91%E6%9C%8D%E5%8A%A1%E9%9B%86">7.7.5. DS (daemon set 后台支撑服务集)</a></li><li><a href="#776-job-%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BB%BB%E5%8A%A1">7.7.6. job (一次性任务)</a></li><li><a href="#777-cronjob-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">7.7.7. cronjob (定时任务)</a></li></ul></li><li><a href="#78-service">7.8. service</a><ul><li><a href="#781-endpoint">7.8.1. Endpoint</a></li><li><a href="#782-%E5%A4%9A%E7%AB%AF%E5%8F%A3">7.8.2. 多端口</a></li><li><a href="#783-clusterip-%E9%BB%98%E8%AE%A4%E4%BD%BF%E7%94%A8%E7%9A%84%E7%B1%BB%E5%9E%8B">7.8.3. ClusterIP (默认使用的类型)</a><ul><li><a href="#7831-headless">7.8.3.1. Headless</a></li></ul></li><li><a href="#784-nodeport">7.8.4. NodePort</a></li><li><a href="#785-loadbalancer">7.8.5. LoadBalancer</a></li><li><a href="#786-externalname">7.8.6. ExternalName</a></li><li><a href="#787-%E6%89%8B%E5%8A%A8%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91">7.8.7. 手动端口转发</a></li><li><a href="#788-service-%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C">7.8.8. service 如何工作</a></li></ul></li><li><a href="#79-ingress">7.9. ingress</a><ul><li><a href="#791-install-ingress-nginx">7.9.1. install ingress-nginx</a></li><li><a href="#792-traefik">7.9.2. Traefik</a></li></ul></li><li><a href="#710-volume">7.10. volume</a></li><li><a href="#711-secret">7.11. secret</a></li><li><a href="#712-config-map">7.12. config map</a></li><li><a href="#713-flannel">7.13. flannel</a></li><li><a href="#714-name">7.14. name</a></li><li><a href="#715-name-namespace-%E7%94%A8%E6%9D%A5%E5%88%92%E5%88%86%E5%A4%9A%E7%8E%AF%E5%A2%83">7.15. name namespace (用来划分多环境)</a></li></ul></li><li><a href="#8-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6">8. 垃圾回收</a><ul><li><a href="#81-%E7%BA%A7%E8%81%94%E5%88%A0%E9%99%A4">8.1. 级联删除</a></li><li><a href="#82-%E5%AD%A4%E5%84%BF%E5%88%A0%E9%99%A4-orphan">8.2. 孤儿删除 orphan</a></li></ul></li><li><a href="#9-%E8%B5%84%E6%BA%90%E6%8F%8F%E8%BF%B0%E6%96%87%E4%BB%B6">9. 资源描述文件</a><ul><li><a href="#91-%E6%9F%A5%E7%9C%8B%E5%B1%9E%E6%80%A7%E8%AF%B4%E6%98%8E">9.1. 查看属性说明</a></li><li><a href="#92-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90-yml">9.2. 通过命令生成 yml</a></li><li><a href="#93-pod-%E7%9A%84-yaml-%E6%8F%8F%E8%BF%B0%E6%96%87%E4%BB%B6">9.3. pod 的 yaml 描述文件</a></li><li><a href="#94-deployment-%E7%9A%84%E6%8F%8F%E8%BF%B0%E6%96%87%E4%BB%B6">9.4. deployment 的描述文件</a></li><li><a href="#95-service">9.5. service</a></li></ul></li><li><a href="#10-%E6%B3%A8%E8%A7%A3">10. 注解</a></li><li><a href="#11-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">11. 命名空间</a></li><li><a href="#12-pod-%E7%AE%A1%E7%90%86">12. pod 管理</a><ul><li><a href="#121-%E6%8E%A2%E6%B5%8B-pod-%E6%98%AF%E5%90%A6%E5%81%A5%E5%BA%B7">12.1. 探测 pod 是否健康</a></li><li><a href="#122-pod-%E5%89%AF%E6%9C%AC">12.2. pod 副本</a></li><li><a href="#123-%E8%BF%90%E8%A1%8C%E5%8D%95%E4%B8%AA%E4%BB%BB%E5%8A%A1-job">12.3. 运行单个任务 Job</a></li><li><a href="#124-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-cronjob">12.4. 定时任务 CronJob</a></li></ul></li><li><a href="#13-pod-%E9%80%9A%E4%BF%A1">13. pod 通信</a><ul><li><a href="#131-proxy">13.1. proxy</a></li><li><a href="#132-service">13.2. Service</a></li><li><a href="#133-pod-%E9%97%B4%E9%80%9A%E4%BF%A1">13.3. pod 间通信</a></li><li><a href="#134-%E9%80%9A%E8%BF%87-service-%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1">13.4. 通过 Service 连接外部服务</a><ul><li><a href="#1341-%E9%80%9A%E8%BF%87%E6%89%8B%E5%8A%A8%E7%94%9F%E6%88%90-endpoint">13.4.1. 通过手动生成 endpoint</a></li><li><a href="#1342-%E9%80%9A%E8%BF%87-externalname-%E7%B1%BB%E5%9E%8B%E7%9A%84-service">13.4.2. 通过 externalName 类型的 Service</a></li></ul></li><li><a href="#135-%E5%B0%86%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%BB%99%E5%A4%96%E9%83%A8">13.5. 将服务暴露给外部</a><ul><li><a href="#1351-%E5%B0%86%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%AE%BE%E7%BD%AE%E6%88%90-nodeport">13.5.1. 将服务的类型设置成 NodePort</a></li><li><a href="#1352-%E5%B0%86%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%AE%BE%E7%BD%AE%E6%88%90-loadbalance">13.5.2. 将服务的类型设置成 LoadBalance</a></li><li><a href="#1353-%E5%88%9B%E5%BB%BA%E4%B8%80-%E4%B8%AA-ingress-%E8%B5%84%E6%BA%90">13.5.3. 创建一 个 Ingress 资源</a></li></ul></li></ul></li><li><a href="#14-%E5%91%BD%E4%BB%A4">14. 命令</a><ul><li><a href="#141-kubectl">14.1. kubectl</a><ul><li><a href="#1411-%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF">14.1.1. 基本信息</a></li><li><a href="#1412-%E5%88%9B%E5%BB%BA-create-expose">14.1.2. 创建 create expose</a></li><li><a href="#1413-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E5%88%B0%E5%AE%B9%E5%99%A8-exec">14.1.3. 执行命令到容器 exec</a></li><li><a href="#1414-%E4%BF%AE%E6%94%B9">14.1.4. 修改</a></li><li><a href="#1415-%E8%B5%84%E6%BA%90%E5%88%97%E8%A1%A8-get">14.1.5. 资源列表 get</a></li><li><a href="#1416-%E6%9F%A5%E8%AF%A2%E8%AF%A6%E7%BB%86%E6%8F%8F%E8%BF%B0-describe">14.1.6. 查询详细描述 describe</a></li><li><a href="#1417-%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97-logs">14.1.7. 查询日志 logs</a></li><li><a href="#1418-%E5%88%A0%E9%99%A4-delete">14.1.8. 删除 delete</a></li><li><a href="#1419-%E6%93%8D%E4%BD%9C%E4%B8%8A%E4%B8%8B%E6%96%87">14.1.9. 操作上下文</a></li></ul></li><li><a href="#142-kubeadmin">14.2. kubeadmin</a></li></ul></li><li><a href="#15-cka-ckad-%E8%AF%81%E4%B9%A6%E8%80%83%E8%AF%95">15. cka ckad 证书考试</a></li><li><a href="#16-dashboard">16. dashboard</a><ul><li><a href="#161-k9s">16.1. k9s</a></li><li><a href="#162-kuboard">16.2. kuboard</a></li><li><a href="#163-kubernetes-dashboard">16.3. kubernetes-dashboard</a></li><li><a href="#164-kubesphere-%E6%8E%A8%E8%8D%90">16.4. kubesphere (推荐)</a></li></ul></li><li><a href="#17-rancher">17. rancher</a></li><li><a href="#18-harbor">18. Harbor</a></li><li><a href="#19-helm">19. Helm</a><ul><li><a href="#191-how-to-create-helm-chart">19.1. How to create helm chart</a></li><li><a href="#192-helm-chart-%E7%9A%84%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83">19.2. helm chart 的打包发布</a><ul><li><a href="#1921-%E6%89%8B%E5%8A%A8%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83">19.2.1. 手动打包发布</a></li><li><a href="#1922-%E5%88%A9%E7%94%A8-github-action-%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83">19.2.2. 利用 github action 自动打包发布</a></li></ul></li><li><a href="#193-%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8">19.3. 基本命令使用</a></li><li><a href="#194-rollback">19.4. rollback</a></li><li><a href="#195-%E5%A4%9A%E7%8E%AF%E5%A2%83">19.5. 多环境</a></li></ul></li><li><a href="#20-reference-materials">20. reference materials</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-面试问题">1. 面试问题<a href="#1-面试问题" class="hash-link" aria-label="1. 面试问题的直接链接" title="1. 面试问题的直接链接">​</a></h2><p>为什么需要 pod? 为什么不能简单地把所有进程都放在一个单独的容器中?</p><ul><li>如果在单个容器中运行多个不相关的进程， 那么保持所有进程运行(如失败重启)、 管理它们的日志会困难(日志会混在一起)。</li></ul><p>为什么要将一个 app 的 前端服务器 和 后端服务器 分为 两个 pod 部署?</p><ul><li><p>造成计算资源浪费: 如果部署到同一个 pod, 那么对于 双节点 k8s, 将总是只能利用一个节点</p></li><li><p>扩缩容不便: k8s 扩容基本单位就是 pod, 前后端若部署到同个 pod, 会造成扩缩容粒度太大. 而且对于 数据库服务器, 扩缩容无法这样简单处理</p></li></ul><p>如何决定是否将多个 container 划分到一个 pod?</p><ul><li>扩缩容是否能够一起进行</li><li>是否可以在同个主机运行</li></ul><p>11 年运维工作经验，现从事腾讯工业互联网运维工作； DevOps 运维工程师，开源爱好者； 3 年+Kubernetes 平台经验，对 Kubernetes 生态有自己的认识；掌握 Jenkins+Gitlab+Helm 持续集成/持续交付工具链；对消息队列，缓存等中间件，软件架构体系有一定的了解；熟练掌握 shell 编程，熟悉 Python,Go 语言； TODO</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="开发调试工具">开发调试工具<a href="#开发调试工具" class="hash-link" aria-label="开发调试工具的直接链接" title="开发调试工具的直接链接">​</a></h2><p>一般来说k8s使用的容器网络与开发者的所在的办公网络并不能直接连通，如何在本地开发环境访问服务器上的k8s的服务?</p><ul><li><a href="https://github.com/alibaba/kt-connect" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/kt-connect</a> 阿里出品</li><li><a href="https://github.com/telepresenceio/telepresence" target="_blank" rel="noopener noreferrer">https://github.com/telepresenceio/telepresence</a> windows 系统上安装复杂</li><li>利用 kubectl forward在本地建立 k8s 中服务的代理
<code>kubectl port-forward &lt;generated target pod name&gt; &lt;local port&gt;:&lt;target port&gt;</code> 这里 pod name 名字不固定, 更好的办法是指定 deployment
<code>kubectl port-forward deployment/&lt;your pod name&gt; &lt;local post&gt;:&lt;target port&gt;</code> 更好
或者 deployment 替换为 rs/svc</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-deploying-springcloud">2. deploying springcloud<a href="#2-deploying-springcloud" class="hash-link" aria-label="2. deploying springcloud的直接链接" title="2. deploying springcloud的直接链接">​</a></h2><p><a href="https://github.com/Fenderon/springcloud-kubernetes-example" target="_blank" rel="noopener noreferrer">https://github.com/Fenderon/springcloud-kubernetes-example</a></p><p><a href="http://www.enmalvi.com/2022/05/27/springcloud-spring-cloud-kubernetes/" target="_blank" rel="noopener noreferrer">http://www.enmalvi.com/2022/05/27/springcloud-spring-cloud-kubernetes/</a></p><p>SpringCloud 通过 spring cloud kubernetes starter, 屏蔽了spring cloud 原来组件和 k8s 原生能力的差异</p><blockquote><p>使用spring-cloud-kubernetes框架，该框架可以调用kubernetes的原生能力来为现有SpringCloud应用提供服务</p></blockquote><p>服务发现. k8s的service</p><blockquote><p>通过Spring Cloud Kubernetes Discovery自动将 HTTP 访问中的服务转换为 full qualified domain name</p></blockquote><p>负载均衡. </p><blockquote><p>采用 Kubernetes Service 本身的负载均衡能力实现，可以不再需要 Ribbon 这样的客户端负载均衡了</p></blockquote><p>配置中心. k8s 的 Secret &amp; ConfigMap</p><blockquote><p>通过 springcloud kubernetes config 自动将 configMap 内容注入到 springboot 配置文件中并实现动态更新</p><p>最佳实践: Git维护配置的版本，CI/CD部署到Kubernetes集群的ConfigMap/Secret。</p></blockquote><p>网关: k8s 提供 Ingress</p><blockquote><p>网关部分 springcloud kubernetes 仍然保留了 Zuul，未采用 Ingress 代替。这里有两点考虑，一是 Ingress Controller 不算是 Kubernetes 的自带组件，它可以有不同的选择（KONG、Nginx、Haproxy，等等），同时也需要独立安装</p></blockquote><p>熔断、降级、限流</p><blockquote><p>Kubernetes本身没有熔断器，因此微服务框架中的熔断组件是有必要的 (Sentinel, Hystrix)</p><p>将在基于 Istio 的服务网格架构中解决这个问题</p></blockquote><p>认证授权</p><blockquote><p>仍然采用 Spring Security OAuth 2，Kubernetes 的 RBAC 授权可以解决服务层面的访问控制问题，但 Security 是跨越了业务和技术的边界的，认证授权模块本身仍承担着对前端用户的认证、授权职责，这部分是与业务相关的。</p></blockquote><p>容器环境感知. </p><blockquote><p>springcloud k8s 引入了 fabric8 的 kubernetes client</p></blockquote><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 整合了 k8s 的功能, 提供服务发现, 可以去掉 eurake 了 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">org.springframework.cloud</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">spring-cloud-starter-kubernetes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 负载均衡 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- spring.cloud.loadbalancer.ribbon. enabled=false</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"> --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 本地调用kubernetes中的服务, 将spring.cloud.kubernetes.ribbon.mode修改为service，然后再将对应的服务开放一个端口出来，放一个nodeport出来就可以直接调用了。 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 本地项目中调用另一个本地服务是用的@FeignClient注解来实现的，那么就可以在@FeignClient注解中添加url参数来实现忽略name的功能从而实现本地请求到本地 ,</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">如 @FeignClient(name = &quot;svcb-service&quot;,url = &quot;${local.feign.server.svcb-service.url:}&quot;,fallback = ServiceBClient.ServiceBClientFallback.class) , 然后就可以在配置文件中配置 local.feign.server.svcb-service.url 为目标 ip:port, 建议配置成环境变量, 不要写死</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">org.springframework.cloud</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">spring-cloud-starter-kubernetes-ribbon</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 配置中心, 可以去掉 config server 了 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 但是不建议替换配置中心, config server 的存在方便配置文件的溯源 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">org.springframework.cloud</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">spring-cloud-starter-kubernetes-config</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 自动维护 k8s deployment, service 资源定义文件, 产物在 meta-inf/fabric8 下 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 也可以自己在 src/main/fabric8 下重写deployment.yml, service.yml定义文件 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">build</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">plugins</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">plugin</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">io.fabric8</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">fabric8-maven-plugin</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">version</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">${fabric8.maven.plugin.version}</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">version</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">executions</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">execution</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">fmp</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">goals</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">goal</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">resource</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">goal</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">goal</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">goal</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">goals</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">execution</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">executions</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!--docker需要开启远程访问--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">dockerHost</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">http://haiyang.dockerhost.com:2375</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">dockerHost</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">enricher</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">config</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">fmp-service</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">NodePort</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">fmp-service</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">config</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">enricher</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!--registry地址,用于推送镜像--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!--                            &lt;registry&gt;ccr.ccs.tencentyun.com&lt;/registry&gt;--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!--认证配置,用于私有registry认证,如果忘记了可以去阿里的registry查看--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">authConfig</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">push</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">username</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your usernmae</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">username</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">password</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your password</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">password</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">push</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">authConfig</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">plugin</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">plugins</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">build</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- fabric8插件生成的deployment还会自动生成readinessProbe和livenessProbe。 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- 需要引入 actuator --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">groupId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">spring-boot-starter-actuator</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">artifactId</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">dependency</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="using-configmap">using configMap<a href="#using-configmap" class="hash-link" aria-label="using configMap的直接链接" title="using configMap的直接链接">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1 by d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 必须和 应用名称一样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这里的内容会被 client-service 作为配置文件, 覆盖应用内的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">application.properties</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">bean.message=Testing reload! Message from backend is</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> %s &lt;br/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"> Services </span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> %s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="部署到-k8s-后还是有缺点">部署到 k8s 后还是有缺点<a href="#部署到-k8s-后还是有缺点" class="hash-link" aria-label="部署到 k8s 后还是有缺点的直接链接" title="部署到 k8s 后还是有缺点的直接链接">​</a></h3><blockquote><p>随着 Kubernetes 集群中的 Pod 数量规模越来越庞大，到一定程度之后，运维的同学无奈地表示已经不可能够依靠人力来跟进微服务中出现的各种问题了：一个请求在哪个服务上调用失败啦？是 A 有调用 B 吗？还是 C 调用 D 时出错了？为什么这个请求、页面忽然卡住了？怎么调度到这个 Node 上的服务比其他 Node 慢那么多？</p></blockquote><p>k8s 下的 springcloud 可配置, 可观测特性还有待加强 --&gt; istio</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-what-and-why">3. what and why<a href="#3-what-and-why" class="hash-link" aria-label="3. what and why的直接链接" title="3. what and why的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-k8s-是做什么的">3.1. k8s 是做什么的<a href="#31-k8s-是做什么的" class="hash-link" aria-label="3.1. k8s 是做什么的的直接链接" title="3.1. k8s 是做什么的的直接链接">​</a></h3><p>抽象了数据中心的硬件基础设施，对外暴露统一的接口，具体包括</p><ul><li>调度: k8s 自动决定组件部署到具体的哪一台 服务器节点。</li><li>自动修复: 自动检查节点的健康状态, 吧程序迁移到健康的节点上</li><li>水平伸缩: 自动检测业务的负载情况, 如果 CPU 负载太高, 或者相应时间太长, 会自动进行扩容</li></ul><p>只需要告诉 k8s 要做什么 (比如保持某个 pod 有三个副本), 而不必告诉它怎么做, 就像 sql 只告诉 数据库要查询那些数据, 而没有告诉数据库怎么查数据</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-为什么使用">3.2. 为什么使用:<a href="#32-为什么使用" class="hash-link" aria-label="3.2. 为什么使用:的直接链接" title="3.2. 为什么使用:的直接链接">​</a></h3><p>当 container 太多, 需要管理, 单机情况下, 还能依靠 docker-compose 这些工具, 当有很多机器时, 就必须通过 k8s 来将 容器合理地分配到这些机器中去</p><ul><li>服务发现和负载均衡</li><li>自动部署 and 回滚</li><li>替换失败容器 (自我修复)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-compare-with-spring-cloud">3.3. compare with spring cloud<a href="#33-compare-with-spring-cloud" class="hash-link" aria-label="3.3. compare with spring cloud的直接链接" title="3.3. compare with spring cloud的直接链接">​</a></h3><p>Spring Cloud 通过整合Neflix相关开源组件实现了一套完整的微服务方案，但是必须借助于K8S这样的容器编排工具才能实现理想的效果。而K8S却可以自成体系构建微服务系统</p><ol><li><p>k8s 对构建的应用无侵入性，有更低的改造成本。</p></li><li><p>对开发语言无要求，Go、nodeJS、Java、PHP都是可以的。</p></li><li><p>程序的版本管理更加灵活，不受制与Spring Cloud的版本。</p></li><li><p>Spring Cloud 体系的程序如果部署在K8S的环境， 很多微服务特性都是重复的</p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-搭建环境">4. 搭建环境<a href="#4-搭建环境" class="hash-link" aria-label="4. 搭建环境的直接链接" title="4. 搭建环境的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-生产服务器上安装">4.1. 生产服务器上安装<a href="#41-生产服务器上安装" class="hash-link" aria-label="4.1. 生产服务器上安装的直接链接" title="4.1. 生产服务器上安装的直接链接">​</a></h3><p><a href="https://github.com/fanux/sealos" target="_blank" rel="noopener noreferrer">https://github.com/fanux/sealos</a> 一键安装</p><p><a href="https://github.com/guoliangdi/springcloudFeign" target="_blank" rel="noopener noreferrer">https://github.com/guoliangdi/springcloudFeign</a> centos 上安装 基于 k8s 的 devops</p><p><a href="https://github.com/lework/kainstall" target="_blank" rel="noopener noreferrer">https://github.com/lework/kainstall</a></p><p><a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener noreferrer">https://github.com/easzlab/kubeasz</a> 使用Ansible脚本安装K8S集群</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-vagrant-搭建-k8s-环境">4.2. vagrant 搭建 k8s 环境<a href="#42-vagrant-搭建-k8s-环境" class="hash-link" aria-label="4.2. vagrant 搭建 k8s 环境的直接链接" title="4.2. vagrant 搭建 k8s 环境的直接链接">​</a></h3><p>一个 master node: docker, kubeadm, kubelet, kubectl 两个 worker node:</p><p>Vagrantfile:</p><div class="language-vagrantfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-vagrantfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Vagrant.configure(&quot;2&quot;) do |config|</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   (1..3).each do |i|</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        config.vm.define &quot;k8s-node#{i}&quot; do |node|</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # 设置虚拟机的Box</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            node.vm.box = &quot;centos7&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # 设置虚拟机的主机名</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            node.vm.hostname=&quot;k8s-node#{i}&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # 设置虚拟机的IP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # 192.168.56.xxx 需要在 virtualbox 先创建 host only network 192.168.56.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            node.vm.network &quot;private_network&quot;, ip: &quot;192.168.56.#{99+i}/24&quot;, netmask: &quot;255.255.255.0&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # 设置主机与虚拟机的共享目录</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # node.vm.synced_folder &quot;~/Documents/vagrant/share&quot;, &quot;/home/vagrant/share&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            # VirtaulBox相关配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            node.vm.provider &quot;virtualbox&quot; do |v|</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                # 设置虚拟机的名称</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                v.name = &quot;k8s-node#{i}&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                # 设置虚拟机的内存大小</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                v.memory = 4096</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                # 设置虚拟机的CPU个数</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                v.cpus = 4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">end</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>虚拟机准备</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 登录 machine sshd, 保证可以通过账号密码登录 (默认仅仅 ssh 登录)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 若使用 tmux + ssh config 则无需无需这一步, 直接通过 ssh 登录即可</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vagrant ssh k8s-node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sudo su</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vi /etc/ssh/sshd_config # 修改 为 PasswordAuthentication yes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">service sshd restart</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 设置默认网卡</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># show default SoftEther</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># We can find that the default soft ether is eth0, the three machine have the same eth0 ip.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># This is because eth0 default to 网络地址转发(nat) 类型. in order  to make the machines can</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># access to each other, etho should be type: Natnetwork</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ip route show</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 操作 virtualbox 图形界面, 全局新建 natnetwork 网络. 为每个 machine 默认网卡1 即 eth0 指定 这个类型, 刷新高级设置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 里的 网卡mac 地址</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 然后在各个 machine 内 互相 ping 是否通</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># close firewall</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl stop firewalld</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl disable firewalld</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># disable selinux (永久)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config # 替换了 enforcing 为 disable</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 当前会话关闭 selinux (临时)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">setenforce 0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 关闭 swap 永久</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab # 其实就是注释掉一行   #/swapfile none swap defaults 0 0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 关闭 swap (内存交换) 临时</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 添加 主机名 and ip 映射</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># hostname 会显示 主机名 k8s-node1/2/3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 若 hostname 显示不正常可以修改: hostnamectl set-hostname &lt;new hostname&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vi /etc/hosts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># eth0 网卡就是 默认网卡, 用来machine 互联的</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &lt;node1 eth0 ip&gt; k8s-node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &lt;node2 eth0 ip&gt; k8s-node2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &lt;node3 eth0 ip&gt; k8s-node3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10.0.2.15 k8s-node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10.0.2.4 k8s-node2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10.0.2.5 k8s-node3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 将桥接的 ipv4 的流量传递到 iptables 的链</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.bridge.bridge-nf-call-iptables = 1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 验证</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sysctl --system</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 同步三台机器的时间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">yum install ntpdate -y</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ntpdate time.windows.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 将只读文件系统 改为 读写</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mount -o remount rw /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装 docker 等</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># docker参照官网即可</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 安装 k8s 需要 aliyun 镜像 推荐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">[kubernetes]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">name=Kubernetes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">enabled=1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">gpgcheck=0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">repo_gpgcheck=0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ustc 的镜像</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cat &lt;&lt;EOF &gt; /etc/apt/sources.list.d/kubernetes.list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># centos</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl enable kubelet</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl start kubelet</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 在 master node 上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 需要拉去 k8s 相关的镜像, 默认仓库 k8s.gcr.io 背墙, 这里重新指定</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># service-cidr 是 service 间通信的网段/子网</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># pod network-cidr 是 pod 间通信网段/子网</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubeadm init --apiserver-advertise-address=&lt;master node eth0 ip&gt; \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--kubernetes-version v1.19.4 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--service-cidr=10.96.0.0/16 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--pod-network-cidr=10.244.0.0/16</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 按照 输出提示, 如下步骤需要做:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># master 生成的 命令, 在 worker node 执行即可加入 cluster.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 2h 内有效</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubeadm join 10.0.2.15:6443 --token 0tpws3.y1uhbzg0rgal4okz \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --discovery-token-ca-cert-hash sha256:0a25a082e0babbc18d1646ebfa9954d82838fa86ec66ee3d88c0d57fc9c0f35e</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 过期之后, 如下生成永久的 token</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubeadm token create --print-join-command</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubeadm token create --ttl 0 --print-join-command # 复制生成的 token 到上面命令即可</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建网络</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 这里选定 flannel 提供的网络扩展插件 (addons)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 具体有哪些可用的插件: https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">curl -L https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml -o flannel_network.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 上传到 master node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">scp ~/flanel.yml root@xxx/root</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 子节点加入到 cluster 后, master 会同步 flanel 相关的 pod 到 子节点上, 可以监控, 等待一段时间再查看 nodes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f flannel.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看 flanel 相关 的 pods 是否启动</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po --all-namespaces</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 如果是 失败的, 那么小替换 flanel.yml 中 image 相关地址, 到 docker hub 上找, 如 https://hub.docker.com/r/easzlab/flannel</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除 , 重新创建</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete -f flannel.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 此时可以在子节点上执行添加 node 命令了   &gt;&gt;&gt; 在 worker node 上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 监控 所有节点上的 指定ns 的 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 等待 所有节点 上 flanel 相关的 pod 都正常启动后再在 master 上查看 nodes 状态, 保证所有 node 状态为 ready 则 cluster 搭建成功</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">watch kubectl get po -n kube-system -o wide</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 安装 ingress controller,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 有多重实现, 选择一种即可 https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 这里选择 ingress-nginx https://kubernetes.io/docs/concepts/services-networking/ingress/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ref: https://www.cnblogs.com/minseo/p/12455320.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43-众多的发行版">4.3. 众多的发行版<a href="#43-众多的发行版" class="hash-link" aria-label="4.3. 众多的发行版的直接链接" title="4.3. 众多的发行版的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="431-k3s">4.3.1. k3s<a href="#431-k3s" class="hash-link" aria-label="4.3.1. k3s的直接链接" title="4.3.1. k3s的直接链接">​</a></h4><p><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noopener noreferrer">https://github.com/k3s-io/k3s</a>
<a href="https://rancher.com/docs/k3s/latest/en/" target="_blank" rel="noopener noreferrer">https://rancher.com/docs/k3s/latest/en/</a> 官网
<a href="https://www.rancher.cn/k3s/" target="_blank" rel="noopener noreferrer">https://www.rancher.cn/k3s/</a> 中文官网</p><p><a href="https://oldj.net/article/2022/04/17/install-k3s-and-rancher/" target="_blank" rel="noopener noreferrer">https://oldj.net/article/2022/04/17/install-k3s-and-rancher/</a></p><p>轻量级的 k8s, 内核机制还是和 K8s 一样，但是剔除了很多外部依赖以及 K8s 的 alpha、beta 特性</p><p>将其应用于 IoT 设备（比如树莓派）, CI, development 是非常好的选择</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4311-k3d">4.3.1.1. k3d<a href="#4311-k3d" class="hash-link" aria-label="4.3.1.1. k3d的直接链接" title="4.3.1.1. k3d的直接链接">​</a></h5><p><a href="https://github.com/k3d-io/k3d" target="_blank" rel="noopener noreferrer">https://github.com/k3d-io/k3d</a> 将 k3s 跑在 docker 里</p><p><a href="https://cloud.tencent.com/developer/article/1791688" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1791688</a> 原理教程</p><p>For macOs, we can just download the binary file from github release page or by using <code>brew install k3d</code></p><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43111-使用-helmchart-controller">4.3.1.1.1. 使用 helmChart controller<a href="#43111-使用-helmchart-controller" class="hash-link" aria-label="4.3.1.1.1. 使用 helmChart controller的直接链接" title="4.3.1.1.1. 使用 helmChart controller的直接链接">​</a></h6><p>Helm Controller 定义了一个新的HelmChart自定义资源, 部署到 kubernetes 中, 用于管理 Helm 图表。</p><blockquote><p>用于简化 helm 命令行的使用, 类比 docker 命令行之于 docker-compose</p><p>Helm Controller实际上就是一个CRD Controller，管理的是HelmChart类型的CRD API</p><p>Helm是 Kubernetes 的包管理器, Helm 由客户端 (helm) 和服务器端组件Tiller组成,用于管理 Helm 图表的部署和生命周期。在 k3s 中,Tiller 被替换为Helm Controller; </p><p>Helm v3 中，Tiller 被移除了, 新的 Helm 客户端会像 kubectl 命令一样，读取本地的 kubeconfig 文件，使用我们在 kubeconfig 中预先定义好的SA权限来进行一系列操作。这样做法即简单，又安全。</p></blockquote><p>HelmChart部署应用，有以下好处:</p><p>1、HelmChart把Helm的操作变成对CRD API的管理，当需要对应用进行修改时，只需修改HelmChart相关属性即可，Helm-controller会主动监听API对象是否发生变化；</p><p>2、省去在宿主机上安装helm的步骤；</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> helm.cattle.io/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> HelmChart</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># Kubernetes object metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># Chart name (required)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 对于 k3s,这必须是kube-system,因为 Helm Controller 仅配置为监视此命名空间以获取新的 HelmChart 资源。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">system </span><span class="token comment" style="color:rgb(0, 128, 0)"># Namespace Helm Controller is monitoring to deploy charts (required)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># resource specification</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">chart</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">helmchart  </span><span class="token comment" style="color:rgb(0, 128, 0)"># char name / url</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">targetNamespace</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">namespace </span><span class="token comment" style="color:rgb(0, 128, 0)"># which ns will be used to install the chart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 0.0.1        </span><span class="token comment" style="color:rgb(0, 128, 0)"># chart version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">//example.com/helm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">charts   </span><span class="token comment" style="color:rgb(0, 128, 0)"># chart repo url</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 要提供给 Helm 的配置值的字典/映射。键应指定为字符串。值可以是整数或字符串。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果需要更复杂的值,请使用valuesContent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">set</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">key1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;value1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">key2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;value2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">valuesContent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">application</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">admin_username</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> admin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">admin_password</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> insecure_password</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">tls_enabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相应的命令行:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ helm install test-helmchart --namespace test-namespace \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              --version 0.0.1 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              --repo https://example.com/helm-charts \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              --set-string key1=value1 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              --set-string key2=value2 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              #  values.yaml 包含valuesContent字段下的内容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                              --values values.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装: <code>k3s kubectl apply --filename node-red-helmchart.yaml</code>, 或者将资源定义复制到服务器的manifest目录 <code>/var/lib/rancher/k3s/server/manifests/</code> (Helm Controller 不断监视此目录中的新 CRD。当它检测到添加了新资源时,它将自动部署图表)</p><p>更新: 修改 yml 文件后, 再次执行 <code>kubectl apply --filename node-red-helmchart.yaml</code></p><p>删除: <code>kubectl --namespace kube-system delete helmchart &lt;char name, eg. node-red&gt;</code></p><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43112-操作-kubeconfig">4.3.1.1.2. 操作 kubeconfig<a href="#43112-操作-kubeconfig" class="hash-link" aria-label="4.3.1.1.2. 操作 kubeconfig的直接链接" title="4.3.1.1.2. 操作 kubeconfig的直接链接">​</a></h6><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 获取 kubeconfig 文件 (最新版k3d 会自动更新 ~/.kube/config, 我们无需手动修改 kubectl 即可操作k3d 创建的集群)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d kubeconfig get --all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43113-支持的命令">4.3.1.1.3. 支持的命令<a href="#43113-支持的命令" class="hash-link" aria-label="4.3.1.1.3. 支持的命令的直接链接" title="4.3.1.1.3. 支持的命令的直接链接">​</a></h6><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">k3d version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 默认值创建一个单节点集群</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create [--servers 2 ...]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># delete the default cluster or the specified cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster delete [mycluster]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl cluster-info # 检查是否启动完成</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get all --all-namespaces [--output wide] #  检查内部结构, 发现 K3s还部署了DNS、metrics和ingress（traefik）服务</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get nodes --output wide # 仅看到了一个节点, k3d node list 发现有两个节点, 有另一个“节点”作为负载均衡器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 可以看到几个比较常用见的组件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># local-path-provisioner: 这个提供本地存储pv动态创建</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># metrics-server: 用于pod metrics的收集</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># traefik: 这个用于请求转发</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># coredns: 集群域名解析</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># (其它的如Kube-proxy, kube-scheduler是没有，这个可以理解，用k3d创建出来的集群不管多少个agent，本质上还是一台实体机)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 都默认创建了一个 1个负载均衡器容器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create two-node-cluster --agents 2 [-image rancher/k3s:v1.19.3-k3s2]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create three-node-cluster --server 3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 通过--api-port 127.0.0.1:6445，您可以使用k3d将Kubernetes API端口（6443内部）映射到127.0.0.1 / localhost的端口6445</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --volume /home/me/mycode:/code@agent[*]绑定将你的本地目录/home/me/mycode挂载到所有（[*] agent 节点）内部的路径/code。使用索引（0或1）替换*，以便只把它挂载到其中一个节点。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create mycluster --api-port 127.0.0.1:6445 --servers 3 --agents 2 --volume &#x27;/home/me/mycode:/code@agent[*/0/1/2/3....]&#x27; --port &#x27;8080:80@loadbalancer&#x27;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create mycluster \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--api-port 127.0.0.1:6443 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p 80:80@loadbalancer \   # 在宿主机的 80, 443 端口访问 ingress 资源。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p 443:443@loadbalancer \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-i rancher/k3s:v1.18.6-k3s1 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--volume &quot;${HOME}/registries.yaml:/etc/rancher/k3s/registries.yaml&quot; \  # 配置国内镜像加速</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--k3s-server-arg &quot;--no-deploy=traefik&quot; # 禁用默认的 Traefik</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># registries.yaml 内容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mirrors:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  &quot;docker.io&quot;:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    endpoint:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://fogjl973.mirror.aliyuncs.com&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://registry-1.docker.io&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 切换集群</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config use-context k3d-two-node-cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># crate node and insert into current cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d node create &lt;prefix name&gt; --role server [--image ...]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d node list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d registry list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43114-国内镜像">4.3.1.1.4. 国内镜像<a href="#43114-国内镜像" class="hash-link" aria-label="4.3.1.1.4. 国内镜像的直接链接" title="4.3.1.1.4. 国内镜像的直接链接">​</a></h6><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d cluster create mycluster \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--api-port 127.0.0.1:6443 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p 80:80@loadbalancer \   # 在宿主机的 80, 443 端口访问 ingress 资源。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p 443:443@loadbalancer \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-i rancher/k3s:v1.18.6-k3s1 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--volume &quot;${HOME}/registries.yaml:/etc/rancher/k3s/registries.yaml&quot; \  # 配置国内镜像加速</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--k3s-server-arg &quot;--no-deploy=traefik&quot; # 禁用默认的 Traefik</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># registries.yaml 内容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mirrors:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  &quot;docker.io&quot;:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    endpoint:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://fogjl973.mirror.aliyuncs.com&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      - &quot;https://registry-1.docker.io&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43115-导入镜像">4.3.1.1.5. 导入镜像<a href="#43115-导入镜像" class="hash-link" aria-label="4.3.1.1.5. 导入镜像的直接链接" title="4.3.1.1.5. 导入镜像的直接链接">​</a></h6><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># k3d 中的镜像和 docker 不通, 需要手动导入</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 编写 deployment 时注明 imagePullPolicy: Never 从不拉取, 仅仅使用k3d 内部镜像</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">k3d image import &lt;customized image name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者自己搭建 image registry</p><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43116-k3s-包括以下一些组件">4.3.1.1.6. k3s 包括以下一些组件<a href="#43116-k3s-包括以下一些组件" class="hash-link" aria-label="4.3.1.1.6. k3s 包括以下一些组件的直接链接" title="4.3.1.1.6. k3s 包括以下一些组件的直接链接">​</a></h6><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token maybe-class-name">Containerd：一个类似</span><span class="token plain"> </span><span class="token maybe-class-name">Docker</span><span class="token plain"> 的运行时容器，但是它不支持构建镜像；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token maybe-class-name">Flannel：基于</span><span class="token plain"> </span><span class="token constant" style="color:rgb(129, 31, 63)">CNI</span><span class="token plain"> 实现的网络模型，默认使用的是 </span><span class="token maybe-class-name">Flannel，也可以使用</span><span class="token plain"> </span><span class="token maybe-class-name">Calico</span><span class="token plain"> 等其他实现替换；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token maybe-class-name">CoreDNS：集群内部</span><span class="token plain"> </span><span class="token constant" style="color:rgb(129, 31, 63)">DNS</span><span class="token plain"> 组件；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token maybe-class-name">SQLite3：默认使用</span><span class="token plain"> </span><span class="token maybe-class-name">SQLite3</span><span class="token plain"> 进行存储，同样也支持 etcd3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token maybe-class-name">MySQL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token maybe-class-name">Postgres；</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token maybe-class-name">Traefik：默认安装</span><span class="token plain"> </span><span class="token maybe-class-name">Ingress</span><span class="token plain"> controller 是 traefik </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token property-access">x</span><span class="token plain"> 的版本；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token maybe-class-name">Embedded</span><span class="token plain"> service loadbalancer：内嵌的一个服务负载均衡组件。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43117-完整的-k3d-yml-配置文件">4.3.1.1.7. 完整的 k3d yml 配置文件<a href="#43117-完整的-k3d-yml-配置文件" class="hash-link" aria-label="4.3.1.1.7. 完整的 k3d yml 配置文件的直接链接" title="4.3.1.1.7. 完整的 k3d yml 配置文件的直接链接">​</a></h6><p>or taking a yaml file to create cluster:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> k3d.io/v1alpha2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mycluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kubeAPI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 可通过 localhost:6443 访问 控制平面的 api</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hostPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;6443&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--api-port &#x27;6443&#x27;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 向主机暴露的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 将本地主机的端口8080映射到负载均衡器（serverlb）上的端口80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 即: 可通过 8080 访问集群内部 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 8080</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--port &#x27;8080:80@loadbalancer&#x27;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定应用的哪些节点, loadbalancer 是节点角色名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果内部Service 是 NodePort 类型 (通过节点暴露出去), 那这里的端口映射应该限制只作用于 loadbalancer 节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#  如果内部Service 通过 ingress 暴露, 那这里无需指定 nodeFilter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 8443</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">443</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--port &#x27;8443:443@loadbalancer&#x27;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">=================</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> k3d.io/v1alpha4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> k3s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--servers 1`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--agents 2`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> docker.io/rancher/k3s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v1.25.6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k3s1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kubeAPI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--api-port myhost.my.domain:6445` (where the name would resolve to 127.0.0.1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;127.0.0.1&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># important for the `server` setting in the kubeconfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># hostIP: &quot;192.168.1.200&quot; # where the Kubernetes API will be listening on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hostPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;6445&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># where the Kubernetes API listening port will be mapped to on your host system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token datetime number" style="color:rgb(9, 134, 88)">80:80</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--port &#x27;8080:80@loadbalancer&#x27;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">options</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">k3d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># k3d runtime settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">wait</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># wait for cluster to be usable before returining; same as `--wait` (default: true)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;60s&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># wait timeout before aborting; same as `--timeout 60s`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">disableLoadbalancer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--no-lb`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">disableImageVolume</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--no-image-volume`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">disableRollback</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># same as `--no-Rollback`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">loadbalancer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">configOverrides</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> settings.workerConnections=2048</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">k3s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># options passed on to K3s itself</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">extraArgs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># additional arguments passed to the `k3s server|agent` command; same as `--k3s-arg`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">arg</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;--tls-san=127.0.0.1 --tls-san=ks.newbe.io&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">kubeconfig</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">updateDefaultKubeconfig</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># add new cluster to your default Kubeconfig; same as `--kubeconfig-update-default` (default: true)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">switchCurrentContext</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># also set current-context to the new cluster&#x27;s context; same as `--kubeconfig-switch-context` (default: true)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">registries</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># define how registries should be created or used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># define contents of the `registries.yaml` file (or reference a file); same as `--registry-config /path/to/config.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">mirrors</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">&quot;docker.io&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">endpoint</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;https://mirror.ccs.tencentyun.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>k3d cluster create --config /path/to/mycluster.yaml</code></p><h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43118-部署一个-nginx">4.3.1.1.8. 部署一个 NGINX<a href="#43118-部署一个-nginx" class="hash-link" aria-label="4.3.1.1.8. 部署一个 NGINX的直接链接" title="4.3.1.1.8. 部署一个 NGINX的直接链接">​</a></h6><p><a href="https://blog.bwcxtech.com/posts/ea0ef82f/" target="_blank" rel="noopener noreferrer">https://blog.bwcxtech.com/posts/ea0ef82f/</a> 使用 Traefik2 代替 1</p><p>now write a k3d-cluster.yml</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> k3d.io/v1alpha4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kubeAPI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hostPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;6443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 8087</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">30080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 8443</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodeFilters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>k3d cluster create --config /path/to/cluster.yml</code></p><p>now let&#x27;s create the simplest nginx deployment and service:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;128Mi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;500m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>check the following picture to get a further understanding</p><p><img loading="lazy" src="/assets/images/k3d-e9c6aa818d0953eb83dc50aa15ba84f7.png" width="2450" height="1680" class="img_ev3q"></p><p><code>kc get pods,services -o wide</code> to check if the resources ready, and we can check <code>http://localhost:8087/</code> for the nginx welcome page</p><p>now try to bring in the Ingress resource: <code>k3d cluster delete cluster-3</code>, and update the service section in the yml:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Service type is set up to clusterIP (default)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># we can expose this service by using ingress</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ingress:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 即使用哪一个域名来访问service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">pathType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>the cluster yml file also need some updates:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> k3d.io/v1alpha4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kubeAPI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hostPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;6443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">#  ingress默认端口是80, 将其映射到宿主机的 9001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不要添加 nodeFilters:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">#           - loadbalancer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 9001</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>http://localhost:9001/</code> To check the nginx welcome page</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="432-k0s">4.3.2. k0s<a href="#432-k0s" class="hash-link" aria-label="4.3.2. k0s的直接链接" title="4.3.2. k0s的直接链接">​</a></h4><p><a href="https://github.com/k0sproject/k0s" target="_blank" rel="noopener noreferrer">https://github.com/k0sproject/k0s</a> 体积下, 更精简的 k8s</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="433-microk8s">4.3.3. microk8s<a href="#433-microk8s" class="hash-link" aria-label="4.3.3. microk8s的直接链接" title="4.3.3. microk8s的直接链接">​</a></h4><p><a href="https://github.com/canonical/microk8s" target="_blank" rel="noopener noreferrer">https://github.com/canonical/microk8s</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="434-docker-desktop-推荐使用-rancher-desktop-替代">4.3.4. docker desktop (推荐使用 rancher desktop 替代)<a href="#434-docker-desktop-推荐使用-rancher-desktop-替代" class="hash-link" aria-label="4.3.4. docker desktop (推荐使用 rancher desktop 替代)的直接链接" title="4.3.4. docker desktop (推荐使用 rancher desktop 替代)的直接链接">​</a></h4><p>it&#x27;s the easiest way to install k8s locally I think.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="435-kind-推荐使用-k3d-代替">4.3.5. kind (推荐使用 k3d 代替)<a href="#435-kind-推荐使用-k3d-代替" class="hash-link" aria-label="4.3.5. kind (推荐使用 k3d 代替)的直接链接" title="4.3.5. kind (推荐使用 k3d 代替)的直接链接">​</a></h4><p><a href="https://guoxudong.io/post/k3d-vs-kind/" target="_blank" rel="noopener noreferrer">https://guoxudong.io/post/k3d-vs-kind/</a> 对比</p><p><a href="https://github.com/kubernetes-sigs/kind/" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/kind/</a></p><p>在 docker 中运行 k8s, 更快更方便</p><p><a href="https://www.cnblogs.com/laochiji/p/13813743.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/laochiji/p/13813743.html</a> 多节点</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># install</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># install golang &amp;&amp; install docker</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker pull kindest/node:v1.19.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --name: specify a name for the cluster. default name : kind</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#  --wait 30s: wait until the cluster reaches a ready status</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --wait 5m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --kubeconfig: specify cluster config file; default location : ${HOME}/.kube/config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kind create cluster [--name kind] [--wait]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 构建镜像</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker build -t my-custom-image:unique-tag ./my-image-dir</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 加载到 kind</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kind load docker-image my-custom-image:unique-tag</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f my-manifest-using-my-image:unique-tag</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># context name 规则: &lt;kind&gt;-&lt;cluster_name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 仅仅一个 cluster 时, 可省略 context</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl cluster-info [--context kind-kind]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 默认删除 kind 名字的 cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kind delete cluster [--name kind]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 加载 images 到 cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 默认 将 镜像加载到 kind 名字的 cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kind load docker-image &lt;img_name&gt; [--name cluster_name]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 进入 kind 启动的 docker 内部, 执行 crictl images, 可以看</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 到用来模拟 k8s 的一系列镜像</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker exec -it kind-control-plane crictl images</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="436-minikube">4.3.6. minikube<a href="#436-minikube" class="hash-link" aria-label="4.3.6. minikube的直接链接" title="4.3.6. minikube的直接链接">​</a></h4><p>create single node k8s cluster for dev, 原理是 创建虚拟机,</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube dashboard</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 可用的扩展/插件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube addons list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 开启插件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube addons enable metrics-server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 关闭插件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube addons disable metrics-server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube stop</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube delete</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 当前 node ip</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">minikube ip</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-quickstart">5. Quickstart<a href="#5-quickstart" class="hash-link" aria-label="5. Quickstart的直接链接" title="5. Quickstart的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-以java-为例">5.1. 以Java 为例<a href="#51-以java-为例" class="hash-link" aria-label="5.1. 以Java 为例的直接链接" title="5.1. 以Java 为例的直接链接">​</a></h3><p><a href="https://mritd.com/2022/11/08/java-containerization-guide/" target="_blank" rel="noopener noreferrer">https://mritd.com/2022/11/08/java-containerization-guide/</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52-以-go-为例">5.2. 以 go 为例<a href="#52-以-go-为例" class="hash-link" aria-label="5.2. 以 go 为例的直接链接" title="5.2. 以 go 为例的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="521-using-pod-directly">5.2.1. using pod directly<a href="#521-using-pod-directly" class="hash-link" aria-label="5.2.1. using pod directly的直接链接" title="5.2.1. using pod directly的直接链接">​</a></h4><p>here is a piece of code in go:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;io&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">main</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">// Register a router</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">HandleFunc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">func</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> r </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        io</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">WriteString</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;[v1] Hello, k8s!&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">// Start the server and listening on port 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">ListenAndServe</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;:80&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>now we write a dockerfile for this go app</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">FROM golang:1.20 AS builder</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># create /src, then jump into it</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WORKDIR /src</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># pre-copy/cache go.mod for pre-downloading dependencies and only redownloading them in subsequent builds if they change</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># COPY go.mod go.sum ./</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># RUN go mod download &amp;&amp; go mod verify</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># copy all host files to /src</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">COPY . ./</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># required, if missing then go.mod is needed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RUN go env -w GO111MODULE=auto</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RUN CGO_ENABLED=0 go build -a -sw -ldflags &#x27;-extldflags &quot;-static&quot;&#x27; -v -o main .</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">FROM scratch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WORKDIR /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">COPY --from=builder /src/main .</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EXPOSE 80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ENTRYPOINT [&quot;/main&quot;]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>so now we can build our image and push it to docker hub:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">go build . -t xiaoyureed/hellok8s:v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker images | grep xiaoyureed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># login docker hub</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker login</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker push</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>then write the pod resource yml:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaoyureed/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;128Mi&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;500m&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apply the yml to create pod</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f xxx.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Wait for about 30s,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># so that the resources can be created</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check pod list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check pod info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc describe pod &lt;pod id&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># post forwarding (Temporary use only, just for debugging)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl port-forward hello-k8s-pod 4000:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># enter the container in the pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec -it hello-k8s-pod -- /bin/bash</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># echo &quot;hello kubernetes by nginx!&quot; &gt; /usr/share/nginx/html/index.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># visit localhost:4000</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl logs --follow hello-k8s-pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># exec cmd &quot;ls&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec hello-k8s-pod -- ls</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># delete resources</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete pod hello-k8s-pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete -f xxx.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="522-using-deployment">5.2.2. using deployment<a href="#522-using-deployment" class="hash-link" aria-label="5.2.2. using deployment的直接链接" title="5.2.2. using deployment的直接链接">​</a></h4><p>Let&#x27;s write a yml file to define a deployment to manage the pods</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaoyureed/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;128Mi&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;500m&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>then apply and check the results:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># create</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc apply -f k8s_resources/deployment.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check deployment info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc get deployments</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check pods info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Note: the pods name is generated by deployment and it&#x27;s unique</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc get pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Try to delete a pod, and then you will find that the pod number recovers after a moment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc delete pod hello-k8s-deployment-6bb465758-5d8lk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-集群结构-underlying-infrastructure-基础设施">6. 集群结构 underlying infrastructure 基础设施<a href="#6-集群结构-underlying-infrastructure-基础设施" class="hash-link" aria-label="6. 集群结构 underlying infrastructure 基础设施的直接链接" title="6. 集群结构 underlying infrastructure 基础设施的直接链接">​</a></h2><p><img loading="lazy" alt="k8s design" src="/assets/images/k8s_design-3303f985c7890750df7bd0ada74e7b20.png" width="1542" height="930" class="img_ev3q"></p><p><img loading="lazy" alt="k8s design1" src="/assets/images/k8s_design1-ee6f461a1bfc8942e993842de39ed7a6.png" width="2260" height="1686" class="img_ev3q"></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">控制平面</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">control plane</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Also</span><span class="token plain"> known </span><span class="token keyword module" style="color:rgb(0, 0, 255)">as</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;master&quot;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> designed to manage the hole cluster to make it work properly</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token literal-property property">配置存储中心</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ETCd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    distributed data storage</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> used to store the cluster status</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  api server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token maybe-class-name">Provide</span><span class="token plain"> the api </span><span class="token keyword" style="color:rgb(0, 0, 255)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">to</span><span class="token plain"> interactive </span><span class="token keyword" style="color:rgb(0, 0, 255)">with</span><span class="token plain"> the developer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property-access">scheduler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    调度， 决定哪个 pod 部署到哪个节点</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  control manager</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token literal-property property">整个集群的管家，用来管理资源对象</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> 如 复制节点， 持续跟踪工作节点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> node controller 在节点出现故障时进行通知和响应</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token maybe-class-name">Replication</span><span class="token plain"> </span><span class="token maybe-class-name">Controller</span><span class="token plain"> 维护正确数量的 </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token maybe-class-name">Endpoints</span><span class="token plain"> </span><span class="token maybe-class-name">Controller</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">填充端点</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token maybe-class-name">Endpoints</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token function" style="color:rgb(0, 0, 255)">对象</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">即加入 </span><span class="token maybe-class-name">Service</span><span class="token plain"> 与 </span><span class="token maybe-class-name">Pod</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">computer </span><span class="token function" style="color:rgb(0, 0, 255)">machines</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">计算节点 </span><span class="token maybe-class-name">Node</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Also</span><span class="token plain"> known </span><span class="token keyword module" style="color:rgb(0, 0, 255)">as</span><span class="token plain"> </span><span class="token maybe-class-name">Node</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> designed to run the real application</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 是所有 </span><span class="token maybe-class-name">Pod</span><span class="token plain"> 运行所在的工作主机，可以是物理机也可以是虚拟机</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token literal-property property">kubelet</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> 相当于节点的代理</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> 和 master 节点交互</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    和 master 节点的 api server 通信</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> 以管理所在的 节点</span><span class="token operator" style="color:rgb(0, 0, 0)">/</span><span class="token plain">机器上的 </span><span class="token function" style="color:rgb(0, 0, 255)">pod</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">创建、修改、监控、删除</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  kube</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">proxy</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> 负责一组 pods 的负载均衡</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    是 </span><span class="token maybe-class-name">K8s</span><span class="token plain"> 集群内部的负载均衡器。它是一个分布式代理服务器</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> 在 </span><span class="token maybe-class-name">K8s</span><span class="token plain"> 的每个节点上都有一个；这一设计体现了它的伸缩性优势，需要访问服务的节点越多，提供负载均衡能力的 </span><span class="token maybe-class-name">Kube</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">proxy 就越多，高可用节点也随之增多。与之相比，我们平时在服务器端做个反向代理做负载均衡，还要进一步解决反向代理的负载均衡和高可用问题。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token maybe-class-name">Fluentd，主要负责日志收集、存储与查询</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  container runtime </span><span class="token function" style="color:rgb(0, 0, 255)">engine</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">需要符合 oci 标准的运行时</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> 如 docker</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> containerd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> rkt</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(129, 31, 63)">CRI</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token constant" style="color:rgb(129, 31, 63)">O</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> 负责创建容器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token literal-property property">核心附件</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  cni 网络插件</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> flannel</span><span class="token operator" style="color:rgb(0, 0, 0)">/</span><span class="token plain">calico</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token literal-property property">服务发现插件</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> coredns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token literal-property property">服务暴露插件</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ingress</span><span class="token operator" style="color:rgb(0, 0, 0)">/</span><span class="token plain">traefik</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  gui 管理插件</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> dashboard</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-api-管理的各种资源">7. api 管理的各种资源<a href="#7-api-管理的各种资源" class="hash-link" aria-label="7. api 管理的各种资源的直接链接" title="7. api 管理的各种资源的直接链接">​</a></h2><p>即各种 api object,</p><p>像 pod, rc, rs, deployment 都属于 api object</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71-各种资源的关系">7.1. 各种资源的关系<a href="#71-各种资源的关系" class="hash-link" aria-label="7.1. 各种资源的关系的直接链接" title="7.1. 各种资源的关系的直接链接">​</a></h3><p>在 K8S 中，应用会被封装在 Container 中暴露出来一个 Port. 一个和多个 Container 组成了一个 Pod。 Pod 是 K8S 的基本执行单元。Pod 会被分配到 Node 上运行。而多个 Node 组成了一个 K8S Cluster.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="72-3-common-properties">7.2. 3 common properties<a href="#72-3-common-properties" class="hash-link" aria-label="7.2. 3 common properties的直接链接" title="7.2. 3 common properties的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="721-metadata">7.2.1. metadata<a href="#721-metadata" class="hash-link" aria-label="7.2.1. metadata的直接链接" title="7.2.1. metadata的直接链接">​</a></h4><p>metadata (contains 3 factors at least):</p><ul><li><p>namespace 命名空间为 Kubernetes 集群提供虚拟的隔离作用</p><p>Kubernetes 集群初始有两个命名空间，分别是默认命名空间 default 和系统命名空间 kube-system</p></li><li><p>name</p></li><li><p>uid</p></li></ul><p>used to identify api obj</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="722-spec">7.2.2. spec<a href="#722-spec" class="hash-link" aria-label="7.2.2. spec的直接链接" title="7.2.2. spec的直接链接">​</a></h4><p>used to declare the configuration that we want</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="723-status">7.2.3. status<a href="#723-status" class="hash-link" aria-label="7.2.3. status的直接链接" title="7.2.3. status的直接链接">​</a></h4><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="73-node">7.3. node<a href="#73-node" class="hash-link" aria-label="7.3. node的直接链接" title="7.3. node的直接链接">​</a></h3><p>是 K8S 的集群工作节点，可以是物理机也可以是虚拟机；</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># check node info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl describe node &lt;NODENAME&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 禁止Pod调度到该节点上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl corndon NODENAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 驱逐该节点上的所有 Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl drain NODENAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="74-pod">7.4. pod<a href="#74-pod" class="hash-link" aria-label="7.4. pod的直接链接" title="7.4. pod的直接链接">​</a></h3><p>由 一个或多个相互关联的 container 组成, 这些 container 共享网络地址和文件系统, 是 k8s 管理的基本单位, 代表着集群中的一个虚拟主机</p><blockquote><p>一个 pod 只可能存在于一个 worker node 上, 不可跨节点, 一组 pod 可以分布在不同 node 上</p><p>一个 pod 内的所有容器共享相同的 Linux network 命名空间. 这样每个 pod 就像一台独立的 主机, 有自己的 ip (集群内部地址), 主机名, 端口 (pod 中的 containers 共享 该 ip 以及 端口空间, 具有相同的 loopback 网络接口,可使用 localhost 相互通信).</p><p>(可以和 docker-compose 启动的多个 container 类比)</p><p>container (容器) 的本质是进程，而 pod 是管理这一组进程的资源</p></blockquote><p>Here is the yml spec file for pod:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaoyureed/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;128Mi&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;500m&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>use these commands to check the pods info</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># check list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc get pod[s]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check list, including more info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods -o wide</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># enter a specific pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec -it &lt;pod name&gt; /bin/bash</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="75-label">7.5. label<a href="#75-label" class="hash-link" aria-label="7.5. label的直接链接" title="7.5. label的直接链接">​</a></h3><p>label 是资源上的标识，用来对它们进行区分和选择,</p><p>通常在资源对象确定时定义，也可以在资源创建后动态添加或删除；</p><p>一个 label 会以 kv 形式附加到各种对象上(node, pod, service ...)</p><p>常用 label:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token literal-property property">版本标签：“version”</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain">“release”</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">环境标签：</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;environment&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;dev&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;environment&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;qa&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;environment&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;production&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">架构标签：</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;tier&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;frontend&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string-property property">&quot;tier&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;backend&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string-property property">&quot;tier&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;cache&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="751-label-selector-使用">7.5.1. Label selector 使用<a href="#751-label-selector-使用" class="hash-link" aria-label="7.5.1. Label selector 使用的直接链接" title="7.5.1. Label selector 使用的直接链接">​</a></h4><ul><li>包含/不包含 特定 key 的 资源</li><li>包含特定 key， value 的 资源</li><li>包含 特定 key， 且 value 和指定的不同的资源</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="76-taint污点和-toleration容忍">7.6. Taint（污点）和 Toleration（容忍）<a href="#76-taint污点和-toleration容忍" class="hash-link" aria-label="7.6. Taint（污点）和 Toleration（容忍）的直接链接" title="7.6. Taint（污点）和 Toleration（容忍）的直接链接">​</a></h3><p>可以作用于 node 和 pod 上, 用于控制和优化 pod 在 node 上的调度</p><p>具有 taint 的 node 和 pod 是互斥关系，而具有节点亲和性 (toleration) 关系的 node 和 pod 是相吸的</p><blockquote><p>Taint 和 toleration 相互配合，可以用来避免 pod 被分配到不合适的节点上。每个节点上都可以应用一个或多个 taint ，这表示对于那些不能容忍这些 taint 的 pod，是不会被该节点接受的。如果将 toleration 应用于 pod 上，则表示这些 pod 可以（但不要求）被调度到具有相应 taint 的节点上。</p><p>另外还有可以给 node 设置 label，通过给 pod 设置 nodeSelector 将 pod 调度到具有匹配标签的节点上。</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="761-taint">7.6.1. taint<a href="#761-taint" class="hash-link" aria-label="7.6.1. taint的直接链接" title="7.6.1. taint的直接链接">​</a></h4><p>作用在 node 上.</p><p>Node 被设置上污点之后，就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度过来，甚至可以将已存在的 Pod 驱逐出去；</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">污点格式：key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain">effect，key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token maybe-class-name">PreferNoSchedule</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> k8s尽量不把pod调度到该污点Node上，除非没有其他节点可调度；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token maybe-class-name">NoSchedule</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> k8s将不会把Pod调度到该污点Node上，已存在的Pod将继续运行；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token maybe-class-name">NoExecute：k8s将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱逐；</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用语法:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 设置污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes &lt;node name&gt; &lt;key&gt;=&lt;value&gt;:&lt;effect&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 去除污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes node1 &lt;key&gt;:&lt;effect&gt;-</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 去除所有污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes node1 &lt;key&gt;-</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 例如：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 为node1设置污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes node1 tag=test:PreferNoSchedule</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 为node1取消污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes node1 tag:PreferNoSchedule-</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 为node1删除去除污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl taint nodes node1 tag-</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看node1 污点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl describe node node1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="762-toleration">7.6.2. toleration<a href="#762-toleration" class="hash-link" aria-label="7.6.2. toleration的直接链接" title="7.6.2. toleration的直接链接">​</a></h4><p>作用在 pod 上</p><p>若将 pod 调度到一个有污点的 node 上去，需要用到容忍; Node 通过污点拒绝 pod 调度上去，pod 通过容忍忽略拒绝；</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="77-controllers各种控制器">7.7. controllers(各种控制器)<a href="#77-controllers各种控制器" class="hash-link" aria-label="7.7. controllers(各种控制器)的直接链接" title="7.7. controllers(各种控制器)的直接链接">​</a></h3><p>pod 控制器, 部署/管理 pods</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="771-rc-replica-controller-副本控制器">7.7.1. <del>RC (replica controller 副本控制器)</del><a href="#771-rc-replica-controller-副本控制器" class="hash-link" aria-label="771-rc-replica-controller-副本控制器的直接链接" title="771-rc-replica-controller-副本控制器的直接链接">​</a></h4><p><strong>outdated</strong></p><p>保证 Pod 高可用的 API 对象； 创建/复制 pod 实例, 确保 pod 副本数量 (it kill the pod or start pod to ensure that the pod number consit with the configuration)</p><p>Best practice: remember that always start pod by using RC</p><p><code>kubectl run ...</code> 会创建一个 rc， 然后 rc 创建 pod （所以删除这样的 pod， 需要先删除 rc）</p><p>工作流程：寻找 符合 label selector 的 pod， 比较找到的 pod 和期望数量， 少了就从当前模板创建新的 pod 副本 ， 多了， 就删除多的 pod</p><p>三个部分：</p><ul><li><p>label selector： 用于确定 ReplicationController 作用域中有哪些 pod</p></li><li><p>replica count (副本个数）， 指定应运行的 pod 数量</p></li><li><p>pod template (pod 模板）， 用于创建新的 pod 副本</p></li></ul><p>在新版的 K8s 中，建议使用 ReplicaSet 作为副本控制器，ReplicationController 不再使用了</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="772-rs-replica-set-代替-rc">7.7.2. RS (replica set, 代替 RC)<a href="#772-rs-replica-set-代替-rc" class="hash-link" aria-label="7.7.2. RS (replica set, 代替 RC)的直接链接" title="7.7.2. RS (replica set, 代替 RC)的直接链接">​</a></h4><p>副本集</p><p>副本集对象一般不单独使用，而是用 Deployment 来管理。</p><blockquote><p>RC 和 RS 主要是控制提供无状态服务的，其所控制的 Pod 的名字是随机设置的，一个 Pod 出故障了就被丢弃掉，在另一个地方重启一个新的 Pod，名字变了。名字和启动在哪儿都不重要，重要的只是 Pod 总数；</p><p>对于 RC 和 RS 中的 Pod，一般不挂载存储或者挂载共享存储，保存的是所有 Pod 共享的状态</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="773-deployment-管理-rs">7.7.3. Deployment (管理 RS)<a href="#773-deployment-管理-rs" class="hash-link" aria-label="7.7.3. Deployment (管理 RS)的直接链接" title="7.7.3. Deployment (管理 RS)的直接链接">​</a></h4><p>表示用户对 Kubernetes 集群的一次更新操作。可以是创建/更新一个新的服务，也可以是滚动升级一个服务</p><blockquote><p>滚动升级一个服务，实际是创建一个新的 RS，然后逐渐将新 RS 中副本数增加到理想状态，将旧 RS 中的副本数减小到 0 的复合操作</p></blockquote><p>比 replica set 使用范围更广, 一般使用 deployment 来管理 replica set</p><p>Here is the yml spec file:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># Control the scale up/back through this filed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># required, used to select pods which can be managed by this deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># Note: no need to specify &quot;name&quot; in metadata since the deployment will create the unique pod name automatically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># required, used to be selected by deployment&#x27;s selector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># required, the final container name contains this field</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaoyureed/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;128Mi&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;500m&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 环境变量 可以在 springboot应用中通过 ${xxx} 使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> yyy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定 container 中应用暴露的端口, 应该保持和 dockerfile 中的 expose 一样</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7731-scale-upback-扩容缩容">7.7.3.1. scale up/back (扩容缩容)<a href="#7731-scale-upback-扩容缩容" class="hash-link" aria-label="7.7.3.1. scale up/back (扩容缩容)的直接链接" title="7.7.3.1. scale up/back (扩容缩容)的直接链接">​</a></h5><p>With regards to Scale up/back, we just need update the &quot;spec.replicas&quot; field, then rerun <code>kubectl apply -f xxx.yml</code></p><blockquote><p>We can use <code>kc get pods --watch</code> to monitor the pod list</p></blockquote><p>or we can use this cmd <code>kubectl scale deployment test-k8s --replicas=5</code></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7732-version-upgrade-版本升级">7.7.3.2. version upgrade (版本升级)<a href="#7732-version-upgrade-版本升级" class="hash-link" aria-label="7.7.3.2. version upgrade (版本升级)的直接链接" title="7.7.3.2. version upgrade (版本升级)的直接链接">​</a></h5><p>When talking about the app Version Upgrade, after make the code change, just need rebuild the image (note version number should change from v1 to v2) and push to docker hub, then update the yml <code>image</code> field, finally exec <code>kc apply ...</code></p><blockquote><p>Use <code>kubectl describe pod xxx</code> to check the pod details info, so that you can see the version info</p></blockquote><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7733-rolling-update-滚动升级">7.7.3.3. rolling update (滚动升级)<a href="#7733-rolling-update-滚动升级" class="hash-link" aria-label="7.7.3.3. rolling update (滚动升级)的直接链接" title="7.7.3.3. rolling update (滚动升级)的直接链接">​</a></h5><blockquote><p>像上面那样的部署方式是可以的，但是也会带来一个问题，就是所有的副本在同一时间更新，这会导致我们 hellok8s 服务在短时间内是不可用的，因为所有 pod 都在升级到 v2 版本的过程中，需要等待某个 pod 升级完成后才能提供服务</p><p>这个时候我们就需要滚动更新，在保证新版本 v2 的 pod 还没有 ready 之前，先不删除 v1 版本的 pod。</p></blockquote><p><code>spec.strategy.type</code> &#x27;s possible values include:</p><ul><li><p>RollingUpdate: 逐渐增加新版本的 pod，逐渐减少旧版本的 pod。</p><p>(可以通过 maxSurge 和 maxUnavailable 字段来控制升级 pod 的速率)</p><ul><li>maxSurge: 最大峰值，用来指定可以创建的超出期望 Pod 个数的 Pod 数量。</li><li>maxUnavailable: 最大不可用，用来指定更新过程中不可用的 Pod 的个数上限。</li></ul></li><li><p>Recreate: 在新版本的 pod 增加前，先将所有旧版本 pod 删除。</p></li></ul><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># specify the upgrade type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定 pod 的最大超出个数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 最大可能会创建 4 个 hellok8s pod (replicas + maxSurge)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxSurge</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定 pod 的最大不可用个数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 最小会有 2 个 hellok8s pod 存活 (replicas - maxUnavailable)。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxUnavailable</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> guangzhengli/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7734-回滚-版本回退-查看历史">7.7.3.4. 回滚 版本回退 查看历史<a href="#7734-回滚-版本回退-查看历史" class="hash-link" aria-label="7.7.3.4. 回滚 版本回退 查看历史的直接链接" title="7.7.3.4. 回滚 版本回退 查看历史的直接链接">​</a></h5><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># roll back to last deployment version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl rollout undo deployment hellok8s-deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check the history version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl rollout history deployment hellok8s-deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># roll back to the specified version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl rollout undo deployment/hellok8s-deployment --to-revision=2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7735-livenessprobe-存活探针">7.7.3.5. livenessProbe (存活探针)<a href="#7735-livenessprobe-存活探针" class="hash-link" aria-label="7.7.3.5. livenessProbe (存活探针)的直接链接" title="7.7.3.5. livenessProbe (存活探针)的直接链接">​</a></h5><blockquote><p>在生产中，有时候因为某些 bug 导致应用死锁或者线程耗尽了，最终会导致应用无法继续提供服务，这个时候如果没有手段来自动监控和处理这一问题的话，可能会导致很长一段时间无人发现</p></blockquote><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxSurge</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxUnavailable</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> guangzhengli/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">liveness</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果服务器上 /healthz 路径下的处理程序返回成功代码，则 kubelet 认为容器是健康存活的。 如果处理程序返回失败代码，则 kubelet 会杀死这个容器并将其重启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用 HTTP GET 请求的方式探活</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># Specify the application route (api path)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /healthz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># specify the application port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 告诉 kubelet 在执行第一次探测前应该等待 3 秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 即容器启动后要等待多少秒后才启动存活和就绪探测器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">initialDelaySeconds</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 执行探测的时间间隔（单位是秒）。默认是 10 秒。最小值是 1。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">periodSeconds</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># timeoutSeconds：探测的超时后等待多少秒。默认值是 1 秒。最小值是 1。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># failureThreshold：当探测失败时，Kubernetes 的重试次数。 对存活探测而言，放弃就意味着重新启动容器。 对就绪探测而言，放弃意味着 Pod 会被打上未就绪的标签。默认值是 3。最小值是 1。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 <code>kubectl get pods</code> 查看状态 or <code>kubectl describe pod hellok8s-68f47f657c-zwn6g</code> 查看原因,</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7736-readinessprobe-就绪探针">7.7.3.6. readinessProbe (就绪探针)<a href="#7736-readinessprobe-就绪探针" class="hash-link" aria-label="7.7.3.6. readinessProbe (就绪探针)的直接链接" title="7.7.3.6. readinessProbe (就绪探针)的直接链接">​</a></h5><blockquote><p>在生产环境中，升级服务的版本是日常的需求，这时我们需要考虑一种场景，即当发布的版本存在问题，就不应该让它升级成功。kubelet 使用就绪探测器可以知道容器何时准备好接受请求流量，当一个 pod 升级后不能就绪，即不应该让流量进入该 pod，在配合 rollingUpate 的功能下，也不能允许升级版本继续下去，否则服务会出现全部升级完成，导致所有服务均不可用的情况。</p></blockquote><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxSurge</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">maxUnavailable</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> guangzhengli/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">bad</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">readinessProbe</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /healthz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 初次探测前等待时间, 默认是 0 秒，最小值是 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">initialDelaySeconds</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 被视为成功的最小连续成功数。默认值是 1。 存活和启动探测的这个值必须是 1。最小值是 1。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">successThreshold</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="774-sc-stateful-set">7.7.4. SC (stateful set)<a href="#774-sc-stateful-set" class="hash-link" aria-label="7.7.4. SC (stateful set)的直接链接" title="7.7.4. SC (stateful set)的直接链接">​</a></h4><p>有状态应用部署 (如 MySQL, ZooKeeper、etcd )</p><p>StatefulSet 中的每个 Pod 的名字都是事先确定的，会被固定住</p><p>StatefulSet 中的 Pod，每个 Pod 挂载自己独立指定的存储，</p><blockquote><p>如果一个 Pod 出现故障，从其他节点启动一个同样名字的 Pod，要挂载上原来 Pod 的存储继续以它的状态提供服务</p><p>使用 StatefulSet，Pod 仍然可以通过漂移到不同节点提供高可用，而存储也可以通过外挂的存储来提供高可靠性，StatefulSet 做的只是将确定的 Pod 与确定的存储关联起来保证状态的连续性。</p></blockquote><p>Service 的 CLUSTER-IP 是空的</p><p>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的</p><p>如下部署 MongoDB:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> StatefulSet</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">serviceName</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token number" style="color:rgb(9, 134, 88)">4.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /data/db </span><span class="token comment" style="color:rgb(0, 128, 0)"># 容器里面的挂载路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">data    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 卷名字，必须跟下面定义的名字一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">data              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 卷名字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">hostPath</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 把节点上的一个目录挂载到 Pod，但是已经不推荐使用了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /data/mongo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">data      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 节点上的路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DirectoryOrCreate     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指向一个目录，不存在时自动创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb </span><span class="token comment" style="color:rgb(0, 128, 0)"># 固定的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> mongodb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># HeadLess</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">clusterIP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> None</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">27017</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">27017</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7741-数据持久化-persist">7.7.4.1. 数据持久化 persist<a href="#7741-数据持久化-persist" class="hash-link" aria-label="7.7.4.1. 数据持久化 persist的直接链接" title="7.7.4.1. 数据持久化 persist的直接链接">​</a></h5><p>Storage Class (SC) : 将存储卷划分为不同的种类，例如：SSD，普通磁盘，本地磁盘</p><p>Persistent Volume (PV) : 描述卷的具体信息，例如磁盘大小，访问模式</p><p>Persistent Volume Claim (PVC): 对存储需求的一个申明，可以理解为一个申请单，系统根据这个申请单去找一个合适的 PV</p><blockquote><p>还可以根据 PVC 自动创建 PV。</p></blockquote><p>PersistemVolume(PV)用来定义存储卷，PersistemVolumeClaim(PVC)用来声明在Pod中用哪个PV。通常PV和PVC是一一对应的。但是如果每次都要去创建PV太麻烦了，所以K8S还提供了StorageClass来动态创建PV。前面的StatefulSets因为要保证Pod的状态持久化落盘，它就依赖于PV和PVC这玩意儿做持久化。</p><p><img loading="lazy" alt="xx" src="/assets/images/k8s_storage-be12cdb7b38ab477a52835c7c8343043.png" width="1264" height="1362" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="775-ds-daemon-set-后台支撑服务集">7.7.5. DS (daemon set 后台支撑服务集)<a href="#775-ds-daemon-set-后台支撑服务集" class="hash-link" aria-label="7.7.5. DS (daemon set 后台支撑服务集)的直接链接" title="7.7.5. DS (daemon set 后台支撑服务集)的直接链接">​</a></h4><p>确保每个 working node 都运行一个指定 pod (working node 可能是所有集群节点也可能是通过 nodeSelector 选定的一些特定节点)</p><blockquote><p>这个 pod 可能是用来专门支撑业务系统运行的基础服务, 比如对集群中的每个 working node 做日志采集，性能指标监控</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="776-job-一次性任务">7.7.6. job (一次性任务)<a href="#776-job-一次性任务" class="hash-link" aria-label="7.7.6. job (一次性任务)的直接链接" title="7.7.6. job (一次性任务)的直接链接">​</a></h4><p>Job 管理的 Pod 根据用户的设置把任务成功完成就自动退出了</p><blockquote><p>成功完成的标志根据不同的 spec.completions 策略而不同：</p><ul><li>单 Pod 型任务有一个 Pod 成功就标志完成；</li><li>定数成功型任务保证有 N 个任务全部成功；</li><li>工作队列型任务根据应用确认的全局成功而标志成功。</li></ul></blockquote><p>Job 完成时不会再创建新的 Pod，不过已有的 Pod 通常也不会被删除</p><blockquote><p>保留这些 Pod 使得你可以查看已完成的 Pod 的日志输出，以便检查错误、警告或者其它诊断性输出。 可以使用 kubectl 来删除 Job（例如 kubectl delete -f hello-job.yaml)。当使用 kubectl 来删除 Job 时，该 Job 所创建的 Pod 也会被删除</p></blockquote><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> batch/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 例如下面就会先创建 3 个 pod 并发执行任务，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 一旦某个 pod 执行完成，就会再创建新的 pod 来执行，直到 5 个 pod 执行完成，Job 才会被标记为完成。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 并发执行的 pod 的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">parallelism</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 创建 Pod 的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">completions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># pod 内的 container 异常而结束时, Pod 会继续保留在当前 node, 但是重启内部 container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 可选值: Never, ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/bin/sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;for i in 9 8 7 6 5 4 3 2 1 ; do echo $i ; done&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f hello-job.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get jobs      </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get cronjob[s]            </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods -w</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl logs -f xxx_pod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="777-cronjob-定时任务">7.7.7. cronjob (定时任务)<a href="#777-cronjob-定时任务" class="hash-link" aria-label="7.7.7. cronjob (定时任务)的直接链接" title="7.7.7. cronjob (定时任务)的直接链接">​</a></h4><p>用法除了需要加上 cron 表达式之外，其余基本和 Job 保持一致。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># ┌───────────── </span><span class="token function" style="color:rgb(0, 0, 255)">分钟</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">59</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ ┌───────────── </span><span class="token function" style="color:rgb(0, 0, 255)">小时</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ ┌───────────── </span><span class="token function" style="color:rgb(0, 0, 255)">月的某天</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ │ ┌───────────── </span><span class="token function" style="color:rgb(0, 0, 255)">月份</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ │ │ ┌───────────── </span><span class="token function" style="color:rgb(0, 0, 255)">周的某天</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">（周日到周一；在某些系统上，</span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"> 也是星期日）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ │ │ │                          或者是 sun，mon，tue，web，thu，fri，sat</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ │ │ │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># │ │ │ │ │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> batch/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> CronJob</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">cronjob</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">schedule</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;* * * * *&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># Every minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">jobTemplate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/bin/sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;for i in 9 8 7 6 5 4 3 2 1 ; do echo $i ; done&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="78-service">7.8. service<a href="#78-service" class="hash-link" aria-label="7.8. service的直接链接" title="7.8. service的直接链接">​</a></h3><p>用来代理一组 pods, 通过 label selector 选择一批 pods</p><blockquote><p>Pod重建后ip是会重新分配的，而且一个服务Pod有好几个, 所以服务之间的调用肯定不能用Pod的ip，需要 service 提供代理; 但是这个Service代理和Nginx这样的反向代理还是不一样的，它本质上是和LVS类似的四层代理，也就是传输层代理, 它是不区分应用层是http流量还是mysql的流量的</p><p>提供访问服务的固定地址(服务发现, 负载均衡).</p></blockquote><p>每个 Service 会对应一个集群内部有效的虚拟 IP，集群内部通过虚拟 IP (or service name) 访问一个服务</p><blockquote><p>RC、RS 和 Deployment 只是保证了支撑服务的微服务 Pod 的数量，但是没有解决如何访问这些服务的问题。一个 Pod 只是一个运行服务的实例，随时可能在一个节点上停止，在另一个节点以一个新的 IP 启动一个新的 Pod，因此不能以确定的 IP 和端口号提供服务。要稳定地提供服务需要服务发现和负载均衡能力。</p><p>在 K8 集群中，客户端需要访问的服务就是 Service 对象, 类似 微服务中注册中心的角色, 通过某个 service, 可访问一组提供相同服务的 pods</p></blockquote><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get service[s]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="781-endpoint">7.8.1. Endpoint<a href="#781-endpoint" class="hash-link" aria-label="7.8.1. Endpoint的直接链接" title="7.8.1. Endpoint的直接链接">​</a></h4><p>被 selector 选中的 Pod，就称为 Service 的 Endpoints</p><blockquote><p>它维护着 Pod 的 IP 地址，只要服务中的 Pod 集合发生更改，Endpoints 就会被更新</p></blockquote><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># check list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get endpoints</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="782-多端口">7.8.2. 多端口<a href="#782-多端口" class="hash-link" aria-label="7.8.2. 多端口的直接链接" title="7.8.2. 多端口的直接链接">​</a></h4><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 本 Service 的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">k8s    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 多端口时必须配置 name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># (被 Service 代理的)容器端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">nodePort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">31000</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 节点端口，范围固定 30000 ~ 32767</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">other</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">nodePort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">32000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>K8S 的结构可以大致分为 3 层，Node, Pod, Container, 为了保护 Container 里面的应用，各层都进行了隔离。为了能够访问到 Pod 里面的 Container, Service 定义了几种 Port 类型：</p><ul><li><p>Port - exposes the Kubernetes service on the specified port within the cluster. Other pods within the cluster can communicate with this server on the specified port.</p><p>是暴露在集群内部 Ip 上的端口, 提供集群内部访问 service 的入口, 即 <code>clusterIP:port</code></p><p>这时的 service 类型即 clusterIp 类型 (k8s 默认的 service type), 仅仅能在内部互相访问</p></li><li><p>TargetPort - is the port on which the service will send requests to, that your pod will be listening on. Your application in the container will need to be listening on this port also.</p><p>即 Pod / Container 监听的 Port.</p></li><li><p>NodePort - exposes a service externally to the cluster by means of the target nodes IP address and the NodePort. </p><p>NodePort is the default setting if the port field is not specified.</p><p>暴露端口到节点，可以让外网能够访问到 Pod/Container.</p><p>范围固定 30000 ~ 32767</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="783-clusterip-默认使用的类型">7.8.3. ClusterIP (默认使用的类型)<a href="#783-clusterip-默认使用的类型" class="hash-link" aria-label="7.8.3. ClusterIP (默认使用的类型)的直接链接" title="7.8.3. ClusterIP (默认使用的类型)的直接链接">​</a></h4><p>Service 的默认类型，自动分配一个仅Cluster内部可以访问的虚拟IP, 通过 kubernetes 集群的内部 IP 暴露服务</p><blockquote><p>当我们只需要让集群中运行的其他应用程序访问我们的 pod 时，就可以使用这种类型的 Service</p></blockquote><p><img loading="lazy" src="/assets/images/k8s_service_clusterip-e86739dbbf5a24827a7c8a13cadbe0ec.png" width="1306" height="976" class="img_ev3q"></p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">clusterip</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional, 默认就是这样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># associate with pods by using the label selector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 当前 service 在集群内部暴露的端口, 即集群内部其他client通过这个端口访问当前 service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)">#  指定当前 service 管理的 pod 上的端口(与制作容器时暴露的端口一致（即DockerFile中的EXPOSE）)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 从port/nodePort上来的数据，经过kube-proxy流入到后端pod的targetPort上，最后进入容器。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7831-headless">7.8.3.1. Headless<a href="#7831-headless" class="hash-link" aria-label="7.8.3.1. Headless的直接链接" title="7.8.3.1. Headless的直接链接">​</a></h5><p>service type 还是 clusterIP, 但是 clusterIp 设置为 None 就变成 Headless 了，不会再分配 IP </p><blockquote><p>适合数据库</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="784-nodeport">7.8.4. NodePort<a href="#784-nodeport" class="hash-link" aria-label="7.8.4. NodePort的直接链接" title="7.8.4. NodePort的直接链接">​</a></h4><p>在ClusterlP基础上为Service在每台机器上绑定一个端口，这样就可以在 cluster 外部通过<code>&lt;NodeIP&gt;:NodePort </code>来访问该服务</p><blockquote><p>比如外部用户要访问 k8s 集群中的一个 Web 应用，那么我们可以配置对应 service 的 type=NodePort，nodePort=30001。其他用户就可以通过浏览器 http://node:30001 访问到该 web 服务。</p><p>而数据库等服务可能不需要被外界访问，只需被内部服务访问即可，那么我们就不必设置 service 的 NodePort。</p></blockquote><blockquote><p>但是 node port 数量是有限的, 六万多个吧, 如果都用这种方式暴露服务给集群外部访问, 总有用完的时候, 这是需要 ingress</p></blockquote><p>NodePort 服务会路由到自动创建的 ClusterIP 服务。</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> NodePort            // 配置NodePort，外部流量可访问k8s中的服务</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 30080             // 服务访问端口，集群内部访问的端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 80          // pod控制器中定义的端口（即 container 定义中的端口）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nodePort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 30001         // NodePort，外部客户端访问的端口</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> 范围固定 30000 ~ 32767</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="785-loadbalancer">7.8.5. LoadBalancer<a href="#785-loadbalancer" class="hash-link" aria-label="7.8.5. LoadBalancer的直接链接" title="7.8.5. LoadBalancer的直接链接">​</a></h4><p>在NodePort的基础上，创建一个外部负载均衡器, 将请求转发到内部 Service 上; 需要第三方负载均衡服务来实现，可以是软件的也可以是硬件的。</p><blockquote><p>一般是使用云提供商的负载均衡器向外部暴露服务。 这个外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上.</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="786-externalname">7.8.6. ExternalName<a href="#786-externalname" class="hash-link" aria-label="7.8.6. ExternalName的直接链接" title="7.8.6. ExternalName的直接链接">​</a></h4><p>此类型的Service节点会将所有流量直接转发到某个预定义的外部服务。</p><blockquote><p>通常情况下，在集群内使用ExternalName Service类型，将某个外部服务作为集群内部服务的别名来使用，使得内部服务使用起来更加方便和简单</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="787-手动端口转发">7.8.7. 手动端口转发<a href="#787-手动端口转发" class="hash-link" aria-label="7.8.7. 手动端口转发的直接链接" title="7.8.7. 手动端口转发的直接链接">​</a></h4><p><code>kubectl port-forward</code>, 用于临时调试</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="788-service-如何工作">7.8.8. service 如何工作<a href="#788-service-如何工作" class="hash-link" aria-label="7.8.8. service 如何工作的直接链接" title="7.8.8. service 如何工作的直接链接">​</a></h4><p>Pod 通过 label 键值对与 Service 上的 label selector 相关联。Service 会自动发现带有与选择器匹配的标签的新 Pod。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="79-ingress">7.9. ingress<a href="#79-ingress" class="hash-link" aria-label="7.9. ingress的直接链接" title="7.9. ingress的直接链接">​</a></h3><p>可为 Service 提供外部可访问的域名绑定(默认端口 80, 通过域名进行流量转发)、负载均衡、 SSL/TLS </p><blockquote><p>和 Service 区别:
service 毕竟只是内部使用的负载均衡, 无法提供给外界访问; Service 工作在网络传输层, 只能识别 ip 和端口来处理网络流量
ingress 则用于将外部网络流量路由到适当的Service上; ingress 工作在应用层, 能识别 http协议, 更细的路由控制</p></blockquote><blockquote><p>为什么需要? - NodePort的方式有个问题，每个 working node 端口65535个，总有用完的时候，要是暴露的服务特别多，65535就不够用了，所以还是得上nginx这样的反向代理，因此K8S还有个Ingress的东西。避免了对外暴露集群节点端口</p></blockquote><p>可以根据域名、路径把请求转发到不同的 Service, 相当于 nginx</p><p>常用的实现是 nginx-ingress, kong-ingress, Traefik Ingress; k8s 也只是定义了 ingress 资源的各个属性，ingress 资源的创建需要借助 ingressController，ingressController 则需要有第三方服务来提供。</p><blockquote><p>原理: Ingress Contronler 通过与 Kubernetes API 交互，动态的去感知集群中 Ingress 规则变化，然后读取它，按照自定义的规则，规则就是写明了哪个域名对应哪个 service，生成一段 Nginx 配置，再写到 Nginx-ingress-control 的 Pod 里，这个 Ingress Contronler 的 pod 里面运行着一个 nginx 服务，控制器会把生成的 nginx 配置写入/etc/nginx.conf 文件中，然后 reload 一下 使用配置生效。以此来达到域名分配置及动态更新的问题。</p></blockquote><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># We are defining this annotation to prevent nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># from redirecting requests to `https` for now 关闭 https 连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /hello</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">pathType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">clusterip</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">pathType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">clusterip</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">4000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>支持这些命令</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># create</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f ingress.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get ingress </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="791-install-ingress-nginx">7.9.1. install ingress-nginx<a href="#791-install-ingress-nginx" class="hash-link" aria-label="7.9.1. install ingress-nginx的直接链接" title="7.9.1. install ingress-nginx的直接链接">​</a></h4><p><a href="https://docs.rancherdesktop.io/zh/how-to-guides/setup-NGINX-Ingress-Controller" target="_blank" rel="noopener noreferrer">https://docs.rancherdesktop.io/zh/how-to-guides/setup-NGINX-Ingress-Controller</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="792-traefik">7.9.2. Traefik<a href="#792-traefik" class="hash-link" aria-label="7.9.2. Traefik的直接链接" title="7.9.2. Traefik的直接链接">​</a></h4><p>todo Traefik</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="710-volume">7.10. volume<a href="#710-volume" class="hash-link" aria-label="7.10. volume的直接链接" title="7.10. volume的直接链接">​</a></h3><p>即在 pod 中可访问的文件目录, 用来存储大数据量的内容</p><p>每个 Pod 中声明的存储卷由 Pod 中的所有容器共享</p><blockquote><p>可被挂载到 pod 中的一个/多个 container 的指定路径 下</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="711-secret">7.11. secret<a href="#711-secret" class="hash-link" aria-label="7.11. secret的直接链接" title="7.11. secret的直接链接">​</a></h3><p>Secret 是用来保存和传递密码</p><blockquote><p>好处是可以避免把敏感信息明文写在配置文件里</p></blockquote><p>Secret 的资源定义和 ConfigMap 结构基本一致，唯一区别在于 kind 是 Secret，还有 Value 需要 Base64 编码</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">echo &quot;db_password&quot; | base64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ZGJfcGFzc3dvcmQK</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">echo &quot;ZGJfcGFzc3dvcmQK&quot; | base64 -d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># db_password</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>for example:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hellok8s-secret.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">DB_PASSWORD</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;ZGJfcGFzc3dvcmQK&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从中查询信息:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl get secret my-mongo-mongodb -o json</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get secret my-mongo-mongodb -o yaml &gt; secret.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="712-config-map">7.12. config map<a href="#712-config-map" class="hash-link" aria-label="7.12. config map的直接链接" title="7.12. config map的直接链接">​</a></h3><p>将非机密性的数据保存到键值对中</p><blockquote><p>用docker的时候有一个volume可以把宿主机的存储挂载到容器中，在k8s里也差不多，但是有两种场景:</p><p>挂载配置文件. 在 docker 里给应用进行配置, 可以使用 env环境变量传到容器里. 还有一种是通过配置文件挂载到容器里面。用环境变量的方式还好说，k8s也提供了env变量，但是配置多了env管理起来不方便，还是配置文件好。
但是k8s有的服务Pod可能部署在多台机器, 所以 configMap 出现了, 可以和 微服务的配置中心类比 (这两者的区别在于ConfigMap是直接把中心化的配置映射到各个容器内，让容器内的应用感觉像是读本地的文件一样，而配置中心是需要应用层搞一个客户端与配置中心通信拉取配置给SpringCloud用)</p><p>挂载数据存储, 这个请看数据持久化</p></blockquote><p>ConfigMap 在设计上不是用来保存大量数据的。在 ConfigMap 中保存的数据不可超过 1 MiB。如果你需要保存超出此尺寸限制的数据，你可能考虑挂载存储卷。</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hellok8s-config-dev.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">DB_URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;http://DB_ADDRESS_DEV&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hellok8s-config-test.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">DB_URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;http://DB_ADDRESS_TEST&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>分别在 dev test 两个 namespace 下创建相同的 ConfigMap，名字都叫 hellok8s-config，但是存放的 Pair 对中 Value 值不一样</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f hellok8s-config-dev.yaml -n dev</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f hellok8s-config-test.yaml -n test </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check list in all ns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get configmap --all-namespaces</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 pod 部署中使用 configMap</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> guangzhengli/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># used to declare an env var</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_URL   </span><span class="token comment" style="color:rgb(0, 128, 0)"># the value have to consist with code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># specify that getting db_url from the specified config map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">configMapKeyRef</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># config map 的name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_URL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="713-flannel">7.13. flannel<a href="#713-flannel" class="hash-link" aria-label="7.13. flannel的直接链接" title="7.13. flannel的直接链接">​</a></h3><p>是 CoreOS 团队针对 Kubernetes 设计的一个网络规划服务, 简单来说, 它的功能是让集群中的不同节点主机创建的 Docker 容器都具有全集群唯一的虚拟 IP 地址, 让属于不同节点上的容器能够直接通过内网 IP 互通</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="714-name">7.14. name<a href="#714-name" class="hash-link" aria-label="7.14. name的直接链接" title="7.14. name的直接链接">​</a></h3><p>由于 K8S 内部,使用“资源”来定义每一种逻辑概念(功能)故每种&quot;资源”, 都应该有自己的&quot;名称”</p><p>&quot;资源”有 api 版本( apiVersion )类别( kind )、元数据( metadata)、定义清单( spec)、状态( status )等配置信息</p><p>&quot;名称”通常定义在&quot;资源”的&quot;元数据”信息里</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="715-name-namespace-用来划分多环境">7.15. name namespace (用来划分多环境)<a href="#715-name-namespace-用来划分多环境" class="hash-link" aria-label="7.15. name namespace (用来划分多环境)的直接链接" title="7.15. name namespace (用来划分多环境)的直接链接">​</a></h3><p>可以使用 namespace 划分出多个“虚拟集群”，这些 ns 之间可以完全隔离, 例如 dev 环境给开发使用，test 环境给 QA 使用</p><blockquote><p>也可以跨 ns，让一个 ns 中的 service 访问到其他 ns 的服务</p><p> 名字空间作用域仅针对带有名字空间的对象，例如 Deployment、Service 等。</p></blockquote><p>namespace: isolate all all kinds of resources. resources of the same kind cannot have the same name in the same namespace</p><p>default initialized namespaces: default, kube-system, kube-public</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># create</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f namespaces.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get namespaces          </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># specify the namespace when creating resources</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f deployment.yaml -n dev</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check pods in specified ns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods -n dev</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建命名空间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl create namespace testapp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 切换命名空间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubens kube-system</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 回到上个命名空间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubens -</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 切换集群</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectx minikube</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8-垃圾回收">8. 垃圾回收<a href="#8-垃圾回收" class="hash-link" aria-label="8. 垃圾回收的直接链接" title="8. 垃圾回收的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="81-级联删除">8.1. 级联删除<a href="#81-级联删除" class="hash-link" aria-label="8.1. 级联删除的直接链接" title="8.1. 级联删除的直接链接">​</a></h3><p>所有者删除，从属对象也被删除；</p><p>分为前台级联删除 Foreground 和后台级联删除 Background 模式；</p><ul><li><p>Foreground 前台级联删除：所有从属对象删除完毕后删除所有者对象；当所有者删除时会进入“正在删除”状态，仍可以通过 RestApi 查询到当前对象；</p></li><li><p>Background 后台级联删除： 立即删除所有者的对象，并由垃圾回收器在后台删除其从属对象 ； 不用等待删除从属对象的时间；</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="82-孤儿删除-orphan">8.2. 孤儿删除 orphan<a href="#82-孤儿删除-orphan" class="hash-link" aria-label="8.2. 孤儿删除 orphan的直接链接" title="8.2. 孤儿删除 orphan的直接链接">​</a></h3><p>所有者删除，从属对象变成孤儿</p><blockquote><p>直接删除所有者对象，并将从属对象中的 ownerReference 元数据设置为默认值。之后垃圾回收器会确定孤儿对象并将其删除；</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9-资源描述文件">9. 资源描述文件<a href="#9-资源描述文件" class="hash-link" aria-label="9. 资源描述文件的直接链接" title="9. 资源描述文件的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="91-查看属性说明">9.1. 查看属性说明<a href="#91-查看属性说明" class="hash-link" aria-label="9.1. 查看属性说明的直接链接" title="9.1. 查看属性说明的直接链接">​</a></h3><p>如 当前 k8s 支持的 apiVersion ...</p><p><code>kc explain deployment</code> , <code>kc explain deployment.spec.template.spec</code></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92-通过命令生成-yml">9.2. 通过命令生成 yml<a href="#92-通过命令生成-yml" class="hash-link" aria-label="9.2. 通过命令生成 yml的直接链接" title="9.2. 通过命令生成 yml的直接链接">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl create deployment tomcat6 --image=tomcat:6.0.53-jre8 --dry-run -o yaml &gt; tomcat6.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f xxx.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="93-pod-的-yaml-描述文件">9.3. pod 的 yaml 描述文件<a href="#93-pod-的-yaml-描述文件" class="hash-link" aria-label="9.3. pod 的 yaml 描述文件的直接链接" title="9.3. pod 的 yaml 描述文件的直接链接">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1 </span><span class="token comment" style="color:rgb(0, 128, 0)">#(k8s api server version)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Deployment、Job、Ingress、Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod </span><span class="token comment" style="color:rgb(0, 128, 0)">#(对象类型)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">#包括名称、命名空间、标签和关于该容器的其他信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">manual</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional, default ns: default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">xxx_key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">yyy_key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> yyy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 包括一些container，storage，volume, 探针...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPost</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 容器会监听的端口, 仅仅是展示, 没有 指定作用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">protocal</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 100m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 100Mi</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 存活探针， 用于 pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在生产中 运行的pod, 一定 要定义 一 个存 活探针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#   optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果没有设置初始延迟，探针将在启动时立即开始探测容器， 这通常会导致探测失败， 因为应用程序还没准备好开始接收请求。 如果失败次数超过阅值，在应用程序能正确响应请求之前， 容器就会重启。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">initialDelaySeconds</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在第一次探测前， 等待 15s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">delay</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 示在容器启动后立即开始探测。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 容器必须在1秒内进行响应， 不然这次探测记作失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">period</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每10秒探测一次容器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">failure</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 探测连续三次失败(#fa辽ure= 3)后重启容器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">status</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">#包含运行中的 po 的当前信息，例如 po 所处的条件 每个容器的描述和状态，以及内部 IP 和其他基本信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94-deployment-的描述文件">9.4. deployment 的描述文件<a href="#94-deployment-的描述文件" class="hash-link" aria-label="9.4. deployment 的描述文件的直接链接" title="9.4. deployment 的描述文件的直接链接">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">## optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">nodeSelector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">gpu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;true&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">#使用 标签选择器使得 pod 只被调度到符合要求的 worker node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># select pods that will be affected by this deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># have to match labels that specified in template.metadata.labels</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># tells deployment to run 2 pods matching the template</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># define pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">alpine</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="95-service">9.5. service<a href="#95-service" class="hash-link" aria-label="9.5. service的直接链接" title="9.5. service的直接链接">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> LoadBalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10-注解">10. 注解<a href="#10-注解" class="hash-link" aria-label="10. 注解的直接链接" title="10. 注解的直接链接">​</a></h2><p>注解: TODO</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-命名空间">11. 命名空间<a href="#11-命名空间" class="hash-link" aria-label="11. 命名空间的直接链接" title="11. 命名空间的直接链接">​</a></h2><p>K8S namespace: 为 对象资源提供了一个作用域, 在不同的 作用域中可以使用相同的资源名， 但这相同的资源名代表了不同的资源。 类比 java package</p><ul><li><p>通过 label 对 pod 进行分组, 每个 组 可能有 pod 重叠, 通过 k8s namespace 分组可以完全避免重叠</p></li><li><p>ns 只隔离资源， 不隔离运行的对象 （资源实例）， 如 不同 ns 中的 pod 仍然可通信</p></li><li><p>适用于多用户 使用 k8s， 限制某个用户的资源使用量</p></li></ul><p>从 ymal 文件创建 ns：</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> custome</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">ns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>kubectl create -f custom-ns.yaml</code></p><p>通过命令创建 ns： <code>kubectl create namespace custom-namespace</code></p><p>切换 ns： <code>kubectl config set-context $(kubectl config current-context) --namespace &lt;other ns&gt;</code></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-pod-管理">12. pod 管理<a href="#12-pod-管理" class="hash-link" aria-label="12. pod 管理的直接链接" title="12. pod 管理的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="121-探测-pod-是否健康">12.1. 探测 pod 是否健康<a href="#121-探测-pod-是否健康" class="hash-link" aria-label="12.1. 探测 pod 是否健康的直接链接" title="12.1. 探测 pod 是否健康的直接链接">​</a></h3><p>k8s 会保持 pod 始终正常运行， 如果容器的主进程崩溃， Kubelet 将重启容器。 当容器被强行终止时，会创建一个全新的容器—-而不是重启原来的容器</p><p>但是 进程没有崩溃， 有时应用程序也会停止正常工作。 例如， 具有内存泄漏的 Java 应用程序将开始抛出 OutOfMemoryErrors, 但 JVM 进程会一直运行</p><ul><li><p>方法 1: 从 app 内部自己检测, 可以在应用中捕获这类错误， 并在错误发生时退出该进程。</p><p>存在问题: 应用因为无限循环或死锁而停止响应, 这个方法就无效了</p></li><li><p>方法 2: 须从外部检查应用程序的运行状况</p><ul><li><p>存活探针 (liveness probe) - 检查容器是否还在运行</p><ul><li><p>HTTP GET 探针, 返回 2xx, 3xx 则代表正常, 不重启</p></li><li><p>TCP 套接字探针, 和 pod 正常建立 链接, 正常, 不重启</p></li><li><p>Exec 探针 , 进入 pod 某个 container, 执行任意命令, 并检查命令的退出状态码。如果状态码是 0, 则探测成功</p></li></ul></li></ul></li></ul><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> custome</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="122-pod-副本">12.2. pod 副本<a href="#122-pod-副本" class="hash-link" aria-label="12.2. pod 副本的直接链接" title="12.2. pod 副本的直接链接">​</a></h3><p>ReplicationController 是一种 Kubernetes 资源，负责创建和管理 pod 副本</p><p>被 ReplicationController 创建的 pod 为 “托管 pod”， 直接创建的 pod 为 “非托管 pod”。托管 pod 异常退出 （如 worker node 崩溃， 或 该 pod 崩溃）后， ReplicationController 会 创建新的 pod 代替</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Replicationcontroller</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义ReplicationController时不要指定 选择器，让Kubemetes从pod模板中提取它。这样YAML更简短。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># rc 创建后， label selector 不会再更改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 一般创建后会更改 template</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 创建新 pod 所用的 模板</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这里的 标签必须和 前面的 标签选择器 匹配， 否则将无休止地创建新的容器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> luksa/kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>kubectl create -f kubia-rc.yaml</p><p>rc 创建后，由于没有任何 pod 有 app=kubia 标签， ReplicationController 会根据 pod 模板启动三个新的 pod</p><p>由 ReplicationController 创建的 pod 并不是绑定到 ReplicationController。 在任何时刻， ReplicationController 管理与标签选择器匹配的 pod。 通 过更改 pod 的标签， 可以将它 从 ReplicationController 的作用域中添加或删除</p><p>尽管一个 pod 没有绑定到一个 ReplicationController ，但 pod 在 metadata.ownerReferences 中引用它 以轻松使用它 来找到一 pod 的 Replication controller</p><p>升级 pod 可以这么做：编辑 rc 的 template 后， 删除 所有要升级的 pod， rc 会自动创建升级后的 pod</p><p>================水平缩扩容：</p><p>方法 1：<code>kubectl scale re kubia --replicas=3 </code></p><p>方法 2：<code>kubectl edit re kubia</code> 更新 <code>spec.replicas</code> 值</p><p>======================新的替代者 ReplicaSet</p><p>ReplicaSet：ReplicaSet 的行为与 ReplicationController 完全相同， 但标签选择器的表达能力更强。</p><ul><li>单个 rc 无法将 pod 与 （ label env=prod 和 env=dev ） 同时匹配，它只能匹配带有 env=devel 标签的 pod 或带有 env=dev 标签的 pod</li><li>rs 可以仅仅根据 是否有 label key 存在 来匹配</li></ul><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1beta2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ReplicaSet</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定了多个表达式，则所有这些表达式都必须为true才能使选择器与</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># pod匹配。如果同时指定matchLabels和matchExpressions, 则所有标签都</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 必须匹配，并且所有表达式必须计算为true以使该pod与选择器匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">hah</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hoo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hah </span><span class="token comment" style="color:rgb(0, 128, 0)"># 要求 pod 包含 key 为 hah 的 label</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 要求 label 值为 hoo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># operator 可选 In (label 值需要匹配 value 中的一个), NotIn （label 值需要不在 values 中），Exists （label 必须有指定 key，不指定 values）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># DoesNotExist （pod不得包含有指定名称的标签。values属性不得指定）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> In</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">values</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> hoo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 创建新 pod 所用的 模板</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这里的 标签必须和 前面的 标签选择器 匹配， 否则将无休止地创建新的容器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">hah</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hoo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> luksa/kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>================ DaemonSet 在每个 worker node 上部署一个 pod</p><p>用来运行系统服务，如 kube-proxy</p><p>DaemonSet 管理下的 pod 不是随机分布在 worker node 上， 而是保证 每个 node 只存在一个 pod。</p><p>若 node 下线， DaemonSet 不会在其他地方创建新的 pod， 但是当某个 node 的 pod 被意外删除，会重新创建新的 pod 代替</p><p>但是 当新的 node 添加进 集群， DaemonSet 会立即部署一个新 pod 到这个 node。</p><p>通过 <code>spec.nodeSelector</code> (节点选择器，原理是给 node 打标签) 只在特定 node 部署 pod</p><p>======================= Deployment ======= 更加方便的管理 Replica Set</p><p>Deployment 额外的特性：</p><ul><li><p>事件，状态查看：可以查看 Deployment 的升级详细进度和状态</p></li><li><p>回滚：当升级 pod 镜像或者相关参数的时候发现问题，可以使用回滚操作回滚到上一个稳定的版本或者指定的版本</p></li><li><p>版本记录: 每一次对 Deployment 的操作，都能保存下来，给予后续可能的回滚使用</p></li><li><p>暂停和启动：对于每一次升级，都能够随时暂停和启动</p></li><li><p>多种升级方案：</p><p>Recreate：删除所有已存在的 pod,重新创建新的;</p><p>RollingUpdate：滚动升级，逐步替换的策略，同时滚动升级时，支持更多的附加参数，例如设置最大不可用 pod 数量，最小升级间隔时间等等。</p></li></ul><p>================= HPA 弹性伸缩 根据资源的使用情况自动缩扩容</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="123-运行单个任务-job">12.3. 运行单个任务 Job<a href="#123-运行单个任务-job" class="hash-link" aria-label="12.3. 运行单个任务 Job的直接链接" title="12.3. 运行单个任务 Job的直接链接">​</a></h3><p>到目前为止， 我们只谈论了需要持续运行的 pod， 这些 pod 由 rc， rs， ds 管理。 你会遇到只想运行完成工作后就终止任务的清况， 这种 pod 由 Job 管理</p><p>该 pod 在内部进程成功结束时， 不重启容器。一旦任务完成， pod 就被认为处千完成状态</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> batch/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ba七ch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">completions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 顺序运行 5 个 pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">parallelism</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># 最多可以 2 个 pod 并行运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">120</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># job 超时时间，若 pod 超时还没结束，系统将终止 pod， 标记 job 为失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">backOffLimit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># job 标记为失败前的重试次数， 默认 6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># Job 的 pod 选择器 将自动根据这里的 labels 创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> batch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 重启策略， 指定 容器中进程结束后， k8s 做什么</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不能是 默认的 Always</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这里 Never 亦可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> luksa/batch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="124-定时任务-cronjob">12.4. 定时任务 CronJob<a href="#124-定时任务-cronjob" class="hash-link" aria-label="12.4. 定时任务 CronJob的直接链接" title="12.4. 定时任务 CronJob的直接链接">​</a></h3><p>TODO</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-pod-通信">13. pod 通信<a href="#13-pod-通信" class="hash-link" aria-label="13. pod 通信的直接链接" title="13. pod 通信的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="131-proxy">13.1. proxy<a href="#131-proxy" class="hash-link" aria-label="13.1. proxy的直接链接" title="13.1. proxy的直接链接">​</a></h3><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="132-service">13.2. Service<a href="#132-service" class="hash-link" aria-label="13.2. Service的直接链接" title="13.2. Service的直接链接">​</a></h3><p>pods 有自己的内部地址, 但是无法从 cluster 外部访问, 通过 service 可以暴露到 cluster 外部</p><p>service 是一个逻辑结构, 定义一系列 pods, 以及他们的访问策略(通过类型指定)</p><ul><li>ClusterIP (default): 只能在 cluster 内部访问到 service</li><li>NodePort: 外部可以使用 <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code> 访问 service</li><li>LoadBalancer: 给 service 分配一个静态 ip, 可以负载均衡多个 pods</li><li>ExternalName: 通过随机名字访问 service (可通过 externalName 在配置中指定). This type requires v1.7 or higher of kube-dns.</li></ul><p>a default service named kubernetes will be created with type ClusterIP</p><p>可以定义配置文件, 指定标签选择器, 选择包含哪些 pods</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="133-pod-间通信">13.3. pod 间通信<a href="#133-pod-间通信" class="hash-link" aria-label="13.3. pod 间通信的直接链接" title="13.3. pod 间通信的直接链接">​</a></h3><p>Service</p><p>作用：</p><ul><li>服务的主要目标就是使集群内部的其他 pod 可以访问当前这组 pod</li><li>对外暴露服务</li></ul><p>如何创建？</p><p>方式 1：<code>kubectl expose rc kubia --type=LoadBalancer --name kubia-http</code></p><p>方式 2：通过 <code>kubectl create -f xxx-service.yml</code></p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 配置会话亲和性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 特定客户端产生的所有请求每次都指向同 一个 pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 还可选 None， 默认值。不支持 cookie</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">sessionAffinity</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ClientIP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># service 的可用端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 可以引用 Pod 中 的 port name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># service将链接转发到 容器的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不是必须， 多端口映射必须</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>多端口映射</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 配置会话亲和性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 特定客户端产生的所有请求每次都指向同 一个 pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 还可选 None， 默认值。不支持 cookie</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">sessionAffinity</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ClientIP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># service 的可用端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># service将链接转发到 容器的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> yyy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如何发现 service</p><ul><li><p>通过环境变量发现服务</p><p>每个 pod 内会有环境变量表示 Service ip （<code>&lt;pod name&gt;_SERVICE_HOST</code>）， port (<code>&lt;pod name&gt;_SERVICE_PORT</code>)</p></li><li><p>通过 dns</p><p>kube-system ns 中有个 pod 为 kube-dns，就是 dns server。在集群 中的其他 pod 都被配置成使用其作为 dns ( Kubemetes 通过修改容器的 /etc/resolv.conf 实现）。运行在 pod 上的进程 DNS 查询都会被 Kubemetes 自身的 DNS 务器响应</p><p>pod 是否使用内部的 DNS 服务器是根据 pod 的 spec.dnsPolicy 属性来决定的</p></li><li><p>通过 FQDN （全限定域名） 连接服务</p><p><code>curl http://kubia.default.svc.cluster.local </code></p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="134-通过-service-连接外部服务">13.4. 通过 Service 连接外部服务<a href="#134-通过-service-连接外部服务" class="hash-link" aria-label="13.4. 通过 Service 连接外部服务的直接链接" title="13.4. 通过 Service 连接外部服务的直接链接">​</a></h3><p>pod 如何访问 k8s 外部 服务？</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1341-通过手动生成-endpoint">13.4.1. 通过手动生成 endpoint<a href="#1341-通过手动生成-endpoint" class="hash-link" aria-label="13.4.1. 通过手动生成 endpoint的直接链接" title="13.4.1. 通过手动生成 endpoint的直接链接">​</a></h4><p>Service 和 pod 中间不是直接相连， 而是插着 Endpoint，就是一个 ip:port 列表，在创建 Service 时 根据 该服务的 label selector 产生</p><p>如果 Service 没有指定 pod selector， 就不会自动生成 endpoints，需要手动生成，这时可以指定地址为任意 外部的 ip：</p><p>demo-service.yml:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 没有配置 selector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 将接收端口80上的传入连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>demo-service-endpoints.yml</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Endpoints</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># Endpoint的名称必须和 service 的名称相同</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">subsets</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># Service将把请求重定向到 下面的 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">addresses</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 11. 11. 11. 11</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> 22.22.22.22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果稍后决定将 外部服务迁移到 Kubemetes 中运行的 pod, 可以为服务添加选择器，从而对 Endpoint 进行自动管理</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1342-通过-externalname-类型的-service">13.4.2. 通过 externalName 类型的 Service<a href="#1342-通过-externalname-类型的-service" class="hash-link" aria-label="13.4.2. 通过 externalName 类型的 Service的直接链接" title="13.4.2. 通过 externalName 类型的 Service的直接链接">​</a></h4><p>另外的方式来访问外部服务：创建 ExtemalName 类型的 Service</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> external</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 默认为 ClusterIP，只能 pod 间通信</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 还有很多种 type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ExternalName</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">externalName</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> someapi.somecompany.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后在 pod 中通过 <code>external-service[.default.svc.cluster.local]</code> 访问 someapi.somecompany.com</p><p>在以后如果将其指向不同的服务，只需简单地修改 externalName 属性，或者将类型重新变回 ClusterIP 并为服务创建 Endpoint</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="135-将服务暴露给外部">13.5. 将服务暴露给外部<a href="#135-将服务暴露给外部" class="hash-link" aria-label="13.5. 将服务暴露给外部的直接链接" title="13.5. 将服务暴露给外部的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1351-将服务的类型设置成-nodeport">13.5.1. 将服务的类型设置成 NodePort<a href="#1351-将服务的类型设置成-nodeport" class="hash-link" aria-label="13.5.1. 将服务的类型设置成 NodePort的直接链接" title="13.5.1. 将服务的类型设置成 NodePort的直接链接">​</a></h4><p>每个集群节点都会在节点上打开一个端口(端口号相同)。并将传入的连接转发给 pod</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">nodeport</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 通过 集群任意节点的 30123 端口可以访问 这个 service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果不指定，Kubernetes将选择一个随机端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">nodePort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">30123</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>worker node ip 如何获取：<code>kubectl get nodes -o jsonpath=&#x27;...&#x27;</code></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1352-将服务的类型设置成-loadbalance">13.5.2. 将服务的类型设置成 LoadBalance<a href="#1352-将服务的类型设置成-loadbalance" class="hash-link" aria-label="13.5.2. 将服务的类型设置成 LoadBalance的直接链接" title="13.5.2. 将服务的类型设置成 LoadBalance的直接链接">​</a></h4><p>NodePort 类型的一 种扩展, 在 client 和 worker node 间 放了一个 LoadBalancer， 防止节点单点故障</p><p>负载均衡器拥有自己独一无二的可公开访问的 IP 地址， 并将所有连接重定向到服务。可以通过负载均衡器的 IP 地址访问服务</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">me七adata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">loadbalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> LoadBalancer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 仅将外部通信重定向到接收连接的节点上运行的pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果没有本地pod存在， 则连接将挂起。因此， 需要确保负载平衡器将连接转发给至少具有一个pod的节点。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 可避免额外的网络跳转。但是可能会导致跨节点的 pod 的负载分布不均衡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Local </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">portS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1353-创建一-个-ingress-资源">13.5.3. 创建一 个 Ingress 资源<a href="#1353-创建一-个-ingress-资源" class="hash-link" aria-label="13.5.3. 创建一 个 Ingress 资源的直接链接" title="13.5.3. 创建一 个 Ingress 资源的直接链接">​</a></h4><p>通过一 个 IP 地址公开多个服务，它运行在 HTTP 层（网络协议第 7 层）上， 因此可以提供比工作在第 4 层的服务更多的功能</p><p>为什么需要 Ingress：每个 LoadBalancer 服务都需要自己的负载均衡器，每个 loadbalancer 都需要自己的 ip， 而 Ingress 只需要一个公网 IP 就能为许多服务提供访问</p><p>当客户端向 Ingress 发送 HTTP 请求时， Ingress 会根据请求的主机名和路径决定请求转发到的服务。</p><p>Ingress 工作在 应用层 基于 cookie 的会话亲和性 (session affinity)</p><p>已经确认集群中正在运行 Ingress 控制器， 因此现在可以创建一个 Ingress 资源：</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> extensions/v1beta1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># Ingress 将这个域名映射到你的 service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia . example.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 将请求发送到  kubia-nodeport 服务的 80 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token key atrule">backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">serviceName</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> kubia</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">nodeport</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">servicePort</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>kubectl get ingresses </code> 获取 Ingress 控制器 内网 ip，配置到 dns server</p><p>为 ingress 创建 tls 认证 TODO</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-命令">14. 命令<a href="#14-命令" class="hash-link" aria-label="14. 命令的直接链接" title="14. 命令的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="141-kubectl">14.1. kubectl<a href="#141-kubectl" class="hash-link" aria-label="14.1. kubectl的直接链接" title="14.1. kubectl的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1411-基本信息">14.1.1. 基本信息<a href="#1411-基本信息" class="hash-link" aria-label="14.1.1. 基本信息的直接链接" title="14.1.1. 基本信息的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubectl version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 获取kube-scheduler和kube-controller-manager组件状态</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get cs # 健康状况</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1412-创建-create-expose">14.1.2. 创建 create expose<a href="#1412-创建-create-expose" class="hash-link" aria-label="14.1.2. 创建 create expose的直接链接" title="14.1.2. 创建 create expose的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># create depend on a spec file.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 和 kubectl apply 区别:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># - create 是创建新资源。这里我们需要注意的是，如果再次运行相同的命令，就会抛出错误，因为资源名称在名称空间中应该是唯一的。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># - apply 使配置在资源上生效, 可能是创建, 也可能是根据资源定义文件更新资源, 可重复执行  (推荐)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl create -f xxx.yml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 递归从 dir 下查找资源定义文件, 并创建</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kc create -R -f &lt;dir&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; deployment,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># dep-name 不能随便设置, 必须符合域名命名规范.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 自动创建的 ReplicaSet 名字为 dep_name + random uuid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 自动创建 pod 名字为 ReplicaSet-name + random uuid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 镜像地址 include the full repository url</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 自动创建 label -&gt; run={dep name}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># auto  create selector -&gt; run={dep name}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl create deployment &lt;dep name&gt; --image=k8s.gcr.io/echoserver:1.4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl create deployment tomcat6 --image=tomcat:6.0.53-jre8 # 不指定 url 前缀, 默认从 docker hub 拉取</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#  pods 默认仅仅能被 同个集群的 pods, service  访问</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建临时的 代理, 可以将外部命令转发到 cluster 内部的 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Ctrl +c 关闭</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查 版本</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">curl http://localhost:8001/version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 访问指定 pod 的服务</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl run &lt;pod name&gt; --image=nginx --restart=Never --port=80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --generator=run/vl  表示同时创建 rc 管理 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl run &lt;pod name&gt; --image=luksa/kubia --port=8080 --generator=run/vl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 从描述文件创建 资源， 可以 pod， rc。。。， 可指定 ns， 默认 default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl create -f kubia-manual.yaml [-n xxx_ns]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建 service, 名字同 deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># The LoadBalancer type makes the Service accessible through the minikube service command</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Port 8080 is specified in image code, so cannot be other port here</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --port : service 暴露在 cluster ip 下的端口, 通过这个端口,  可以在 cluster 内部访问到多个 pod. 通过这个 service 负载均衡了 多个 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --targetPort 容器的端口, 默认=== port, 与制作镜像时暴露的端口一致, 不能随便指定</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --type: service 类型,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#       NodePort: 创建一个 service 并暴露到 cluster 外部, service 的端口还是 --port 指定, 同时 service 有自己的 cluster url, node 会指定一个随机端口映射到 service 的 端口, 若指定了 --nodePort, 就用指定端口映射到 service 端口; 如 type=NodePort，而且配置 nodePort=30001, 那么外部机器 可以 scheme://nodeIP:30001访问到该服务</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#       LoadBalancer:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl expose deployment &lt;dep name&gt; --type=LoadBalancer --port=8080</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查找暴露的随机端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl describe service mywebservice | grep NodePort</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># service port 80 will mapping to random node port ,and this service can be visited by someone outside cluster</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 若扩容, 则在各个有 pod 运行的节点都能通过 node 端口访问  这个 service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl expose deploy tomcat6 --port=80 --target-port=8080 --type=NodePort</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建一个负载均衡服务 service 对象. 可以从外部访问 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># rc 为 replicationController 缩写</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl expose rc &lt;po name&gt; --type=LoadBalancer --name kubia-http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; label</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 语法: kubectl label &lt;obj_type, eg: pod, service&gt; &lt;obj_name&gt; &lt;label, eg: app=v1&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl label pod $POD_NAME app=v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 命名空间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 创建</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config set-context Kubernetes --namespace=beta</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 验证</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config view | grep namespace command</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1413-执行命令到容器-exec">14.1.3. 执行命令到容器 exec<a href="#1413-执行命令到容器-exec" class="hash-link" aria-label="14.1.3. 执行命令到容器 exec的直接链接" title="14.1.3. 执行命令到容器 exec的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 仅有 一个容器在 pod, 无需指定容器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec [-c container_name] $POD_NAME -- env</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 进入 pod 内部随机一个容器 </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec -ti $POD_NAME -- bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1414-修改">14.1.4. 修改<a href="#1414-修改" class="hash-link" aria-label="14.1.4. 修改的直接链接" title="14.1.4. 修改的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 扩容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 指定 replicas 可以缩扩容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ kubectl scale deployments/&lt;dep_name&gt; --replicas=4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl scale deployment.apps/tomcat6 --replicas=2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl scale deployment tomcat6 --replicas=2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 滚动更新</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 更新 image version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ kubectl set image deployments/&lt;dep_name&gt; &lt;dep_name&gt;=jocatalin/kubernetes-bootcamp:v2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 验证更新是否成功</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ kubectl rollout status deployments/kubernetes-bootcamp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 回滚</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 取消之前的部署，这将执行反向操作，将负载移动至之前版本的容器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ kubectl rollout undo deployments/kubernetes-bootcamp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1415-资源列表-get">14.1.5. 资源列表 get<a href="#1415-资源列表-get" class="hash-link" aria-label="14.1.5. 资源列表 get的直接链接" title="14.1.5. 资源列表 get的直接链接">​</a></h4><p>单复数均可</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 所有</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get deployments</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --show-labels 同时显示所有标签。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -A 查看所有 pods, 包括 kube-system 命名空间 下的 pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --all-namespaces 所有空间的 pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods [--show-labels]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -o 输出格式; wide 表示输出文本信息, 列出 ip , 节点 name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -o yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods -o wide</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 通过标签过滤</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods -l &lt;label&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 获取 pod 完整 yaml/json 文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 缩写 po</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po &lt;pod name&gt; -o yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po &lt;pod name&gt; -o json</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 根据模板获取 信息</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">export POD_NAME=$(kubectl get pods -o go-template --template &#x27;{{range .items}}{{.metadata.name}}{{&quot;\n&quot;}}{{end}}&#x27;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template=&#x27;{{(index .spec.ports 0).nodePort}}&#x27;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看 service  的 endpoint 列表</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get endpoints &lt;service name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看所有 svc</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 缩写 svc</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get services</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; ReplicaSet</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get rs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 端口转发， 将会运行一个端口转发代理</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 将 local port 8888 转发到 pod 的 8080</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl port-forward &lt;pod name&gt; 8888:8080</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 标签</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 列出 pods 的所有标签</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get pods --show-labels</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 只列出感兴趣的标签， 标签按照列展示</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -L creation_method,env</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 添加</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl label po &lt;pod name&gt; creation_method=manual</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 修改</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl label po &lt;pod name&gt; creation_method=manual --override</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 标签选择器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 creation_method=manual</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 creation_method!=manual</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 env</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 列出没有 env 的pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 &#x27;!env&#x27;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 选择带有env标签且值为prod或devel的pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 env in (prod, devel)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po -1 env notin (prod, devel)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 使用 label 分类 worker node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl label node &lt;node name&gt; gpu=true # 每个 node 都有一个默认 label， kubernetes.io/hostname:主机名</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get nodes -l gpu=true</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 命名空间</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看所有 ns, 有 default， kube-public， kube-system，默认我们使用的是 default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get ns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 列出只属于该命名空间的 pod, 可使用 -n</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get po --namespace kube-system</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 编辑 rc 的 yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 一般仅仅编辑 rc 的 template， 不动 label selector</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 用来升级 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl edit rc kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 增加 副本数， 水平扩容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl scale rc kubia --replicas=3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 等同 parallelism</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl scale job xxx_job --replicas 3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 远程在 pod 中某个 container 执行命令</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># “--” 表示 kubectl 命令结束， 后面的是在 pod 内执行的</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec &lt;pod name&gt; -- curl -s http://10.23...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 列出环境变量，如 Service 的 ip， 端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec kubia-3inly env</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 在 pod 中执行 shell</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl exec -it kubi-3inly bash</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 配置文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config view</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; 事件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl get events</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 通过 describe 也能得到 object 相关的事件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1416-查询详细描述-describe">14.1.6. 查询详细描述 describe<a href="#1416-查询详细描述-describe" class="hash-link" aria-label="14.1.6. 查询详细描述 describe的直接链接" title="14.1.6. 查询详细描述 describe的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看资源描述， 附加信息， 作为 kubectl get xxx xxx 补充, 可用于排查问题</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 如 pod 是否正在运行， 重启原因， 退出码 137，143 表示 pod 被迫终止</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl describe pods [pod_name]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl describe services/&lt;srv name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># &gt;&gt;&gt; deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ kubectl describe deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1417-查询日志-logs">14.1.7. 查询日志 logs<a href="#1417-查询日志-logs" class="hash-link" aria-label="14.1.7. 查询日志 logs的直接链接" title="14.1.7. 查询日志 logs的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 查指定 pod 下的 container 日志</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 若pod 只有一个 container, 无需指定 container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl logs $POD_NAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl logs -f POD-NAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 需要 ssh 到 pod 所在的 worker node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">docker logs &lt;container_id&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 无需 ssh, 可指定某个 container， 可指定看重启前的版本的日志</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl logs &lt;pod name&gt; [-c container_name] [--previous]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看 k8s 资源</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl explain pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl explain pod.spec</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1418-删除-delete">14.1.8. 删除 delete<a href="#1418-删除-delete" class="hash-link" aria-label="14.1.8. 删除 delete的直接链接" title="14.1.8. 删除 delete的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># delete by spec file</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete -f flask.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 无法直接删除, 只要 replicaSet 没有删除, 删了 po, 还会重现创建 po</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 可直接 通过删除 deployment 删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete po kubia-gpu [pod2 [pod3]]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除当前 ns 下 all pod， 保留 ns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete po --all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 按照标签删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete po -1 creation_method=manual</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete service hello-node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete deployment hello-node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#  删除 ns, 同时会删除 ns 下的所有 pod</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete ns custom-namespace</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除所有资源， 包括 rc， pod， service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete all --all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除 rc， rc 管理的 pods 也会删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete rc &lt;rc name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除 rc， 但是保留 pods</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete rc &lt;rc name&gt; --cascade=false</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete rs kubia</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除所有 pod, deployment, service 资源</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl delete deployment,service --all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1419-操作上下文">14.1.9. 操作上下文<a href="#1419-操作上下文" class="hash-link" aria-label="14.1.9. 操作上下文的直接链接" title="14.1.9. 操作上下文的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 更新上下文, 为当前上下文加上 namespace</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config set-context $(kubectl config current-context) --namespace &lt;other ns&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># check list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config get-contexts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 更换上下文</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl config use-context docker-desktop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="142-kubeadmin">14.2. kubeadmin<a href="#142-kubeadmin" class="hash-link" aria-label="14.2. kubeadmin的直接链接" title="14.2. kubeadmin的直接链接">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">kubeadm init # create a master node</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubeadm join &lt;master_id:port&gt; # add a node to cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="15-cka-ckad-证书考试">15. cka ckad 证书考试<a href="#15-cka-ckad-证书考试" class="hash-link" aria-label="15. cka ckad 证书考试的直接链接" title="15. cka ckad 证书考试的直接链接">​</a></h2><p><a href="https://blog.csdn.net/vic_qxz/article/details/108338442" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/vic_qxz/article/details/108338442</a> <a href="https://zhuanlan.zhihu.com/p/139052135" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/139052135</a> 备考 cka ckad</p><p><a href="https://training.linuxfoundation.cn/certificate/details/1" target="_blank" rel="noopener noreferrer">https://training.linuxfoundation.cn/certificate/details/1</a> 中国区</p><p><a href="https://zhuanlan.zhihu.com/p/138796893" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/138796893</a> <a href="https://www.jianshu.com/p/629525af31c4" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/629525af31c4</a> <a href="https://www.kubernetes.org.cn/peixun" target="_blank" rel="noopener noreferrer">https://www.kubernetes.org.cn/peixun</a> 考试要点 <a href="https://zhuanlan.zhihu.com/p/138796893" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/138796893</a> , <a href="https://www.zhihu.com/zvideo/1302356091591372800" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/zvideo/1302356091591372800</a> 真题</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="16-dashboard">16. dashboard<a href="#16-dashboard" class="hash-link" aria-label="16. dashboard的直接链接" title="16. dashboard的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="161-k9s">16.1. k9s<a href="#161-k9s" class="hash-link" aria-label="16.1. k9s的直接链接" title="16.1. k9s的直接链接">​</a></h3><p><a href="https://k9scli.io/" target="_blank" rel="noopener noreferrer">https://k9scli.io/</a>, 基于 Terminal 的轻量级 UI</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="162-kuboard">16.2. kuboard<a href="#162-kuboard" class="hash-link" aria-label="16.2. kuboard的直接链接" title="16.2. kuboard的直接链接">​</a></h3><p><a href="https://github.com/eip-work/kuboard-press" target="_blank" rel="noopener noreferrer">https://github.com/eip-work/kuboard-press</a> 面板</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="163-kubernetes-dashboard">16.3. kubernetes-dashboard<a href="#163-kubernetes-dashboard" class="hash-link" aria-label="16.3. kubernetes-dashboard的直接链接" title="16.3. kubernetes-dashboard的直接链接">​</a></h3><p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/dashboard</a></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># install</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># start in background</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl proxy &gt;/dev/null &amp;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># create administrator</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/gotok8s/gotok8s/master/dashboard-admin.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># and token</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep kubernetes-dashboard-admin | awk &quot;&#x27;{print $1}&#x27;&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># visit</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="164-kubesphere-推荐">16.4. kubesphere (推荐)<a href="#164-kubesphere-推荐" class="hash-link" aria-label="16.4. kubesphere (推荐)的直接链接" title="16.4. kubesphere (推荐)的直接链接">​</a></h3><p>打通 devops 全套流水线, 对 cluster 要求高 <a href="https://github.com/kubesphere/kubesphere" target="_blank" rel="noopener noreferrer">https://github.com/kubesphere/kubesphere</a></p><p>(kuboard 也行, 对 cluster 要求不高)</p><p><a href="https://www.zhihu.com/question/348609092" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/question/348609092</a> rancher 和 kubesphere 对比</p><p><a href="https://www.bilibili.com/video/BV1cL4y167GV" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1cL4y167GV</a> 视频教程</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="17-rancher">17. rancher<a href="#17-rancher" class="hash-link" aria-label="17. rancher的直接链接" title="17. rancher的直接链接">​</a></h2><p>部署和管理 k8s 集群</p><p><a href="https://docs.rancher.cn/" target="_blank" rel="noopener noreferrer">https://docs.rancher.cn/</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="18-harbor">18. Harbor<a href="#18-harbor" class="hash-link" aria-label="18. Harbor的直接链接" title="18. Harbor的直接链接">​</a></h2><p>Harbor 是由 VMware 公司中国团队为企业用户设计的 Registry server 开源项目 (镜像仓库, 类似 docker hub)</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="19-helm">19. Helm<a href="#19-helm" class="hash-link" aria-label="19. Helm的直接链接" title="19. Helm的直接链接">​</a></h2><p>来自 CNCF, 使用 helm chart 一键拉起整套环境(第三方部署k8s应用的工具). 也可以使用其应用商店, 一键部署别人写好的软件集群</p><blockquote><p>Helm把Kubernetes资源（比如deployments、services或 ingress等）打包到一个chart中，而chart被保存到chart仓库。通过chart仓库可用来存储和分享chart。Helm使发布可配置，支持发布应用配置的版本管理，简化了Kubernetes部署应用的版本控制、打包、发布、删除、更新等操作。</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="191-how-to-create-helm-chart">19.1. How to create helm chart<a href="#191-how-to-create-helm-chart" class="hash-link" aria-label="19.1. How to create helm chart的直接链接" title="19.1. How to create helm chart的直接链接">​</a></h3><p>We can use <code>helm create &lt;chart-name&gt;</code> to create a default chart template, 该命令默认会创建一些 k8s 资源定义的初始文件，并且会生成官网推荐的目录结构</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">helm create hello-helm</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── Chart.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── charts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── templates     // we can put our resource yml files into this folder, then our code can be put into the root path</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── NOTES.txt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── _helpers.tpl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── deployment.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── hpa.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── ingress.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── service.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   ├── serviceaccount.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   └── tests</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│       └── test-connection.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── values.yaml</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>values.yml is used to define the env vars, we can extract the vars from cofigMap and then put the vars into this file.</p><blockquote><p>好处是可以将所有可变的参数定义在 values.yaml 文件中，使用该 helm charts 的人无需了解具体 k8s 的定义，只需改变成自己想要的参数，即可创建自定义的资源！</p></blockquote><p>for example:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># values.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">application</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> guangzhengli/hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain">v6</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;It works with Helm Values[v2]!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">database</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;http://DB_ADDRESS_DEFAULT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;db_password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>we can change the configMap like this:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hello-k8s-configmap.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 意思是从 values.yaml 文件中获取 application.name 的值 hellok8s，拼接 -config 字符串，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这样创建出来的 configmaps 资源名称就是 hellok8s-config。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">DB_URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.hellok8s.database.url </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>change secret yml like this:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hellok8s-secret.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 通过 b64enc 方法将值 Base64 编码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">DB_PASSWORD</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.hellok8s.database.password </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token plain"> b64enc </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and change deployment like this:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># hello-k8s-deployment.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.hellok8s.replicas </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.hellok8s.image </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hellok8s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">configMapKeyRef</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_PASSWORD</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> DB_PASSWORD</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> NAMESPACE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># Helm 的内置对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Release.Namespace </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> MESSAGE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> .Values.application.hellok8s.message </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="192-helm-chart-的打包发布">19.2. helm chart 的打包发布<a href="#192-helm-chart-的打包发布" class="hash-link" aria-label="19.2. helm chart 的打包发布的直接链接" title="19.2. helm chart 的打包发布的直接链接">​</a></h3><p>这里一 使用 github pages 存储为例</p><p>打包发布到 <a href="https://artifacthub.io/" target="_blank" rel="noopener noreferrer">https://artifacthub.io/</a>  (类似 dockerhub)</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1921-手动打包发布">19.2.1. 手动打包发布<a href="#1921-手动打包发布" class="hash-link" aria-label="19.2.1. 手动打包发布的直接链接" title="19.2.1. 手动打包发布的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">helm package &lt;char name&gt; # 将chart目录打包到chart归档中。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm repo index . # 命令可以基于包含打包chart的目录，生成仓库的索引文件 index.yaml。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 指定包进行安装使用</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install *.tgz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install hello-helm hello-helm-0.1.0.tgz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1922-利用-github-action-自动打包发布">19.2.2. 利用 github action 自动打包发布<a href="#1922-利用-github-action-自动打包发布" class="hash-link" aria-label="19.2.2. 利用 github action 自动打包发布的直接链接" title="19.2.2. 利用 github action 自动打包发布的直接链接">​</a></h4><p>使用 <a href="https://github.com/helm/chart-releaser-action" target="_blank" rel="noopener noreferrer">char-release-action</a> 自动发布 (该 action 会默认生成 helm chart 发布到 gh-pages 分支上)</p><p>ci.yml</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Release Charts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">release</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Checkout</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">fetch-depth</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Configure Git</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token scalar string" style="color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">          git config user.name &quot;$GITHUB_ACTOR&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">          git config user.email &quot;$GITHUB_ACTOR@users.noreply.github.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Install Helm</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> azure/setup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">helm@v1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> v3.8.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Run chart</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">releaser</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> helm/chart</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">releaser</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">action@v1.4.0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">charts_dir</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain">charts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token key atrule">CR_TOKEN</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;${{ secrets.GITHUB_TOKEN }}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="193-基本命令使用">19.3. 基本命令使用<a href="#193-基本命令使用" class="hash-link" aria-label="19.3. 基本命令使用的直接链接" title="19.3. 基本命令使用的直接链接">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># Chart 仓库其实就是一个带有index.yaml索引文件和任意个打包的 Chart 的 HTTP 服务器而已</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 可以利用 Github pages 搭建自己的仓库</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># stable https://kubernetes-charts.storage.googleapis.com the offical repo from google</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Repos provided by Microsoft</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># stable: http://mirror.azure.cn/kubernetes/charts/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># incubator: http://mirror.azure.cn/kubernetes/charts-incubator/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># provied by bitnami</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># bitnami   https://charts.bitnami.com/bitnami</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># aliyun                https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ingress-nginx         https://kubernetes.github.io/ingress-nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm repo list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm repo remove &lt;repo name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm repo add &lt;repo name&gt; &lt;url&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># search from local added repo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm search repo [chart name]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># search from helm hub</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm search hub [chart name]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看一个 chart 的详细信息</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm inspect stable/mysql</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># Chart name usually consists of repo_name + / + sub_name, eg. stable/mysql</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 安装 chart 会创建一个新 release 对象, 通过 --name 指定名字</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -f config.yaml 指定自定义配置文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm install [-f config.yaml] &lt;char name&gt; [--name &lt;release name&gt;]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm install &lt;release name&gt; &lt;chart name&gt; [--version 0.1.0]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#  自己制作好 chart 后, 在 helm chart 目录下执行安装, 会创建好 resources</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install hello-helm --values values.yaml .</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 跟踪 release 状态或重新读取配置信息</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm status &lt;release name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看 chart 上可配置自定义的选项</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 通过 yml 格式定义配置如 config.yml后, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#   可 helm install -f config.yaml stable/mysql --name mydb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#   亦可 --set persistence.enabled=false 来自定义配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm inspect values</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 更新/升级 (config.yml 中就是更新的内容)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade -f config.yaml &lt;release object&gt; &lt;chart name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 查看 已经安装的 charts list (即已经 release 的对象), 包括已经删除的</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm ls [--all]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 不代表就完全删除了</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 由于 Helm 保留已删除 release 的记录，因此不能重新使用 release 名称。（如果 确实 需要重新使用此 release 名称，则可以使用此 –replace 参数，但它只会重用现有 release 并替换其资源。）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># --purge 彻底删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm delete &lt;release name&gt; [--purge]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 显示被删除掉 release</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm list --deleted</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm uninstall &lt;chart name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="194-rollback">19.4. rollback<a href="#194-rollback" class="hash-link" aria-label="19.4. rollback的直接链接" title="19.4. rollback的直接链接">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 先查看历史</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm history &lt;release object name&gt;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 比如, 我们对 values.yml 做了修改</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 更新 k8s 资源</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install hello-helm --values values.yaml .</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 发现更新有问题, 回滚上一个版本 (回滚后 REVISION 版本都会增大到 3 而不是回滚到 1)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm rollback hello-helm 1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="195-多环境">19.5. 多环境<a href="#195-多环境" class="hash-link" aria-label="19.5. 多环境的直接链接" title="19.5. 多环境的直接链接">​</a></h3><p>create <code>values-dev.yaml</code></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 可以多次指定&#x27;--values 或者 -f&#x27;参数，最后（最右边）指定的文件优先级最高</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 这里最右边的是 values-dev.yaml 文件，所以 values-dev.yaml 文件中的值会覆盖 values.yaml 中相同的值</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -n dev 表示在名字为 dev 的 namespace 中创建 k8s 资源</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install hello-helm -f values.yaml -f values-dev.yaml -n dev .</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 还可以再 cmd 中临时设置 values (此方法在 CICD 中经常用到。)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">helm upgrade --install hello-helm -f values.yaml -f values-dev.yaml \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --set application.hellok8s.message=&quot;It works with set helm values&quot; \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -n dev .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="20-reference-materials">20. reference materials<a href="#20-reference-materials" class="hash-link" aria-label="20. reference materials的直接链接" title="20. reference materials的直接链接">​</a></h2><p><a href="https://github.com/techiescamp/kubernetes-learning-path" target="_blank" rel="noopener noreferrer">https://github.com/techiescamp/kubernetes-learning-path</a>
<a href="https://github.com/guangzhengli/k8s-tutorials" target="_blank" rel="noopener noreferrer">https://github.com/guangzhengli/k8s-tutorials</a></p><p><a href="https://www.bilibili.com/video/BV1Ja4y1x748" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1Ja4y1x748</a> 视频教程
<a href="https://edu.aliyun.com/roadmap/cloudnative?from=timeline" target="_blank" rel="noopener noreferrer">https://edu.aliyun.com/roadmap/cloudnative?from=timeline</a></p><p><a href="https://github.com/caicloud/kube-ladder" target="_blank" rel="noopener noreferrer">https://github.com/caicloud/kube-ladder</a></p><p><a href="https://github.com/jpetazzo/container.training" target="_blank" rel="noopener noreferrer">https://github.com/jpetazzo/container.training</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/k-8-s">k8s</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/kotlin"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">kotlin</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux-note"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">鸟哥的 Linux 私房菜阅读笔记</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-面试问题" class="table-of-contents__link toc-highlight">1. 面试问题</a></li><li><a href="#开发调试工具" class="table-of-contents__link toc-highlight">开发调试工具</a></li><li><a href="#2-deploying-springcloud" class="table-of-contents__link toc-highlight">2. deploying springcloud</a><ul><li><a href="#using-configmap" class="table-of-contents__link toc-highlight">using configMap</a></li><li><a href="#部署到-k8s-后还是有缺点" class="table-of-contents__link toc-highlight">部署到 k8s 后还是有缺点</a></li></ul></li><li><a href="#3-what-and-why" class="table-of-contents__link toc-highlight">3. what and why</a><ul><li><a href="#31-k8s-是做什么的" class="table-of-contents__link toc-highlight">3.1. k8s 是做什么的</a></li><li><a href="#32-为什么使用" class="table-of-contents__link toc-highlight">3.2. 为什么使用:</a></li><li><a href="#33-compare-with-spring-cloud" class="table-of-contents__link toc-highlight">3.3. compare with spring cloud</a></li></ul></li><li><a href="#4-搭建环境" class="table-of-contents__link toc-highlight">4. 搭建环境</a><ul><li><a href="#41-生产服务器上安装" class="table-of-contents__link toc-highlight">4.1. 生产服务器上安装</a></li><li><a href="#42-vagrant-搭建-k8s-环境" class="table-of-contents__link toc-highlight">4.2. vagrant 搭建 k8s 环境</a></li><li><a href="#43-众多的发行版" class="table-of-contents__link toc-highlight">4.3. 众多的发行版</a><ul><li><a href="#431-k3s" class="table-of-contents__link toc-highlight">4.3.1. k3s</a><ul><li><a href="#4311-k3d" class="table-of-contents__link toc-highlight">4.3.1.1. k3d</a></li></ul></li><li><a href="#432-k0s" class="table-of-contents__link toc-highlight">4.3.2. k0s</a></li><li><a href="#433-microk8s" class="table-of-contents__link toc-highlight">4.3.3. microk8s</a></li><li><a href="#434-docker-desktop-推荐使用-rancher-desktop-替代" class="table-of-contents__link toc-highlight">4.3.4. docker desktop (推荐使用 rancher desktop 替代)</a></li><li><a href="#435-kind-推荐使用-k3d-代替" class="table-of-contents__link toc-highlight">4.3.5. kind (推荐使用 k3d 代替)</a></li><li><a href="#436-minikube" class="table-of-contents__link toc-highlight">4.3.6. minikube</a></li></ul></li></ul></li><li><a href="#5-quickstart" class="table-of-contents__link toc-highlight">5. Quickstart</a><ul><li><a href="#51-以java-为例" class="table-of-contents__link toc-highlight">5.1. 以Java 为例</a></li><li><a href="#52-以-go-为例" class="table-of-contents__link toc-highlight">5.2. 以 go 为例</a><ul><li><a href="#521-using-pod-directly" class="table-of-contents__link toc-highlight">5.2.1. using pod directly</a></li><li><a href="#522-using-deployment" class="table-of-contents__link toc-highlight">5.2.2. using deployment</a></li></ul></li></ul></li><li><a href="#6-集群结构-underlying-infrastructure-基础设施" class="table-of-contents__link toc-highlight">6. 集群结构 underlying infrastructure 基础设施</a></li><li><a href="#7-api-管理的各种资源" class="table-of-contents__link toc-highlight">7. api 管理的各种资源</a><ul><li><a href="#71-各种资源的关系" class="table-of-contents__link toc-highlight">7.1. 各种资源的关系</a></li><li><a href="#72-3-common-properties" class="table-of-contents__link toc-highlight">7.2. 3 common properties</a><ul><li><a href="#721-metadata" class="table-of-contents__link toc-highlight">7.2.1. metadata</a></li><li><a href="#722-spec" class="table-of-contents__link toc-highlight">7.2.2. spec</a></li><li><a href="#723-status" class="table-of-contents__link toc-highlight">7.2.3. status</a></li></ul></li><li><a href="#73-node" class="table-of-contents__link toc-highlight">7.3. node</a></li><li><a href="#74-pod" class="table-of-contents__link toc-highlight">7.4. pod</a></li><li><a href="#75-label" class="table-of-contents__link toc-highlight">7.5. label</a><ul><li><a href="#751-label-selector-使用" class="table-of-contents__link toc-highlight">7.5.1. Label selector 使用</a></li></ul></li><li><a href="#76-taint污点和-toleration容忍" class="table-of-contents__link toc-highlight">7.6. Taint（污点）和 Toleration（容忍）</a><ul><li><a href="#761-taint" class="table-of-contents__link toc-highlight">7.6.1. taint</a></li><li><a href="#762-toleration" class="table-of-contents__link toc-highlight">7.6.2. toleration</a></li></ul></li><li><a href="#77-controllers各种控制器" class="table-of-contents__link toc-highlight">7.7. controllers(各种控制器)</a><ul><li><a href="#771-rc-replica-controller-副本控制器" class="table-of-contents__link toc-highlight">7.7.1. <del>RC (replica controller 副本控制器)</del></a></li><li><a href="#772-rs-replica-set-代替-rc" class="table-of-contents__link toc-highlight">7.7.2. RS (replica set, 代替 RC)</a></li><li><a href="#773-deployment-管理-rs" class="table-of-contents__link toc-highlight">7.7.3. Deployment (管理 RS)</a><ul><li><a href="#7731-scale-upback-扩容缩容" class="table-of-contents__link toc-highlight">7.7.3.1. scale up/back (扩容缩容)</a></li><li><a href="#7732-version-upgrade-版本升级" class="table-of-contents__link toc-highlight">7.7.3.2. version upgrade (版本升级)</a></li><li><a href="#7733-rolling-update-滚动升级" class="table-of-contents__link toc-highlight">7.7.3.3. rolling update (滚动升级)</a></li><li><a href="#7734-回滚-版本回退-查看历史" class="table-of-contents__link toc-highlight">7.7.3.4. 回滚 版本回退 查看历史</a></li><li><a href="#7735-livenessprobe-存活探针" class="table-of-contents__link toc-highlight">7.7.3.5. livenessProbe (存活探针)</a></li><li><a href="#7736-readinessprobe-就绪探针" class="table-of-contents__link toc-highlight">7.7.3.6. readinessProbe (就绪探针)</a></li></ul></li><li><a href="#774-sc-stateful-set" class="table-of-contents__link toc-highlight">7.7.4. SC (stateful set)</a><ul><li><a href="#7741-数据持久化-persist" class="table-of-contents__link toc-highlight">7.7.4.1. 数据持久化 persist</a></li></ul></li><li><a href="#775-ds-daemon-set-后台支撑服务集" class="table-of-contents__link toc-highlight">7.7.5. DS (daemon set 后台支撑服务集)</a></li><li><a href="#776-job-一次性任务" class="table-of-contents__link toc-highlight">7.7.6. job (一次性任务)</a></li><li><a href="#777-cronjob-定时任务" class="table-of-contents__link toc-highlight">7.7.7. cronjob (定时任务)</a></li></ul></li><li><a href="#78-service" class="table-of-contents__link toc-highlight">7.8. service</a><ul><li><a href="#781-endpoint" class="table-of-contents__link toc-highlight">7.8.1. Endpoint</a></li><li><a href="#782-多端口" class="table-of-contents__link toc-highlight">7.8.2. 多端口</a></li><li><a href="#783-clusterip-默认使用的类型" class="table-of-contents__link toc-highlight">7.8.3. ClusterIP (默认使用的类型)</a><ul><li><a href="#7831-headless" class="table-of-contents__link toc-highlight">7.8.3.1. Headless</a></li></ul></li><li><a href="#784-nodeport" class="table-of-contents__link toc-highlight">7.8.4. NodePort</a></li><li><a href="#785-loadbalancer" class="table-of-contents__link toc-highlight">7.8.5. LoadBalancer</a></li><li><a href="#786-externalname" class="table-of-contents__link toc-highlight">7.8.6. ExternalName</a></li><li><a href="#787-手动端口转发" class="table-of-contents__link toc-highlight">7.8.7. 手动端口转发</a></li><li><a href="#788-service-如何工作" class="table-of-contents__link toc-highlight">7.8.8. service 如何工作</a></li></ul></li><li><a href="#79-ingress" class="table-of-contents__link toc-highlight">7.9. ingress</a><ul><li><a href="#791-install-ingress-nginx" class="table-of-contents__link toc-highlight">7.9.1. install ingress-nginx</a></li><li><a href="#792-traefik" class="table-of-contents__link toc-highlight">7.9.2. Traefik</a></li></ul></li><li><a href="#710-volume" class="table-of-contents__link toc-highlight">7.10. volume</a></li><li><a href="#711-secret" class="table-of-contents__link toc-highlight">7.11. secret</a></li><li><a href="#712-config-map" class="table-of-contents__link toc-highlight">7.12. config map</a></li><li><a href="#713-flannel" class="table-of-contents__link toc-highlight">7.13. flannel</a></li><li><a href="#714-name" class="table-of-contents__link toc-highlight">7.14. name</a></li><li><a href="#715-name-namespace-用来划分多环境" class="table-of-contents__link toc-highlight">7.15. name namespace (用来划分多环境)</a></li></ul></li><li><a href="#8-垃圾回收" class="table-of-contents__link toc-highlight">8. 垃圾回收</a><ul><li><a href="#81-级联删除" class="table-of-contents__link toc-highlight">8.1. 级联删除</a></li><li><a href="#82-孤儿删除-orphan" class="table-of-contents__link toc-highlight">8.2. 孤儿删除 orphan</a></li></ul></li><li><a href="#9-资源描述文件" class="table-of-contents__link toc-highlight">9. 资源描述文件</a><ul><li><a href="#91-查看属性说明" class="table-of-contents__link toc-highlight">9.1. 查看属性说明</a></li><li><a href="#92-通过命令生成-yml" class="table-of-contents__link toc-highlight">9.2. 通过命令生成 yml</a></li><li><a href="#93-pod-的-yaml-描述文件" class="table-of-contents__link toc-highlight">9.3. pod 的 yaml 描述文件</a></li><li><a href="#94-deployment-的描述文件" class="table-of-contents__link toc-highlight">9.4. deployment 的描述文件</a></li><li><a href="#95-service" class="table-of-contents__link toc-highlight">9.5. service</a></li></ul></li><li><a href="#10-注解" class="table-of-contents__link toc-highlight">10. 注解</a></li><li><a href="#11-命名空间" class="table-of-contents__link toc-highlight">11. 命名空间</a></li><li><a href="#12-pod-管理" class="table-of-contents__link toc-highlight">12. pod 管理</a><ul><li><a href="#121-探测-pod-是否健康" class="table-of-contents__link toc-highlight">12.1. 探测 pod 是否健康</a></li><li><a href="#122-pod-副本" class="table-of-contents__link toc-highlight">12.2. pod 副本</a></li><li><a href="#123-运行单个任务-job" class="table-of-contents__link toc-highlight">12.3. 运行单个任务 Job</a></li><li><a href="#124-定时任务-cronjob" class="table-of-contents__link toc-highlight">12.4. 定时任务 CronJob</a></li></ul></li><li><a href="#13-pod-通信" class="table-of-contents__link toc-highlight">13. pod 通信</a><ul><li><a href="#131-proxy" class="table-of-contents__link toc-highlight">13.1. proxy</a></li><li><a href="#132-service" class="table-of-contents__link toc-highlight">13.2. Service</a></li><li><a href="#133-pod-间通信" class="table-of-contents__link toc-highlight">13.3. pod 间通信</a></li><li><a href="#134-通过-service-连接外部服务" class="table-of-contents__link toc-highlight">13.4. 通过 Service 连接外部服务</a><ul><li><a href="#1341-通过手动生成-endpoint" class="table-of-contents__link toc-highlight">13.4.1. 通过手动生成 endpoint</a></li><li><a href="#1342-通过-externalname-类型的-service" class="table-of-contents__link toc-highlight">13.4.2. 通过 externalName 类型的 Service</a></li></ul></li><li><a href="#135-将服务暴露给外部" class="table-of-contents__link toc-highlight">13.5. 将服务暴露给外部</a><ul><li><a href="#1351-将服务的类型设置成-nodeport" class="table-of-contents__link toc-highlight">13.5.1. 将服务的类型设置成 NodePort</a></li><li><a href="#1352-将服务的类型设置成-loadbalance" class="table-of-contents__link toc-highlight">13.5.2. 将服务的类型设置成 LoadBalance</a></li><li><a href="#1353-创建一-个-ingress-资源" class="table-of-contents__link toc-highlight">13.5.3. 创建一 个 Ingress 资源</a></li></ul></li></ul></li><li><a href="#14-命令" class="table-of-contents__link toc-highlight">14. 命令</a><ul><li><a href="#141-kubectl" class="table-of-contents__link toc-highlight">14.1. kubectl</a><ul><li><a href="#1411-基本信息" class="table-of-contents__link toc-highlight">14.1.1. 基本信息</a></li><li><a href="#1412-创建-create-expose" class="table-of-contents__link toc-highlight">14.1.2. 创建 create expose</a></li><li><a href="#1413-执行命令到容器-exec" class="table-of-contents__link toc-highlight">14.1.3. 执行命令到容器 exec</a></li><li><a href="#1414-修改" class="table-of-contents__link toc-highlight">14.1.4. 修改</a></li><li><a href="#1415-资源列表-get" class="table-of-contents__link toc-highlight">14.1.5. 资源列表 get</a></li><li><a href="#1416-查询详细描述-describe" class="table-of-contents__link toc-highlight">14.1.6. 查询详细描述 describe</a></li><li><a href="#1417-查询日志-logs" class="table-of-contents__link toc-highlight">14.1.7. 查询日志 logs</a></li><li><a href="#1418-删除-delete" class="table-of-contents__link toc-highlight">14.1.8. 删除 delete</a></li><li><a href="#1419-操作上下文" class="table-of-contents__link toc-highlight">14.1.9. 操作上下文</a></li></ul></li><li><a href="#142-kubeadmin" class="table-of-contents__link toc-highlight">14.2. kubeadmin</a></li></ul></li><li><a href="#15-cka-ckad-证书考试" class="table-of-contents__link toc-highlight">15. cka ckad 证书考试</a></li><li><a href="#16-dashboard" class="table-of-contents__link toc-highlight">16. dashboard</a><ul><li><a href="#161-k9s" class="table-of-contents__link toc-highlight">16.1. k9s</a></li><li><a href="#162-kuboard" class="table-of-contents__link toc-highlight">16.2. kuboard</a></li><li><a href="#163-kubernetes-dashboard" class="table-of-contents__link toc-highlight">16.3. kubernetes-dashboard</a></li><li><a href="#164-kubesphere-推荐" class="table-of-contents__link toc-highlight">16.4. kubesphere (推荐)</a></li></ul></li><li><a href="#17-rancher" class="table-of-contents__link toc-highlight">17. rancher</a></li><li><a href="#18-harbor" class="table-of-contents__link toc-highlight">18. Harbor</a></li><li><a href="#19-helm" class="table-of-contents__link toc-highlight">19. Helm</a><ul><li><a href="#191-how-to-create-helm-chart" class="table-of-contents__link toc-highlight">19.1. How to create helm chart</a></li><li><a href="#192-helm-chart-的打包发布" class="table-of-contents__link toc-highlight">19.2. helm chart 的打包发布</a><ul><li><a href="#1921-手动打包发布" class="table-of-contents__link toc-highlight">19.2.1. 手动打包发布</a></li><li><a href="#1922-利用-github-action-自动打包发布" class="table-of-contents__link toc-highlight">19.2.2. 利用 github action 自动打包发布</a></li></ul></li><li><a href="#193-基本命令使用" class="table-of-contents__link toc-highlight">19.3. 基本命令使用</a></li><li><a href="#194-rollback" class="table-of-contents__link toc-highlight">19.4. rollback</a></li><li><a href="#195-多环境" class="table-of-contents__link toc-highlight">19.5. 多环境</a></li></ul></li><li><a href="#20-reference-materials" class="table-of-contents__link toc-highlight">20. reference materials</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">历史</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/xiaoyureed" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/xiaoyuhfq" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/3fPgwd3naN" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/resource">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Xiaoyureed, Inc. Built with ❤️ by xiaoyu.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.831ed87f.js"></script>
<script src="/assets/js/main.d4aae7e0.js"></script>
</body>
</html>