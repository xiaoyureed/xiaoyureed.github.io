---
title: Message QueueğŸŒˆ
tags:
  - mq
date: 2019-04-13 19:23:02
toc_min_heading_level: 2
toc_max_heading_level: 5
---

<div align="center">
https://www.zhihu.com/question/43557507
https://www.jianshu.com/p/79ca08116d57
æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰æ˜¯ä¸€ç§åº”ç”¨é—´çš„é€šä¿¡æ–¹å¼, æ˜¯ä¸€ç§åº”ç”¨é—´çš„å¼‚æ­¥åä½œæœºåˆ¶
rabbitmqï¼šhttps://www.rabbitmq.com

https://blog.csdn.net/jiaowo_ccc/article/details/93893715 usage scenario
</div>

<!--more-->

- [1. æ€»ç»“](#1-æ€»ç»“)
- [2. mq æ˜¯ä»€ä¹ˆ](#2-mq-æ˜¯ä»€ä¹ˆ)
- [3. ä¸ºä»€ä¹ˆä½¿ç”¨mq-ä¼˜ç¼ºç‚¹](#3-ä¸ºä»€ä¹ˆä½¿ç”¨mq-ä¼˜ç¼ºç‚¹)
    - [3.1. å¸¦æ¥çš„å¥½å¤„](#31-å¸¦æ¥çš„å¥½å¤„)
    - [3.2. å¼•å…¥mqå¸¦æ¥çš„é—®é¢˜-æ€ä¹ˆè§£å†³](#32-å¼•å…¥mqå¸¦æ¥çš„é—®é¢˜-æ€ä¹ˆè§£å†³)
        - [3.2.1. è§£å†³é«˜å¯ç”¨é—®é¢˜](#321-è§£å†³é«˜å¯ç”¨é—®é¢˜)
        - [3.2.2. è§£å†³æ¶ˆæ¯ä¼ é€’å¯é æ€§](#322-è§£å†³æ¶ˆæ¯ä¼ é€’å¯é æ€§)
            - [3.2.2.1. å¦‚ä½•é˜²æ­¢é‡å¤æ¶ˆè´¹](#3221-å¦‚ä½•é˜²æ­¢é‡å¤æ¶ˆè´¹)
            - [3.2.2.2. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±](#3222-å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±)
            - [3.2.2.3. å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåº](#3223-å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåº)
            - [3.2.2.4. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯çš„å¤§é‡ç§¯å‹](#3224-å¦‚ä½•é˜²æ­¢æ¶ˆæ¯çš„å¤§é‡ç§¯å‹)
            - [3.2.2.5. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆ](#3225-å¦‚ä½•é˜²æ­¢æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆ)
            - [3.2.2.6. å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼æœ€ç»ˆä¸€è‡´æ€§](#3226-å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼æœ€ç»ˆä¸€è‡´æ€§)
- [4. æœ‰å“ªäº›äº§å“å¯ä¾›é€‰æ‹©-é€‰å‹](#4-æœ‰å“ªäº›äº§å“å¯ä¾›é€‰æ‹©-é€‰å‹)
- [5. RabbitMQ](#5-rabbitmq)
    - [5.1. AMQPåè®®](#51-amqpåè®®)
        - [5.1.1. æ¦‚å¿µ](#511-æ¦‚å¿µ)
        - [5.1.2. å·¥ä½œè¿‡ç¨‹](#512-å·¥ä½œè¿‡ç¨‹)
        - [5.1.3. æ¶ˆæ¯ç¡®è®¤](#513-æ¶ˆæ¯ç¡®è®¤)
    - [5.2. åŸºæœ¬ä»‹ç»](#52-åŸºæœ¬ä»‹ç»)
    - [5.3. å‡ ç§æ¶ˆæ¯æ¨¡å‹](#53-å‡ ç§æ¶ˆæ¯æ¨¡å‹)
        - [5.3.1. hello-world](#531-hello-world)
        - [5.3.2. worker-queue](#532-worker-queue)
        - [5.3.3. å‘å¸ƒè®¢é˜…](#533-å‘å¸ƒè®¢é˜…)
        - [5.3.4. rpc](#534-rpc)
    - [5.4. ä½¿ç”¨ rabbit](#54-ä½¿ç”¨-rabbit)
        - [5.4.1. æ¶ˆæ¯çš„åºåˆ—åŒ–](#541-æ¶ˆæ¯çš„åºåˆ—åŒ–)
        - [5.4.2. å‘é€](#542-å‘é€)
        - [5.4.3. æ¥æ”¶](#543-æ¥æ”¶)
        - [5.4.4. æŒä¹…åŒ–](#544-æŒä¹…åŒ–)
        - [5.4.5. æ¶ˆæ¯ç¡®è®¤æœºåˆ¶-æ‰‹åŠ¨ç¡®è®¤-å›è°ƒ](#545-æ¶ˆæ¯ç¡®è®¤æœºåˆ¶-æ‰‹åŠ¨ç¡®è®¤-å›è°ƒ)
            - [5.4.5.1. æ¶ˆæ¯å‘é€ç¡®è®¤](#5451-æ¶ˆæ¯å‘é€ç¡®è®¤)
            - [5.4.5.2. æ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤](#5452-æ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤)
        - [5.4.6. ä½¿ç”¨ amqpAdmin é›†ä¸­é…ç½® rabbitmq](#546-ä½¿ç”¨-amqpadmin-é›†ä¸­é…ç½®-rabbitmq)
- [6. kafka](#6-kafka)
    - [6.1. kafka åŸºæœ¬æ¦‚å¿µ](#61-kafka-åŸºæœ¬æ¦‚å¿µ)
        - [6.1.1. é€»è¾‘æ¶æ„](#611-é€»è¾‘æ¶æ„)
        - [6.1.2. ç‰©ç†æ¶æ„](#612-ç‰©ç†æ¶æ„)
        - [6.1.3. å†™å…¥æ¶ˆæ¯å·¥ä½œæµç¨‹](#613-å†™å…¥æ¶ˆæ¯å·¥ä½œæµç¨‹)
        - [6.1.4. æ¶ˆè´¹æ¶ˆæ¯çš„åŸç†](#614-æ¶ˆè´¹æ¶ˆæ¯çš„åŸç†)
        - [6.1.5. partition åˆ†åŒºé€‰æ‹©åŸåˆ™é€»è¾‘](#615-partition-åˆ†åŒºé€‰æ‹©åŸåˆ™é€»è¾‘)
        - [6.1.6. kafka æ¶ˆæ¯æœ‰åºæ€§](#616-kafka-æ¶ˆæ¯æœ‰åºæ€§)
        - [6.1.7. kafka ä¸ºä»€ä¹ˆå¿«](#617-kafka-ä¸ºä»€ä¹ˆå¿«)
        - [6.1.8. kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§](#618-kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§)
        - [6.1.9. å¦‚ä½•ä¿è¯ä¸é‡å¤æ¶ˆè´¹](#619-å¦‚ä½•ä¿è¯ä¸é‡å¤æ¶ˆè´¹)
        - [6.1.10. å¦‚ä½•ä¿è¯ä¸é—æ¼æ¶ˆè´¹ æ¶ˆæ¯ä¸¢å¤±](#6110-å¦‚ä½•ä¿è¯ä¸é—æ¼æ¶ˆè´¹-æ¶ˆæ¯ä¸¢å¤±)
        - [6.1.11. æ¨oræ‹‰](#6111-æ¨oræ‹‰)
        - [6.1.12. ä¸¤ç§æ¨¡å‹ åŸºäºé˜Ÿåˆ— åŸºäºå‘å¸ƒè®¢é˜…](#6112-ä¸¤ç§æ¨¡å‹-åŸºäºé˜Ÿåˆ—-åŸºäºå‘å¸ƒè®¢é˜…)
    - [6.2. ä¸ºä»€ä¹ˆä½¿ç”¨ kafka](#62-ä¸ºä»€ä¹ˆä½¿ç”¨-kafka)
        - [6.2.1. kafkaä½¿ç”¨åœºæ™¯](#621-kafkaä½¿ç”¨åœºæ™¯)
        - [6.2.2. å’Œ redis æ¶ˆæ¯é˜Ÿåˆ—çš„åŒºåˆ«](#622-å’Œ-redis-æ¶ˆæ¯é˜Ÿåˆ—çš„åŒºåˆ«)
    - [6.3. å¦‚ä½•ä½¿ç”¨kafka](#63-å¦‚ä½•ä½¿ç”¨kafka)
        - [6.3.1. kafka åŸç”Ÿé…ç½®](#631-kafka-åŸç”Ÿé…ç½®)
        - [6.3.2. åœ¨ springboot ä¸­ä½¿ç”¨ kafka](#632-åœ¨-springboot-ä¸­ä½¿ç”¨-kafka)
        - [6.3.3. åˆ›å»ºä¸»é¢˜](#633-åˆ›å»ºä¸»é¢˜)
        - [6.3.4. ç”Ÿäº§è€…å‘é€](#634-ç”Ÿäº§è€…å‘é€)
            - [6.3.4.1. kafka template åŒæ­¥ å¼‚æ­¥](#6341-kafka-template-åŒæ­¥-å¼‚æ­¥)
            - [6.3.4.2. ç”Ÿäº§è€…é…ç½®](#6342-ç”Ÿäº§è€…é…ç½®)
            - [6.3.4.3. ç”Ÿäº§è€…äº‹åŠ¡æ¶ˆæ¯](#6343-ç”Ÿäº§è€…äº‹åŠ¡æ¶ˆæ¯)
        - [6.3.5. æ¶ˆè´¹è€…æ¶ˆè´¹](#635-æ¶ˆè´¹è€…æ¶ˆè´¹)
            - [6.3.5.1. é…ç½® è¿‡æ»¤å™¨ å…¨å±€å¼‚å¸¸å¤„ç†](#6351-é…ç½®-è¿‡æ»¤å™¨-å…¨å±€å¼‚å¸¸å¤„ç†)
            - [6.3.5.2. ç›‘å¬æ¶ˆè´¹](#6352-ç›‘å¬æ¶ˆè´¹)
                - [6.3.5.2.1. @kafkaListeneråŸºæœ¬ä½¿ç”¨](#63521-kafkalisteneråŸºæœ¬ä½¿ç”¨)
                - [6.3.5.2.2. æ¶ˆè´¹æŒ‡å®šåˆ†åŒº](#63522-æ¶ˆè´¹æŒ‡å®šåˆ†åŒº)
                - [6.3.5.2.3. åŠ¨æ€å¼€å¯å…³é—­ç›‘å¬](#63523-åŠ¨æ€å¼€å¯å…³é—­ç›‘å¬)
                - [6.3.5.2.4. ç¦ç”¨è‡ªå¯åŠ¨](#63524-ç¦ç”¨è‡ªå¯åŠ¨)
                - [6.3.5.2.5. å®šæ—¶å¯åœç›‘å¬å™¨](#63525-å®šæ—¶å¯åœç›‘å¬å™¨)
            - [6.3.5.3. æ¶ˆè´¹è€…é”™è¯¯å¤„ç† å•æ¶ˆæ¯ æ‰¹é‡æ¶ˆæ¯](#6353-æ¶ˆè´¹è€…é”™è¯¯å¤„ç†-å•æ¶ˆæ¯-æ‰¹é‡æ¶ˆæ¯)
            - [6.3.5.4. offset æäº¤](#6354-offset-æäº¤)
            - [6.3.5.5. æ¶ˆæ¯åºåˆ—åŒ–](#6355-æ¶ˆæ¯åºåˆ—åŒ–)
            - [6.3.5.6. è‡ªå®šä¹‰ä»£æ›¿é»˜è®¤çº¿ç¨‹æ± ](#6356-è‡ªå®šä¹‰ä»£æ›¿é»˜è®¤çº¿ç¨‹æ± )
            - [6.3.5.7. æ¶ˆè´¹è€…ç»„ å¤šçº¿ç¨‹æ¶ˆè´¹](#6357-æ¶ˆè´¹è€…ç»„-å¤šçº¿ç¨‹æ¶ˆè´¹)
            - [6.3.5.8. æ¶ˆæ¯è½¬å‘](#6358-æ¶ˆæ¯è½¬å‘)
        - [6.3.6. æ€»ç»“:æ¶ˆæ¯é€è¾¾çš„æƒ…å†µ](#636-æ€»ç»“æ¶ˆæ¯é€è¾¾çš„æƒ…å†µ)
    - [6.4. å‚æ•°è°ƒä¼˜](#64-å‚æ•°è°ƒä¼˜)
    - [å¼€æºç”Ÿæ€](#å¼€æºç”Ÿæ€)
- [7. å³æ—¶é€šè®¯ MQTTåè®®](#7-å³æ—¶é€šè®¯-mqttåè®®)


# 1. æ€»ç»“

```java
åœºæ™¯: è§£è€¦, å‰Šå³°é™æµ(æ”¾ç½®æ‰“å®åº”ç”¨), å¼‚æ­¥(æå‰è¿”å›)
æ¨¡å‹: producer, consumer, queue(exchange, queue)
    exchange type: fanout, direct, topic, headers
        topic: *å·, #å·
    binding: ç»‘å®šexchangeå’Œqueue, è®¾ç½® bingdingKey,å‘é€æ•°æ®æ—¶éœ€è¦åŒæ—¶å‘é€bindingKey
ç‰¹æ€§: æ¶ˆæ¯ç¡®è®¤(msg ack), æŒä¹…åŒ–, å…¬å¹³å‘å¸ƒ(fair dispatch)
    msg ack: æ¯ä¸ªconsumer æ¶ˆè´¹å®Œæ¶ˆæ¯, ä¼šå‘é€ä¸€ä¸ªå›æ‰§ç»™ rabbit, rabbitç„¶åæ‰èƒ½åˆ é™¤é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯, å¦åˆ™ rabbit ä¼šå°è¯•å‘é€è¿™ä¸ªæ¶ˆæ¯ç»™å…¶ä»– consumer
    æŒä¹…åŒ–: 
    è½®è¯¢æœºåˆ¶
å¸¦æ¥çš„é—®é¢˜: é¢å¤–çš„ç»„ä»¶å¼•å…¥å¤æ‚æ€§; æš‚æ—¶çš„ä¸ä¸€è‡´æ€§(æœ€ç»ˆä¼šä¸€è‡´)

```

# 2. mq æ˜¯ä»€ä¹ˆ

æ¶ˆæ¯é˜Ÿåˆ—ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼ é€’æ•°æ®

æ¶‰åŠä¸‰ä¸ªæ¦‚å¿µ -- producerï¼Œconsumerï¼Œmqä¸­é—´ä»¶ï¼›

# 3. ä¸ºä»€ä¹ˆä½¿ç”¨mq-ä¼˜ç¼ºç‚¹

ä½¿ç”¨çš„å¤§å‰æ: ç”Ÿäº§è€…ä¸éœ€è¦ä»æ¶ˆè´¹è€…å¤„è·å¾—åé¦ˆ/å®¹è®¸çŸ­æš‚çš„ä¸ä¸€è‡´æ€§, å…¶å®å°±æ˜¯å®¹è®¸å¼‚æ­¥

## 3.1. å¸¦æ¥çš„å¥½å¤„

- ç³»ç»Ÿè§£è€¦

  ä¸Šæ¸¸ç³»ç»Ÿå°†æ•°æ®å‘é€åˆ° mq, ä¸‹æ¸¸ç³»ç»Ÿæ— è®ºæœ‰å¤šå°‘ä¸ª, åªéœ€è¦è®¢é˜…è‡ªå·±æ„Ÿå…´è¶£çš„ä¸»é¢˜å³å¯.

  æ¡ˆä¾‹: ç³»ç»Ÿaçš„æ•°æ®éœ€è¦ä¸»åŠ¨å‘é€ç»™ä¸‹æ¸¸ç³»ç»Ÿbæ¶ˆè´¹, é‚£ä¹ˆa ç›´æ¥è°ƒç”¨bçš„æ¥å£å°±å¥½äº†, ç°åœ¨éœ€æ±‚æ›´æ”¹: åˆæœ‰ç³»ç»Ÿc, déœ€è¦è¿™ä¸ªæ•°æ® (ä¹Ÿå°±æ˜¯ä¸€ä¸ª producer æœ‰å¤šä¸ª consumer), é‚£ä¹ˆç³»ç»Ÿaéœ€è¦ä¿®æ”¹, åŠ å…¥è°ƒç”¨c, d æ¥å£çš„ä»£ç ; ç°åœ¨å¼•å…¥  mq, ä¸Šæœ‰ç³»ç»Ÿaå‘é€æ•°æ®åˆ° mq, ä¸‹æ¸¸ç³»ç»Ÿbcdéœ€è¦æ•°æ®, ç›´æ¥è®¢é˜…æ„Ÿå…´è¶£çš„ topic å³å¯.

- å¼‚æ­¥è°ƒç”¨ (ææ—©è¿”å›)

  ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—åŠ¨ä½œï¼Œå¦‚æœè¿™äº›æ“ä½œéƒ½æ˜¯æ²¡æœ‰è¿”å›ç»“æœçš„é‚£ä¹ˆå¯ä»¥ç›´æ¥éƒ½æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—æ‰§è¡Œ,è¯·æ±‚ç«‹åˆ»è¿”å›
  
  å¦‚æœè¿™äº›åŠ¨ä½œå¯ä»¥ä¸­é—´ä¸€åˆ‡åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æœ‰è¿”å›ç»“æœï¼ŒäºŒç±»æ˜¯æ²¡æœ‰è¿”å›ç»“æœï¼Œå¼•å…¥mqåï¼Œä¸€ç±»æ“ä½œæ‰§è¡Œå®Œç›´æ¥è¿”å›ï¼Œ äºŒç±»æ“ä½œè¿›å…¥mqä¸­æ…¢æ…¢æ‰§è¡Œï¼Œè¿™æ ·æ•´ä¸ªè¯·æ±‚é€Ÿåº¦å°±åŠ å¿«äº†ï¼›
  
  æ¯”å¦‚ï¼šå¤–å–è®¢å•çš„ä¾‹å­ï¼Œæ‰§è¡Œé“¾æ¡ä¸­å¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯åˆ›å»ºè®¢å•ï¼Œé€šçŸ¥é¥­åº—æ¥å•ï¼ˆæ‰§è¡Œå®Œç›´æ¥è¿”å›ï¼‰ï¼Œ äºŒæ˜¯æ‰¾åˆ°éª‘æ‰‹ï¼ˆè€—æ—¶æ“ä½œï¼Œæ”¾åˆ°mqä¸­æ‰§è¡Œï¼‰ï¼›

- æ‰¿è½½æ¿€å¢çš„å¤§æµé‡, æ…¢æ…¢æ¶ˆåŒ– (æµé‡é”™å³°)

  ç³»ç»Ÿçš„è¯·æ±‚ä¸å‡åŒ€ï¼Œæµé‡é«˜çš„æ—¶å€™ï¼Œè¯·æ±‚å…ˆè¿›å…¥mqï¼Œåœ¨æµé‡ä½æ—¶æ…¢æ…¢æ¶ˆåŒ–å¤„ç† ï¼Œç”¨æœ‰é™çš„æœºå™¨æ‰¿è½½é«˜å¹¶å‘è¯·æ±‚


## 3.2. å¼•å…¥mqå¸¦æ¥çš„é—®é¢˜-æ€ä¹ˆè§£å†³


### 3.2.1. è§£å†³é«˜å¯ç”¨é—®é¢˜

å¼•å…¥ mq, ä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿ `å¯ç”¨æ€§ä¸å¥½` ï¼ˆå› ä¸º mq ä¸­é—´ä»¶æœåŠ¡å™¨å¯èƒ½ä¼šæŒ‚ï¼‰

é‚£ä¹ˆæ€ä¹ˆåšé«˜å¯ç”¨?

- åšé›†ç¾¤ -  ä»¥rabbitmqä¸ºä¾‹, é›†ç¾¤æœ‰ä¸¤ç§æ¨¡å¼ 

  ç½²å¤šä¸ªrabbitmqèŠ‚ç‚¹,æ¶ˆæ¯æ•°æ®åªå­˜åœ¨äºä¸€ä¸ªèŠ‚ç‚¹,ä½†æ˜¯å…ƒæ•°æ®å­˜åœ¨äºæ¯ä¸ªèŠ‚ç‚¹, æ¶ˆè´¹è€…å¦‚æœè¿æ¥åˆ°ä¸€ä¸ªç©ºèŠ‚ç‚¹,è¿™ä¸ªèŠ‚ç‚¹ä¼šæ ¹æ®å…ƒæ•°æ®åˆ°queueæ‰€åœ¨èŠ‚ç‚¹åŒæ­¥queueæ•°æ®; å®é™…ä¸Š,è¿˜æ˜¯æ²¡æ³•ä¿è¯é«˜å¯ç”¨,å› ä¸ºqueueæ•°æ®è¿˜æ˜¯åªå­˜åœ¨äºä¸€ä¸ªèŠ‚ç‚¹, è¿™æ ·åšåªæ˜¯æé«˜äº†ååé‡

  é•œåƒé›†ç¾¤æ¨¡å¼(å¯ä»¥ä¿è¯é«˜å¯ç”¨,æ²¡æ³•ä¿è¯å¯æ‹“å±•): é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰queueæ•°æ®, å†™æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨æŠŠæ¶ˆæ¯åŒæ­¥åˆ°æ¯ä¸ªèŠ‚ç‚¹; æ€ä¹ˆå¼€å¯:RabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹

- ä½¿ç”¨åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— Kafka 

  Kafka ä¸€ä¸ªæœ€åŸºæœ¬çš„æ¶æ„è®¤è¯†ï¼šç”±å¤šä¸ª broker ç»„æˆï¼Œæ¯ä¸ª broker æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›åˆ›å»ºä¸€ä¸ª topicï¼Œè¿™ä¸ª topic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition å¯ä»¥å­˜åœ¨äºä¸åŒçš„ broker ä¸Šï¼Œæ¯ä¸ª partition å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚

  Kafka 0.8 ä»¥åï¼Œæä¾›äº† HA (é«˜å¯ç”¨)æœºåˆ¶, æ¯ä¸ª partition çš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª replica å‰¯æœ¬ã€‚æ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥(ä¸€ä¸ªæŒ‚æ‰äº†åœ¨é€‰ä¸¾ä¸€ä¸ª)ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª leader æ‰“äº¤é“ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚
  
  å†™çš„æ—¶å€™ï¼Œleader ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ follower ä¸Šå»(ä¸€æ—¦æ‰€æœ‰ follower åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ ack ç»™ leaderï¼Œleader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…)ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» leader ä¸Šçš„æ•°æ®å³å¯
  
  (åªèƒ½è¯»å†™leader, è¦æ˜¯ä½ å¯ä»¥éšæ„è¯»å†™æ¯ä¸ª follower, å°±æœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜), åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚


### 3.2.2. è§£å†³æ¶ˆæ¯ä¼ é€’å¯é æ€§

æ¶ˆæ¯`å¯é æ€§ä¸å¥½` ï¼ˆæ¶ˆæ¯ä¸¢å¤±ï¼Œæ¶ˆæ¯é‡å¤/å¹‚ç­‰æ€§ï¼Œ å¤§é‡æ¶ˆæ¯ç§¯å‹, æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆ, æ€ä¹ˆä¿è¯æ¶ˆæ¯é¡ºåºæ€§ï¼‰

#### 3.2.2.1. å¦‚ä½•é˜²æ­¢é‡å¤æ¶ˆè´¹

- ä»€ä¹ˆæ—¶å€™å‡ºç°: 

  - ä¸ºäº†ç¡®ä¿æ¶ˆæ¯è¢«æˆåŠŸæ¶ˆè´¹, å¼€å¯ "æ‰‹åŠ¨ç¡®è®¤", å¦‚æœæ¶ˆæ¯å·²è¢«æˆåŠŸå¤„ç†ï¼Œä½†åœ¨æ¶ˆæ¯ç¡®è®¤è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨æ¶ˆè´¹ç«¯é‡å¯åï¼Œæ¶ˆæ¯ä¼šé‡æ–°è¢«æ¶ˆè´¹ã€‚

  - å‘é€ç«¯ä¸ºäº†ä¿è¯æ¶ˆæ¯ä¼šæˆåŠŸæŠ•é€’ï¼Œä¸€èˆ¬ä¼šè®¾å®šé‡è¯•ã€‚å¦‚æœæ¶ˆæ¯å‘é€è‡³RabbitMQä¹‹åï¼Œåœ¨RabbitMQå›å¤å·²æˆåŠŸæ¥æ”¶æ¶ˆæ¯è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆå‘é€ç«¯ä¼šé‡æ–°å‘é€è¯¥æ¶ˆæ¯ï¼Œä»è€Œé€ æˆæ¶ˆæ¯é‡å¤å‘é€

  - Kafkaæ¶ˆæ¯é‡å¤çš„è¡¨ç°: Kafka å®é™…ä¸Šæœ‰ä¸ª offset çš„æ¦‚å¿µï¼Œå°±æ˜¯æ¯ä¸ªæ¶ˆæ¯å†™è¿›å»ï¼Œéƒ½æœ‰ä¸€ä¸ª offsetï¼Œä»£è¡¨æ¶ˆæ¯çš„åºå·ï¼Œç„¶å consumer æ¶ˆè´¹äº†æ•°æ®ä¹‹åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆå®šæ—¶å®šæœŸï¼‰ï¼Œä¼šæŠŠè‡ªå·±æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯çš„ offset æäº¤ä¸€ä¸‹(æ­¤æ—¶æ¶ˆæ¯å¯èƒ½è¿˜æ²¡æœ‰æ­£å¼å¼€å§‹å¤„ç†)ï¼Œè¡¨ç¤ºâ€œæˆ‘å·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œä¸‹æ¬¡æˆ‘è¦æ˜¯é‡å¯å•¥çš„ï¼Œä½ å°±è®©æˆ‘ç»§ç»­ä»ä¸Šæ¬¡æ¶ˆè´¹åˆ°çš„ offset æ¥ç»§ç»­æ¶ˆè´¹å§â€; --- å¦‚æœæ¶ˆè´¹ç«¯çªç„¶å´©æ‰, æ­¤æ—¶è¿˜æ²¡æœ‰å°†å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯çš„offsetæäº¤, é‡å¯åå°±ä¼šé‡å¤æ¶ˆè´¹æ¶ˆæ¯

- æ€ä¹ˆè§£å†³å‘¢,éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡æ¥çœ‹: (é˜²æ­¢æ¶ˆæ¯é‡å¤/ä¿è¯å¹‚ç­‰æ€§ - æ¶ˆæ¯é‡å¤ä¸å¯æ€•, é‡è¦çš„æ˜¯è¦ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§)

  - æ¯”å¦‚ä½ æ‹¿ä¸ªæ•°æ®è¦å†™åº“ï¼Œä½ å…ˆæ ¹æ®ä¸»é”®æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœè¿™æ•°æ®éƒ½æœ‰äº†ï¼Œä½ å°±åˆ«æ’å…¥äº†ï¼Œupdate ä¸€ä¸‹

  - æ¯”å¦‚ä½ æ˜¯å†™ Redisï¼Œé‚£æ²¡é—®é¢˜äº†ï¼Œåæ­£æ¯æ¬¡éƒ½æ˜¯ setï¼Œå¤©ç„¶å¹‚ç­‰æ€§ã€‚

  - ç”Ÿäº§è€…å‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œé‡Œé¢åŠ ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ id, æ¶ˆè´¹åˆ°äº†ä¹‹åï¼Œå…ˆæ ¹æ®è¿™ä¸ª id å»æ¯”å¦‚ Redis é‡ŒæŸ¥ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æŸ¥åˆ°, è¯æ˜æ²¡æœ‰æ¶ˆè´¹è¿‡ï¼Œå¤„ç†ï¼Œç„¶åè¿™ä¸ª id å†™ Redisã€‚å¦‚æœæ¶ˆè´¹è¿‡äº†ï¼Œå°±åˆ«å¤„ç†äº†

#### 3.2.2.2. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±

é˜²æ­¢æ¶ˆæ¯ä¸¢å¤± - æ¶ˆæ¯å¯èƒ½åœ¨ä¸‰ä¸ªç‚¹ä¸¢å¤± -- æ¶ˆè´¹è€…,mq,ç”Ÿäº§è€… ;  RabbitMQ å’Œ Kafka çš„æœºåˆ¶ä¸åŒ

- å¯¹äºrabbitmq:

  - ç”Ÿäº§è€…å°†æ•°æ®å‘é€åˆ° RabbitMQ çš„æ—¶å€™ï¼Œå¯èƒ½æ•°æ®å°±åœ¨åŠè·¯ç»™æä¸¢äº†

    - åˆ©ç”¨äº‹åŠ¡(åŒæ­¥æ¨¡å¼çš„,ååé‡ä¸‹é™,ä¸å¥½ç”¨) - å‘é€æ•°æ®ä¹‹å‰,å¼€å¯ RabbitMQ äº‹åŠ¡channel.txSelect, å¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸè¢« RabbitMQ æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¼šæ”¶åˆ°å¼‚å¸¸æŠ¥é”™ï¼Œæ­¤æ—¶å°±å¯ä»¥å›æ»šäº‹åŠ¡channel.txRollback,å¦‚æœæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯ä»¥æäº¤äº‹åŠ¡channel.txCommit

    - é€šè¿‡ å¼€å¯ confirm æ¨¡å¼(å¼‚æ­¥æ¨¡å¼çš„, ä¸ä¼šé˜»å¡) - å¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª ack æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚å¦‚æœ RabbitMQ æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå›è°ƒä½ çš„ä¸€ä¸ª nack æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•

  - rabbitmqå¼„ä¸¢æ¶ˆæ¯ - å¼€å¯ RabbitMQ çš„æŒä¹…åŒ–. 
  
    ç¬¬ä¸€æ­¥,åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–,è¿™æ ·å°±å¯ä»¥ä¿è¯ RabbitMQ æŒä¹…åŒ– queue çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ä¼šæŒä¹…åŒ– queue é‡Œçš„æ•°æ®çš„ã€‚
    
    ç¬¬äºŒä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ deliveryMode è®¾ç½®ä¸º 2 ,å°±æ˜¯å°†æ¶ˆæ¯è®¾ç½®ä¸ºæŒä¹…åŒ–çš„ï¼Œæ­¤æ—¶ RabbitMQ å°±ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šå»

  - æ¶ˆè´¹è€…å¼„ä¸¢æ¶ˆæ¯ - RabbitMQ æä¾›çš„ ack æœºåˆ¶, å¿…é¡»å…³é—­ RabbitMQ çš„è‡ªåŠ¨ ack, ç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ ackä¸€ä¸‹, å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰å¤„ç†å®Œå°±æŒ‚äº†,rabbitmqæ²¡æœ‰æ”¶åˆ°ack,ä¼šå°†è¿™ä¸ªæ¶ˆæ¯å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…å¤„ç†;

- å¯¹äºKafka:

  - æ¶ˆè´¹ç«¯ä¸¢å¤±æ¶ˆæ¯ - æ­£å¸¸æ¥è¯´, kafkaæ˜¯æ¯éš”ä¸€æ®µå®è·µå°±æäº¤ä¸€æ¬¡offset, å¦‚æœæ¶ˆè´¹ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯è¿˜æ²¡å¤„ç†, ç¢°åˆ°kafkaåˆšå¥½è‡ªåŠ¨æäº¤äº†offset, å¤„ç†æ¶ˆæ¯æ—¶æ¶ˆè´¹ç«¯æŒ‚æ‰äº†,å°±é€ æˆäº†æ¶ˆæ¯ä¸¢å¤±; è¿™å’Œ rabbitmqçš„æ¶ˆè´¹ç«¯(ackæœºåˆ¶)ç±»ä¼¼; æ­¤æ—¶åªè¦å…³é—­offset, å¤„ç†å®Œæ‰‹åŠ¨æäº¤offset

  - kafkaå¼„ä¸¢æ¶ˆæ¯
  
    - æŸä¸ªbrokeræŒ‚äº†, ç„¶åå›é‡æ–°é€‰ä¸¾ partition çš„ leader,è¦æ˜¯æ­¤æ—¶å…¶ä»–brokerä¸­çš„ follower åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥, ç„¶åé€‰ä¸¾æŸä¸ª follower æˆ leader ä¹‹å,æ•°æ®å°±ä¸¢å¤±äº†

    - å¦‚ä½•è§£å†³å‘¢: (ä¿è¯åœ¨ leader æ‰€åœ¨ broker å‘ç”Ÿæ•…éšœï¼Œè¿›è¡Œ leader åˆ‡æ¢æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚)

      - ç»™ topic è®¾ç½® replication.factor å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬
      - åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® min.insync.replicas å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§
      

  - ç”Ÿäº§è€…ä¸¢å¤±æ•°æ® 

    - è®¾ç½® `acks=all`, å’Œ `retries=MAX`åå°±å¯ä»¥ä¿è¯æ²¡æœ‰æ•°æ®ä¸¢å¤±äº†;
      - åœ¨ producer ç«¯è®¾ç½® acks=allï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†ã€‚
      - åœ¨ producer ç«¯è®¾ç½® retries=MAXï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚
    - ä¸è¦ä½¿ç”¨ send(xxx, xxx), è€Œæ˜¯ä½¿ç”¨ send(xxx, xxx, callback), åœ¨ callback é‡Œå¤„ç†å‘é€å¤±è´¥çš„åçš„è¡¥å¿æªæ–½


#### 3.2.2.3. å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåº

ä¿è¯æ¶ˆæ¯é¡ºåºæ€§, æ²¡æœ‰é¡ºåºä¼šé€ æˆä»€ä¹ˆé—®é¢˜? 

æ¯”å¦‚ä¸¤ä¸ªæ•°æ®åº“é€šè¿‡ binglog åŒæ­¥æ•°æ®, binglog ä¸­æœ‰å¢åŠ ,ä¿®æ”¹,åˆ é™¤ä¸‰ä¸ªæ“ä½œ, å¦‚æœæ¶ˆè´¹è€…è¯»å–çš„é¡ºåºå˜äº†,åŒæ­¥æ•°æ®å°±é”™äº†; rabbitå’Œkafkaæœºåˆ¶ä¸åŒåˆ†å¼€æ¥è¯´

- å¯¹äº rabbitmq:

  é—®é¢˜: ä¸€ä¸ªqueue, å¤šä¸ªconsumer, msg1,msg2,msg3 é¡ºåºè¿›å…¥queue, ç»“æœæŸä¸ªæ¶ˆè´¹è€…å…ˆå¾—åˆ°msg2, é‚£ä¹ˆé¡ºåºå°±å˜äº†;

  è§£å†³æ–¹æ³•1: rabbitä¸­å°†ä¸€ä¸ª queue, æ›¿æ¢ä¸ºå¤šä¸ª queue, æ¯ä¸ªconsumerå¯¹åº”ä¸€ä¸ªqueue, ä¸€ç»„æœ‰åºçš„æ¶ˆæ¯ä¸€èµ·è¢«å‘é€åˆ°ä¸€ä¸ªqueue, è¢«åŒä¸€ä¸ªconsumeræ¶ˆè´¹; 
  
  æ–¹æ³•2: æˆ–è€…åªæœ‰ä¸€ä¸ªqueue, å’Œä¸€ä¸ªconsumer, åœ¨consumerå†…éƒ¨ç»´æŠ¤å†…å­˜é˜Ÿåˆ—åšæ’é˜Ÿ, åˆ†å‘ç»™ä¸åŒçš„workerå¤„ç†;

- å¯¹äºKafka

    æ–¹æ³•:  å¯¹æŸä¸ª topic è®¾ç½® N ä¸ªpartitionï¼Œè¿›æ¥çš„æ•°æ®æ ¹æ® key å¯¹ N å–ä½™æ•°, å…·æœ‰ç›¸åŒ ä½™æ•°çš„çš„æ•°æ®éƒ½åˆ°åŒä¸€ partition, è€Œ partition å†…éƒ¨æ˜¯æœ‰åºçš„,è¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§

#### 3.2.2.4. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯çš„å¤§é‡ç§¯å‹

æ¶ˆæ¯å¤§é‡ç§¯å‹çš„é—®é¢˜: consumerå‡ºç°é—®é¢˜, ä¸æ¶ˆè´¹äº†; -- ä¸´æ—¶ç´§æ€¥æ‰©å®¹æ¶ˆæ¯é˜Ÿåˆ—

- å…ˆä¿®å¤consumerçš„é—®é¢˜, è¿™æ˜¯è‚¯å®šè¦åšäº†, ç„¶åå°†æ‰€æœ‰çš„consumeråœæ­¢;
- æ–°å»ºå®¹é‡æ›´å¤§çš„æ¶ˆæ¯é˜Ÿåˆ—, å†™ä¸€ä¸ªä¸´æ—¶çš„åˆ†å‘æ•°æ®çš„consumer, å°†æ¶ˆæ¯è½¬å…¥åˆ°å¤§å®¹é‡çš„é˜Ÿåˆ—ä¸­
- ç„¶åå°†ä¿®å¤å¥½çš„consumeréƒ¨ç½²åˆ°10å€æ•°é‡çš„æœºå™¨ä¸Š, å¯åŠ¨, æ¶ˆè´¹ä¸´æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯(ç›¸å½“äºå°†queueèµ„æº, consumerèµ„æºéƒ½ä¸´æ—¶æ‰©å¤§äº†)
- ç­‰æ¶ˆè´¹å®Œç§¯å‹çš„æ¶ˆæ¯å, æ¢å¤åŸå…ˆçš„queueå’Œconsumeræ¶æ„;

#### 3.2.2.5. å¦‚ä½•é˜²æ­¢æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆ

æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆ - æ¯”å¦‚ rabbitmq ä¸­å¯ä»¥è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´, ç§¯å‹è¿‡äº†è¿™ä¸ªæ—¶é—´, æ¶ˆæ¯å›ç›´æ¥ä¸¢å¤±; æ€ä¹ˆè§£å†³: é‡æ–°å¯¼å…¥, åœ¨åŠå¤œæµé‡å°çš„æ—¶å€™, å†™ä¸´æ—¶ç¨‹åº, åœ¨æ¶ˆè´¹è€…ä¸­å°†ä¸¢å¤±çš„æ¶ˆæ¯æŸ¥å‡ºæ¥,é‡æ–°å‘é€åˆ°queueä¸­(æ¯”å¦‚åœ¨è®¢å•æœåŠ¡ä¸­æŸ¥æ‰¾ä¸¢å¤±çš„1000ä¸ªè®¢å•, é‡æ–°å¯¼å…¥åˆ°queueä¸­ç»™åº“å­˜æœåŠ¡æ¶ˆè´¹;)

#### 3.2.2.6. å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼æœ€ç»ˆä¸€è‡´æ€§

åˆ†å¸ƒå¼æœ€ç»ˆä¸€è‡´æ€§é—®é¢˜ (æ­£å¸¸æ¥è¯´mqä¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§,ä½†æ˜¯å¦‚æœç”Ÿäº§è€…ç³»ç»Ÿå¤„ç†æˆåŠŸç›´æ¥è¿”å›æˆåŠŸ, æŸä¸ªæ¶ˆè´¹è€…ç³»ç»Ÿå‡ºç°å¼‚å¸¸,æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§å°±æ— æ³•ä¿è¯ -- éœ€è¦å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡)


# 4. æœ‰å“ªäº›äº§å“å¯ä¾›é€‰æ‹©-é€‰å‹

ActiveMQ, RabbitMQï¼ŒRocketMQï¼ŒKafkaï¼ŒRedis

é€‰æ‹©å“ªä¸ªå¥½å‘¢

- ActiveMQ - Javaå®ç°ï¼Œå‡ºç°çš„æœ€æ—©ï¼Œæ€§èƒ½æ²¡æœ‰åæ¥çš„mqå¥½ï¼›ç”¨çš„è¾ƒå°‘;

- RabbitMQ - erlangå®ç°ï¼Œæ€§èƒ½å¥½ï¼Œ åå°ç®¡ç†ç•Œé¢ï¼›ç¤¾åŒºæ´»è·ƒï¼›

  - åŒ…å«ç»„ä»¶: rabbit-mq server, 

  - é«˜å¯ç”¨æ–¹æ¡ˆé‡‡ç”¨çš„æ˜¯ "é›†ç¾¤é•œåƒ"åŠŸèƒ½, å¹¶ä¸æ˜¯åˆ†å¸ƒå¼, æ¯ä¸ªèŠ‚ç‚¹ä¿å­˜å…¨é‡æ•°æ®, æ— æ³•æ— çº¿æ‹“å±•

- rocket - å¯ä»¥è¯´æ˜¯kafkaçš„å˜ç§, javaç‰ˆæœ¬å®ç°, é˜¿é‡Œå¼€æº; rocketå’Œkafkaæœ‰ç±»ä¼¼æ— é™å †ç§¯çš„èƒ½åŠ›ï¼›æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡

  - ç»„ä»¶: name server, broker

  - é«˜å¯ç”¨: name-server cluster is used to save the meta data, åªè¦æœ‰ä¸€å° name-server å­˜æ´»å°±å¯ç”¨

- redis:  å¸¸å¸¸ç”¨äºç¼“å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸æ˜¯ä¸»è¦åŠŸèƒ½

  - redis æ¶ˆæ¯æ¨é€ï¼ˆåŸºäºåˆ†å¸ƒå¼ pub/subï¼‰å¤šç”¨äºå®æ—¶æ€§è¾ƒé«˜çš„æ¶ˆæ¯æ¨é€ï¼Œå¹¶ä¸ä¿è¯å¯é ; å…¶ä»–çš„mqå’Œkafkaä¿è¯å¯é ä½†æœ‰ä¸€äº›å»¶è¿Ÿ

  - redis å‘å¸ƒè®¢é˜…é™¤äº†è¡¨ç¤ºä¸åŒçš„ topic å¤–ï¼Œå¹¶ä¸æ”¯æŒåˆ†ç»„

- Kafka - çœŸæ­£çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸»è¦ç”¨äºæ—¥å¿—é‡‡é›†ï¼Œå®æ—¶æ•°æ®è®¡ç®—ï¼ˆspark streamingï¼Œstormä¸€èµ·ç”¨ï¼‰

  - kafkaä¸­å‘å¸ƒä¸€ä¸ªä¸œè¥¿ï¼Œå¤šä¸ªè®¢é˜…è€…å¯ä»¥åˆ†ç»„ï¼ŒåŒä¸€ä¸ªç»„é‡Œåªæœ‰ä¸€ä¸ªè®¢é˜…è€…ä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥ç”¨ä½œè´Ÿè½½å‡è¡¡

  - å®æ—¶logåˆ†æ, åº”ä»˜å¤§å¹¶å‘

- Pulsar - 

  - ç»„ä»¶: zookeeper, book-keeper, broker

# 5. RabbitMQ

## 5.1. AMQPåè®®

### 5.1.1. æ¦‚å¿µ

https://blog.yoodb.com/yoodb/article/detail/1347

AMQPï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰æ˜¯ä¸€ä¸ªç½‘ç»œåè®®ã€‚å®ƒæ”¯æŒç¬¦åˆè¦æ±‚çš„å®¢æˆ·ç«¯åº”ç”¨ï¼ˆapplicationï¼‰å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ï¼ˆmessaging middleware brokerï¼‰ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚

- Server: ä¸­é—´ä»¶æœ¬ä½“, æ¥æ”¶ client è¿æ¥

- virtual host: ä¸€ä¸ª virtual host è¡¨ç¤ºä¸€ä¸ªäº¤æ¢å™¨ã€æ¶ˆæ¯é˜Ÿåˆ—çš„é›†åˆ. 

  æƒé™æ§åˆ¶çš„æœ€å°ç²’åº¦æ˜¯Virtual Host

  æ¯ä¸ª vhost æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª mini ç‰ˆçš„ RabbitMQ æœåŠ¡å™¨ï¼Œæ‹¥æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šå’Œæƒé™æœºåˆ¶

  è¿æ¥æ—¶å¿…é¡»æŒ‡å®š, RabbitMQ é»˜è®¤çš„ vhost æ˜¯ / 

- Exchange: æ¥å—ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®Bindingè§„åˆ™å°†æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—ã€‚ å°±æ˜¯ä¸€ä¸ªè·¯ç”±è¡¨

  ExchangeTypeå†³å®šäº†Exchangeè·¯ç”±æ¶ˆæ¯çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œåœ¨RabbitMQä¸­ï¼ŒExchangeTypeæœ‰directã€Fanoutå’ŒTopicä¸‰ç§ï¼Œä¸åŒç±»å‹çš„Exchangeè·¯ç”±çš„è¡Œä¸ºæ˜¯ä¸ä¸€æ ·çš„

- Binding: ç”¨äº Exchangeä¸Message Queue çš„å…³è”

  Exchangeåœ¨ä¸å¤šä¸ªMessage Queueå‘ç”ŸBindingåä¼šç”Ÿæˆä¸€å¼ è·¯ç”±è¡¨ï¼Œè·¯ç”±è¡¨ä¸­å­˜å‚¨ç€Message Queueæ‰€éœ€æ¶ˆæ¯çš„é™åˆ¶æ¡ä»¶å³Binding Keyã€‚å½“Exchangeæ”¶åˆ°Messageæ—¶ä¼šè§£æå…¶Headerå¾—åˆ°Routing Keyï¼ŒExchangeæ ¹æ®Routing Keyä¸Exchange Typeå°†Messageè·¯ç”±åˆ°Message Queueã€‚Binding Keyç”±Consumeråœ¨Binding Exchangeä¸Message Queueæ—¶æŒ‡å®šï¼Œè€ŒRouting Keyç”±Producerå‘é€Messageæ—¶æŒ‡å®šï¼Œä¸¤è€…çš„åŒ¹é…æ–¹å¼ç”±Exchange Typeå†³å®š

  Exchange å’ŒQueueçš„ç»‘å®šå¯ä»¥æ˜¯å¤šå¯¹å¤šçš„å…³ç³»


- Message Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨è¿˜æœªè¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯

- broker å„ç§å„æ ·çš„ exchange å’Œ queue åˆåœ¨ä¸€èµ·æˆä¸º broker

- Message: ç”±Headerå’ŒBodyç»„æˆï¼Œ

  Headeræ˜¯ç”±ç”Ÿäº§è€…æ·»åŠ çš„å„ç§å±æ€§çš„é›†åˆï¼ŒåŒ…æ‹¬Messageæ˜¯å¦è¢«æŒä¹…åŒ–ã€ç”±å“ªä¸ªMessage Queueæ¥å—ã€ä¼˜å…ˆçº§æ˜¯å¤šå°‘ç­‰ã€‚
  
  è€ŒBodyæ˜¯çœŸæ­£éœ€è¦ä¼ è¾“çš„APPæ•°æ®

-Channel:ä¿¡é“ï¼Œä»…ä»…åˆ›å»ºäº†å®¢æˆ·ç«¯åˆ°Brokerä¹‹é—´çš„è¿æ¥åï¼Œå®¢æˆ·ç«¯è¿˜æ˜¯ä¸èƒ½å‘é€æ¶ˆæ¯çš„ã€‚éœ€è¦ä¸ºæ¯ä¸€ä¸ªConnectionåˆ›å»ºChannelï¼ŒAMQPåè®®è§„å®šåªæœ‰é€šè¿‡Channelæ‰èƒ½æ‰§è¡ŒAMQPçš„å‘½ä»¤ã€‚

  ä¸€ä¸ªConnectionå¯ä»¥åŒ…å«å¤šä¸ªChannelã€‚å› ä¸ºå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´å»ºç«‹å’Œé”€æ¯ TCP éƒ½æ˜¯éå¸¸æ˜‚è´µçš„å¼€é”€ï¼Œæ‰€ä»¥å¼•å…¥äº†ä¿¡é“çš„æ¦‚å¿µï¼Œä»¥å¤ç”¨ä¸€æ¡ TCP è¿æ¥ã€‚

### 5.1.2. å·¥ä½œè¿‡ç¨‹

æ¶ˆæ¯ï¼ˆmessageï¼‰è¢«å‘å¸ƒè€…ï¼ˆpublisherï¼‰å‘é€ç»™äº¤æ¢æœºï¼ˆexchangeï¼‰, 

ç„¶åäº¤æ¢æœºå°†æ”¶åˆ°çš„æ¶ˆæ¯æ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘ç»™ç»‘å®šçš„é˜Ÿåˆ—ï¼ˆqueueï¼‰ã€‚

æœ€åAMQPä»£ç†ä¼šå°†æ¶ˆæ¯æŠ•é€’ç»™è®¢é˜…äº†æ­¤é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ï¼Œæˆ–è€…æ¶ˆè´¹è€…æŒ‰ç…§éœ€æ±‚è‡ªè¡Œè·å–

### 5.1.3. æ¶ˆæ¯ç¡®è®¤

æ¥æ”¶æ¶ˆæ¯çš„åº”ç”¨ä¹Ÿæœ‰å¯èƒ½åœ¨å¤„ç†æ¶ˆæ¯çš„æ—¶å€™å¤±è´¥ã€‚åŸºäºæ­¤åŸå› ï¼ŒAMQPæ¨¡å—åŒ…å«äº†ä¸€ä¸ªæ¶ˆæ¯ç¡®è®¤ï¼ˆmessage acknowledgementsï¼‰çš„æ¦‚å¿µï¼šå½“ä¸€ä¸ªæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­æŠ•é€’ç»™æ¶ˆè´¹è€…åï¼ˆconsumerï¼‰ï¼Œæ¶ˆè´¹è€…ä¼šé€šçŸ¥ä¸€ä¸‹æ¶ˆæ¯ä»£ç†ï¼ˆbrokerï¼‰

å½“â€œæ¶ˆæ¯ç¡®è®¤â€è¢«å¯ç”¨çš„æ—¶å€™ï¼Œæ¶ˆæ¯ä»£ç†ä¸ä¼šå®Œå…¨å°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œç›´åˆ°å®ƒæ”¶åˆ°æ¥è‡ªæ¶ˆè´¹è€…çš„ç¡®è®¤å›æ‰§ï¼ˆacknowledgementï¼‰


## 5.2. åŸºæœ¬ä»‹ç»


ç”± Erlang è¯­è¨€å¼€å‘çš„ AMQP çš„å¼€æºå®ç°, å¯é›†ç¾¤, æœ‰ ui ç•Œé¢, æœ‰æ’ä»¶æœºåˆ¶

ä¿è¯æ¶ˆæ¯å¯é : RabbitMQ ä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯å¯é æ€§

- msg ack `æ¶ˆæ¯ç¡®è®¤(message acknowledgement)`: æœ‰å¤šä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹, ä¸€ä¸ªconsumerå¤„ç†æ¶ˆæ¯æ—¶æŒ‚äº†, è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰ "æ¶ˆæ¯ç¡®è®¤" å‘ç»™ rabbitmq, é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸ä¼šåˆ é™¤, ä¼šå°è¯•å‘é€ç»™å¦å¤–çš„consumerå¤„ç†

- æŒä¹…åŒ–:message, queue æŒä¹…åŒ–, å³ä½¿ rabbitmq é‡å¯, é˜Ÿåˆ—, æ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±

- å…¬å¹³å‘å¸ƒ: ä¸€ä¸ªconsumer åŒæ—¶åªèƒ½æ¥å—ä¸€ä¸ªæ¶ˆæ¯, å‘é€ç»™ rabbitmq ä¸€ä¸ªæ¶ˆæ¯å›æ‰§åæ‰ä¼šè¢«å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯, é¿å…äº†ä¸€ä¸ªconsumerç‰¹åˆ«å¿™ç¢Œ, ä¸€ä¸ªconsumerç‰¹åˆ«é—²çš„é—®é¢˜


å…¶ä»–ç‰¹æ€§:

- è™šæ‹Ÿä¸»æœº(vhost): æ”¯æŒå°†ä¸€ä¸ª rabbit å®ä¾‹åˆ’åˆ†æˆå¤šä¸ª è™šæ‹Ÿå®ä¾‹, åˆ†åˆ«ç»™ä¸åŒçš„ç³»ç»Ÿç”¨, èµ·åˆ°éš”ç¦»çš„æ•ˆæœ, ä¸€ä¸ªç³»ç»Ÿå¯¹åº”çš„è™šæ‹Ÿä¸»æœºå´©äº†, ä¸å½±å“å‰©ä¸‹çš„è™šæ‹Ÿä¸»æœº

- é›†ç¾¤: æ˜¯é•œåƒé›†ç¾¤, åªèƒ½æé«˜ååé‡, æ— æ³•ä¿è¯å¯æ— é™æ‹“å±•


å®‰è£…:

https://blog.csdn.net/qq_22638399/article/details/81704372

erlang å‘½ä»¤è¡Œé€€å‡ºï¼šhttps://blog.csdn.net/cnxieyang/article/details/52710967

WSL ä¸­æœ‰bug ï¼Œ å‘çˆ¹è´§

docker + rabbitmqï¼šhttps://www.jianshu.com/p/14ffe0f3db94


## 5.3. å‡ ç§æ¶ˆæ¯æ¨¡å‹

RabbitMQæä¾›äº†6ç§æ¶ˆæ¯æ¨¡å‹ï¼Œä½†æ˜¯ç¬¬6ç§å…¶å®æ˜¯RPCï¼Œå¹¶ä¸æ˜¯MQ; 3ã€4ã€5è¿™ä¸‰ç§éƒ½å±äºè®¢é˜…æ¨¡å‹ï¼Œåªä¸è¿‡è¿›è¡Œè·¯ç”±çš„æ–¹å¼ä¸åŒã€‚

### 5.3.1. hello-world

```
+------------------+                                                                  +---------------------+
|                  |                                                                  |                     |
|                  |              +------+----+-----+-----+-----+-----+               |                     |
|                  |              |      |    |     |     |     |     |               |                     |
|    publisher     |              | queue|    |     |     |     |     |               |       consumer      |
|                  |              |      |    |     |     |     |     |               |                     |
|                  +---------->   |      |    |     |     |     |     +-------------->+                     |
|                  |              |      |    |     |     |     |     |               |                     |
|                  |              |      |    |     |     |     |     |               |                     |
|                  |              +------+----+-----+-----+-----+-----+               |                     |
|                  |                                                                  +---------------------+
+------------------+


```

### 5.3.2. worker-queue

è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸€æ—¦æ¶ˆ
è´¹ï¼Œå°±ä¼šæ¶ˆå¤±ï¼Œå› æ­¤æ¶ˆæ¯ä¸ä¼šé‡å¤æ¶ˆè´¹

```
+--------------+         +------+----+-----+        +-------------+
|              |         |      |    |     |        |             |
               |         | queue|    |     |        | consumer    |
|   publisher  |         |      |    |     |        |             |
|              +----->   |      |    |     | -------+             |
|              |         |      |    |     |        +-------------+
|              |         |      |    |     |        +--------------+
+--------------+         +------+----+-+---+        |              |
                                       |            |    consumer  |
                                       +------------+              |
                                                    |              |
                                                    +--------------+


```

### 5.3.3. å‘å¸ƒè®¢é˜…

å¯ä»¥åˆ†ä¸‰ç±» (å®é™…ä¸Šå¯¹åº”äº†ä¸‰ç§Exchangeç±»å‹)




=================å¹¿æ’­è®¢é˜…: å¯¹åº” exchange type ä¸º fanout

- provider å‘ exchange å‘é€æ¶ˆæ¯

- exchange å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰ queue (æ¶ˆæ¯è¢«å¹¿æ’­)

  exchange å’Œæ‰€æœ‰ queue ç»‘å®š

- consumer ä» queue æ‹¿åˆ°æ¶ˆæ¯ 

  è‹¥ ä¸¤ä¸ª consumer ä»åŒä¸€ä¸ª queue æ‹¿å»æ¶ˆæ¯, æ¶ˆæ¯ä¸ä¼šé‡å¤

  è‹¥ä¸¤ä¸ª consumer ä»ä¸åŒ queue æ‹¿æ¶ˆæ¯, ä¼šé‡å¤ (ä¹Ÿå°±æ˜¯æ¶ˆæ¯è¢«å¹¿æ’­äº†)


```
                                        +------+
                                        |      |
                                        +------+       +---------+
                                        |      |       |         |
                            +-----------+      +-------+   consumer
                            |           +------+       |         |
+-------------+             |           |      |       +---------+
|             |     +-------+-+         +------+
|             +-----+exchange |
|    publisher|     |         |        +------+
|             |     +-------+-+        |      |
+-------------+             |          +------+      +------------+
                            +----------+      +------+            |
                     type: fanout      +------+      |  consumer  |
                                       +------+      |            |
                                                     +------------+

```


=======================è·¯ç”±è®¢é˜…: exchange type ä¸º Direct

- provider å‘ exchange å‘é€æ¶ˆæ¯, å¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„routing key

- exchange æ¥æ”¶æ¶ˆæ¯, ç„¶åæŠŠæ¶ˆæ¯é€’äº¤ç»™ ä¸routing keyå®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—

  queue æŒ‡å®šæ¥æ”¶å“ªäº› routing key

  å¦‚ æŸä¸ªæ¶ˆæ¯ msg1 (routing key = xxx), msg2 (key = yyy), msg3 (key = zzz), queue1 (æŒ‡å®š routing key = xxx), queue2 (key = xxx, yyy), é‚£ä¹ˆ queue1 çš„consumerä¼šæ¥æ”¶åˆ° msg1, queue2 çš„consumer ä¼šæ¥æ”¶åˆ° msg1, msg2. 

- å„ä¸ª consumer ä» è‡ªå·±çš„queueæ‹¿å»æ¶ˆæ¯



=============================topic ä¸»é¢˜è®¢é˜…: exchange type = topic. æ˜¯è·¯ç”±è®¢é˜…çš„å‡çº§ç‰ˆ, routing key æ”¯æŒé€šé…ç¬¦

- #ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ (æ³¨æ„ä¸æ˜¯å­—æ¯)
- *ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½ 1 ä¸ªè¯


### 5.3.4. rpc



## 5.4. ä½¿ç”¨ rabbit

springbootæ•´åˆ

å¼•å…¥ `spring-boot-starter-amqp` (ç¬¦åˆ amqp åè®®çš„å®ç°éƒ½å¯ä»¥ç”¨)

### 5.4.1. æ¶ˆæ¯çš„åºåˆ—åŒ–

RabbitMQ çš„åºåˆ—åŒ–æ˜¯æŒ‡ Message çš„ body å±æ€§ï¼Œå³æˆ‘ä»¬çœŸæ­£éœ€è¦ä¼ è¾“çš„å†…å®¹ï¼Œ

RabbitMQ æŠ½è±¡å‡ºä¸€ä¸ª MessageConvert æ¥å£å¤„ç†æ¶ˆæ¯çš„åºåˆ—åŒ–, å½“è°ƒç”¨äº† convertAndSend æ–¹æ³•æ—¶ä¼šä½¿ç”¨ MessageConvert è¿›è¡Œæ¶ˆæ¯çš„åºåˆ—åŒ–ï¼Œå…¶å®ç°æœ‰ : 

- SimpleMessageConverterï¼ˆé»˜è®¤ï¼‰

  å¯¹äºè¦å‘é€çš„æ¶ˆæ¯ä½“ body ä¸º byte[] æ—¶ä¸è¿›è¡Œå¤„ç†ï¼Œ
  
  å¦‚æœæ˜¯ String åˆ™è½¬æˆå­—èŠ‚æ•°ç»„,
  
  å¦‚æœæ˜¯ Java å¯¹è±¡ï¼Œåˆ™ä½¿ç”¨ jdk åºåˆ—åŒ–å°†æ¶ˆæ¯è½¬æˆå­—èŠ‚æ•°ç»„ï¼Œè½¬å‡ºæ¥çš„ç»“æœè¾ƒå¤§ï¼Œå«classç±»åï¼Œç±»ç›¸åº”æ–¹æ³•ç­‰ä¿¡æ¯ã€‚å› æ­¤æ€§èƒ½è¾ƒå·®;æ­¤æ—¶å°±è¦è€ƒè™‘ä½¿ç”¨ç±»ä¼¼ Jackson2JsonMessageConverter ç­‰åºåˆ—åŒ–å½¢å¼ä»¥æ­¤æé«˜æ€§èƒ½

- Jackson2JsonMessageConverter ;

è¦è‡ªå®šä¹‰éœ€è¦å¦‚ä¸‹é…ç½®:

```java
@Configuration
public class MyAMQPConfig {
    @Bean
    public MessageConverter messageConverter(){
          return new Jackson2JsonMessageConverter();
    }
}
```

æˆ–è€…:

```java
@Configuration
public class RabbitMQConfig {

    @Bean
    public RabbitListenerContainerFactory<?> rabbitListenerContainerFactory(ConnectionFactory connectionFactory){
        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        factory.setMessageConverter(new MessageConverter() {
            @Override
            public Message toMessage(Object object, MessageProperties messageProperties) throws MessageConversionException {
                return null;
            }

            @Override
            public Object fromMessage(Message message) throws MessageConversionException {
                try(ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(message.getBody()))){
                    return (User)ois.readObject();
                }catch (Exception e){
                    e.printStackTrace();
                    return null;
                }
            }
        });

        return factory;
    }

}
```

### 5.4.2. å‘é€

æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯, å•ä½æ¯«ç§’

ä½¿ç”¨é»˜è®¤çš„ exchange

```java
// éœ€è¦æ³¨å†Œä¸€ä¸ª queue, å¦åˆ™æ¶ˆæ¯åªä¼šåˆ° exchange, ä¸ä¼šå­˜å…¥ queue
@Configuration
public class RabbitConfig {
    @Bean
    public Queue queueHello() {
        return new Queue("hello_queue");
    }

}

// ç„¶åä½¿ç”¨:

@Autowired
private final AmqpTemplate template;

/**
* å‘é€åˆ°é»˜è®¤ exchange, ä¸ä¼šå‘é€åˆ° queue
*
*/
public void sendMessage(String msg) {
  // æ³¨æ„MessageBuilder ä¸æ˜¯å¸¦æ³›å‹çš„é‚£ä¸ª
    template.send(MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8)).build());

    // å¯ä»¥ä½¿ç”¨ convertAndSend() ç›´æ¥å‘é€å¯¹è±¡ 
}

/**
å‘é€åˆ° é»˜è®¤ exchange, ç„¶åè½¬å‘åˆ° queue (queue name  = hello_queue)

ä¹Ÿå°±æ˜¯è¯´, é»˜è®¤ exchange ä¸ç”¨ binding , å‘é€æ—¶, routing key æŒ‡å®šä¸º queue name å³å¯è¢« è¯¥ queue æ”¶åˆ°
*/
public void send1(String msg) {
  // è‡ªåŠ¨è½¬æ¢ä¸º Message åå‘é€
    this.template.convertAndSend("hello_queue", msg);
    System.out.println("sender: å‘é€äº† " + msg);
}

public void sendWithTopic(String msg, String routingKey) {
  // å‘é€ç»™æŒ‡å®šçš„ exchange
    this.template.convertAndSend("exchange", routingKey, msg);
}
```

è‡ªå·±æŒ‡å®š exchange:

```java
@Configuration
public class TopicExchangeConfig {
    @Bean
    public Queue queue1() {
        return new Queue("queue_1");
    }

    @Bean
    public Queue queue2() {
        return new Queue("queue_2");  // éœ€è¦æŒ‡å®š name
    }

    @Bean
    public TopicExchange exchange() {
        return new TopicExchange("exchange");  // éœ€è¦æŒ‡å®š name
    }

    // binding exchange and queue with routing key
    @Bean
    public Binding bindingQueue1(Queue queue1, TopicExchange exchange) {
        return BindingBuilder.bind(queue1).to(exchange).with("topic.message");
    }

    @Bean
    public Binding bindingQueue2(Queue queue2, TopicExchange exchange) {
        return BindingBuilder.bind(queue2).to(exchange).with("topic.#");
    }
}

// ä½¿ç”¨

/**
  * å¸¦ exchange å’Œ routing key å‘é€
  */
public void sendWithTopic(String msg, String routingKey) {
    this.template.convertAndSend("exchange", routingKey, msg);
}
```

### 5.4.3. æ¥æ”¶

========================å•ç‹¬ä½¿ç”¨ @RabbitListener æ³¨è§£æ¥æŒ‡å®šæŸæ–¹æ³•ä½œä¸ºæ¶ˆæ¯æ¶ˆè´¹çš„æ–¹æ³•

```java
@Component
public class Receiver2 {
    @RabbitListener(queues = "queue_2")
    public void process(String msg) { // æ¥æ”¶å‚æ•°ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡, will auto deserialize
        System.out.println("receiver2: " + msg);
    }

    @RabbitListener(queues = {"hello_queue"})
    public void processHelloQueue(String msg) {
        System.out.println(">>> receive msg from hello_queue: " + msg);
    }
}
```

========================@RabbitListener å’Œ @RabbitHandler æ­é…ä½¿ç”¨

(@RabbitListener æ ‡æ³¨åœ¨ç±»ä¸Šé¢è¡¨ç¤ºå½“æœ‰æ”¶åˆ°æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±äº¤ç»™ @RabbitHandler çš„æ–¹æ³•å¤„ç†ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªæ–¹æ³•å¤„ç†ï¼Œæ ¹æ® MessageConverter è½¬æ¢åçš„å‚æ•°ç±»å‹)

æ­¤æ—¶éœ€è¦æœ‰ä¸€ä¸ªé»˜è®¤çš„å¤„ç†æ–¹æ³• @RabbitHandler(isDefault=true)ï¼Œé»˜è®¤æ˜¯falseã€‚ä¸è®¾ç½®ä¸€ä¸ªtrueï¼Œæ¶ˆè´¹mqæ¶ˆæ¯çš„æ—¶å€™ä¼šå‡ºç°â€œListener method â€˜no matchâ€™ threw exceptionâ€å¼‚å¸¸ã€‚

```java
// ä¸º consumer æŒ‡å®š queue
// ç›‘å¬
@Component
@RabbitListener(queues = "consumer_queue")
public class Receiver {

    @RabbitHandler
    public void processMessage1(String message) {
        System.out.println(message);
    }

    @RabbitHandler
    public void processMessage2(byte[] message) {
        System.out.println(new String(message));
    }
}
```

===============ä½¿ç”¨ ä½¿ç”¨ @Payload å’Œ @Headers æ³¨è§£å¯ä»¥æ¶ˆæ¯ä¸­çš„ body ä¸ headers ä¿¡æ¯, ä¸ä½¿ç”¨çš„è¯é»˜è®¤æ–¹æ³•å‚æ•°å°±æ˜¯ body

```java
@RabbitListener(queues = "debug")
public void processMessage1(@Payload String body, @Headers Map<String,Object> headers) {
    System.out.println("bodyï¼š"+body);
    System.out.println("Headersï¼š"+headers);
}

// è·å–å•ä¸ª headerå±æ€§

@RabbitListener(queues = "debug")
public void processMessage1(@Payload String body, @Header String token) {
    System.out.println("bodyï¼š"+body);
    System.out.println("tokenï¼š"+token);
}
```


===========================ç”šè‡³ å¯ä»¥åœ¨ consumer ç«¯ é€šè¿‡ rabbitListener è®¾ç½® binding:

```java
@RabbitListener(bindings = @QueueBinding(
        exchange = @Exchange(value = "topic.exchange",durable = "true",type = "topic"),
        value = @Queue(value = "consumer_queue",durable = "true"),
        key = "key.#"
))
public void processMessage1(Message message) {
    System.out.println(message);
}
```

### 5.4.4. æŒä¹…åŒ–

ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–? ä¸­é—´ä»¶æœåŠ¡å™¨å¼‚å¸¸é‡å¯, æ•°æ®ä¼šä¸¢å¤±

æŒä¹…åŒ–ä¼šé€ æˆæ€§èƒ½æŸè€—ã€‚å¯ä»¥é€šè¿‡`è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´`ã€`é™ä½å‘é€æ¶ˆæ¯å¤§å°`ç­‰å…¶ä»–æ–¹å¼æ¥å°½å¯èƒ½çš„é™ä½MQæ€§èƒ½çš„é™ä½ã€‚

åˆ†ä¸ºå¦‚ä¸‹ä¸‰ä¸ª: (å‡å¯é€šè¿‡ æ„é€ å‡½æ•°çš„ durable æŒ‡å®š, é»˜è®¤éƒ½æ˜¯ true)

- queue çš„æŒä¹…åŒ–

  é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®

- exchange çš„æŒä¹…åŒ–

  é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®

- message çš„æŒä¹…åŒ– (å¿…é¡»åœ¨ queue çš„æŒä¹…åŒ–åŸºç¡€ä¸Šæ‰æœ‰æ„ä¹‰)

  åº•å±‚å°±æ˜¯ AMQP.BasicPropertiesçš„å±æ€§deliveryModeè®¾ç½®ä¸º2

  å‘é€æ¶ˆæ¯æ—¶, é€šè¿‡æ¶ˆæ¯åå¤„ç†è®¾ç½®æŒä¹…åŒ–`convertAndSend(.... , new MessagePostProcessor() {message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);})`





éƒ½è®¾ç½®æŒä¹…åŒ–ä¹‹åå°±èƒ½ä¿è¯æ•°æ®ä¸ä¼šè¢«ä¸¢å¤±å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œå¤šä¸ªæ–¹é¢:

- åœ¨æ¶ˆè´¹è€…ç«¯, å¦‚æœæ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤ä¸ºtrueï¼Œé‚£ä¹ˆåœ¨æ¶ˆæ¯è¢«æ¥æ”¶ä»¥åï¼ŒRabbitMQå°±ä¼šåˆ é™¤è¯¥æ¶ˆæ¯ï¼Œå‡å¦‚æ¶ˆè´¹ç«¯æ­¤æ—¶å®•æœºï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚

  å› æ­¤éœ€è¦å°†æ¶ˆæ¯è®¾ç½®ä¸ºæ‰‹åŠ¨ç¡®è®¤ã€‚å³æ¶ˆè´¹å®Œæˆåå†å‘é€ç¡®è®¤

- åœ¨rabbitmqæœåŠ¡ç«¯ï¼Œå¦‚æœæ¶ˆæ¯æ­£ç¡®è¢«å‘é€ï¼Œä½†æ˜¯rabbitmqæœªæ¥å¾—åŠæŒä¹…åŒ–ï¼Œæ²¡æœ‰å°†æ•°æ®å†™å…¥ç£ç›˜ï¼ŒæœåŠ¡å¼‚å¸¸è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œ

  è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é€šè¿‡rabbitmqé›†ç¾¤çš„æ–¹å¼å®ç°æ¶ˆæ¯ä¸­é—´ä»¶çš„é«˜å¯ç”¨æ€§


### 5.4.5. æ¶ˆæ¯ç¡®è®¤æœºåˆ¶-æ‰‹åŠ¨ç¡®è®¤-å›è°ƒ

ç¡®è®¤æœºåˆ¶æœ‰ä¸¤ç§:

#### 5.4.5.1. æ¶ˆæ¯å‘é€ç¡®è®¤

åˆ†ä¸ºä¸¤æ­¥

- æ˜¯å¦åˆ°è¾¾ exchange çš„ç¡®è®¤; 

  å®ç° RabbitTemplate.ConfirmCallBackæ¥å£ï¼Œæ¶ˆæ¯å‘é€åˆ°äº¤æ¢å™¨Exchangeåè§¦å‘å›è°ƒ (å®é™…æ˜¯å‘é€åˆ° broker å‡ºå‘å›è°ƒ, è€Œ broker åŒ…å« exchange å’Œ queue, æ‰€ä»¥å¯ä»¥è®¤ä¸º exchange å‡ºå‘å›è°ƒ)

  ä¸º rabbitTemplate é…ç½® @PostConstruct `rabbitTemplate.setConfirmCallback(new ConfirmCallBackHandler())`

  è®¾ç½® `spring.rabbitmq.publisher-confirms = true`

- æ˜¯å¦åˆ°è¾¾ queue çš„ç¡®è®¤ (æ¯”å¦‚æ ¹æ®å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šçš„routingKeyæ‰¾ä¸åˆ°é˜Ÿåˆ—æ—¶ä¼šè§¦å‘)

  å®ç° RabbitTemplate.ReturnCallback æ¥å£

  `abbitTemplate.setReturnCallback(new ReturnCallBackHandler());`

  `spring.rabbitmq.publisher-returns = true`


è‹¥æ²¡æœ‰ ack, ç”Ÿäº§è€…è¿™è¾¹ä¸šåŠ¡è¿™æ ·æ§åˆ¶: æ¯”å¦‚ç”Ÿäº§è€…æ¯æ¬¡å‘æ¶ˆæ¯ä¹‹å‰å…ˆæŠŠæ¶ˆæ¯ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¦‚æœæ”¶åˆ°ackå°±æŠŠè¿™ä¸ªæ¶ˆæ¯ç»™åˆ é™¤ï¼Œæ²¡æœ‰æ”¶åˆ°å°±éš”ä¸€æ®µæ—¶é—´é‡è¯•ï¼Œæœ€å¤šé‡è¯•ä¸ª3æ¬¡ï¼Œè¿˜æ˜¯æ²¡æ”¶åˆ°å°±æŠŠè¿™ä¸ªæ¶ˆæ¯ç™»è®°èµ·æ¥åç»­å¤„ç†ï¼Œä¸å†å‘é€äº†

```java
@configuration
class config {
  @autowired
  RabbitmqTemplate tt;


  @PostConstruct
  public void initRabbitTemplate() {
    //RabbitTemplate.ConfirmCallBack
    tt.setConfirmCallback(() -> {
      // ...
    })
  }
}
```


####  5.4.5.2. æ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤

å°±æ˜¯ æ¶ˆæ¯æ˜¯å¦è¢« consumer æ¶ˆè´¹

æœ‰ä¸‰ç§æ¨¡å¼: AcknowledgeMode.NONE/AUTO/MANUAL, é»˜è®¤æ˜¯ auto, consumer æ¥æ”¶åˆ°æ¶ˆæ¯ä¼šè‡ªåŠ¨ç¡®è®¤, ä¸ç®¡æ¶ˆæ¯æ˜¯å¦å®Œå…¨è¢«æ¶ˆè´¹å®Œæˆ, broker éƒ½ä¼šåˆ é™¤è¿™æ¡æ¶ˆæ¯,ä»»åŠ¡æ¶ˆè´¹å®Œæˆäº†

`spring.rabbitmq.listener.simple.acknowledge-mode = manual` æ‰‹åŠ¨ç¡®è®¤

å¦‚æœæ˜¯è‡ªå®šä¹‰çš„ç›‘å¬å®¹å™¨, é…ç½® `SimpleRabbitListenerContainerFactory` å³å¯

æ¶ˆè´¹è€…æˆåŠŸç¡®è®¤:

```java
@Component
@RabbitListener(queues = "confirm_queue_B")
public class Customer {
    @RabbitHandler
    public void process(Message message, Channel channel){
        System.out.println("ReceiverAï¼š"+new String(message.getBody()));
        // delivertag å°±æ˜¯ä¸€ä¸ªæ•°å­—, åœ¨ channel å†…æ¯æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯å°±è‡ªå¢
        // å‚æ•° 2: æ˜¯å¦æ‰¹é‡ç¡®è®¤æ¶ˆæ¯; ä¸€èˆ¬ä¸º false, æ¯æ¡æ¶ˆæ¯éƒ½åˆ†åˆ«ç­¾æ”¶ç¡®è®¤
        channel.basicAck(message.getMessageProperties().getDeliveryTag(),true);
}

```

æ¶ˆè´¹è€…å¤±è´¥ç¡®è®¤:

```java
Component
@RabbitListener(queues = "confirm_queue_B")
public class Customer {
    @RabbitHandler
    public void processJsonMessage(@Payload String body, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag, Message message,Channel channel){      
        System.out.println("ReceiverAï¼š"+new String(message.getBody()));
        // å‚æ•° 2: æ˜¯å¦æ‰¹é‡æ‹’ç»
        // å‚æ•° 3: æ˜¯å¦é‡æ–°åŠ å…¥ queue ç­‰å¾…æ¶ˆè´¹
        channel.basicNack(deliveryTag,true,true);
}

// è¿˜å¯ä»¥ä¸€æ¬¡åªæ‹’ç»ä¸€æ¡æ¶ˆæ¯
@Component
@RabbitListener(queues = "confirm_queue_B")
public class Customer {
     public void processJsonMessage(@Payload String body, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag, Message message,Channel channel){  
        System.out.println("ReceiverAï¼š"+new String(message.getBody()));
        channel.basicReject(deliveryTag,true);
}

// channel.basicNack ä¸ channel.basicReject çš„åŒºåˆ«åœ¨äºbasicNackå¯ä»¥æ‰¹é‡æ‹’ç»å¤šæ¡æ¶ˆæ¯ï¼Œè€ŒbasicRejectä¸€æ¬¡åªèƒ½æ‹’ç»ä¸€æ¡æ¶ˆæ¯
```

æ¶ˆæ¯æ‰‹åŠ¨æ‹’ç»ä¸­å¦‚æœrequeueä¸ºtrueä¼šé‡æ–°æ”¾å…¥é˜Ÿåˆ—ï¼Œä½†æ˜¯å¦‚æœæ¶ˆè´¹è€…åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¸€ç›´æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šå¯¼è‡´å…¥é˜Ÿ-ã€‹æ‹’ç»-ã€‹å…¥é˜Ÿçš„å¾ªç¯ï¼Œè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ======== å…ˆæˆåŠŸç¡®è®¤ï¼Œç„¶åé€šè¿‡**channel.basicPublish()**é‡æ–°å‘å¸ƒè¿™ä¸ªæ¶ˆæ¯ã€‚é‡æ–°å‘å¸ƒçš„æ¶ˆæ¯ç½‘ä¸Šè¯´ä¼šæ”¾åˆ°é˜Ÿåˆ—åé¢ï¼Œè¿›è€Œä¸ä¼šå½±å“å·²ç»è¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å¤„ç†ã€‚

```java
@Component
@RabbitListener(queues = "confirm_queue_B")
public class AckTempalte {
    enum Action{
        ACCEPT, // å¤„ç†æˆåŠŸ
        RETRY, // å¯ä»¥é‡è¯•çš„é”™è¯¯
        REJECT, // æ— éœ€é‡è¯•çš„é”™è¯¯
    }
    @RabbitHandler
    public void processJsonUser(Message message, Channel channel){
        Action action=Action.ACCEPT;
        long tag=message.getMessageProperties().getDeliveryTag();
        try{
            System.out.println( message.getMessageProperties().getConsumerTag());
            String message1 = new String(message.getBody(), "UTF-8");
            System.out.println("è·å–æ¶ˆæ¯'" + message1 + "'");

        }catch (Exception e){
            // æ ¹æ®å¼‚å¸¸ç§ç±»å†³å®šæ˜¯ACCEPTã€RETRYè¿˜æ˜¯ REJECT
            action = Action.RETRY;
            e.printStackTrace();

        }finally {
            try {
                // é€šè¿‡finallyå—æ¥ä¿è¯Ack/Nackä¼šä¸”åªä¼šæ‰§è¡Œä¸€æ¬¡
                if (action == Action.ACCEPT) {
                    channel.basicAck(tag, true);
                    
                }
                // é‡è¯•
                else if (action == Action.RETRY) {
                    channel.basicNack(tag, false, true);// æœ€åä¸€ä¸ª true è¡¨ç¤º é‡æ–°å…¥ queue
                    Thread.sleep(2000L);
                } 
                // æ‹’ç»æ¶ˆæ¯ä¹Ÿç›¸å½“äºä¸»åŠ¨åˆ é™¤mqé˜Ÿåˆ—çš„æ¶ˆæ¯
                else {
                    channel.basicNack(tag, false, false);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}

```

### 5.4.6. ä½¿ç”¨ amqpAdmin é›†ä¸­é…ç½® rabbitmq

# 6. kafka

https://github.com/redpanda-data/redpanda ä»£æ›¿ kafka

## 6.1. kafka åŸºæœ¬æ¦‚å¿µ

https://www.bilibili.com/video/BV1jt4y1C7PZ?p=49

https://developer.confluent.io/learn/

åˆ†å¸ƒå¼åŸºäºå‘å¸ƒ / è®¢é˜…çš„æ¶ˆæ¯ç³»ç»Ÿæ¶ˆæ¯ä¸­é—´ä»¶

æ¨èç°åœ¨å¤§å®¶ç”¨Pulsarï¼Œç›¸æ¯” kafkaï¼Œæ›´åŠ ç®€æ´æ›´å¥½ç”¨

é€‚ç”¨äºå¯¹æ¶ˆè´¹æ¬¡åºæˆ–æ—¶é—´æ²¡æœ‰å¼ºä¸€è‡´æ€§éœ€è¦çš„åœºæ™¯

### 6.1.1. é€»è¾‘æ¶æ„

```

æœ‰è¿™ä¹ˆå‡ ä¸ªæ¦‚å¿µ:

- kafka cluster: ä¸€å° or å¤šå° server ç»„æˆ

  broker: ä¸€å° Kafka æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ªbrokerå¯ä»¥å®¹çº³å¤šä¸ª topic, é›†ç¾¤ä¸­çš„æ¯ä¸ª broker éƒ½æœ‰ä¸€ä¸ªä¸é‡å¤çš„ç¼–å·

  topic ä¸»é¢˜: å¯ä»¥ç†è§£ä¸ºæ¶ˆæ¯åˆ†ç±», æ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µ, 

    ä¸€ä¸ªä¸»é¢˜å†…çš„æ¶ˆæ¯å¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªåˆ†åŒº, åœ¨æ¯ä¸ª broker ä¸Šå¯èƒ½æ–°å»ºå¤šä¸ª topic, 
  
    å®é™…åœºæ™¯ä¸‹, ä¸€èˆ¬æ˜¯ä¸€ä¸ªä¸šåŠ¡çº¿å»ºä¸€ä¸ªtopic (producer å‘é€å¿…é¡»æŒ‡å®š topic); 
    
    è‹¥å†™å…¥çš„ topic ä¸å­˜åœ¨, kafka ä¼šè‡ªåŠ¨åˆ›å»ºä¸»é¢˜, partition å’Œ replication æ•°é‡å‡é»˜è®¤ä¸º 1

  partition åˆ†åŒº: å¯çœ‹åšå­˜å‚¨æ¶ˆæ¯çš„æœ‰åºé˜Ÿåˆ—
  
    åˆ†åŒºçš„ä½œç”¨æ˜¯åšè´Ÿè½½ , ç”¨æ¥æé«˜kafkaçš„ååé‡ã€‚ åˆ†åŒºçš„è¡¨ç°å½¢å¼å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ–‡ä»¶å¤¹, é‡Œé¢å­˜å‚¨è¿™ä¸ªåˆ†åŒºæ‰€æœ‰çš„æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ 

    æ— è®ºæ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹ï¼Œé™¤éæ¶ˆæ¯åˆ°æœŸ Partition ä»ä¸åˆ é™¤æ¶ˆæ¯, Partition ä¼šä¸ºæ¯ä¸ª Consumer Group ä¿å­˜ä¸€ä¸ªåç§»é‡ï¼Œè®°å½• Group æ¶ˆè´¹åˆ°çš„ä½ç½®

    å¯¹äºåŒä¸€ä¸ªåˆ†åŒº, æ•°æ®å†™å…¥ä¿å­˜æ˜¯æœ‰åºçš„, æ¶ˆæ¯éƒ½ä¼šè¢«è¿½åŠ åˆ° Partition æ•°æ®æ–‡ä»¶çš„å°¾éƒ¨, ç£ç›˜æ•ˆç‡å¾ˆé«˜ 

    Offset: æ¶ˆæ¯ä½ç§»,è¡¨ç¤ºåˆ†åŒºä¸­æ¯æ¡æ¶ˆæ¯çš„ä½ç½®ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢ä¸”ä¸å˜çš„å€¼

  replica å‰¯æœ¬: æ¯ä¸ªåˆ†åŒºä¼šæœ‰å¤šä¸ªå‰¯æœ¬, å‰¯æœ¬çš„ä½œç”¨æ˜¯ç”¨æ¥åšå¤‡èƒã€‚ æ¯å½“ä¸»åˆ†åŒº(leader)æ•…éšœå°±ä¼šé€‰ä¸€ä¸ªå¤‡èƒ(follower)ä¸Šä½ã€‚ é»˜è®¤å¤‡èƒæ•°æ˜¯10ä¸ªã€‚  


    - Leader ï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬çš„â€œä¸»â€ï¼Œç”Ÿäº§è€…å‘é€æ•°æ®çš„å¯¹è±¡ï¼Œä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„å¯¹è±¡éƒ½æ˜¯ Leaderã€‚

    - Follower ï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„â€œä»â€ï¼Œå®æ—¶ä» Leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’ŒLeader æ•°æ®çš„åŒæ­¥ã€‚Leader å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ª Follower ä¼šæˆä¸ºæ–°çš„ Leaderã€‚

  


- producer : é“¾æ¥broker, æŠŠæ¶ˆæ¯å‘é€åˆ°æŸä¸ªåˆ†åŒº

- consumer: æ¯ä¸ªæ¶ˆè´¹è€…éƒ½å±äºæŸä¸€ä¸ªæ¶ˆè´¹è€…ç»„

  å¯¹äºæŸä¸ªåˆ†åŒºçš„æ¶ˆæ¯
  
    åœ¨æŸä¸ª consumer group ä¸­åªèƒ½æœ‰ä¸€ä¸ª consumer å¯ä»¥æ¶ˆè´¹ (åŒä¸ªgroup ä¸­çš„å…¶ä»–consumer æ— æ³•æ¶ˆè´¹è¯¥åˆ†åŒº)

    ä¸åŒ consumer group ä¸­çš„consumer å¯æ¶ˆè´¹åŒä¸€ä¸ªåˆ†åŒºçš„æ¶ˆæ¯

  Consumer Offsetï¼šæ¶ˆè´¹è€…ä½ç§»ï¼Œè¡¨å¾æ¶ˆè´¹è€…æ¶ˆè´¹è¿›åº¦ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„æ¶ˆè´¹è€…ä½ç§»ã€‚



- ack ç¡®è®¤æœºåˆ¶
    broker è¡¨ç¤ºå‘æ¥çš„æ•°æ®å·²ç¡®è®¤æ¥æ”¶æ— è¯¯ï¼Œè¡¨ç¤ºæ•°æ®å·²ç»ä¿å­˜åˆ°ç£ç›˜ã€‚ 
    
    0ï¼šä¸ç­‰å¾… broker è¿”å›ç¡®è®¤æ¶ˆæ¯ , ç¡®è®¤è¿”å›æ•ˆç‡æœ€é«˜ï¼Œä½†ä¸ä¿è¯å‘é€æˆåŠŸã€‚å®‰å…¨æ€§ä¸å¥½ æ•ˆç‡æœ€é«˜
    1ï¼šç­‰å¾… topic ä¸­æŸä¸ª partition leader ä¿å­˜æˆåŠŸçš„çŠ¶æ€åé¦ˆ , åªéœ€è¦åˆ†åŒº leader è¿”å› ack, å°±è®¤ä¸ºå‘é€æˆåŠŸ, å¯ä»¥å‘é€ä¸‹ä¸€æ¡. åªç¡®ä¿ leader å‘é€æˆåŠŸ
    -1/allï¼šç­‰å¾… topic ä¸­æŸä¸ª partition æ‰€æœ‰å‰¯æœ¬éƒ½ä¿å­˜æˆåŠŸçš„çŠ¶æ€åé¦ˆ (åˆ†åŒºçš„æ‰€æœ‰å‰¯æœ¬éƒ½å®Œæˆå¤‡ä»½), produceræˆåŠŸæ‰è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚  å®‰å…¨æ€§æœ€å¥½ æ•ˆç‡æœ€ä½

  åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ acks=0 å¾ˆå°‘ä½¿ç”¨ï¼›acks=1ï¼Œ ä¸€èˆ¬ç”¨äºä¼ è¾“æ™®é€šæ—¥å¿— ï¼Œ å…è®¸ä¸¢ä¸ªåˆ«æ•°æ®ï¼›acks=allï¼Œä¸€èˆ¬ç”¨äºä¼ è¾“å’Œé’±ç›¸å…³çš„æ•°æ®ï¼Œå¯¹å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ ã€‚

- consumer group:  å¯ä»¥å°†å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç»„, ä½œä¸ºä¸€ä¸ªæ•´ä½“, ç”¨ä¸€ä¸ªæ ‡ç­¾æ ‡è¯†ã€‚  
  
    (ä¸åœ¨åŒä¸€ä¸ªGroup çš„Consumerèƒ½é‡å¤æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼ˆè®¢é˜…æ¨¡å¼ï¼‰ï¼Œç›¸åŒGroupçš„Consumerå­˜åœ¨æ¶ˆè´¹ç«äº‰ï¼ˆä¸ä¼šæ¶ˆè´¹åŒæ¡æ•°æ®, å³è´Ÿè½½å‡è¡¡ï¼‰)

    å¯¹äºåŒä¸€ä¸ªgroupè€Œè¨€ï¼Œtopicçš„æ¯æ¡æ¶ˆæ¯åªèƒ½è¢«å‘é€åˆ°groupä¸‹çš„ä¸€ä¸ªconsumerå®ä¾‹ä¸Š, topicæ¶ˆæ¯å¯ä»¥è¢«å‘é€åˆ°å¤šä¸ªgroupä¸­

    å¯ä»¥é€šè¿‡å¢åŠ æ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…æ¥è¿›è¡Œæ°´å¹³æ‰©å±•æå‡æ¶ˆè´¹èƒ½åŠ›, ç»„ä¸­æ¶ˆè´¹è€…çš„æ•°é‡ä¸åº”è¯¥æ¯”åˆ†åŒºæ•°å¤šï¼Œå› ä¸ºå¤šå‡ºæ¥çš„æ¶ˆè´¹è€…æ˜¯ç©ºé—²çš„ (æ‰€ä»¥åˆ›å»ºä¸»é¢˜æ—¶åº”è¯¥ä½¿ç”¨æ¯”è¾ƒå¤šçš„åˆ†åŒºæ•°)

    Kafkaçš„è®¢é˜…è€…æ˜¯é€šè¿‡æ¶ˆè´¹ç»„ï¼ˆConsumer Groupï¼‰æ¥ä½“ç°çš„ï¼Œæ¯ä¸ªæ¶ˆè´¹ç»„éƒ½å¯ä»¥é‡å¤æ¶ˆè´¹Topicä¸€ä»½å®Œæ•´çš„æ¶ˆæ¯ï¼Œä¸åŒæ¶ˆè´¹ç»„ä¹‹é—´æ¶ˆè´¹è¿›åº¦å½¼æ­¤ä¸å—å½±å“ã€‚ä¾‹å¦‚Message1èƒ½è¢«Consumer Group 1å’ŒConsumer Group2é‡Œçš„æ¶ˆè´¹è€…éƒ½æ¶ˆè´¹ä¸€æ¬¡ã€‚

    å½“æ¶ˆè´¹è€…ç¦»å¼€æ¶ˆè´¹ç»„ï¼ˆæ¯”å¦‚é‡å¯ã€å®•æœºç­‰ï¼‰æ—¶ï¼Œå®ƒæ‰€æ¶ˆè´¹çš„åˆ†åŒºä¼šåˆ†é…ç»™å…¶ä»–åˆ†åŒºã€‚è¿™ç§ç°è±¡ç§°ä¸ºé‡å¹³è¡¡ï¼ˆrebalanceï¼‰, åœ¨é‡å¹³è¡¡æœŸé—´ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½ä¸èƒ½æ¶ˆè´¹æ¶ˆæ¯ï¼Œå› æ­¤ä¼šé€ æˆæ•´ä¸ªæ¶ˆè´¹ç»„çŸ­æš‚çš„ä¸å¯ç”¨ (æ”¯æŒä¸‰ç§åˆ†é…ç­–ç•¥: https://zhuanlan.zhihu.com/p/418158376)




æ•°æ®å®Œå…¨å®‰å…¨å¯é æ€§æ¡ä»¶è®¾ç½®:

  ACK çº§åˆ«è®¾ç½®ä¸º-1 + åˆ†åŒºå‰¯æœ¬å¤§äºç­‰äº2 + ISR é‡Œåº”ç­”çš„çš„æœ€å°å‰¯æœ¬æ•°é‡å¤§äºç­‰äº2


```

### 6.1.2. ç‰©ç†æ¶æ„

partition å¯¹åº”ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤¹, ä¸€ä¸ªåˆ†åŒºæ ¹æ®å­˜å‚¨çš„æ¶ˆæ¯æ•°é‡, ä¼šæœ‰å¤šä¸ªæ–‡ä»¶å¤¹, æ–‡ä»¶å¤¹åŒ…æ‹¬ä¸‰ä¸ªæ–‡ä»¶:

```

0000000001.log    æ•°æ®æ–‡ä»¶, å­˜å‚¨æ¶ˆæ¯, æ¯æ¡æ¶ˆæ¯åŒ…æ‹¬ (æ•°æ®, offsetç¼–å·, ç‰©ç†åœ°å€)

0000000001.index  ç´¢å¼•, é‡‡ç”¨ç¨€ç–ç´¢å¼•çš„æ–¹å¼, è®°å½• log æ–‡ä»¶çš„ç´¢å¼•

  log æ–‡ä»¶æ¯å¢åŠ  4kb, è®°å½•ä¸€æ¡ç´¢å¼•ä¿¡æ¯, ç´¢å¼•ä¿¡æ¯å°±æ˜¯ offsetç¼–å· å’Œ ç‰©ç†åœ°å€çš„æ˜ å°„

0000000001.timeindex  æ—¶é—´ç´¢å¼•




```


### 6.1.3. å†™å…¥æ¶ˆæ¯å·¥ä½œæµç¨‹

```

å·¥ä½œæµç¨‹:

1. ç”Ÿäº§è€…ä»clusterä¸­è·å– partition leader çš„ä¿¡æ¯ã€‚ ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™åˆ†åŒº leaderã€‚ 
1. åˆ†åŒº leader å°†æ•ˆå…³ç³»å†™å…¥ç£ç›˜
1. follower ä» leader æ‹‰å–æ¶ˆæ¯æ•°æ®, å†™å…¥ç£ç›˜, å‘ leader å‘é€ ack æ¶ˆæ¯
1. leader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack åå‘ç”Ÿäº§è€…å‘é€ ack, è¡¨ç¤ºå†™å…¥æˆåŠŸ
```

### 6.1.4. æ¶ˆè´¹æ¶ˆæ¯çš„åŸç†

ç¨€ç–ç´¢å¼• + äºŒåˆ†æŸ¥æ‰¾

consumer çš„æ¶ˆè´¹ç­–ç•¥:

- earliest ä»å¤´å¼€å§‹æ¶ˆè´¹
- latest ä»å½“å‰ä½ç½®å¼€å§‹æ¶ˆè´¹
- none ä»æŒ‡å®šoffset å¼€å§‹æ¶ˆè´¹, è‹¥æ¶ˆè´¹è€…æ²¡æœ‰æä¾› offset åˆ™æŠ¥é”™

### 6.1.5. partition åˆ†åŒºé€‰æ‹©åŸåˆ™é€»è¾‘

```
è‹¥æŸä¸ª topic ä¸‹æœ‰å¤šä¸ª partition, producer å¦‚ä½•å†³å®šå¾€å“ªä¸ª partition å†™æ•°æ®?

- producer åœ¨å†™å…¥æ—¶, èƒ½æŒ‡å®špartition, è‹¥æŒ‡å®šäº†, è¿™å†™å…¥ç›¸åº”çš„ partition
- è‹¥producer æ²¡æŒ‡å®š partition, ä½†æ˜¯è®¾ç½®äº†æ•°æ®çš„ key, åˆ™æ ¹æ® key ä¼š hash å‡ºä¸€ä¸ª partition
- è‹¥æ²¡æœ‰æŒ‡å®š partition, ä¹Ÿæ²¡æœ‰æŒ‡å®šæ•°æ® key, kafka ä¼šé‡‡ç”¨è½®è®­çš„æ–¹å¼, æŸä¸€æ®µæ—¶é—´, æ‰€æœ‰æ•°æ®ä¼šå†™å…¥ partition1, æŸä¸€æ®µæ—¶é—´, æ•°æ®ä¼šå†™å…¥ partition2...
```

### 6.1.6. kafka æ¶ˆæ¯æœ‰åºæ€§

å¯¹äºåŒä¸ªåˆ†åŒºæ¥è¯´ï¼Œå®ƒçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„, ä¸åŒ partition å°±æ˜¯æ— åºçš„äº†

æ‰€ä»¥å¯¹äºæ¶ˆæ¯, å¯ä»¥å¯¹ id ä½¿ç”¨ partition num å–æ¨¡å¾—åˆ° partition id

### 6.1.7. kafka ä¸ºä»€ä¹ˆå¿«

å¼‚æ­¥æ‰¹é‡å¤„ç†: ä¾‹å¦‚ç”Ÿäº§è€…å®¢æˆ·ç«¯ï¼Œä»–ä¼šç§¯ç´¯ä¸€å®šé‡ï¼ˆæ¡æ•°ã€å¤§å°ï¼‰çš„æ¶ˆæ¯ï¼Œå†æ‰¹é‡çš„å‘ç»™kafka broker

ç£ç›˜é¡ºåºè¯»å†™: æ¯ä¸ªpartition éƒ½æ˜¯è¿½åŠ åˆ°å°¾éƒ¨, åœ¨è¡¨ç°åœ¨ç£ç›˜ä¸Šå°±æ˜¯é¡ºåºè¯»å†™, é€Ÿåº¦å¿«

åˆ†æ®µå­˜å‚¨: æ•°æ®å­˜å‚¨ä¸ºå¤šä¸ªæ–‡ä»¶, åŠ è½½å¿«, é¿å…æ•°æ®ç«äº‰

æ“ä½œç³»ç»ŸPageCacheç¼“å­˜æ•°æ®

é›¶æ‹·è´åŠ é€Ÿæ¶ˆè´¹

### 6.1.8. kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§

å³æ¶ˆæ¯ä¸ä¸¢å¤±

ç”Ÿäº§è€…è®¾ç½®ackï¼š

0ï¼šproducerä¸ç­‰å¾…brokerçš„ackï¼Œbrokerä¸€æ¥æ”¶åˆ°è¿˜æ²¡æœ‰å†™å…¥ç£ç›˜å°±å·²ç»è¿”å›ï¼Œå¯é æ€§æœ€ä½ï¼›
1ï¼šproducerç­‰å¾…brokerçš„ackï¼Œpartitionçš„leaderåˆ·ç›˜æˆåŠŸåè¿”å›ackï¼Œå¦‚æœåœ¨followeråŒæ­¥æˆåŠŸä¹‹å‰leaderæ•…éšœï¼Œé‚£ä¹ˆå°†ä¼šä¸¢å¤±æ•°æ®ï¼Œå¯é æ€§ä¸­ï¼›
-1ï¼šproducerç­‰å¾…brokerçš„ackï¼Œpartitionçš„leaderå’Œfollowerå…¨éƒ¨è½ç›˜æˆåŠŸåæ‰è¿”å›ackï¼Œæ•°æ®ä¸€èˆ¬ä¸ä¼šä¸¢å¤±ï¼Œå»¶è¿Ÿæ—¶é—´é•¿ä½†æ˜¯å¯é æ€§é«˜

æ¶ˆè´¹è€…
è®¾ç½®enable.auto.commit=trueï¼Œä¸ç®¡æ‰§è¡Œç»“æœå¦‚ä½•ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æäº¤offsetã€‚falseï¼Œéœ€è¦ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æäº¤offsetï¼Œå¯ä»¥æ ¹æ®æ‰§è¡Œç»“æœå…·ä½“å¤„ç†offset

### 6.1.9. å¦‚ä½•ä¿è¯ä¸é‡å¤æ¶ˆè´¹

```

é‡å¤æ¶ˆè´¹åŸå› : 

- å¯èƒ½æ˜¯é€‰æ‹©äº†é”™è¯¯çš„æ¶ˆè´¹æ¨¡å‹, ç‚¹å¯¹ç‚¹çš„æ¨¡å‹ä¸­æ¶ˆè´¹è€…ä¸ä¼šé‡å¤æ¶ˆè´¹, å‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­, å¤šä¸ªæ¶ˆè´¹è€…ä¼šé‡å¤æ¶ˆè´¹æ¶ˆæ¯
  
  è§£å†³: æ‰€ä»¥å¯ä»¥é‡‡ç”¨ç‚¹å¯¹ç‚¹æ¨¡å‹: æ¯ä¸ª partition å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹, æˆ–è€… æ¯ä¸ª partition å¯¹åº”ä¸€ä¸ª consumer group

- å¯èƒ½æ˜¯ consumer çš„ offset æ²¡æœ‰é…ç½®, é‡‡ç”¨äº†é»˜è®¤çš„è‡ªåŠ¨æäº¤

  æ¯”å¦‚ consumer æ¯éš” 5s è‡ªåŠ¨æäº¤ä¸€æ¬¡ offset (åŠ å…¥æ­¤æ—¶ offset = 2), ä½†æ˜¯æŸæ¬¡æäº¤å®Œæˆåç¬¬ 2s consumer æŒ‚äº† (æ­¤æ—¶ offset=4), å†æ¬¡é‡å¯ consumer, åˆ™ consumer ä¼šä» offset=2 å¤„å¼€å§‹æ¶ˆè´¹, é€ æˆé‡å¤æ¶ˆè´¹

  è§£å†³: 

```


### 6.1.10. å¦‚ä½•ä¿è¯ä¸é—æ¼æ¶ˆè´¹ æ¶ˆæ¯ä¸¢å¤±

```
æ¶ˆæ¯é—æ¼æ¶ˆè´¹æ˜¯å¯¹äºconsumer æ¥è¯´çš„, ä¸€èˆ¬æ˜¯å› ä¸º : å¦‚æœæ¶ˆè´¹ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯è¿˜æ²¡å¤„ç†, ç¢°åˆ°kafkaåˆšå¥½è‡ªåŠ¨æäº¤äº†offset, å¤„ç†æ¶ˆæ¯æ—¶æ¶ˆè´¹ç«¯æŒ‚æ‰äº†,å°±é€ æˆäº†æ¶ˆæ¯ä¸¢å¤±

  è§£å†³: è®¾ç½®consumeræ‰‹åŠ¨æäº¤ offset, æ¶ˆæ¯å¤„ç†å®Œäº†å†æ‰‹åŠ¨æäº¤ offset

    enable.auto.commitï¼šè¡¨ç¤ºæ¶ˆè´¹è€…ä¼šå‘¨æœŸæ€§è‡ªåŠ¨æäº¤æ¶ˆè´¹çš„offsetã€‚é»˜è®¤å€¼trueã€‚
    auto.commit.interval.msï¼šåœ¨enable.auto.commitä¸ºtrueçš„æƒ…å†µä¸‹ï¼Œ è‡ªåŠ¨æäº¤çš„é—´éš”ã€‚é»˜è®¤å€¼5ç§’

  è§£å†³: å¼•å…¥æ¶ˆæ¯å»é‡æœºåˆ¶ (ä¾‹å¦‚ï¼šç”Ÿæˆæ¶ˆæ¯æ—¶ï¼Œåœ¨æ¶ˆæ¯ä¸­åŠ å…¥å”¯ä¸€æ ‡è¯†ç¬¦å¦‚æ¶ˆæ¯id, åœ¨æ¶ˆè´¹ç«¯ï¼Œå¯ä»¥ä¿å­˜æœ€è¿‘çš„max.poll.recordsæ¡æ¶ˆæ¯idåˆ°redisæˆ–mysqlè¡¨ä¸­ï¼Œè¿™æ ·åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶å…ˆé€šè¿‡æŸ¥è¯¢å»é‡åï¼Œå†è¿›è¡Œæ¶ˆæ¯çš„å¤„ç†)

æ­¤å¤–æ¶ˆæ¯è¿˜å¯èƒ½

  åœ¨ broker ä¸­ä¸¢å¤±: å¦‚, æŸä¸ª broker æŒ‚äº†, æ­¤æ—¶ä¼šé€‰ä¸¾æ–° leader, å¦‚æœæŸä¸ª follower å€é€‰ä¸¾ä¸º leader ä½†æ˜¯å®ƒè¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥, å°±æ¶ˆæ¯ä¸¢å¤±äº†

    è§£å†³: æœ¬è´¨æ˜¯è¦ä¿è¯å¡å¤«å¡é«˜å¯ç”¨ (ä¸ºæ¯éš”åˆ†åŒºè®¾ç½®å¤šä¸ªå‰¯æœ¬)

      - ç»™ topic è®¾ç½® replication.factor å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬

      - åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® min.insync.replicas å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower 

  åœ¨ producer ä¸­ä¸¢å¤±

    - è®¾ç½® `acks=all`, å’Œ `retries=MAX`åå°±å¯ä»¥ä¿è¯æ²¡æœ‰æ•°æ®ä¸¢å¤±äº†;
      - åœ¨ producer ç«¯è®¾ç½® acks=allï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†ã€‚
      - åœ¨ producer ç«¯è®¾ç½® retries=MAXï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚
    - ä¸è¦ä½¿ç”¨ send(xxx, xxx), è€Œæ˜¯ä½¿ç”¨ send(xxx, xxx, callback), åœ¨ callback é‡Œå¤„ç†å‘é€å¤±è´¥çš„åçš„è¡¥å¿æªæ–½

```


### 6.1.11. æ¨oræ‹‰

æ¶ˆè´¹è€…å¦‚ä½•æ¶ˆè´¹æ¶ˆæ¯? é‡‡ç”¨ pull è¿˜æ˜¯ push?

kafka ä½¿ç”¨ pull (ä¸»åŠ¨æ‹‰) çš„æ–¹å¼, (æ²¡æœ‰é‡‡ç”¨ push çš„æ–¹å¼, æ˜¯å› ä¸ºå¦‚æœ broker push æ¶ˆæ¯çš„é€Ÿåº¦å¤ªå¿«, consumer å¯èƒ½è·Ÿä¸ä¸Š)
(pull ç¼ºç‚¹: å¦‚æœå¡å¤«å¡æ²¡æœ‰æ•°æ®, consumer å°±ä¼šé™·å…¥ç©ºè½¬)

### 6.1.12. ä¸¤ç§æ¨¡å‹ åŸºäºé˜Ÿåˆ— åŸºäºå‘å¸ƒè®¢é˜…

KafkaåŒæ—¶æ”¯æŒåŸºäºé˜Ÿåˆ—å’ŒåŸºäºå‘å¸ƒ/è®¢é˜…çš„ä¸¤ç§æ¶ˆæ¯å¼•æ“æ¨¡å‹ï¼Œäº‹å®ä¸ŠKafkaæ˜¯é€šè¿‡consumer groupå®ç°å¯¹è¿™ä¸¤ç§æ¨¡å‹çš„æ”¯æŒ

```
æ‰€æœ‰consumerå®ä¾‹éƒ½å±äºç›¸åŒgroupâ€”å®ç°åŸºäºé˜Ÿåˆ—çš„æ¨¡å‹ï¼Œæ¯æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªconsumerå®ä¾‹å¤„ç†

consumerå®ä¾‹éƒ½å±äºä¸åŒgroupâ€”å®ç°åŸºäºå‘å¸ƒ/è®¢é˜…çš„æ¨¡å‹

  æç«¯çš„æƒ…å†µæ˜¯æ¯ä¸ªconsumerå®ä¾‹éƒ½è®¾ç½®å®Œå…¨ä¸åŒéƒ½groupï¼Œè¿™æ ·kafkaæ¶ˆæ¯å°±ä¼šè¢«å¹¿æ’­åˆ°æ‰€æœ‰consumreå®ä¾‹

```

## 6.2. ä¸ºä»€ä¹ˆä½¿ç”¨ kafka

### 6.2.1. kafkaä½¿ç”¨åœºæ™¯

- æ¶ˆæ¯é˜Ÿåˆ— (è§£è€¦, æµé‡å‰Šå³°..)

- è¿½è¸ªç½‘ç«™æ´»åŠ¨ : å°†ä¸åŒçš„æ´»åŠ¨æ”¾å…¥ä¸åŒçš„ä¸»é¢˜, ä¾›åç»­çš„å®æ—¶è®¡ç®—/ç›‘æ§ç¨‹åºä½¿ç”¨

- æ—¥å¿—å’Œç›‘æ§metricsèšåˆ:   èšåˆåˆ†å¸ƒå¼åº”ç”¨çš„æ—¥å¿—, è¿›è¡Œç»Ÿä¸€åˆ†æå±•ç¤º

### 6.2.2. å’Œ redis æ¶ˆæ¯é˜Ÿåˆ—çš„åŒºåˆ«

- redis å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨æ¨æ¨¡å¼, è‹¥æ¶ˆè´¹è€…åœ¨æ¶ˆæ¯æ¨è¿‡æ¥çš„æ—¶å€™æ‰çº¿äº†, ä¹Ÿå°±é”™è¿‡äº†æ¶ˆæ¯; kafka æ˜¯åŸºäºæ‹‰æ¨¡å¼, æ¯ä¸ªæ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯

å®é™…ä¸Š redis ä½œè€…çœ‹åˆ°è¿™ä¹ˆå¤šäººä½¿ç”¨ redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—, è¿èƒŒäº†ä»–ç»™æœ¬æ„, ç‰¹åœ°å¼€å‘äº† Disque ä¸“é—¨åº”å¯¹æ¶ˆæ¯é˜Ÿåˆ—åœºæ™¯


## 6.3. å¦‚ä½•ä½¿ç”¨kafka

https://kafka.apache.org/documentation/#quickstart å¯åŠ¨æµ‹è¯•ç”¨æœåŠ¡, kafka åœ¨ `localhost:9092`, zookeeper åœ¨`xxx`

### 6.3.1. kafka åŸç”Ÿé…ç½®

configæ–‡ä»¶å¤¹ä¸‹ï¼Œä¼šå‘ç°æœ‰å¾ˆå¤šå¾ˆå¤šçš„é…ç½®æ–‡ä»¶, åªéœ€è¦å…³æ³¨ server.properties

```
ã€broker.idã€‘
æ¯ä¸ªbrokeréƒ½å¿…é¡»è‡ªå·±è®¾ç½®çš„ä¸€ä¸ªå”¯ä¸€idï¼Œå¯ä»¥åœ¨0~255ä¹‹é—´
ã€log.dirsã€‘
è¿™ä¸ªæä¸ºé‡è¦ï¼ŒKafkaçš„æ‰€æœ‰æ•°æ®å°±æ˜¯å†™å…¥è¿™ä¸ªç›®å½•ä¸‹çš„ç£ç›˜æ–‡ä»¶ä¸­çš„ï¼Œå¦‚æœè¯´æœºå™¨ä¸Šæœ‰å¤šå—ç‰©ç†ç¡¬ç›˜ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠå¤šä¸ªç›®å½•æŒ‚è½½åˆ°ä¸åŒçš„ç‰©ç†ç¡¬ç›˜ä¸Šï¼Œç„¶åè¿™é‡Œå¯ä»¥è®¾ç½®å¤šä¸ªç›®å½•ï¼Œè¿™æ ·Kafkaå¯ä»¥æ•°æ®åˆ†æ•£åˆ°å¤šå—ç‰©ç†ç¡¬ç›˜ï¼Œå¤šä¸ªç¡¬ç›˜çš„ç£å¤´å¯ä»¥å¹¶è¡Œå†™ï¼Œè¿™æ ·å¯ä»¥æå‡ååé‡ã€‚psï¼šå¤šä¸ªç›®å½•ç”¨è‹±æ–‡é€—å·åˆ†éš”
ã€zookeeper.connectã€‘
è¿æ¥Kafkaåº•å±‚çš„ZooKeeperé›†ç¾¤çš„
ã€Listenersã€‘
brokerç›‘å¬å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„ç«¯å£å·ï¼Œé»˜è®¤æ˜¯9092
ã€num.network.threadsã€‘é»˜è®¤å€¼ä¸º3
ã€num.io.threadsã€‘é»˜è®¤å€¼ä¸º8
ç»†å¿ƒçš„æœ‹å‹ä»¬åº”è¯¥å·²ç»å‘ç°äº†ï¼Œè¿™å°±æ˜¯ä¸Šä¸€ç¯‡æˆ‘ä»¬åœ¨ç½‘ç»œæ¶æ„ä¸Šæåˆ°çš„processorå’Œå¤„ç†çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ç›®ã€‚
æ‰€ä»¥è¯´æŒæ¡Kafkaç½‘ç»œæ¶æ„æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚
ç°åœ¨ä½ çœ‹åˆ°è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå°±çŸ¥é“è¿™å°±æ˜¯Kafkaé›†ç¾¤æ€§èƒ½çš„å…³é”®å‚æ•°äº†
ã€unclean.leader.election.enableã€‘
é»˜è®¤æ˜¯falseï¼Œæ„æ€å°±æ˜¯åªèƒ½é€‰ä¸¾ISRåˆ—è¡¨é‡Œçš„followeræˆä¸ºæ–°çš„leaderï¼Œ1.0ç‰ˆæœ¬åæ‰è®¾ä¸ºfalseï¼Œä¹‹å‰éƒ½æ˜¯trueï¼Œå…è®¸éISRåˆ—è¡¨çš„followeré€‰ä¸¾ä¸ºæ–°çš„leader
ã€delete.topic.enableã€‘
é»˜è®¤trueï¼Œå…è®¸åˆ é™¤topic
ã€log.retention.hoursã€‘
å¯ä»¥è®¾ç½®ä¸€ä¸‹ï¼Œè¦ä¿ç•™æ•°æ®å¤šå°‘ä¸ªå°æ—¶ï¼Œè¿™ä¸ªå°±æ˜¯åº•å±‚çš„ç£ç›˜æ–‡ä»¶ï¼Œé»˜è®¤ä¿ç•™7å¤©çš„æ•°æ®ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å°±è¡Œäº†
ã€min.insync.replicasã€‘
acks=-1(ä¸€æ¡æ•°æ®å¿…é¡»å†™å…¥ISRé‡Œæ‰€æœ‰å‰¯æœ¬æ‰ç®—æˆåŠŸ)ï¼Œä½ å†™ä¸€æ¡æ•°æ®åªè¦å†™å…¥leaderå°±ç®—æˆåŠŸäº†ï¼Œä¸éœ€è¦ç­‰å¾…åŒæ­¥åˆ°followeræ‰ç®—å†™æˆåŠŸã€‚ä½†æ˜¯æ­¤æ—¶å¦‚æœä¸€ä¸ªfollowerå®•æœºäº†ï¼Œä½ å†™ä¸€æ¡æ•°æ®åˆ°leaderä¹‹åï¼Œleaderä¹Ÿå®•æœºï¼Œä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ã€‚


```



### 6.3.2. åœ¨ springboot ä¸­ä½¿ç”¨ kafka


https://github.com/confluentinc/kafka-streams-examples


> https://github.com/confluentinc/kafka-rest rest å°è£…

Springåˆ›å»ºäº†ä¸€ä¸ªåä¸ºSpring kafkaçš„é¡¹ç›®ï¼Œå®ƒå°è£…äº†Apacheçš„kafkaå®¢æˆ·ç«¯éƒ¨åˆ†(ç”Ÿäº§è€…/æ¶ˆè´¹è€…/æµå¤„ç†ç­‰

@EnableKafkaå¹¶ä¸æ˜¯åœ¨Spring Bootä¸­å¯ç”¨Kafkaå¿…é¡»çš„ï¼ŒSpring Booté™„å¸¦äº†Spring Kafkaçš„è‡ªåŠ¨é…ç½®ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨æ˜¾å¼çš„@EnableKafkaã€‚å¦‚æœæƒ³è¦è‡ªå·±å®ç°Kafkaé…ç½®ç±»ï¼Œåˆ™éœ€è¦åŠ ä¸Š@EnableKafkaï¼Œå¦‚æœä½ ä¸æƒ³è¦Kafkaè‡ªåŠ¨é…ç½®ï¼Œæ¯”å¦‚æµ‹è¯•ä¸­ï¼Œéœ€è¦åšçš„åªæ˜¯ç§»é™¤KafkaAutoConfiguration `@SpringBootTest("spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration")`


spring ä¸­çš„é…ç½®

```sh

max.poll.recordsï¼šå•æ¬¡æ¶ˆè´¹è€…æ‹‰å–çš„æœ€å¤§æ•°æ®æ¡æ•°ï¼Œé»˜è®¤å€¼500ã€‚

max.poll.interval.msï¼šè¡¨ç¤ºè‹¥åœ¨é˜ˆå€¼æ—¶é—´ä¹‹å†…æ¶ˆè´¹è€…æ²¡æœ‰æ¶ˆè´¹å®Œä¸Šä¸€æ¬¡pollçš„æ¶ˆæ¯ï¼Œconsumer
clientä¼šä¸»åŠ¨å‘coordinatorå‘èµ·LeaveGroupè¯·æ±‚ï¼Œè§¦å‘Rebalanceï¼›ç„¶åconsumeré‡æ–°å‘é€JoinGroupè¯·æ±‚ã€‚

session.timeout.msï¼šgroup
Coordinatoræ£€æµ‹consumerå‘ç”Ÿå´©æºƒæ‰€éœ€çš„æ—¶é—´ã€‚åœ¨è¿™ä¸ªæ—¶é—´å†…å¦‚æœCoordinatoræœªæ”¶åˆ°Consumerçš„ä»»ä½•æ¶ˆæ¯ï¼Œé‚£Coordinatorå°±è®¤ä¸ºConsumeræŒ‚äº†ã€‚é»˜è®¤å€¼10ç§’ã€‚

heartbeat.interval.msï¼šæ ‡è¯†Consumerç»™Coordinatorå‘ä¸€ä¸ªå¿ƒè·³åŒ…çš„æ—¶é—´é—´éš”ã€‚heartbeat.interval.msè¶Šå°ï¼Œå‘çš„å¿ƒè·³åŒ…è¶Šå¤šã€‚é»˜è®¤å€¼3ç§’ã€‚

```

### 6.3.3. åˆ›å»ºä¸»é¢˜

```java
// åˆ›å»ºä¸»é¢˜

@Configuration
@Data
public class KafkaTopicConfig {

    @Value("${kafka.topic.topic1}")
    private final String topic1;

    @Value("${kafka.topic.topic2}")
    private final String topic2;

    @Bean
    public NewTopic topic1() {
        return TopicBuilder.name(topic1)
                .partitions(1)
                .replicas(1)
                .build();
    }

    @Bean
    public NewTopic topic2() {
        return TopicBuilder.name(topic2)
                .partitions(2)
                .replicas(1)
                .build();
    }



}

```

æˆ–è€…:

```java
@Configuration
@Slf4j
@Data
public class KafkaConfig {

    private final KafkaProps kafkaProps;

    private final DefaultListableBeanFactory defaultListableBeanFactory;

    

    @PostConstruct
    public void init() {
        initTopics();
    }

    /**
     * create kafka topics
     */
    private void initTopics() {
        kafkaProps.getTopics().forEach(ele -> {
            defaultListableBeanFactory.registerSingleton(ele.getName(), TopicBuilder.name(ele.getName())
                    .partitions(ele.getPartitions()).replicas(ele.getReplicationFactor()).build());
            log.debug(">>> register topic ok: {}", ele.getName());
        });
    }

    @Data
    @Component
    @ConfigurationProperties(prefix = "kafka")
    static class KafkaProps {
        private List<Topic> topics = new ArrayList<>();
    }

    @Data
    static class Topic {
        private String name;
        private int partitions;
        private int replicationFactor;
    }

}
```

### 6.3.4. ç”Ÿäº§è€…å‘é€

#### 6.3.4.1. kafka template åŒæ­¥ å¼‚æ­¥

```java

// å‘é€

@Service
@Data
@Slf4j
public class BookProducerService<T> {

    private final KafkaTemplate<String, T> kafkaTemplate;    

    public void send(String topic, T data) {
      // åŒæ­¥çš„æ–¹å¼
        // try {
        //     SendResult<String, T> sendResult = kafkaTemplate.send(topic,data).get();
        //     RecordMetadata meta = sendResult.getRecordMetadata();
        //     if (meta != null) {
        //         ProducerRecord<String, T> producerRecord = sendResult.getProducerRecord();
        //         log.debug("producer record: {}", producerRecord);

        //     }
        // } catch (InterruptedException | ExecutionException e) {
        //     e.printStackTrace();
        // }

        // åˆ©ç”¨ future å¼‚æ­¥çš„å†™æ³•:
        // å‘é€å¯¹è±¡éœ€è¦é…ç½® value çš„åºåˆ—åŒ–æ–¹å¼
        kafkaTemplate.send(topic, data).addCallback(new ListenableFutureCallback<SendResult<String, T>>() {
            @Override
            public void onFailure(Throwable throwable) {
                log.error("send message failed, topic: {}, data: {}, err: {}", topic, data, throwable.getMessage());
            }

            @Override
            public void onSuccess(SendResult<String, T> sendResult) {
                RecordMetadata meta = sendResult.getRecordMetadata();
                if (meta != null) {
                    ProducerRecord<String, T> producerRecord = sendResult.getProducerRecord();
                    log.debug("Send ok, producer record: {}", producerRecord);
                }
            }
        });
    }
}


```

#### 6.3.4.2. ç”Ÿäº§è€…é…ç½®

```yml
spring:
  application:
    name: springboot-kafka-demo
  kafka:
    bootstrap-servers:
      - localhost:9092
    consumer:
      # é…ç½®æ¶ˆè´¹è€…é‡è¿æ—¶, offset é‡ç½®çš„è§„åˆ™ (è¿™é‡Œæ˜¯: æ¶ˆè´¹è€…é‡è¿ä¼šé‡æ–°æ¥æ”¶æœ€å¼€å§‹çš„æ¶ˆæ¯)
      auto-offset-reset: earliest
      # ç¦ç”¨offset è‡ªåŠ¨æäº¤, è‡ªå·±æ‰‹åŠ¨æäº¤é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
      enable-auto-commit: false
    producer:
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

server:
  port: 8080

logging:
  level:
    '[io.github.xiaoyureed.springbootkafkademo]': DEBUG

kafka:
  topic: 
    topic1: topic1
    topic2: topic2


```

ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­é…ç½®:

```java
@Bean
public Map<String, Object> producerConfigs() {
    Map<String, Object> props = new HashMap<>();
    props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
    props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
    props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);

    // æ§åˆ¶æ‰¹å¤„ç†å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚
        props.put(ProducerConfig.BATCH_SIZE_CONFIG, 4096);
        // æ‰¹é‡å‘é€ï¼Œå»¶è¿Ÿä¸º1æ¯«ç§’ï¼Œå¯ç”¨è¯¥åŠŸèƒ½èƒ½æœ‰æ•ˆå‡å°‘ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ¬¡æ•°ï¼Œä»è€Œæé«˜å¹¶å‘é‡
        props.put(ProducerConfig.LINGER_MS_CONFIG, 1);

        // ç”Ÿäº§è€…å¯ä»¥ä½¿ç”¨çš„æ€»å†…å­˜å­—èŠ‚æ¥ç¼“å†²ç­‰å¾…å‘é€åˆ°æœåŠ¡å™¨çš„è®°å½•d
        props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, 40960);
        // æ¶ˆæ¯çš„æœ€å¤§å¤§å°é™åˆ¶,ä¹Ÿå°±æ˜¯è¯´sendçš„æ¶ˆæ¯å¤§å°ä¸èƒ½è¶…è¿‡è¿™ä¸ªé™åˆ¶, é»˜è®¤1048576(1MB)
        props.put(ProducerConfig.MAX_REQUEST_SIZE_CONFIG,1048576);

     
    // æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
    /*
     //å¹‚ç­‰æ€§
      props.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true);
      // é‡è¯•æ¬¡æ•°ï¼Œ0ä¸ºä¸å¯ç”¨é‡è¯•æœºåˆ¶ï¼Œå¹‚ç­‰æ€§çš„æ—¶å€™å¿…é¡»å¤§äº0
      props.put(ProducerConfig.RETRIES_CONFIG, 1);
      //åŒæ­¥åˆ°å‰¯æœ¬,
      // å½“å¹‚ç­‰æ€§ enable.idempotence ä¸º trueï¼Œè¿™é‡Œé»˜è®¤ä¸º all
      props.put(ProducerConfig.ACKS_CONFIG, "all");
    */
    // é‡è¯•æ¬¡æ•°ï¼Œ0ä¸ºä¸å¯ç”¨é‡è¯•æœºåˆ¶
        props.put(ProducerConfig.RETRIES_CONFIG, 0);
        //åŒæ­¥åˆ°å‰¯æœ¬, é»˜è®¤ä¸º1
        // acks=0 æŠŠæ¶ˆæ¯å‘é€åˆ°kafkaå°±è®¤ä¸ºå‘é€æˆåŠŸ
        // acks=1 æŠŠæ¶ˆæ¯å‘é€åˆ°kafka leaderåˆ†åŒºï¼Œå¹¶ä¸”å†™å…¥ç£ç›˜å°±è®¤ä¸ºå‘é€æˆåŠŸ
        // acks=all æŠŠæ¶ˆæ¯å‘é€åˆ°kafka leaderåˆ†åŒºï¼Œå¹¶ä¸”leaderåˆ†åŒºçš„å‰¯æœ¬followerå¯¹æ¶ˆæ¯è¿›è¡Œäº†åŒæ­¥å°±ä»»åŠ¡å‘é€æˆåŠŸ
        props.put(ProducerConfig.ACKS_CONFIG, 1);

        // å‹ç¼©æ¶ˆæ¯ï¼Œæ”¯æŒå››ç§ç±»å‹ï¼Œåˆ†åˆ«ä¸ºï¼šnoneã€lz4ã€gzipã€snappyï¼Œé»˜è®¤ä¸ºnoneã€‚
        // æ¶ˆè´¹è€…é»˜è®¤æ”¯æŒè§£å‹ï¼Œæ‰€ä»¥å‹ç¼©è®¾ç½®åœ¨ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…æ— éœ€è®¾ç½®ã€‚
        props.put(ProducerConfig.COMPRESSION_TYPE_CONFIG,"none");

    // See https://kafka.apache.org/documentation/#producerconfigs for more properties
    return props;
}

@Bean
public ProducerFactory<Integer, String> producerFactory() {
    return new DefaultKafkaProducerFactory<>(producerConfigs());
}

// springboot é»˜è®¤æä¾›äº†
@Bean
public KafkaTemplate<Integer, String> kafkaTemplate() {
    // KafkaTemplateæ„é€ å‡½æ•°ä¸­è¾“å…¥ç”Ÿäº§è€…å·¥å‚é…ç½®
    return new KafkaTemplate<Integer, String>(producerFactory());
}
```

#### 6.3.4.3. ç”Ÿäº§è€…äº‹åŠ¡æ¶ˆæ¯

https://www.cnblogs.com/lshan/p/14467527.html

```
Kafkaä¸­çš„äº‹åŠ¡ç‰¹æ€§ä¸»è¦ç”¨äºä»¥ä¸‹ä¸¤ç§åœºæ™¯ï¼š
ã€1ã€‘ç”Ÿäº§è€…å‘é€å¤šæ¡æ¶ˆæ¯å¯ä»¥å°è£…åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå½¢æˆä¸€ä¸ªåŸå­æ“ä½œã€‚ å¤šæ¡æ¶ˆæ¯è¦ä¹ˆéƒ½å‘é€æˆåŠŸï¼Œè¦ä¹ˆéƒ½å‘é€å¤±è´¥ã€‚
ã€2ã€‘read-process-writeæ¨¡å¼ï¼š å°†æ¶ˆæ¯æ¶ˆè´¹å’Œç”Ÿäº§å°è£…åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå½¢æˆä¸€ä¸ªåŸå­æ“ä½œã€‚åœ¨ä¸€ä¸ªæµå¼å¤„ç†çš„åº”ç”¨ä¸­ï¼Œå¸¸å¸¸ä¸€ä¸ªæœåŠ¡éœ€è¦ä»ä¸Šæ¸¸æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åç»è¿‡å¤„ç†åé€è¾¾åˆ°ä¸‹æ¸¸ï¼Œè¿™å°±å¯¹åº”ç€æ¶ˆæ¯çš„æ¶ˆè´¹å’Œç”Ÿæˆã€‚

```

Kafka çš„äº‹åŠ¡æ¶ˆæ¯é»˜è®¤è¦æ±‚ä½ çš„ Kafka Brokerçš„èŠ‚ç‚¹åœ¨ 3 ä¸ªä»¥ä¸Š

```java

@Service
public class BookProducerService {

    private List<Object> sendedBooks = new ArrayList<>();
    private static final Logger logger = LoggerFactory.getLogger(BookProducerService.class);

    private final KafkaTemplate<String, Object> kafkaTemplate;

    public BookProducerService(KafkaTemplate<String, Object> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public void sendMessage(String topic, Object o) {
        kafkaTemplate.executeInTransaction(new KafkaOperations.OperationsCallback<String, Object, Object>() {
            @Override
            public Object doInOperations(KafkaOperations<String, Object> operations) {
                // å‘é€æ¶ˆæ¯
                operations.send(topic, o);
                // æ¨¡æ‹Ÿå‘ç”Ÿå¼‚å¸¸
                int a = 1 / 0;
                // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
                sendedBooks.add(o);
                return null;
            }
        });
    }
}



// ç›´æ¥ä½¿ç”¨ @Transactionalä¹Ÿå¯ä»¥ï¼š

    @Transactional(rollbackFor = Exception.class)
    public void sendMessage(String topic, Object o) {
        // å‘é€æ¶ˆæ¯
        kafkaTemplate.send(topic, o);
        // æ¨¡æ‹Ÿå‘ç”Ÿå¼‚å¸¸
        int a = 1 / 0;
        // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
        sendedBooks.add(o);
    }
```

transaction-id-prefix: äº‹åŠ¡ç¼–å·å‰ç¼€

isolation-level: read_committed :ä»…è¯»å–å·²æäº¤çš„æ¶ˆæ¯

```yml
server:
 port: 9090
spring:
 kafka:
   bootstrap-servers: localhost:9092,localhost:9093,localhost:9094
   consumer:
     # é…ç½®æ¶ˆè´¹è€…æ¶ˆæ¯offsetæ˜¯å¦è‡ªåŠ¨é‡ç½®(æ¶ˆè´¹è€…é‡è¿ä¼šèƒ½å¤Ÿæ¥æ”¶æœ€å¼€å§‹çš„æ¶ˆæ¯)
     auto-offset-reset: earliest
     # äº‹åŠ¡éš”ç¦»çº§åˆ«
     isolation-level: read_committed #ä»…è¯»å–å·²æäº¤çš„æ¶ˆæ¯
   producer:
     value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
     retries: 3  #  é‡è¯•æ¬¡æ•°
     # å¯ç”¨äº‹åŠ¡
     transaction-id-prefix: my-tx. # äº‹åŠ¡ç¼–å·å‰ç¼€
kafka:
 topic:
   topic-test-transaction: topic-test-transaction


```

### 6.3.5. æ¶ˆè´¹è€…æ¶ˆè´¹

#### 6.3.5.1. é…ç½® è¿‡æ»¤å™¨ å…¨å±€å¼‚å¸¸å¤„ç†

```java
// é…ç½®
@Configuration
@EnableKafka
public class KafkaConsumerConfig {

    @Bean
    KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String>
                factory = new ConcurrentKafkaListenerContainerFactory<>();
        // è®¾ç½®æ¶ˆè´¹è€…å·¥å‚
        factory.setConsumerFactory(consumerFactory());
        // æ¶ˆè´¹è€…ç»„ä¸­çº¿ç¨‹æ•°é‡
        factory.setConcurrency(3);
        // æ‹‰å–è¶…æ—¶æ—¶é—´
        factory.getContainerProperties().setPollTimeout(3000);

        // å½“ä½¿ç”¨æ‰¹é‡ç›‘å¬å™¨æ—¶éœ€è¦è®¾ç½®ä¸ºtrue
        factory.setBatchListener(true);

        // è¢«è¿‡æ»¤çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒ
        factory.setAckDiscarded(true);
        // è¿‡æ»¤ç›‘å¬çš„æ¶ˆæ¯
        // å°†è¿‡æ»¤å™¨æ·»æ·»åŠ åˆ°å‚æ•°ä¸­
        factory.setRecordFilterStrategy(consumerRecord -> {
            // è®¾ç½®è¿‡æ»¤å™¨ï¼Œåªæ¥æ”¶æ¶ˆæ¯å†…å®¹ä¸­åŒ…å« "test" çš„æ¶ˆæ¯
            String value = consumerRecord.value().toString();
            if (value !=null && value.contains("test")) {
                System.err.println(consumerRecord.value());
                // è¿”å› false åˆ™æ¥æ”¶æ¶ˆæ¯
                return false;
            }
            // è¿”å› true åˆ™æŠ›å¼ƒæ¶ˆæ¯
            return true;
        });

         // å°†å•æ¡æ¶ˆæ¯å¼‚å¸¸å¤„ç†å™¨æ·»åŠ åˆ°å‚æ•°ä¸­
        factory.setErrorHandler(new ConsumerAwareErrorHandler() {
            @Override
            public void handle(Exception thrownException, ConsumerRecord<?, ?> data, Consumer<?, ?> consumer) {
                log.error("// å°†å•æ¡æ¶ˆæ¯å¼‚å¸¸");
            }
        });
        // å°†æ‰¹é‡æ¶ˆæ¯å¼‚å¸¸å¤„ç†å™¨æ·»åŠ åˆ°å‚æ•°ä¸­
        factory.setBatchErrorHandler(new BatchErrorHandler() {
            @Override
            public void handle(Exception thrownException, ConsumerRecords<?, ?> data) {
                log.error("// å°†æ‰¹é‡æ¶ˆæ¯å¼‚å¸¸");
            }
        });

        return factory;
    }

    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        return new DefaultKafkaConsumerFactory<>(consumerConfigs());
    }

    @Bean
    public Map<String, Object> consumerConfigs() {
        Map<String, Object> propsMap = new HashMap<>();
        // Kafkaåœ°å€
        propsMap.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaConstants.bootstrapServers);
        //é…ç½®é»˜è®¤åˆ†ç»„ï¼Œè¿™é‡Œæ²¡æœ‰é…ç½®+åœ¨ç›‘å¬çš„åœ°æ–¹æ²¡æœ‰è®¾ç½®groupIdï¼Œå¤šä¸ªæœåŠ¡ä¼šå‡ºç°æ”¶åˆ°ç›¸åŒæ¶ˆæ¯æƒ…å†µ
        propsMap.put(ConsumerConfig.GROUP_ID_CONFIG, "defaultGroup");
        // æ˜¯å¦è‡ªåŠ¨æäº¤offsetåç§»é‡(é»˜è®¤true)
        propsMap.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, true);
        // è‡ªåŠ¨æäº¤çš„é¢‘ç‡(ms)
        propsMap.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, "100");
        // Sessionè¶…æ—¶è®¾ç½®
        propsMap.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, "15000");
        // é”®çš„ååºåˆ—åŒ–æ–¹å¼
        propsMap.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        // å€¼çš„ååºåˆ—åŒ–æ–¹å¼
        propsMap.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        // offsetåç§»é‡è§„åˆ™è®¾ç½®ï¼š
        // (1)ã€earliestï¼šå½“å„åˆ†åŒºä¸‹æœ‰å·²æäº¤çš„offsetæ—¶ï¼Œä»æäº¤çš„offsetå¼€å§‹æ¶ˆè´¹ï¼›æ— æäº¤çš„offsetæ—¶ï¼Œä»å¤´å¼€å§‹æ¶ˆè´¹
        // (2)ã€latestï¼šå½“å„åˆ†åŒºä¸‹æœ‰å·²æäº¤çš„offsetæ—¶ï¼Œä»æäº¤çš„offsetå¼€å§‹æ¶ˆè´¹ï¼›æ— æäº¤çš„offsetæ—¶ï¼Œæ¶ˆè´¹æ–°äº§ç”Ÿçš„è¯¥åˆ†åŒºä¸‹çš„æ•°æ®
        // (3)ã€noneï¼štopicå„åˆ†åŒºéƒ½å­˜åœ¨å·²æäº¤çš„offsetæ—¶ï¼Œä»offsetåå¼€å§‹æ¶ˆè´¹ï¼›åªè¦æœ‰ä¸€ä¸ªåˆ†åŒºä¸å­˜åœ¨å·²æäº¤çš„offsetï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        propsMap.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
        return propsMap;
    }
}

```

#### 6.3.5.2. ç›‘å¬æ¶ˆè´¹

##### 6.3.5.2.1. @kafkaListeneråŸºæœ¬ä½¿ç”¨

```java
// ç›‘å¬ æ–¹å¼ 1:, é€šè¿‡æ³¨è§£
@Component
public class KafkaConsumerListener {

   @KafkaListener(topics = {"test"},groupId = "group1", containerFactory="kafkaListenerContainerFactory")
   public void kafkaListener(String message, @Header(KafkaHeaders.RECEIVED_PARTITION_ID) int partition){
       System.out.println(message);
   }

   @KafkaListener(id = "webGroup1", topics = "hello")
	public void onMessage(ConsumerRecord<Object, Object> record, Acknowledgment ack,
			@Header(KafkaHeaders.RECEIVED_TOPIC) String topic) {
		System.out.println("å•æ¡æ¶ˆè´¹æ¶ˆæ¯ï¼š" + record.topic() + "----" + record.partition() + "----" + record.value());
		ack.acknowledge();
	}
	
	
	@KafkaListener(id = "webGroup2", topics = "hello")
	public void onMessageButch(List<ConsumerRecord<?, ?>> records, Acknowledgment ack) {
		for(ConsumerRecord<?, ?> record:records) {
		    System.out.println("æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ï¼š" + record.topic() + "----" + record.partition() + "----" + record.value());
		}
		ack.acknowledge();
	}

}


// ç›‘å¬æ–¹å¼ 2:
 /**
     * åˆ›å»º KafkaMessageListenerContainer å®ä¾‹ç›‘å¬ kafka æ¶ˆæ¯
     */
    @Bean
    public KafkaMessageListenerContainer demoListenerContainer() {
        // åˆ›å»ºcontaineré…ç½®å‚æ•°ï¼Œå¹¶æŒ‡å®šè¦ç›‘å¬çš„ topic åç§°
        ContainerProperties properties = new ContainerProperties("test");
        // è®¾ç½®æ¶ˆè´¹è€…ç»„åç§°
        properties.setGroupId("group2");
        // è®¾ç½®ç›‘å¬å™¨ç›‘å¬ kafka æ¶ˆæ¯
        properties.setMessageListener(new MessageListener<Integer,String>() {
            @Override
            public void onMessage(ConsumerRecord<Integer, String> record) {
                System.out.println("æ¶ˆæ¯ï¼š" + record);
            }
        });
        return new KafkaMessageListenerContainer(consumerFactory(), properties);
    }


// æ–¹å¼ 3:
/**
 * @KafkaListener è¿˜å¯ä»¥ä½œç”¨åœ¨class ç±»ä¸Š:
è¯¥æ³¨è§£ä½œç”¨äºç±»ä¸Šæ—¶,ç±»ä¸­çš„æ–¹æ³•å¿…é¡»ç”¨ @KafkaHandleræ³¨è§£ï¼Œåœ¨ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œå°†ä½¿ç”¨è½¬æ¢åçš„æ¶ˆæ¯æœ‰æ•ˆè´Ÿè½½ç±»å‹æ¥ç¡®å®šè°ƒç”¨é‚£ä¸ªæ–¹æ³•
 */
@KafkaListener(id = "myId", topics = "myTopic")
public class Myclass {
    @KafkaHandler
    public void listen(String str) {

    }

    @KafkaHandler
    public void listen(Integer integer) {

    }
}

```

##### 6.3.5.2.2. æ¶ˆè´¹æŒ‡å®šåˆ†åŒº

```java
@KafkaListener(
  topicPartitions = @TopicPartition(
    topic = "topicName",
    partitionOffsets = {
      @PartitionOffset(partition = "0", initialOffset = "0"), // msgs will be re-consuming every time this listener is initialized
      @PartitionOffset(partition = "3", initialOffset = "0")
    }
  ),
  containerFactory = "partitionsKafkaListenerContainerFactory")
public void listenToPartition(
  @Payload String message, 
  @Header(KafkaHeaders.RECEIVED_PARTITION_ID) int partition) {
      System.out.println(
        "Received Message: " + message+ "from partition: " + partition);
}


// è‹¥ä¸éœ€è¦æŒ‡å®š offset
@KafkaListener(topicPartitions 
  = @TopicPartition(topic = "topicName", partitions = { "0", "1" }))
```

##### 6.3.5.2.3. åŠ¨æ€å¼€å¯å…³é—­ç›‘å¬

```java
/*
å¯åŠ¨é¡¹ç›®ï¼Œè°ƒç”¨ /test æ¥å£å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç›‘å¬å™¨æˆåŠŸæ¥æ”¶åˆ°æ¶ˆæ¯ã€‚

è°ƒç”¨ /stop æ¥å£å…³é—­ç›‘å¬ï¼Œå†æ¬¡å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç›‘å¬å™¨ä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚

è°ƒç”¨ /start æ¥å£å¼€å¯ç›‘å¬ï¼Œç›‘å¬å™¨æ”¶åˆ°ä¹‹å‰å‘é€çš„æ¶ˆæ¯ã€‚

ç”±äºç›‘å¬å·²ç»å¼€å¯ï¼Œå†æ¬¡å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç›‘å¬å™¨æˆåŠŸæ¥æ”¶åˆ°æ¶ˆæ¯ã€‚
*/
@RestController
public class KafkaProducer {
 
    @Autowired
    private KafkaListenerEndpointRegistry registry;
 
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
 
    // å‘é€æ¶ˆæ¯
    @GetMapping("/test")
    public void test() {
        System.out.println("ç›‘å¬å™¨å‘é€æ¶ˆæ¯!");
        kafkaTemplate.send("topic1", "1æ¡æµ‹è¯•æ¶ˆæ¯");
    }
 
    // å¼€å¯ç›‘å¬
    @GetMapping("/start")
    public void start() {
        System.out.println("å¼€å¯ç›‘å¬");
        //åˆ¤æ–­ç›‘å¬å®¹å™¨æ˜¯å¦å¯åŠ¨ï¼Œæœªå¯åŠ¨åˆ™å°†å…¶å¯åŠ¨
        if (!registry.getListenerContainer("myListener1").isRunning()) {
            registry.getListenerContainer("myListener1").start();
        }
        registry.getListenerContainer("myListener1").resume();
    }
 
    // å…³é—­ç›‘å¬
    @GetMapping("/stop")
    public void stop() {
        System.out.println("å…³é—­ç›‘å¬");
        //åˆ¤æ–­ç›‘å¬å®¹å™¨æ˜¯å¦å¯åŠ¨ï¼Œæœªå¯åŠ¨åˆ™å°†å…¶å¯åŠ¨
        registry.getListenerContainer("myListener1").pause();
    }
}

```

##### 6.3.5.2.4. ç¦ç”¨è‡ªå¯åŠ¨

```java

// ç¦æ­¢ç›‘å¬å™¨è‡ªå¯åŠ¨
@Configuration
public class KafkaInitialConfiguration {
 
    // ç›‘å¬å™¨å·¥å‚
    @Autowired
    private ConsumerFactory consumerFactory;
 
    // ç›‘å¬å™¨å®¹å™¨å·¥å‚(è®¾ç½®ç¦æ­¢KafkaListenerè‡ªå¯åŠ¨)
    @Bean
    public ConcurrentKafkaListenerContainerFactory delayContainerFactory() {
        ConcurrentKafkaListenerContainerFactory container =
                new ConcurrentKafkaListenerContainerFactory();
        container.setConsumerFactory(consumerFactory);
        //ç¦æ­¢è‡ªåŠ¨å¯åŠ¨
        container.setAutoStartup(false);
        return container;
    }
}
//ç„¶åå°†è¿™ä¸ªå®¹å™¨å·¥å‚çš„ BeanName æ”¾åˆ° @KafkaListener æ³¨è§£çš„ containerFactory å±æ€§é‡Œé¢ã€‚è¿™æ ·è¯¥ç›‘å¬å™¨å°±ä¸ä¼šè‡ªåŠ¨å¯åŠ¨äº† 
@Component
public class KafkaConsumer {
    // æ¶ˆè´¹ç›‘å¬
    @KafkaListener(id = "myListener1", topics = {"topic1"},
            containerFactory = "delayContainerFactory")
    public void listen1(String data) {
        System.out.println("ç›‘å¬å™¨æ”¶åˆ°æ¶ˆæ¯ï¼š" + data);
    }
}

```

##### 6.3.5.2.5. å®šæ—¶å¯åœç›‘å¬å™¨

```java
// åœºæ™¯: é¡¹ç›®éœ€è¦åˆ©ç”¨ Kafka åšæ•°æ®æŒä¹…åŒ–çš„åŠŸèƒ½ï¼Œç”±äºç”¨æˆ·æ´»è·ƒçš„æ—¶é—´ä¸ºæ—©ä¸Š 10 ç‚¹è‡³æ™šä¸Š 12 ç‚¹, æˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨ç”¨æˆ·æ´»è·ƒåº¦ä½çš„æ—¶é—´æ®µå»åšæŒä¹…åŒ–çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ™šä¸Š 12 ç‚¹ååˆ°ç¬¬äºŒæ¡çš„æ—©ä¸Š 10 ç‚¹å‰

@SpringBootApplication
@EnableScheduling // å¼€å¯å®šæ—¶ä»»åŠ¡
public class KtestApplication {
    public static void main(String[] args) {
        SpringApplication.run(KtestApplication.class, args);
    }
}

@Component
public class MyKafkaSchedule {
    @Autowired
    private KafkaListenerEndpointRegistry registry;
 
    //å®šæ—¶å™¨ï¼Œæ¯å¤©å‡Œæ™¨0ç‚¹å¼€å¯ç›‘å¬
    @Scheduled(cron = "0 0 0 * * ?")
    public void startListener() {
        System.out.println("å¼€å¯ç›‘å¬");
        //åˆ¤æ–­ç›‘å¬å®¹å™¨æ˜¯å¦å¯åŠ¨ï¼Œæœªå¯åŠ¨åˆ™å°†å…¶å¯åŠ¨
        if (!registry.getListenerContainer("myListener1").isRunning()) {
            registry.getListenerContainer("myListener1").start();
        }
        registry.getListenerContainer("myListener1").resume();

        // ... æŒä¹…åŒ–æ“ä½œ

    }
 
    //å®šæ—¶å™¨ï¼Œæ¯å¤©æ—©ä¸Š10ç‚¹å…³é—­ç›‘å¬
    @Scheduled(cron = "0 0 10 * * ?")
    public void shutDownListener() {

        // ... åœæ­¢æŒä¹…åŒ–

        System.out.println("å…³é—­ç›‘å¬");
        registry.getListenerContainer("myListener1").pause();
    }
}
```

#### 6.3.5.3. æ¶ˆè´¹è€…é”™è¯¯å¤„ç† å•æ¶ˆæ¯ æ‰¹é‡æ¶ˆæ¯ 

```java
/**
 * å•æ¶ˆæ¯æ¶ˆè´¹å¼‚å¸¸å¤„ç†å™¨
 */
@Service
public class ConsumerService {

    private static final Logger log = LoggerFactory.getLogger(ConsumerService.class);

    /**
     * æ¶ˆæ¯ç›‘å¬å™¨
     * errorHandler ä¸æŒ‡å®šlistenErrorHandlerçš„æƒ…å†µï¼Œä½¿ç”¨å…¨å±€å¼‚å¸¸
     */
    @KafkaListener( topics = {"test"},groupId = "group21",errorHandler = "listenErrorHandler")
    public void listen(String message) {
        log.info(message);
        // åˆ›å»ºå¼‚å¸¸ï¼Œè§¦å‘å¼‚å¸¸å¤„ç†å™¨
        throw new NullPointerException("æµ‹è¯•é”™è¯¯å¤„ç†å™¨");
    }

    /**
     * å¼‚å¸¸å¤„ç†å™¨
     */
    @Bean
    public ConsumerAwareListenerErrorHandler listenErrorHandler() {
        return new ConsumerAwareListenerErrorHandler() { // æˆ–è€…: åˆ›å»º ConsumerAwareErrorHandler è¿™ä¸ªå­æ¥å£ä¹Ÿå¯

            @Override
            public Object handleError(Message<?> message,
                                      ListenerExecutionFailedException e,
                                      Consumer<?, ?> consumer) {
                log.info("message:" + message.getPayload());
                log.info("exception:" + e.getMessage());
                return null;
            }
        };
    }
}



/**
 *  æ‰¹é‡æ¶ˆè´¹å¼‚å¸¸å¤„ç†å™¨
 */
@Service
public class ConsumerBatchService {

    private static final Logger log = LoggerFactory.getLogger(ConsumerBatchService.class);
    /**
     * æ¶ˆæ¯ç›‘å¬å™¨
     */
    @KafkaListener( topics = {"test"},groupId = "group20",errorHandler = "listenErrorHandler")
    public void listen(List<String> messages) {
        for(String msg:messages){
            System.out.println(msg);
        }
        // åˆ›å»ºå¼‚å¸¸ï¼Œè§¦å‘å¼‚å¸¸å¤„ç†å™¨
        throw new NullPointerException("æµ‹è¯•é”™è¯¯å¤„ç†å™¨");
    }


    /**
     * å¼‚å¸¸å¤„ç†å™¨
     */
    @Bean
    public ConsumerAwareListenerErrorHandler listenErrorHandler() {
        return new ConsumerAwareListenerErrorHandler() {
            @Override
            public Object handleError(Message<?> message, ListenerExecutionFailedException e, Consumer<?, ?> consumer) {
                log.info("consumerAwareErrorHandler receive : "+message.getPayload().toString());
                MessageHeaders headers = message.getHeaders();
                List<String> topics = headers.get(KafkaHeaders.RECEIVED_TOPIC, List.class);
                List<Integer> partitions = headers.get(KafkaHeaders.RECEIVED_PARTITION_ID, List.class);
                List<Long> offsets = headers.get(KafkaHeaders.OFFSET, List.class);
                Map<TopicPartition, Long> offsetsToReset = new HashMap<>();
                return null;
            }
        };
    }
}


```

#### 6.3.5.4. offset æäº¤

åœ¨kafkaçš„æ¶ˆè´¹è€…ä¸­æœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„æœºåˆ¶ï¼Œé‚£å°±æ˜¯ offset æœºåˆ¶ã€‚å®ƒä½¿å¾— Kafka åœ¨æ¶ˆè´¹çš„è¿‡ç¨‹ä¸­å³ä½¿æŒ‚äº†æˆ–è€…å¼•å‘å†å‡è¡¡é—®é¢˜é‡æ–°åˆ†é… Partationï¼Œå½“ä¸‹æ¬¡é‡æ–°æ¢å¤æ¶ˆè´¹æ—¶ä»ç„¶å¯ä»¥çŸ¥é“ä»å“ªé‡Œå¼€å§‹æ¶ˆè´¹ã€‚

Kafkaä¸­åç§»é‡çš„è‡ªåŠ¨æäº¤æ˜¯ç”±å‚æ•° enable_auto_commit å’Œ auto_commit_interval_ms æ§åˆ¶çš„ï¼Œå½“ enable_auto_commit=true æ—¶ï¼ŒKafkaåœ¨æ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ä¼šä»¥é¢‘ç‡ä¸º auto_commit_interval_ms å‘ Kafka è‡ªå¸¦çš„ topic(__consumer_offsets) è¿›è¡Œåç§»é‡æäº¤

```java
// è‡ªåŠ¨æäº¤
auto.commit.enable=trueï¼šæ˜¯å¦å°†offsetç»´æŠ¤äº¤ç»™kafkaè¿›è¡Œç»´æŠ¤ï¼ˆè€ç‰ˆæœ¬ä¸­æäº¤åˆ°zookeeperä¸­ç»´æŠ¤ï¼‰ï¼Œè®¾ç½®ä¸ºtrueã€‚
auto.commit.interval.ms=10000ï¼šè‡ªåŠ¨æäº¤æ—¶é—´é—´éš”ã€‚

// æ‰‹åŠ¨æäº¤
auto.commit.enable=falseï¼šæ˜¯å¦å°†offsetç»´æŠ¤äº¤ç»™kafkaè¿›è¡Œç»´æŠ¤ï¼ˆè€ç‰ˆæœ¬ä¸­æäº¤åˆ°zookeeperä¸­ç»´æŠ¤ï¼‰ï¼Œè®¾ç½®ä¸ºfalseã€‚
ç„¶åéœ€è¦åœ¨ç¨‹åºä¸­è®¾ç½®ackæ¨¡å¼,ä»è€Œè¿›è¡Œæ‰‹åŠ¨æäº¤ç»´æŠ¤offsetã€‚
@Bean
KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<Integer, String>> kafkaListenerContainerFactory() {
    ConcurrentKafkaListenerContainerFactory<Integer, String> factory = new ConcurrentKafkaListenerContainerFactory<>();
    factory.setConsumerFactory(consumerFactory());
    factory.setConcurrency(3);
    factory.getContainerProperties().setPollTimeout(3000);
    // è®¾ç½®ACKæ¨¡å¼(æ‰‹åŠ¨æäº¤æ¨¡å¼ï¼Œè¿™é‡Œæœ‰ä¸ƒç§)
    /*
    RECORDï¼š æ¯å¤„ç†å®Œä¸€æ¡è®°å½•åæäº¤ã€‚
    BATCH(é»˜è®¤)ï¼š æ¯æ¬¡pollä¸€æ‰¹æ•°æ®åæäº¤ä¸€æ¬¡ï¼Œé¢‘ç‡å–å†³äºæ¯æ¬¡pollçš„è°ƒç”¨é¢‘ç‡ã€‚
    TIMEï¼š æ¯æ¬¡é—´éš”ackTimeçš„æ—¶é—´æäº¤ã€‚
    COUNTï¼š å¤„ç†å®Œpollçš„ä¸€æ‰¹æ•°æ®åå¹¶ä¸”è·ç¦»ä¸Šæ¬¡æäº¤å¤„ç†çš„è®°å½•æ•°è¶…è¿‡äº†è®¾ç½®çš„ackCountå°±æäº¤ã€‚
    COUNT_TIMEï¼š TIMEå’ŒCOUNTä¸­ä»»æ„ä¸€æ¡æ»¡è¶³å³æäº¤ã€‚
    MANUALï¼š æ‰‹åŠ¨è°ƒç”¨Acknowledgment.acknowledge()åï¼Œå¹¶ä¸”å¤„ç†å®Œpollçš„è¿™æ‰¹æ•°æ®åæäº¤ã€‚
    MANUAL_IMMEDIATEï¼š æ‰‹åŠ¨è°ƒç”¨Acknowledgment.acknowledge()åç«‹å³æäº¤
    
    */
    // ä¸é…ç½®ä¼š error
    factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL_IMMEDIATE);
    return factory;
}

// æ‰‹åŠ¨æäº¤
 @KafkaListener(id = "webGroup1", topics = "hello")
	public void onMessage(ConsumerRecord<Object, Object> record, Acknowledgment ack,
			@Header(KafkaHeaders.RECEIVED_TOPIC) String topic) {
		System.out.println("å•æ¡æ¶ˆè´¹æ¶ˆæ¯ï¼š" + record.topic() + "----" + record.partition() + "----" + record.value());
		ack.acknowledge();
	}

```

#### 6.3.5.5. æ¶ˆæ¯åºåˆ—åŒ–

```java
// producer

@Bean
public ProducerFactory<String, Greeting> greetingProducerFactory() {
    // ...
    configProps.put(
      ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, 
      JsonSerializer.class);
    return new DefaultKafkaProducerFactory<>(configProps);
}

@Bean
public KafkaTemplate<String, Greeting> greetingKafkaTemplate() {
    return new KafkaTemplate<>(greetingProducerFactory());
}


// consumer

@Bean
public ConsumerFactory<String, Greeting> greetingConsumerFactory() {
    // ...
    return new DefaultKafkaConsumerFactory<>(
      props,
      new StringDeserializer(), 
      new JsonDeserializer<>(Greeting.class));
}

@Bean
public ConcurrentKafkaListenerContainerFactory<String, Greeting> 
  greetingKafkaListenerContainerFactory() {

    ConcurrentKafkaListenerContainerFactory<String, Greeting> factory =
      new ConcurrentKafkaListenerContainerFactory<>();
    factory.setConsumerFactory(greetingConsumerFactory());
    return factory;
}

@KafkaListener(
  topics = "topicName", 
  containerFactory = "greetingKafkaListenerContainerFactory")
public void greetingListener(Greeting greeting) {
    // process greeting message
}
```

#### 6.3.5.6. è‡ªå®šä¹‰ä»£æ›¿é»˜è®¤çº¿ç¨‹æ± 

https://www.jianshu.com/p/cf367a8c6d67

```java
public class CustomConcurrentKafkaListenerContainerFactory<K,V> extends ConcurrentKafkaListenerContainerFactory<K,V> {

    /**
     * The executor for threads that poll the consumer.
     */
    private AsyncListenableTaskExecutor consumerTaskExecutor;

    /**
     * The executor for threads that invoke the listener.
     */
    private AsyncListenableTaskExecutor listenerTaskExecutor;

    public CustomConcurrentKafkaListenerContainerFactory(AsyncListenableTaskExecutor consumerTaskExecutor, AsyncListenableTaskExecutor listenerTaskExecutor) {
        this.consumerTaskExecutor = consumerTaskExecutor;
        this.listenerTaskExecutor = listenerTaskExecutor;
    }

    @Override
    protected void initializeContainer(ConcurrentMessageListenerContainer<K, V> instance) {
        super.initializeContainer(instance);
        instance.getContainerProperties().setConsumerTaskExecutor(consumerTaskExecutor);
        instance.getContainerProperties().setListenerTaskExecutor(listenerTaskExecutor);
    }
}


@Configuration
@AutoConfigureBefore(KafkaAutoConfiguration.class)
public class KafkaExecutorConfig {

    @Bean(name = "consumerTaskExecutor")
    public ThreadPoolTaskExecutor consumerTaskExecutor(){
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(Runtime.getRuntime().availableProcessors());
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("my-C-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.initialize();
        return executor;
    }

    @Bean(name = "listenerTaskExecutor")
    public ThreadPoolTaskExecutor listenerTaskExecutor(){
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("my-L-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.initialize();
        return executor;
    }

    @Bean("kafkaListenerContainerFactory")
    public ConcurrentKafkaListenerContainerFactory<?, ?> kafkaListenerContainerFactory(
            ConcurrentKafkaListenerContainerFactoryConfigurer configurer,
            ConsumerFactory<Object, Object> kafkaConsumerFactory) {
        ConcurrentKafkaListenerContainerFactory<Object, Object> factory = new CustomConcurrentKafkaListenerContainerFactory<Object, Object>(consumerTaskExecutor(),listenerTaskExecutor());
        configurer.configure(factory, kafkaConsumerFactory);
        return factory;
    }
}



```

#### 6.3.5.7. æ¶ˆè´¹è€…ç»„ å¤šçº¿ç¨‹æ¶ˆè´¹

https://www.modb.pro/db/51256


```java
// æ–¹æ¡ˆä¸€: å¤šçº¿ç¨‹+å¤š consumer å®ä¾‹

public class KafkaConsumerRunner implements Runnable {
  private final AtomicBoolean closed = new AtomicBoolean(false);
  private final KafkaConsumer consumer;

  public void run() {
    try{
      consumer.subscribe(Arrays.asList("topic"));
      while(!closed.get()){
        ConsumerRecords records = consumer.poll(Duration.ofMillis(10000));
      }
    }catch (WakeupException e){
      if (!closed.get()) throw e;
    }finally {
      consumer.close();
    }
  }

  public void shutdown() {
    closed.set(true);
    consumer.wakeup();
  }
}




// æ–¹æ¡ˆäºŒ: å•çº¿ç¨‹+å• consumer å®ä¾‹ + worker çº¿ç¨‹æ± 
private final KafkaConsumer<String, String> consumer;
private ExecutorService executors;
...

private int workerNum = ...;
executors = new ThreadPoolExecutor(
            workerNum, workerNum, 0L, TimeUnit.MILLISECONDS,
            new ArrayBlockingQueue<>(1000),
            new ThreadPoolExecutor.CallerRunsPolicy());

...
while (true) {
  ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
  for (final ConsumerRecord record : records) {
    executors.submit(new Worker(record));
  }
}

```

#### 6.3.5.8. æ¶ˆæ¯è½¬å‘

```java
@Component
public class KafkaConsumer {
    // æ¶ˆè´¹ç›‘å¬
    @KafkaListener(topics = {"topic1"})
    @SendTo("topic2")
    public String listen1(String data) {
        System.out.println("ä¸šåŠ¡Aæ”¶åˆ°æ¶ˆæ¯ï¼š" + data);
        return data + "(å·²å¤„ç†)";
    }
 
    // æ¶ˆè´¹ç›‘å¬
    @KafkaListener(topics = {"topic2"})
    public void listen2(String data) {
        System.out.println("ä¸šåŠ¡Bæ”¶åˆ°æ¶ˆæ¯ï¼š" + data);
    }
}
```

### 6.3.6. æ€»ç»“:æ¶ˆæ¯é€è¾¾çš„æƒ…å†µ

```
æ¶ˆæ¯é€è¾¾è¯­ä¹‰æ˜¯æ¶ˆæ¯ç³»ç»Ÿä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œä¸»è¦åŒ…å«ä¸‰ç§è¯­ä¹‰ï¼š

ã€1ã€‘At most onceï¼šæ¶ˆæ¯å‘é€æˆ–æ¶ˆè´¹è‡³å¤šä¸€æ¬¡ï¼›(å…è®¸å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±, ä¸å…è®¸é‡å¤æ¶ˆè´¹)

    å¯¹ producer æ¥è¯´, æ„å‘³ç€ Producerå‘é€å®Œä¸€æ¡æ¶ˆæ¯åï¼Œä¸ä¼šç¡®è®¤æ¶ˆæ¯æ˜¯å¦æˆåŠŸé€è¾¾

        é€šè¿‡é…ç½® Producer çš„ acks=0 && retries=0
            å½“ retries ä¸æ˜¯ 0, æ„å‘³ç€å…è®¸é‡è¯•, å¦‚æœæ²¡æœ‰å°† max.in.flight.requests.per.connection (ä»£è¡¨ç€ä¸€ä¸ª ProduceråŒæ—¶å¯ä»¥å‘é€çš„æœªæ”¶åˆ°ç¡®è®¤çš„æ¶ˆæ¯æ•°é‡)é…ç½®çš„å€¼è®¾ç½®ä¸º1ï¼Œæœ‰å¯èƒ½é€ æˆæ¶ˆæ¯ä¹±åºçš„ç»“æœã€‚(å¦‚æœmax.in.flight.requests.per.connectionæ•°é‡å¤§äº1ï¼Œé‚£ä¹ˆå¯èƒ½å‘é€äº†message1åï¼Œåœ¨æ²¡æœ‰æ”¶åˆ°ç¡®è®¤å‰å°±å‘é€äº†message2ï¼Œæ­¤æ—¶ message1å‘é€å¤±è´¥åè§¦å‘é‡è¯•ï¼Œè€Œ message2ç›´æ¥å‘é€æˆåŠŸï¼Œå°±é€ æˆäº†Brokerä¸Šæ¶ˆæ¯çš„ä¹±åºã€‚max.in.flight.requests.per.connectionçš„é»˜è®¤å€¼ä¸º5ã€‚)

    å¯¹ consumer æ¥è¯´, æ„å‘³ç€æœ‰å¯èƒ½å­˜åœ¨æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ä¾æ—§æäº¤offsetçš„æƒ…å†µ (è€ƒè™‘ä¸‹é¢çš„æƒ…å†µï¼šConsumeré¦–å…ˆè¯»å–æ¶ˆæ¯ï¼Œç„¶åæäº¤ offsetï¼Œæœ€åå¤„ç†è¿™æ¡æ¶ˆæ¯ã€‚åœ¨å¤„ç†æ¶ˆæ¯æ—¶ï¼ŒConsumerå®•æœºäº†ï¼Œæ­¤æ—¶ offsetå·²ç»æäº¤ï¼Œä¸‹ä¸€æ¬¡è¯»å–æ¶ˆæ¯æ—¶è¯»åˆ°çš„æ˜¯ä¸‹ä¸€æ¡æ¶ˆæ¯äº†ï¼Œè¿™å°±æ˜¯ At most onceæ¶ˆè´¹ã€‚)

        consumer é…ç½®:enable.auto.commit=trueï¼šåå°å®šæ—¶æäº¤offsetï¼›, auto.commit.interval.ms (è¡¨ç¤ºåå°æäº¤ offsetçš„æ—¶é—´é—´éš”)é…ç½®ä¸ºä¸€ä¸ªå¾ˆå°çš„æ•°å€¼ã€‚


ã€2ã€‘At least onceï¼šæ¶ˆæ¯å‘é€æˆ–æ¶ˆè´¹è‡³å°‘ä¸€æ¬¡ï¼›(ä¸å…è®¸æ¶ˆæ¯ä¸¢å¤±, å…è®¸é‡å¤æ¶ˆè´¹)

    å¯¹äº producer æ„å‘³ç€å‘é€å®Œæ¶ˆæ¯, éœ€è¦ç¡®è®¤, å¦‚æœ Produceræ²¡æœ‰æ”¶åˆ° Brokerçš„ ackç¡®è®¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šä¸æ–­é‡è¯•å‘é€æ¶ˆæ¯

        Kafkaé»˜è®¤çš„ Produceræ¶ˆæ¯é€è¾¾è¯­ä¹‰å°±æ˜¯ At least once (åŸå› æ˜¯ Kafkaä¸­é»˜è®¤ acks=1å¹¶ä¸” retries=2147483647ã€‚)

    å¯¹äº consumer, æ„å‘³ç€ Consumerå¯¹ä¸€æ¡æ¶ˆæ¯å¯èƒ½æ¶ˆè´¹å¤šæ¬¡ (è€ƒè™‘ä¸‹é¢çš„æƒ…å†µï¼šConsumeré¦–å…ˆè¯»å–æ¶ˆæ¯ï¼Œç„¶åå¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œæœ€åæäº¤offsetã€‚åœ¨å¤„ç†æ¶ˆæ¯æ—¶æˆåŠŸåï¼ŒConsumerå®•æœºäº†ï¼Œæ­¤æ—¶ offsetè¿˜æœªæäº¤ï¼Œä¸‹ä¸€æ¬¡è¯»å–æ¶ˆæ¯æ—¶ä¾æ—§æ˜¯è¿™æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¤„ç†æ¶ˆæ¯çš„é€»è¾‘åˆå°†è¢«æ‰§è¡Œä¸€éï¼Œè¿™å°±æ˜¯ At least onceæ¶ˆè´¹ã€‚)

        consumer é…ç½®: enable.auto.commit=falseï¼šç¦æ­¢åå°è‡ªåŠ¨æäº¤offsetï¼›, æ‰‹åŠ¨è°ƒç”¨ consumer.commitSync()æ¥æäº¤offset, ä¿è¯äº† offsetå³æ—¶æ›´æ–°ï¼›


ã€3ã€‘Exactly onceï¼šæ¶ˆæ¯æ°å¥½åªå‘é€ä¸€æ¬¡æˆ–åªæ¶ˆè´¹ä¸€æ¬¡ï¼›(ä¸å…è®¸ä¸¢å¤±, ä¹Ÿä¸å…è®¸é‡å¤)

    å¯¹äº producer, æ„å‘³ç€ Produceræ¶ˆæ¯çš„å‘é€æ˜¯å¹‚ç­‰çš„ã€‚ è¿™æ„å‘³ç€ä¸è®ºæ¶ˆæ¯é‡å‘å¤šå°‘éï¼Œæœ€ç»ˆ Brokerä¸Šè®°å½•çš„åªæœ‰ä¸€æ¡ä¸é‡å¤çš„æ•°æ®ã€‚(kafka produceré»˜è®¤æ˜¯æ”¯æŒat least once çš„, æ‰€ä»¥ä¸»è¦æ˜¯è¦å®ç°æ¶ˆæ¯å»é‡)

        é€šè¿‡é…ç½® Producerçš„ä»¥ä¸‹é…ç½®é¡¹æ¥å®ç°: 
        
            enable.idempotence=trueã€‚enable.idempotenceé…ç½®é¡¹è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨å¹‚ç­‰æ€§(é»˜è®¤ false)ã€‚å½“ enable.idempotenceé…ç½®ä¸º trueæ—¶ï¼Œackså¿…é¡»é…ç½®ä¸ºallã€‚å¹¶ä¸”å»ºè®® max.in.flight.requests.per.connectionçš„å€¼å°äº5ã€‚

                è®¾ç½® transactional.id (åœ¨ springboot é‡Œæ˜¯é…ç½®äº‹åŠ¡å‰ç¼€ä¸ºéç©º)åï¼Œenable.idempotenceä¼šè‡ªåŠ¨è®¾ç½®ä¸ºtrue

        åŸç†: kafka å¼•å…¥äº†ä¸¤ä¸ªæ¦‚å¿µ
            ã€1ã€‘PIDï¼šæ¯ä¸ªæ–°çš„ Produceråœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„PIDï¼Œè¿™ä¸ª PIDå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼›
            ã€2ã€‘Sequence Numblerï¼šå¯¹äºæ¯ä¸ªPIDï¼Œè¯¥ Producerå‘é€æ•°æ®çš„æ¯ä¸ª<Topic, Partition>éƒ½å¯¹åº”ä¸€ä¸ªä»0å¼€å§‹å•è°ƒé€’å¢çš„Sequence Numberï¼›

    å¯¹äº consumer, æ„å‘³ç€æ¶ˆæ¯çš„æ¶ˆè´¹å¤„ç†é€»è¾‘å’Œoffsetçš„æäº¤æ˜¯åŸå­æ€§çš„ï¼Œå³æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸå offsetæ”¹å˜ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ offsetä¹Ÿèƒ½å›æ»š

        å³éœ€è¦äº‹åŠ¡ç‰¹æ€§, é…ç½® consumer çš„ isolation.level=read_committed, æœ‰ä¸¤ä¸ªå€¼
            - read_committed : æ‰€æœ‰äº‹åŠ¡æœªæäº¤çš„æ•°æ®å°±éƒ½å¯¹ Consumerä¸å¯è§äº†ï¼Œä¹Ÿå°±å®ç°äº† Kafkaçš„äº‹åŠ¡è¯­ä¹‰
            - read_uncommitted (é»˜è®¤)

```

## 6.4. å‚æ•°è°ƒä¼˜

https://blog.csdn.net/hanjibing1990/article/details/51673540 æ¶ˆæ¯ä½“å¤§å°

## å¼€æºç”Ÿæ€

https://github.com/zalando/nakadi é€šè¿‡restful api ä¹Ÿkafkaäº¤äº’


# 7. å³æ—¶é€šè®¯ MQTTåè®®

https://www.jianshu.com/p/e132261456b5
TODO