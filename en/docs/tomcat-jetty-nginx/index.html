<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-tomcat-jetty-nginx">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Tomcat Jetty Nginx 等 web 容器 - Xiaoyureed 的网络 Wiki</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://xiaoyureed.github.io/en/img/logo.webp"><meta data-rh="true" name="twitter:image" content="https://xiaoyureed.github.io/en/img/logo.webp"><meta data-rh="true" property="og:url" content="https://xiaoyureed.github.io/en/docs/tomcat-jetty-nginx"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="xiaoyureed"><meta data-rh="true" name="keywords" content="blog, java, spring, microservice, python, rust, typescript, react, web"><meta data-rh="true" name="keywords" content=" 半路转行的编程爱好者, 写过 Python, Rust, 现在主攻 Java 分布式系统"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Tomcat Jetty Nginx 等 web 容器 - Xiaoyureed 的网络 Wiki"><meta data-rh="true" name="description" content="caddy 代替 NGINX"><meta data-rh="true" property="og:description" content="caddy 代替 NGINX"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://xiaoyureed.github.io/en/docs/tomcat-jetty-nginx"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/en/docs/tomcat-jetty-nginx" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/tomcat-jetty-nginx" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/tomcat-jetty-nginx" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://5SAMPKXTP9-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Xiaoyureed 的网络 Wiki" href="/en/opensearch.xml">


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?f6da56a47f5085d1e0fedae39b8de00a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="xiaoyureed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="xiaoyureed Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="xiaoyureed JSON Feed">

<link rel="icon" href="/en/img/logo.webp">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)">
<meta name="description" content="Xiaoyureed 的个人博客"><link rel="stylesheet" href="/en/assets/css/styles.261d8673.css">
<link rel="preload" href="/en/assets/js/runtime~main.7df8c467.js" as="script">
<link rel="preload" href="/en/assets/js/main.82e41e7b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><a href="/docs/rust-note" target="_blank">Rust 指北, 欢迎查看...</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kuizuo</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">菜单</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/archive">博客</a></li><li><a class="dropdown__link" href="/en/docs/intro">教程</a></li><li><a class="dropdown__link" href="/en/resource">Links</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="xiaoyureed" class="themedImage_ToTc themedImage--dark_i4oU"><b>kuizuo</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/SpringBoot-note">Spring Boot 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/autohotkey">Autohotkey 脚本</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/blockchain">blockchain区块链</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/c-sharp-and-dot-net">C# &amp; .NET</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/chatgpt">Chatgpt Usage Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cpp">CPP and C 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cross-gfw">Cross The GFW</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cs-note">Computer Science Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/css-pre-processor">几种CSS预处理器比较选型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/data-structure-and-algorithm">Data Structure and Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/design-pattern-note">Design Pattern 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/dev-resources">开发者资源</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/distributed-system">Distributed System 分布式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/docker-note-virtual-dev-env">Docker Note &amp; Other Virtual Develop Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/effective-java-reading-note">Effective Java 阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/elk-elastic-log">Distributed log collection分布式日志收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/english-note">英语学习🔥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/extjs-note">Extjs 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/git-note">Git 备忘 🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/golang-note">Golang 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/gps-gis-tracing">基于地理位置开发技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/gradle">Gradle note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/greasy-monkey">油猴插件&amp;编写脚本🐒</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/groovy-note">groovy note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/health">Health 关爱程序员健康🏥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/how-to-test-java-app">How to Test Java App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/interview-system-design">系统设计 System design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/iot">Iot 物联网</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-code-clean">Java Clean Code Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-concurrent">Java Concurrent🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-memory-model-jmm-jvm">JMM and GC🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-note">Java Core 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/js-tutorial">JavaScript tutorial</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/kotlin">kotlin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/kubernetes-k8s">kubernetes-k8s ☁️</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux-note">鸟哥的 Linux 私房菜阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/low-code-platform">关于低代码平台的调研</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mac">Mac 开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/machine-learning-ml">machine-learning-ml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/marketing-seo">Marketing SEO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/maven-note">Maven Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/message-queue">Message Queue🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/money">Investment Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mongodb-note">MongoDB Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/monitor-system-grafana-prometheus-influxdb-hbase-time-serials-database">monitor-system-grafana-prometheus监控🖥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mvc-mvvm">MVC to MVVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mybatis-note">MyBatis Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/netty-note">netty</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/nlp-natural-language-processing">nlp-natural-language-processing👄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/nodejs-yarn-npm">Nodejs, Yarn, Npm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/oracle">Oracle 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-audio-video">Audio and Video development Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-big-data-introduce">大数据开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-cache">Cache 缓存🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-computational-ad">计算广告 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-crawler-spider">网络爬虫 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-db-design-note">关系型数据库表设计🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-desktop-develop">桌面应用开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-http-restful">HTTP protocol Intro &amp; RESTful</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-reactive-programming">响应式编程 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-rpc">RPC Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-rule-engine-note">规则引擎 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/php-note">PHP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/postgres-note">Postgres note🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/process-workflow-bpm-engine">工作流引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/protect-your-app-authentication-oauth2-jwt-https">Protect Your App 安全保护认证鉴权🔑</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/psychology">psychology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/python-note">Python🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/quant-money">量化交易</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/quarkus">Quarkus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/react-note">React🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/real-time-communication-protocol">实时通信 Real-time</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/redis-note">Redis🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/regex">Regular Expression 正则🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/rust-note">Rust 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/scala-akka-play-framework">Scala 语言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/serverless">Serverless</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/service-mesh">service mesh 服务网格</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/servlet">Servlet Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/shell-bash-note">shell-bash脚本收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/spring-note">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/springcloud-note">Spring Cloud 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/springmvc-note">Spring MVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/task-schedule-note">Task Schedule</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/tcp-ip-note-p2p">TCP IP, p2p</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/en/docs/tomcat-jetty-nginx">Tomcat Jetty Nginx 等 web 容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/vertx">Vertx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/video-creator">拍摄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/vue">Vue Brief Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/webassembly">webassembly</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/webpack-esbuild-vite-rollup">前端打包构建工具</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Tomcat Jetty Nginx 等 web 容器</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Tomcat Jetty Nginx 等 web 容器</h1></header><div align="center">caddy 代替 NGINX<p>比较Tomcat, jetty, Nginx; 笔记
references: <a href="https://www.zhihu.com/question/32212996" target="_blank" rel="noopener noreferrer">1</a>, <a href="https://blog.csdn.net/zhongyanpingzzz/article/details/50353111" target="_blank" rel="noopener noreferrer">2</a>,</p></div><ul><li><a href="#%E6%AF%94%E8%BE%83">比较</a><ul><li><a href="#tomcat%E5%92%8Cjetty">Tomcat和jetty</a></li><li><a href="#apache-http-server%E5%92%8Cnginx">Apache http server和Nginx</a></li></ul></li><li><a href="#nginx">nginx</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></li><li><a href="#nginx-%E6%97%A0%E6%B3%95%E5%81%9C%E6%AD%A2-%E6%97%A0%E6%B3%95%E9%87%8D%E5%90%AF">nginx 无法停止 无法重启</a></li><li><a href="#nginxconf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">nginx.conf 配置文件</a><ul><li><a href="#%E6%9C%80%E7%AE%80%E9%85%8D%E7%BD%AE">最简配置</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95">配置语法</a><ul><li><a href="#location">location</a></li><li><a href="#proxy_pass">proxy<!-- -->_<!-- -->pass</a></li></ul></li><li><a href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">反向代理配置</a></li><li><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE">负载均衡配置</a></li><li><a href="#gzip-%E5%8E%8B%E7%BC%A9">gzip 压缩</a></li><li><a href="#websocket-%E9%85%8D%E7%BD%AE">websocket 配置</a></li><li><a href="#%E6%90%AD%E5%BB%BA%E8%B0%B7%E6%AD%8C%E9%95%9C%E5%83%8F%E7%AB%99">搭建谷歌镜像站</a></li><li><a href="#%E4%B8%8A-https">上 https</a></li><li><a href="#%E7%BB%84%E6%88%90%E5%85%83%E7%B4%A0">组成元素</a></li></ul></li><li><a href="#%E6%90%AD%E9%85%8D-docker-%E4%BD%BF%E7%94%A8">搭配 docker 使用</a></li><li><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AEdemo">负载均衡配置demo</a></li><li><a href="#nginx%E5%92%8Clua%E8%84%9A%E6%9C%AC">nginx和lua脚本</a></li><li><a href="#tengine">tengine</a></li><li><a href="#nginx-%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91">nginx 模块开发</a></li><li><a href="#nginx-lua-%E5%BC%80%E5%8F%91%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1">nginx-lua 开发高并发服务</a></li><li><a href="#nginx%E9%9D%A2%E8%AF%95%E9%A2%98">nginx面试题</a><ul><li><a href="#nginx%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84">nginx是如何实现高并发的</a></li><li><a href="#nginx-%E5%92%8C-apache-%E5%8C%BA%E5%88%AB">nginx 和 apache 区别</a></li><li><a href="#fastcgi-%E4%B8%8E-cgi-%E7%9A%84%E5%8C%BA%E5%88%AB">fastcgi 与 cgi 的区别</a></li></ul></li><li><a href="#nginx-%E9%85%8D%E7%BD%AE%E8%B0%83%E4%BC%98">NGINX 配置调优</a></li></ul></li><li><a href="#jetty">jetty</a><ul><li><a href="#%E9%83%A8%E7%BD%B2-app-%E5%88%B0-jetty-%E5%86%85%E9%83%A8">部署 app 到 jetty 内部</a></li><li><a href="#jetty%E6%94%AF%E6%8C%81servlet30%E6%B3%A8%E8%A7%A3">jetty支持servlet3.0注解</a></li><li><a href="#jetty%E7%9A%84%E6%95%B4%E4%B8%AA%E7%BB%93%E6%9E%84">jetty的整个结构</a></li><li><a href="#jetty%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B">Jetty的工作过程</a><ul><li><a href="#%E5%90%AF%E5%8A%A8">启动</a></li><li><a href="#%E6%8E%A5%E5%8F%97%E8%AF%B7%E6%B1%82">接受请求</a></li><li><a href="#%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82">处理请求</a></li></ul></li></ul></li><li><a href="#tomcat">Tomcat</a><ul><li><a href="#tomcat-%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84">Tomcat 总体结构</a><ul><li><a href="#connector">Connector</a></li><li><a href="#container">Container</a></li></ul></li><li><a href="#%E7%94%A8%E5%88%B0%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">用到了哪些设计模式</a><ul><li><a href="#facade">Facade</a></li><li><a href="#observer">Observer</a></li><li><a href="#command">Command</a></li><li><a href="#chain-of-responsibility">Chain of responsibility</a></li></ul></li><li><a href="#tomcat-%E4%BC%98%E5%8C%96">Tomcat 优化</a></li></ul></li></ul><h1>比较</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tomcat和jetty">Tomcat和jetty<a href="#tomcat和jetty" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><ul><li><p>jetty和Tomcat类似, 均为servlet容器 - 他们都支持标准的servlet规范和JavaEE的规范</p></li><li><p>jetty比Tomcat轻量级</p></li><li><p>Jetty比tomcat更容易扩展</p><ul><li><p>jetty的架构是基于Handler来实现的，主要的扩展功能都可以用Handler来实现，扩展简单. Tomcat的架构是基于容器设计的，进行扩展是需要了解Tomcat的整体设计结构，不易扩展。</p></li><li><p>jetty是使用java编写的，他的api是一组以jar包的形式发布，开发人员可以将jetty容器实例化成一个对象，可以迅速为一些独立（stand-alone）的java应用提供网络和web链接</p></li></ul></li><li><p>主攻方向不同:</p><ul><li>jetty可以利用 Continuation 机制来处理大量的用户请求以及时间比较长的连接, 适合于web聊天应用等等,像淘宝的 web 旺旺就是用 Jetty 作为 Servlet 引擎; </li><li>Tomcat适合处理少数非常繁忙的链接，也就是说链接生命周期短的话，Tomcat的总体性能更高</li></ul></li><li><p>Tomcat默认采用BIO处理I/O请求，在处理静态资源时，性能较差。Jetty默认采用NIO在处理I/O请求上更占优势，在处理静态资源时，性能较高</p></li><li><p>Jetty更满足公有云的分布式环境的需求 ,比如 Google app engine ，而Tomcat更符合企业级环境</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="apache-http-server和nginx">Apache http server和Nginx<a href="#apache-http-server和nginx" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><ul><li><p>Nginx类似于Apache http server, 不像Tomcat可以支持生成动态页面，但它们可以通过其他模块来支持（例如通过Shell、PHP、Python脚本程序来动态生成内容）</p></li><li><p>Tomcat通常和Nginx配合使用</p><ul><li><p>动静态资源分离——运用Nginx的反向代理功能分发请求：所有动态资源的请求交给Tomcat，而静态资源的请求（例如图片、视频、CSS、JavaScript文件等）则直接由Nginx返回到浏览器，这样能大大减轻Tomcat的压力。</p></li><li><p>负载均衡，当业务压力增大时，可能一个Tomcat的实例不足以处理，那么这时可以启动多个Tomcat实例进行水平扩展，而Nginx的负载均衡功能可以把请求通过算法分发到各个不同的实例进行处理</p></li></ul></li><li><p>Nginx相对于Apache的优点: 轻量级; 抗并发(nginx 处理请求是异步非阻塞的，而apache 则是阻塞型的); 高度模块化的设计，编写模块相对简单; 提供负载均衡;</p></li><li><p>Apache优点: apache的 rewrite 比nginx 的强大; 性能稳定，而nginx相对bug较多; Apache 对 PHP 支持比较简单，Nginx 需要配合其他后端用</p><ul><li>apache rewrite -&gt; <a href="http://httpd.apache.org/docs/current/rewrite/" target="_blank" rel="noopener noreferrer">http://httpd.apache.org/docs/current/rewrite/</a>, 主要的功能就是实现URL的跳转</li></ul></li></ul><h1>nginx</h1><p><a href="https://www.zhihu.com/question/266535644?sort=created" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/question/266535644?sort=created</a>
<a href="http://openresty.org/en/" target="_blank" rel="noopener noreferrer">http://openresty.org/en/</a>   nginx 和 lua</p><p><a href="https://github.com/jaywcjlove/nginx-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/jaywcjlove/nginx-tutorial</a></p><p><a href="https://docshome.gitbook.io/nginx-docs/" target="_blank" rel="noopener noreferrer">https://docshome.gitbook.io/nginx-docs/</a> 中文文档</p><p><a href="https://github.com/dunwu/nginx-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/dunwu/nginx-tutorial</a> 入门</p><p><a href="https://github.com/caddyserver/caddy" target="_blank" rel="noopener noreferrer">https://github.com/caddyserver/caddy</a> 替代 nginx , 自动支持 https</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="使用场景">使用场景<a href="#使用场景" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><ul><li><p>静态web服务器, </p></li><li><p>负载均衡, </p></li><li><p>反向代理</p><p>  (以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。)图示:</p></li><li><p>http 缓存</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="常用命令">常用命令<a href="#常用命令" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># -s 即signal, 向 nginx 发送 start|reload|stop 命令的意思 </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s start;     # 启动</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">./sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s stop       # 快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s quit       # 平稳关闭Nginx，保存相关信息，有安排的结束web服务。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s reload     # 因改变了Nginx相关配置，需要重新加载配置而重载。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s reopen     # 重新打开日志文件。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -c filename   # 为 Nginx 指定一个配置文件，来代替缺省的。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -t            # 检查配置文件的语法的正确性。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    # 不运行，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -v            # 显示 nginx 的版本。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx-无法停止-无法重启">nginx 无法停止 无法重启<a href="#nginx-无法停止-无法重启" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">netstat -tunlp |grep nginx # 找到暴露的端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fuser -k 80/tcp # 杀死访问指定文件/网络socket的所有进程</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fuser -k 8088/tcp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginxconf-配置文件">nginx.conf 配置文件<a href="#nginxconf-配置文件" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="最简配置">最简配置<a href="#最简配置" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen       80;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name  localhost;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root   /usr/share/nginx/html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    index  index.html index.htm;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    try_files $uri /index.html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="配置语法">配置语法<a href="#配置语法" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p><a href="https://thinking.renzhansheng.cn/pages/nginx/" target="_blank" rel="noopener noreferrer">https://thinking.renzhansheng.cn/pages/nginx/</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="location">location<a href="#location" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location [ = | ~ | ~* | ^~ | @ ] uri { ... }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">匹配方式(优先级由高到低)：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    精确匹配：使用修饰符=。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    前缀匹配：使用修饰符^~。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    正则匹配：使用修饰符~（区分大小写）和~*（不区分大小写）。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    最长匹配：没有修饰符，使用匹配到的最长记录。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    nginx内部跳转: @</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location /img/ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    error_page 404 @img_err;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#以 /img/ 开头的请求，如果链接的状态为 404, 则会匹配到 @img_err 这条规则上。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location @img_err {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 精确匹配</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 只匹配请求/ , 请求/精准匹配A，不再往下查找</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location = / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration A ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 正则匹配，不区分大小写</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 通过后缀匹配图片, /images/.../1.jpg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 请求/index.html匹配B。首先找到最长匹配B，接着又按照顺序查找匹配的正则。结果没有找到，因此使用先前标记的最长匹配，即配置B。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 请求/documents/about.html匹配B。因为B表示任何以/开头的URL都匹配。在上面的配置中，只有B能满足，所以匹配B。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~* \.(gif|jpg|jpeg)$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration B ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 前缀匹配</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 匹配 /images/xxx/yyyy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 请求/user/index.html匹配C。首先找到最长匹配C，由于后面没有匹配的正则，所以使用最长匹配C。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ^~ /images/ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration C ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 前缀匹配</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 匹配 /img/xxx/yyyy, /imgx,/imgy/abc/1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 请求/images/1.jpg匹配D。首先进行前缀字符的查找，找到最长匹配D。但是，特殊的是它使用了^~修饰符，不再进行接下来的正则的匹配查找，因此使用D。这里，如果没有前面的修饰符，其实最终的匹配是E。大家可以想一想为什么。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ^~ /img {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration D ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 请求/user/1.jpg匹配E。首先找到最长匹配项C，继续进行正则查找，找到匹配项E。因此使用E。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration E ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location /user/ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [ configuration F ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="proxy_pass">proxy_pass<a href="#proxy_pass" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location [ = | ~ | ~* | ^~ ] uri {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://host:port[uri0]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># uri0可以是 /, /www, /www/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 不存在uri0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">actualUrl = requestUrl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 存在uri0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">actualUrl = uri0 + requestUrl.remove(uri)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 以请求http://localhost:8080/api/values/ccc为例：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="反向代理配置">反向代理配置<a href="#反向代理配置" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>nginx的反向代理是依赖于ngx_http_proxy_module这个module来实现的</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># 场景: 我要把这个https协议的图片请求反向代理到http协议的真实图片上。https协议 的这张图片是不存在，而它有一个地址实际指向的内容是http协议中的图片</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># https</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ; 没域名则填 IP地址</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name www.example.com;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen       443;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location /newchart/hollow/small/nsh000001.gif {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://image.sinajs.cn/newchart/hollow/small/nsh000001.gif;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location /newchart/hollow/small/nsz399001.gif {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://image.sinajs.cn/newchart/hollow/small/nsz399001.gif;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 再看一个例子</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">upstream rails365 {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #指定了一个服务器，这个服务器和nginx 是同一台机器的，用的是unix socket来连接，连接的是一个unicorn进程 (进程内跑的是 ruby on rails 代码)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server unix:///home/yinsigan/rails365/shared/tmp/sockets/unicorn.sock fail_timeout=0;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ; 若希望负载均衡, 部署多一个unicorn进程，监听在另外的unix socket上，就等于多了一台服务器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #server unix:///home/yinsigan/rails365_cap/shared/tmp/sockets/unicorn.sock;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen 80 default_server;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen [::]:80 default_server ipv6only=on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name www.rails365.net;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root         /home/yinsigan/rails365/current/public;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #这里表示若访问 www.rails365.net, 先找 root目录 下的 index.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #若访问的是 www.rails365.net/about.html或者其他的非 index 页面 , 找 root 下的 about.html或者其他对应的非 index 页面, 若没找到, 会执行 @rails365 即 location @rails365 {...}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        try_files $uri/index.html $uri @rails365; </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location @rails365 {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_set_header Host $http_host;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_redirect off;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            #反向代理(转发)到 upstream rails365 指定的内容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass http://rails365;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        } }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="负载均衡配置">负载均衡配置<a href="#负载均衡配置" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>在版本1.9之前，它只能作为http 的负载均衡，也就是在网络模型的第七层发挥作用，1.9之后，它可以对tcp进行负 载均衡，比如redis，mysql等</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain"># load balance config 负载均衡</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 位于 server 下</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">; 就是在 反向代理基础上, 在 upstream 下多加几个 server节点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># upstream的负载均衡配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">upstream aaa {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #默认情况下，如果不指定方式，就是随机轮循(round-robin)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #还有中方式 least_conn;, (优先发送给那些接受请求少的节点)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    least_conn;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #ip_hash 可以记录请求来源的ip，如果是同一个ip，下次访问的时候还是会到相同 的主机，这个可以略微解决那种带cookie，session的请求的一致性问题</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ip_hash;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #hash方式, 控制粒度更小, 可根据任意变量来控制</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    hash $request_uri consistent;   # 通过请求地址($request_uri)来控制, 相同的请求地址路由到相同的节点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。default to 1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server 192.168.80.121:80 weight=3;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server 192.168.80.122:80 weight=2;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server 192.168.80.123:80 weight=3;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #down 暂时移出某个节点</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server xxx.xxx.xxx.xx down;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #backup 备用节点, 相对于备份的机器来说，其他的机器就相当于主要服务器，只要当主要服务器不可用的时候，才会用到备用服务器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server xxx.xxx.xxx.xx backup;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #max_fails和fail_timeout</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #默认情况下，max_fails的值为1，表示的是请求失败的次数，请求1次失败就换到下台主机</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #fail_timeout，表示的是请求失败的超时时间，在设定的时间内 没有成功，那作为失败处理</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server xxxxx max_fails=2;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://aaa;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_set_header Host $host; # nginx 转发时会丢失 Host header, 这里加上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gzip-压缩">gzip 压缩<a href="#gzip-压缩" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>需要nginx已经有编译过 ngx_http_gzip_module 这个模块, 能对需要的静态文件压缩大小，比如图片，css，javascript，html等, 压缩是 需要消耗CPU，但能提高传缩的速度，因为传缩量少了许多，从而节省带宽;</p><p>浏览器也要支 持解压功能，只要浏览器的请求头带上 Accept-Encoding: gzip 即可</p><p>别对二进制文件，比如图片做gz压缩，因为没有任何意义</p><p><a href="https://blog.csdn.net/qq_36431213/article/details/78221189" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_36431213/article/details/78221189</a></p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">; http 全局开启 gzip 压缩</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ; 必须</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">; 可选</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_disable &quot;msie6&quot;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_vary on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_proxied any;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_comp_level 6;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_buffers 16 8k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_http_version 1.1;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ; 在需要压缩的资源这里配置三行</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #assets 目录下有很多静态资源，比如js，css等</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ ^/assets/ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        gzip_static on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        expires max;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        add_header Cache-Control public;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="websocket-配置">websocket 配置<a href="#websocket-配置" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">; 可以在 浏览器 console 中测试 new WebSocket(&#x27;ws://www.example.com/wx&#x27;);</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">upstream ws {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server unix:///home/eason/tt_deploy/shared/tmp/sockets/puma.sock fail_timeout=0;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location /ws/ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://ws;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_http_version 1.1;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_set_header Upgrade $http_upgrade;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_set_header Connection &quot;upgrade&quot;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">} }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="搭建谷歌镜像站">搭建谷歌镜像站<a href="#搭建谷歌镜像站" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>ngx_http_google_filter_module 是一个nginx的插件，用 的原理是nginx的反向代理, (依赖于 ngx_http_substitutions_filter_module 这个库)</p><p>要有一台能访问google.com的vps或云主机</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  # ... part of server configuration</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  resolver 8.8.8.8;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    google on; </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># ... </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="上-https">上 https<a href="#上-https" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p><a href="https://ruby-china.org/topics/31983" target="_blank" rel="noopener noreferrer">https://ruby-china.org/topics/31983</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="组成元素">组成元素<a href="#组成元素" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>分号结尾</p><p>分为几个部分:</p><ul><li>全局块: configuring cmds that affect the global, eg: user group, worker number, log file path, pid path...</li><li>events: config the network connections, such as worker max connection num, even driven model...</li><li>http module: 日志 , 代理 ,缓存...超时..., <ul><li>http global module, 如 upstream, 超时, error page</li><li>include /etc/nginx/conf.d/<em>.conf 包含其他配置文件 (即 http 块儿下的配置可以放置到其他配置文件)
所以 nginx.conf 基本不用动, 添加新的路由配置, 只需要到 /etc/nginx/conf.d/</em>.conf 新建配置文件重启 nginx即可</li><li>server module 1 配置虚拟主机<ul><li>location 1 配置 route</li><li>location 2</li></ul></li><li>server module 2;</li></ul></li><li>mail</li></ul><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 定义Nginx运行的用户和用户组</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">user www www;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#工作进程个数 建议设置为等于CPU总核心数</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_processes  1;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#error_log  logs/error.log;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#error_log  logs/error.log  notice;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#error_log  /usr/local/nginx/logs/error.log info;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#进程pid文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">#pid        logs/nginx.pid;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 若为空, 需要保留这一个段落</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">events {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 单个工作进程最大并发连接数, 默认 1024, 也不能设置太大，不能让你的CPU跑满100%</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    worker_connections  1024;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 使用什么事件模型， use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #use epoll;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #连接超时时间。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #keepalive_timeout 60;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #client_header_buffer_size 4k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 事件驱动模型</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #文件扩展名与文件类型映射表 (支持的 mine 类型)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include       /etc/nginx/mime.types;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #默认文件类型</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type  application/octet-stream;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #默认编码</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #charset utf-8; </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # server_names_hash_bucket_size 128; #服务器名字的hash表大小</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # client_header_buffer_size 32k; #上传文件大小限制</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 日志格式</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #日志路径</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #access_log  logs/access.log  main;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #开启高效文件传输模式，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等 磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #注意：如果图片显示不正常把这个改成off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sendfile        on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #autoindex on; #开启目录列表访问，合适下载服务器，默认关闭。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ##防止网络阻塞</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #tcp_nopush     on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    tcp_nodelay on; #防止网络阻塞</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    keepalive_timeout 120; #长连接超时时间，单位是秒</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_connect_timeout 300;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_send_timeout 300;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_read_timeout 300;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_buffer_size 64k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_buffers 4 64k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_busy_buffers_size 128k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_temp_file_write_size 128k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #gzip模块设置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip on; #开启gzip压缩输出</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 不是必须</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_min_length 1k; #最小压缩文件大小</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_buffers 4 16k; #压缩缓冲区</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_http_version 1.0; #压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_comp_level 2; #压缩等级</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #压缩类型，默认就已经包含text/html，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_types text/plain application/x-javascript text/css application/xml;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    gzip_vary on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 虚拟主机的配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # 可以放到其他配置文件, 通过 http.include 引入, 如 (常用) -&gt; include /etc/nginx/conf.d/*.conf , 每个 .conf 是一个 server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # 监听端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen       8080;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # #域名, 当前 server 为这个域名服务</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # nginx会 比较 请求头里的 Host 请头, 和这里比较</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #可以有多个，用空格隔开</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name  localhost aa.cn;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #index index.html index.htm index.php;  # 设置访问主页 (也可以在 location.index 设置)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #root /home/wwwroot/aa.cn/web$subdomain;# 访问域名跟目录  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">     # 绑定目录为二级域名 bbb.aa.com  根目录 /bbb  文件夹</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        set $subdomain &#x27;&#x27;; # 定义变量</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        if ( $host ~* &quot;(?:(\w+\.){0,})(\b(?!www\b)\w+)\.\b(?!(com|org|gov|net|cn)\b)\w+\.[a-zA-Z]+&quot; ) { </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            set $subdomain &quot;/$2&quot;; </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        include rewrite/dedecms.conf; #rewrite end   #载入其他配置文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #charset koi8-r;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #access_log  logs/host.access.log  main;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / { # 为 / (根路径) 配置 路径映射, 若为 /articles, 则是为 /articles 配置路径映射</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            root   html; # 项目根目录为 html (即 /usr/share/nginx/html)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            index  index.html index.htm; # 欢迎页</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass http://baidu.com ;# 代理给百度</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_set_header Host $host; # nginx 转发给 gateway, 会丢失 Host , 这里给补上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #图片缓存时间设置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~ .*.(gif|jpg|jpeg|png|bmp|swf)$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        　　expires 10d;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #JS和CSS缓存时间设置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~ .*.(js|css)?$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        　　expires 1h;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #error_page  404              /404.html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # redirect server error pages to the static page /50x.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        error_page   500 502 503 504  /50x.html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location = /50x.html {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            root   html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #location ~ \.php$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    proxy_pass   http://127.0.0.1;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #location ~ \.php$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    root           html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    fastcgi_pass   127.0.0.1:9000;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    fastcgi_index  index.php;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    include        fastcgi_params;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        # concurs with nginx&#x27;s one</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #location ~ /\.ht {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #    deny  all;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #动态路由配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #当用户访问 http://example.org 时就会去读取 /data/www/index.html, 若没有, 则 index.php, 就会就会转发到 &quot;location ~ \.php$ {...}&quot; 里面的逻辑</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen 80;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name xxx.org www.xxx.org;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root   /data/www;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            index index.html index.php;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~* \.(gif|jpg|png)$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            expires 30d;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~ \.php$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            fastcgi_pass  localhost:9000;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            fastcgi_param SCRIPT_FILENAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                $document_root$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            include       fastcgi_params;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #对 &quot;/&quot; 启用反向代理</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://127.0.0.1:88;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_redirect off;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #以下是一些反向代理的配置，可选。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header Host $host;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        client_max_body_size 10m; #允许客户端请求的最大单文件字节数</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的设置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_temp_file_write_size 64k;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #设定查看Nginx状态的地址</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location /NginxStatus {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stub_status on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        access_log on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        auth_basic &quot;NginxStatus&quot;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        auth_basic_user_file conf/htpasswd;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #htpasswd文件的内容可以用apache提供的htpasswd工具来产生。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #本地动静分离反向代理配置</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #所有jsp的页面均交由tomcat或resin处理</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ .(jsp|jspx|do)?$ {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header Host $host;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://127.0.0.1:8080;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #所有静态文件由nginx直接读取不经过tomcat或resin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$ {　　 </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        expires 15d;　　 </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ .*.(js|css)?$ { 　　</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        expires 1h;　　</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    listen       8000;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    listen       somename:8080;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    server_name  somename  alias  another.alias;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #        root   html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #        index  index.html index.htm;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    # HTTPS server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    listen       443 ssl;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    server_name  localhost;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_certificate      cert.pem;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_certificate_key  cert.key;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_session_cache    shared:SSL:1m;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_session_timeout  5m;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    ssl_prefer_server_ciphers  on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    location / {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #        root   html;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #        index  index.html index.htm;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mail {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="搭配-docker-使用">搭配 docker 使用<a href="#搭配-docker-使用" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="http://www.ruanyifeng.com/blog/2018/02/nginx-docker.html" target="_blank" rel="noopener noreferrer">http://www.ruanyifeng.com/blog/2018/02/nginx-docker.html</a></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ docker container run \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -p 127.0.0.2:8080:80 \    # 容器的80端口映射到127.0.0.2:8080</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --rm \                    # 容器停止运行后，自动删除容器文件(不是image), 如果是后台运行(-d), 则无效</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --name mynginx \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  nginx                     # 本地没有这个image, 会自动从远程 pull 最新版</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># $PWD表示当前目录, 接string需要&quot;&quot;, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ docker container run \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -p 127.0.0.2:8080:80 \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --rm \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --name mynginx \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --volume $PWD/html:/usr/share/nginx/html \</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">$ ducker run -p 8080:80 --rm --name mynginx --privileged=true -v &quot;$PWD/html&quot;:/usr/share/nginx/html -v &quot;$PWD/conf&quot;:/etc/nginx nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="负载均衡配置demo">负载均衡配置demo<a href="#负载均衡配置demo" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #设定mime类型,类型由mime.type文件定义</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include       /etc/nginx/mime.types;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type  application/octet-stream;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #设定日志格式</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    access_log    /var/log/nginx/access.log;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    #设定负载均衡的服务器列表, 然后在location中对应。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    upstream load_balance_server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #weigth参数表示权值，权值越高被分配到的几率越大</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server 127.0.0.1        weight=2;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server 127.0.0.1:8081   weight=1;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   #HTTP服务器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   server {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #监听80端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen       8090;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #以什么IP进行访问</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name  localhost;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        #对所有请求进行负载均衡请求</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location /blog {</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            #请求转向load_balance_server 定义的服务器列表</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass  http://load_balance_server ;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>即上面配置中的upstream可选的四种负载均衡算法(<a href="https://zhuanlan.zhihu.com/p/25102281" target="_blank" rel="noopener noreferrer">ref</a>))</p><ul><li>服务器轮询（默认方式）</li><li>ip_hash</li><li>fair</li><li>url_hash</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx和lua脚本">nginx和lua脚本<a href="#nginx和lua脚本" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="http://wiki.jikexueyuan.com/project/nginx-lua/introduction.html" target="_blank" rel="noopener noreferrer">http://wiki.jikexueyuan.com/project/nginx-lua/introduction.html</a>
<a href="https://blog.csdn.net/cgj296645438/article/details/88560461" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/cgj296645438/article/details/88560461</a> 灰度发布
<a href="https://www.cnblogs.com/wangxusummer/p/4309007.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/wangxusummer/p/4309007.html</a> ngx_lua 模块
<a href="https://www.cnblogs.com/xd502djj/p/6097773.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/xd502djj/p/6097773.html</a>, <a href="https://www.cnblogs.com/digdeep/p/4859575.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/digdeep/p/4859575.html</a> Openrestry入门</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tengine">tengine<a href="#tengine" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>1、tengine是在nginx上面开发的，包含了nginx的性能。</p><p>2、tengine更适合大访问量网站的需求，相比nginx更加的稳定，性能更加的强劲。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx-模块开发">nginx 模块开发<a href="#nginx-模块开发" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="http://blog.codinglabs.org/articles/intro-of-nginx-module-development.html" target="_blank" rel="noopener noreferrer">http://blog.codinglabs.org/articles/intro-of-nginx-module-development.html</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx-lua-开发高并发服务">nginx-lua 开发高并发服务<a href="#nginx-lua-开发高并发服务" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="https://github.com/openresty/lua-nginx-module" target="_blank" rel="noopener noreferrer">https://github.com/openresty/lua-nginx-module</a> 章亦春
<a href="http://openresty.org/cn/" target="_blank" rel="noopener noreferrer">http://openresty.org/cn/</a></p><p><a href="https://blog.csdn.net/enweitech/article/details/78519398" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/enweitech/article/details/78519398</a>  随后Tengine也包含了ngx_lua模块。至于二者的区别：OpenResty是Nginx的Bundle；而Tengine则是Nginx的Fork。值得一提的是，OpenResty和Tengine均是国人自己创建的项目，前者主要由春哥和晓哲开发，后者主要由淘宝打理。</p><p><a href="https://www.cnblogs.com/chopper-poet/p/10744214.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/chopper-poet/p/10744214.html</a>  nginx+lua在我司的实践案例</p><p>openrestry开发环境搭建 《跟我学Nginx+Lua开发》 <a href="https://blog.csdn.net/xlxxcc/article/details/61927151" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/xlxxcc/article/details/61927151</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx面试题">nginx面试题<a href="#nginx面试题" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="https://www.cnblogs.com/mmdln/p/8952261.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/mmdln/p/8952261.html</a>
<a href="https://blog.csdn.net/xal0610/article/details/79531692" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/xal0610/article/details/79531692</a></p><p>TODO</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx是如何实现高并发的">nginx是如何实现高并发的<a href="#nginx是如何实现高并发的" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>一个主进程，多个工作进程，每个工作进程可以处理多个请求</p><p>事件驱动：每进来一个request，会有一个worker进程去处理。但不是全程的处理，处理到可能发生阻塞的地方，比如向上游（后端）服务器转发request，并等待请求返回。那么，这个处理的worker继续处理其他请求，而一旦上游服务器返回了，就会触发这个事件，worker才会来接手，这个request才会接着往下走。</p><p>由于web server的工作性质决定了每个request的大部份生命都是在网络传输中，实际上花费在server机器上的时间片不多。这是几个进程就解决高并发的秘密所在</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx-和-apache-区别">nginx 和 apache 区别<a href="#nginx-和-apache-区别" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>nginx 比 apache 占用更少的资源</p><p>nginx 处理请求是异步非阻塞的，一个进程可以同时处理多个连接；apache 是阻塞的， 一个进程只能同时处理一个连接</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="fastcgi-与-cgi-的区别">fastcgi 与 cgi 的区别<a href="#fastcgi-与-cgi-的区别" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nginx-配置调优">NGINX 配置调优<a href="#nginx-配置调优" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="https://www.v2ex.com/t/894781#reply19" target="_blank" rel="noopener noreferrer">https://www.v2ex.com/t/894781#reply19</a> -&gt; <a href="https://serverfault.com/questions/47876/handling-http-and-https-requests-using-a-single-port-with-nginx/930789#930789" target="_blank" rel="noopener noreferrer">https://serverfault.com/questions/47876/handling-http-and-https-requests-using-a-single-port-with-nginx/930789#930789</a> http, https 使用同一个端口 (四层代理)</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">#https://github.com/Kalasearch/high-performance-nginx-tls-tuning</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen 443 ssl http2; # 开启 HTTP/2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">; 调整 Cipher 优先级</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"># 手动启用 cipher 列表</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">; 尽量挑选更新更快的 Cipher，有助于减少延迟(https://stackoverflow.com/questions/36672261/how-to-reduce-ssl-time-of-website)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssl_prefer_server_ciphers on;  # prefer a list of ciphers to prevent old and slow ciphers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssl_ciphers &#x27;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&#x27;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">; 启用 OCSP Stapling</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssl_stapling on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssl_stapling_verify on;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssl_trusted_certificate /path/to/full_chain.pem;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>jetty</h1><p>references: <a href="https://www.cnblogs.com/windlaughing/archive/2013/06/07/3125358.html" target="_blank" rel="noopener noreferrer">embed jetty into your app</a>, <a href="https://my.oschina.net/tryUcatchUfinallyU?tab=newest&amp;catalogId=300813" target="_blank" rel="noopener noreferrer">source code reading</a>, <a href="https://www.eclipse.org/jetty/documentation/9.4.12.v20180830/" target="_blank" rel="noopener noreferrer">official specifications</a></p><p>embed jetty into your app -&gt; <a href="https://github.com/xiaoyureed/samples/" target="_blank" rel="noopener noreferrer">https://github.com/xiaoyureed/samples/</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="部署-app-到-jetty-内部">部署 app 到 jetty 内部<a href="#部署-app-到-jetty-内部" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>开发好的应用程序打成 WAR 包放到 Jetty 的 Webapps 目录下面。然后用如下的命令来启动 Jetty 服务器：Java –jar start.jar， 在启动服务器后。我们就可以访问我们的应用程序了，Jetty 的默认端口是 8080，WAR 的名字也就是我们的应用程序的 Root Context。例如一个典型的 URL 就是：<code>http://127.0.0.1:8080/sample/index.html</code> 。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="jetty支持servlet30注解">jetty支持servlet3.0注解<a href="#jetty支持servlet30注解" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Jetty Distribution - 默认支持</p><p>Jetty Maven Plugin - pre-enabled for the Maven plugin</p><p>embedded jetty 需要手动设置:  include the <code>jetty-annotations</code> jar, include the <code>org.eclipse.jetty.annotations.AnnotationConfiguration</code></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="jetty的整个结构">jetty的整个结构<a href="#jetty的整个结构" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><ul><li><p>整个 Jetty 的所有组件的生命周期管理是基于观察者模式设计</p></li><li><p>整个 Jetty 的核心组件由 Server 和 Connector 两个组件构成</p><ul><li>整个 Server 组件是基于 Handler 容器工作的，它类似与 Tomcat 的 Container 容器; server组件由<code>多个 server Handler</code> 组成</li><li>Connector，它负责接受客户端的连接请求，并将请求分配给一个处理队列去执行</li></ul></li><li><p>Jetty 中还有一些非必须的组件，我们可以在它上做扩展。如 JMX，我们可以定义一些 Mbean 把它加到 Server 中，当 Server 启动的时候，这些 Bean 就会一起工作。</p></li><li><p>Handler 的体系结构 - 提供了两种 Handler 类型</p><ul><li><p>HandlerWrapper - 可以将一个 Handler 委托给另外一个类去执行</p></li><li><p>HandlerCollection - 将多个 Handler 组装在一起，构成一个 Handler 链, ScopeHandler 可以帮助你控制这个链的访问顺序</p></li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="jetty的工作过程">Jetty的工作过程<a href="#jetty的工作过程" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="启动">启动<a href="#启动" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Server 的 start 方法调用就会调用所有已经注册到 Server 的组件，Server 启动其它组件的顺序是：首先启动设置到 Server 的 Handler，通常这个 Handler 会有很多子 Handler，这些 Handler 将组成一个 Handler 链。Server 会依次启动这个链上的所有 Handler。接着会启动注册在 Server 上 JMX 的 Mbean，让 Mbean 也一起工作起来，最后会启动 Connector，打开端口，接受客户端请求</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="接受请求">接受请求<a href="#接受请求" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><ul><li><p>使用两种协议: 一个是 HTTP，一个是 AJP 协议</p></li><li><p>如果前端没有其它 web 服务器，那么 Jetty 应该是基于 HTTP 协议工作。也就是当 Jetty 接收到一个请求时，必须要按照 HTTP 协议解析请求和封装返回的数据 - 设置 Jetty 的 Connector 实现类为 <code>org.eclipse.jetty.server.bi.SocketConnector </code>让 Jetty 以 BIO 的方式工作</p></li><li><p>在应用服务器，如 Jboss 的前面在加一个 web 服务器，如 Apache 或者 nginx，这样做的目的是: 做日志分析、负载均衡、权限控制、防止恶意请求以及静态资源预加载等等。此时使用 ajp协议  </p><ul><li><p>这种架构下 servlet 引擎就不需要解析和封装返回的 HTTP 协议，因为 HTTP 协议的解析工作已经在 Apache 或 Nginx 服务器上完成了，Jboss 只要基于更加简单的 AJP 协议工作就行了，这样能加快请求的响应速度。</p></li><li><p>让 Jetty 工作在 AJP 协议下，需要配置 connector 的实现类为 <code>Ajp13SocketConnector</code></p></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="处理请求">处理请求<a href="#处理请求" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Jetty 要做的就是调用你注册的第一个 Handler 的 <code>handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) </code>方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token class-name" style="color:rgb(38, 127, 153)">Server</span><span class="token plain"> server </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">Server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token class-name" style="color:rgb(38, 127, 153)">ContextHandler</span><span class="token plain"> context </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">ContextHandler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">context</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">setContextPath</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">context</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">setResourceBase</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;.&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">context</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">setClassLoader</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token class-name" style="color:rgb(38, 127, 153)">Thread</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">currentThread</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">getContextClassLoader</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">setHandler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">context</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">setHandler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token keyword" style="color:rgb(0, 0, 255)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">HelloHandler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">join</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Tomcat</h1><p>references: <a href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/" target="_blank" rel="noopener noreferrer">1</a>, <a href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat2/" target="_blank" rel="noopener noreferrer">2</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tomcat-总体结构">Tomcat 总体结构<a href="#tomcat-总体结构" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><ul><li><p>2个核心组件 - Connector 和 Container: </p><ul><li><p>connector 接收浏览器的发过来的 tcp 连接请求: 创建 Request, response 对象, 传递给 container的线程</p></li><li><p>container 主要处理 Connector 接受的请求: 产生一个线程来处理connector产生的 Request 和 Response 对象</p></li></ul></li><li><p>多个 Connector 和一个 Container 就形成了一个 Service对外提供服务 (service 就是一个接口)</p></li><li><p>server 可以包含多个 service</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="connector">Connector<a href="#connector" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>主要任务是负责接收浏览器的发过来的 tcp 连接请求，创建一个 Request 和 Response 对象分别用于和请求端交换数据，然后会产生一个线程来处理这个请求并把产生的 Request 和 Response 对象传给处理这个请求的线程，处理这个请求的线程就是 Container 组件要做的事了</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="container">Container<a href="#container" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Container 是容器的父接口，所有子容器都必须实现这个接口，Container 容器的设计用的是典型的责任链的设计模式</p><p>它有四个子容器组件构成, 有父子关系，分别是：Engine、Host、Context、Wrapper (遵从 &quot;parent -&gt; child&quot; 顺序:)</p><p>一个 Servlet class 对应一个 Wrapper，如果有多个 Servlet 就可以定义多个 Wrapper</p><p>真正管理 Servlet 的容器是 Context 容器，一个 Context 对应一个 Web 工程</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">Context</span><span class="token tag" style="color:rgb(128, 0, 0)"></span><br></span><span class="token-line" style="color:#000000"><span class="token tag" style="color:rgb(128, 0, 0)">    </span><span class="token tag attr-name" style="color:rgb(255, 0, 0)">path</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(4, 81, 165)">=</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag attr-value" style="color:rgb(128, 0, 0)">/library</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag" style="color:rgb(128, 0, 0)"></span><br></span><span class="token-line" style="color:#000000"><span class="token tag" style="color:rgb(128, 0, 0)">    </span><span class="token tag attr-name" style="color:rgb(255, 0, 0)">docBase</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(4, 81, 165)">=</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag attr-value" style="color:rgb(128, 0, 0)">D:\projects\library\deploy\target\library.war</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag" style="color:rgb(128, 0, 0)"></span><br></span><span class="token-line" style="color:#000000"><span class="token tag" style="color:rgb(128, 0, 0)">    </span><span class="token tag attr-name" style="color:rgb(255, 0, 0)">reloadable</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(4, 81, 165)">=</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag attr-value" style="color:rgb(128, 0, 0)">true</span><span class="token tag attr-value punctuation" style="color:rgb(4, 81, 165)">&quot;</span><span class="token tag" style="color:rgb(128, 0, 0)"> </span><br></span><span class="token-line" style="color:#000000"><span class="token tag" style="color:rgb(128, 0, 0)"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- </span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">- reloadable=&quot;true&quot; - war 被修改后 Tomcat 会自动的重新加载这个应用</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"> --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Context 还可以定义在父容器 Host 中，Host 不是必须的，但是要运行 war 程序，就必须要 Host，因为 war 中必有 web.xml 文件，这个文件的解析就需要 Host 了，如果要有多个 Host 就要定义一个 top 容器 Engine 了。而 Engine 没有父容器了，一个 Engine 代表一个完整的 Servlet 引擎。</p><p>四个组件都会有自己的一套 Valve 集合, 在 server.xml 文件中可以添加Valve; StandardEngineValve 和 StandardHostValve 是 Engine 和 Host 的默认的 Valve，它们是最后一个 Valve 负责将请求传给它们的子容器，以继续往下执行</p><p>Wrapper 的实现类是 StandardWrapper，StandardWrapper 还实现了拥有一个 Servlet 初始化信息的 ServletConfig，由此看出 StandardWrapper 将直接和 Servlet 的各种信息打交道</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="用到了哪些设计模式">用到了哪些设计模式<a href="#用到了哪些设计模式" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="facade">Facade<a href="#facade" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>门面模式</p><p>HttpRequestFacade 类封装了 HttpRequest 接口能够提供数据，通过 HttpRequestFacade 访问到的数据都被代理到 HttpRequest 中</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="observer">Observer<a href="#observer" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>观察者模式</p><p>控制组件生命周期的 Lifecycle 就是这种模式的体现</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="command">Command<a href="#command" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>命令模式</p><p>Connector 也是通过命令模式调用 Container</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chain-of-responsibility">Chain of responsibility<a href="#chain-of-responsibility" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>责任链模式</p><p> Tomcat 中 Container , 整个容器的就是通过一个链连接在一起，这个链一直将请求正确的传递给最终处理请求的那个 Servlet</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tomcat-优化">Tomcat 优化<a href="#tomcat-优化" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><a href="https://mp.weixin.qq.com/s/3WQB3NGkPrSqmLaYIJ7koQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/3WQB3NGkPrSqmLaYIJ7koQ</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/docs/tags/tomcat">tomcat</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/docs/tags/jetty">jetty</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/docs/tags/nginx">nginx</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/tcp-ip-note-p2p"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">TCP IP, p2p</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/vertx"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Vertx</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tomcat和jetty" class="table-of-contents__link toc-highlight">Tomcat和jetty</a></li><li><a href="#apache-http-server和nginx" class="table-of-contents__link toc-highlight">Apache http server和Nginx</a></li><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#常用命令" class="table-of-contents__link toc-highlight">常用命令</a></li><li><a href="#nginx-无法停止-无法重启" class="table-of-contents__link toc-highlight">nginx 无法停止 无法重启</a></li><li><a href="#nginxconf-配置文件" class="table-of-contents__link toc-highlight">nginx.conf 配置文件</a><ul><li><a href="#最简配置" class="table-of-contents__link toc-highlight">最简配置</a></li><li><a href="#配置语法" class="table-of-contents__link toc-highlight">配置语法</a><ul><li><a href="#location" class="table-of-contents__link toc-highlight">location</a></li><li><a href="#proxy_pass" class="table-of-contents__link toc-highlight">proxy_pass</a></li></ul></li><li><a href="#反向代理配置" class="table-of-contents__link toc-highlight">反向代理配置</a></li><li><a href="#负载均衡配置" class="table-of-contents__link toc-highlight">负载均衡配置</a></li><li><a href="#gzip-压缩" class="table-of-contents__link toc-highlight">gzip 压缩</a></li><li><a href="#websocket-配置" class="table-of-contents__link toc-highlight">websocket 配置</a></li><li><a href="#搭建谷歌镜像站" class="table-of-contents__link toc-highlight">搭建谷歌镜像站</a></li><li><a href="#上-https" class="table-of-contents__link toc-highlight">上 https</a></li><li><a href="#组成元素" class="table-of-contents__link toc-highlight">组成元素</a></li></ul></li><li><a href="#搭配-docker-使用" class="table-of-contents__link toc-highlight">搭配 docker 使用</a></li><li><a href="#负载均衡配置demo" class="table-of-contents__link toc-highlight">负载均衡配置demo</a></li><li><a href="#nginx和lua脚本" class="table-of-contents__link toc-highlight">nginx和lua脚本</a></li><li><a href="#tengine" class="table-of-contents__link toc-highlight">tengine</a></li><li><a href="#nginx-模块开发" class="table-of-contents__link toc-highlight">nginx 模块开发</a></li><li><a href="#nginx-lua-开发高并发服务" class="table-of-contents__link toc-highlight">nginx-lua 开发高并发服务</a></li><li><a href="#nginx面试题" class="table-of-contents__link toc-highlight">nginx面试题</a><ul><li><a href="#nginx是如何实现高并发的" class="table-of-contents__link toc-highlight">nginx是如何实现高并发的</a></li><li><a href="#nginx-和-apache-区别" class="table-of-contents__link toc-highlight">nginx 和 apache 区别</a></li><li><a href="#fastcgi-与-cgi-的区别" class="table-of-contents__link toc-highlight">fastcgi 与 cgi 的区别</a></li></ul></li><li><a href="#nginx-配置调优" class="table-of-contents__link toc-highlight">NGINX 配置调优</a></li><li><a href="#部署-app-到-jetty-内部" class="table-of-contents__link toc-highlight">部署 app 到 jetty 内部</a></li><li><a href="#jetty支持servlet30注解" class="table-of-contents__link toc-highlight">jetty支持servlet3.0注解</a></li><li><a href="#jetty的整个结构" class="table-of-contents__link toc-highlight">jetty的整个结构</a></li><li><a href="#jetty的工作过程" class="table-of-contents__link toc-highlight">Jetty的工作过程</a><ul><li><a href="#启动" class="table-of-contents__link toc-highlight">启动</a></li><li><a href="#接受请求" class="table-of-contents__link toc-highlight">接受请求</a></li><li><a href="#处理请求" class="table-of-contents__link toc-highlight">处理请求</a></li></ul></li><li><a href="#tomcat-总体结构" class="table-of-contents__link toc-highlight">Tomcat 总体结构</a><ul><li><a href="#connector" class="table-of-contents__link toc-highlight">Connector</a></li><li><a href="#container" class="table-of-contents__link toc-highlight">Container</a></li></ul></li><li><a href="#用到了哪些设计模式" class="table-of-contents__link toc-highlight">用到了哪些设计模式</a><ul><li><a href="#facade" class="table-of-contents__link toc-highlight">Facade</a></li><li><a href="#observer" class="table-of-contents__link toc-highlight">Observer</a></li><li><a href="#command" class="table-of-contents__link toc-highlight">Command</a></li><li><a href="#chain-of-responsibility" class="table-of-contents__link toc-highlight">Chain of responsibility</a></li></ul></li><li><a href="#tomcat-优化" class="table-of-contents__link toc-highlight">Tomcat 优化</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">历史</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/xiaoyureed" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/xiaoyuhfq" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/3fPgwd3naN" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/resource">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">闽ICP备2020017848号-2</a></p><p>Copyright © 2020 – PRESENT kuizuo Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.7df8c467.js"></script>
<script src="/en/assets/js/main.82e41e7b.js"></script>
</body>
</html>