<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-springcloud-note">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Spring Cloud 笔记🌈 | Xiaoyureed&#x27;s 网络 Wiki </title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://xiaoyureed.github.io/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://xiaoyureed.github.io/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://xiaoyureed.github.io/en/docs/springcloud-note"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring Cloud 笔记🌈 | Xiaoyureed&#x27;s 网络 Wiki "><meta data-rh="true" name="description" content="https://github.com/macrozheng/mall-swarm"><meta data-rh="true" property="og:description" content="https://github.com/macrozheng/mall-swarm"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://xiaoyureed.github.io/en/docs/springcloud-note"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/en/docs/springcloud-note" hreflang="en"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/springcloud-note" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://xiaoyureed.github.io/docs/springcloud-note" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Xiaoyureed&#39;s 网络 Wiki  RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Xiaoyureed&#39;s 网络 Wiki  Atom Feed"><link rel="stylesheet" href="/en/assets/css/styles.c6a654bf.css">
<link rel="preload" href="/en/assets/js/runtime~main.b94328d8.js" as="script">
<link rel="preload" href="/en/assets/js/main.fc98d8e0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.png" alt="xiaoyureed Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.png" alt="xiaoyureed Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Xiaoyureed</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/xiaoyureed" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/FreeMarker-note">FreeMarker Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/SpringBoot-note">Spring Boot 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/agile-development-user-story-scrum">敏捷开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/android">Android 开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/autohotkey">Autohotkey 脚本</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/blockchain">blockchain区块链</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/c-sharp-and-dot-net">C# &amp; .NET</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/chatgpt">Chatgpt Usage Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cloud-native-platform">云服务平台</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cpp">CPP and C 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cross-gfw">Cross The GFW</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/cs-note">Computer Science Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/css-pre-processor">几种CSS预处理器比较选型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/data-structure-and-algorithm">Data Structure and Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/design-pattern-note">Design Pattern 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/dev-resources">开发者资源</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/devops">DevOps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/distributed-system">Distributed System 分布式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/docker-note-virtual-dev-env">Docker Note &amp; Other Virtual Develop Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/effective-java-reading-note">Effective Java 阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/elk-elastic-log">Distributed log collection分布式日志收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/english-note">英语学习🔥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/extjs-note">Extjs 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/flutter">flutter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/games-development-introduce">游戏开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/git-note">Git 备忘 🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/github-starts">Github 星标⭐️</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/golang-note">Golang 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/gps-gis-tracing">基于地理位置开发技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/gradle">gradle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/greasy-monkey">油猴插件&amp;编写脚本🐒</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/groovy-note">groovy note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/health">Health 关爱程序员健康🏥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/how-to-test-java-app">How to Test Java App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/html-note">HTML 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/idea-note">InteliJ idea tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/interview-system-design">经典的系统设计思路</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/iot">Iot 物联网</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-code-clean">Java Clean Code Tips</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-concurrent">Java Concurrent🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-memory-model-jmm-jvm">JMM and GC🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/java-note">Java Core 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/jquery-note">JQuery notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/js-tutorial">JavaScript tutorial</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/kotlin">kotlin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/kubernetes-k8s">kubernetes-k8s ☁️</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux-note">鸟哥的 Linux 私房菜阅读笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mac">Mac 开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/machine-learning-ml">machine-learning-ml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/maven-note">Maven Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/message-queue">Message Queue🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/money">Investment Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mongodb-note">MongoDB Notes🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/monitor-system-grafana-prometheus-influxdb-hbase">monitor-system-grafana-prometheus监控🖥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mvc-mvvm">MVC to MVVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/mybatis-note">MyBatis Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/netty-note">netty</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/nlp-natural-language-processing">nlp-natural-language-processing👄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/nodejs-yarn-npm">Nodejs, Yarn, Npm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/oracle">Oracle 备忘</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-audio-video">Audio and Video development Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-big-data-introduce">大数据开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-cache">Cache 缓存🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-computational-ad">计算广告 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-crawler-spider">网络爬虫 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-db-design-note">关系型数据库表设计🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-desktop-develop">桌面应用开发 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-http">HTTP protocol Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-reactive-programming">响应式编程 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-rest-api">RESTful api 及 其他webService技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-rpc">RPC Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/outline-about-rule-engine-note">规则引擎 Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/php-note">PHP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/play-framework">Play框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/postgres-note">Postgres note🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/process-workflow-bpm-engine">工作流引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/protect-your-app-authentication-oauth2-jwt-https">Protect Your App 安全保护认证鉴权🔑</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/python-note">Python🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/quant-money">量化交易</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/quarkus">Quarkus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/react-note">React🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/real-time-communication-protocol">实时通信 Real-time</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/redis-note">Redis🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/regex">Regular Expression 正则🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/rust-note">Rust 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/saas-paas-iaas-as-a-service">SaaS Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/serverless">Serverless</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/service-mesh">service mesh 服务网格</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/servlet">Servlet Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/shell-bash-note">shell-bash脚本收集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/spring-note">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/en/docs/springcloud-note">Spring Cloud 笔记🌈</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/springmvc-note">Spring MVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/task-schedule-note">Task Schedule</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/tcp-ip-note">TCP IP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/tomcat-jetty-nginx">Tomcat Jetty Nginx 等 web 容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/vertx">Vertx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/video-creator">拍摄</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/webassembly">webassembly</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/webpack-esbuild-vite-rollup">前端打包构建工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/windows-sub-system-on-linux">WSL 使用</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring Cloud 笔记🌈</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring Cloud 笔记🌈</h1></header><div align="center"><p><a href="https://github.com/macrozheng/mall-swarm" target="_blank" rel="noopener noreferrer">https://github.com/macrozheng/mall-swarm</a>
TODO</p><p>Spring Cloud是一系列框架的有序集合, 它利用Spring Boot简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等;
<a href="http://projects.spring.io/spring-cloud/#quick-start" target="_blank" rel="noopener noreferrer">官网</a>;
<a href="http://www.ityouknow.com/springcloud/2017/11/02/framework-and-springcloud.html" target="_blank" rel="noopener noreferrer">微服务的架构演化</a>
<a href="https://www.youtube.com/watch?v=aO3W-lYnw-o" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=aO3W-lYnw-o</a> (一个入门介绍)
<a href="https://github.com/xiaoyureed/springcloud-tutorial" target="_blank" rel="noopener noreferrer">demo在这里</a></p><p>spring cloud alibaba: nacos (服务注册, 配置中心, bus),  sentinel (熔断限流), seata (分布式事务)</p><p><a href="https://juejin.im/post/6870288195674718222" target="_blank" rel="noopener noreferrer">https://juejin.im/post/6870288195674718222</a> 选型 2020</p><p><a href="https://github.com/macrozheng" target="_blank" rel="noopener noreferrer">https://github.com/macrozheng</a> 电商系统tutorial</p><p><a href="https://github.com/zhoutaoo/SpringCloud" target="_blank" rel="noopener noreferrer">https://github.com/zhoutaoo/SpringCloud</a> demo</p><p><a href="https://docshome.gitbook.io/microservices/" target="_blank" rel="noopener noreferrer">https://docshome.gitbook.io/microservices/</a> 从设计到部署</p><p><a href="https://github.com/maventalker/simplemall" target="_blank" rel="noopener noreferrer">https://github.com/maventalker/simplemall</a>
TODO</p><p><a href="https://github.com/chillzhuang/SpringBlade" target="_blank" rel="noopener noreferrer">https://github.com/chillzhuang/SpringBlade</a> 实例</p></div><ul><li><a href="#1-spring-boot-%E5%92%8C-spring-cloud-%E6%90%AD%E9%85%8D%E9%80%89%E5%9E%8B">1. spring boot 和 spring cloud 搭配选型</a></li><li><a href="#2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A0%B8%E5%BF%83%E8%A6%81%E7%B4%A0%E5%92%8C-spring-cloud-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">2. 微服务核心要素和 spring cloud 工作流程</a></li><li><a href="#3-%E5%92%8Cdubbo-zookeeper%E5%AF%B9%E6%AF%94">3. 和dubbo-zookeeper对比</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83">4. 配置中心</a><ul><li><a href="#41-spring-cloud-config">4.1. Spring-Cloud-Config</a></li><li><a href="#42-apolo">4.2. apolo</a></li><li><a href="#43-alibaba-nacos-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83">4.3. alibaba nacos 作为配置中心</a></li></ul></li><li><a href="#5-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83">5. 注册中心</a><ul><li><a href="#51-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%80%89%E5%9E%8B">5.1. 注册中心选型</a></li><li><a href="#52-eureka">5.2. eureka</a></li><li><a href="#53-consul">5.3. consul</a></li><li><a href="#54-zookeeper">5.4. zookeeper</a></li><li><a href="#55-nacos-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83">5.5. nacos 作为注册中心</a></li><li><a href="#56-etcd">5.6. etcd</a></li></ul></li><li><a href="#6-%E6%9C%8D%E5%8A%A1%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8">6. 服务相互调用</a><ul><li><a href="#61-%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0%E8%B0%83%E7%94%A8%E6%A1%86%E6%9E%B6">6.1. 手动实现调用框架</a></li><li><a href="#62-feign">6.2. feign</a></li><li><a href="#63-openfeign">6.3. OpenFeign</a><ul><li><a href="#631-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">6.3.1. 基本使用</a></li><li><a href="#632-%E8%B6%85%E6%97%B6%E7%BB%BC%E5%90%88%E9%85%8D%E7%BD%AE">6.3.2. 超时综合配置</a></li><li><a href="#633-feign-client-interceptor">6.3.3. feign client interceptor</a></li><li><a href="#634-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE">6.3.4. 日志配置</a></li></ul></li></ul></li><li><a href="#7-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">7. 负载均衡</a><ul><li><a href="#71-%E9%9B%86%E4%B8%AD%E5%BC%8F%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">7.1. 集中式负载均衡和客户端负载均衡</a></li><li><a href="#72-ribbon">7.2. ribbon</a><ul><li><a href="#721-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-ribbon">7.2.1. 如何使用 ribbon</a></li><li><a href="#722-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95">7.2.2. 负载均衡算法</a></li></ul></li><li><a href="#73-spring-cloud-loadbalancer">7.3. spring cloud loadBalancer</a></li></ul></li><li><a href="#8-%E7%86%94%E6%96%AD%E5%99%A8">8. 熔断器</a><ul><li><a href="#81-hystrix">8.1. hystrix</a><ul><li><a href="#811-hystrix-%E5%8E%9F%E7%90%86">8.1.1. hystrix 原理</a></li><li><a href="#812-hystrix-%E9%99%8D%E7%BA%A7%E4%BD%BF%E7%94%A8">8.1.2. hystrix 降级使用</a><ul><li><a href="#8121-%E5%8D%95%E7%8B%AC%E4%BD%BF%E7%94%A8">8.1.2.1. 单独使用</a></li><li><a href="#8122-%E9%85%8D%E5%90%88-openfeign">8.1.2.2. 配合 openFeign</a></li></ul></li><li><a href="#813-%E7%86%94%E6%96%AD%E7%9B%91%E6%8E%A7hystrix-dashboard%E5%92%8Cturbine">8.1.3. 熔断监控Hystrix-Dashboard和Turbine</a></li><li><a href="#814-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5">8.1.4. 自定义隔离策略</a></li></ul></li><li><a href="#82-spring-cloud-alibaba-sentinel">8.2. spring cloud alibaba sentinel</a></li><li><a href="#83-resilience4j">8.3. resilience4j</a></li></ul></li><li><a href="#9-%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3">9. 服务网关</a><ul><li><a href="#91-%E7%BD%91%E5%85%B3%E9%80%89%E5%9E%8B">9.1. 网关选型</a></li><li><a href="#92-%E7%BD%91%E5%85%B3%E9%AB%98%E5%8F%AF%E7%94%A8">9.2. 网关高可用</a></li><li><a href="#93-nodejs">9.3. nodejs</a></li><li><a href="#94-kong">9.4. kong</a></li><li><a href="#95-openresty">9.5. openResty</a></li><li><a href="#96-zuul">9.6. zuul</a><ul><li><a href="#961-%E4%BB%80%E4%B9%88%E6%98%AFzuul">9.6.1. 什么是zuul</a></li><li><a href="#962-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">9.6.2. 基本使用</a></li></ul></li><li><a href="#97-spring-cloud-gateway">9.7. spring-cloud-gateway</a><ul><li><a href="#971-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">9.7.1. 简单介绍</a></li><li><a href="#972-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%86%85%E7%BD%AE-route-predicate-factory">9.7.2. 有哪些内置 route predicate factory</a></li><li><a href="#973-%E6%9C%89%E5%93%AA%E4%BA%9B-%E5%86%85%E7%BD%AE-filter">9.7.3. 有哪些 内置 filter</a></li><li><a href="#974-%E8%87%AA%E5%AE%9A%E4%B9%89-filter">9.7.4. 自定义 filter</a><ul><li><a href="#9741-gateway-filter">9.7.4.1. gateway filter</a></li><li><a href="#9742-%E5%85%A8%E5%B1%80-filter">9.7.4.2. 全局 filter</a></li></ul></li><li><a href="#975-gateway-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95">9.7.5. gateway 配置方法</a></li><li><a href="#976-%E7%BD%91%E5%85%B3%E7%9B%91%E6%8E%A7">9.7.6. 网关监控</a></li></ul></li></ul></li><li><a href="#10-%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA">10. 调用链路追踪</a><ul><li><a href="#101-sleuth-%E5%92%8C-zipkin">10.1. sleuth 和 zipkin</a><ul><li><a href="#1011-%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA">10.1.1. 分布式追踪</a></li><li><a href="#1012-spring-cloud-sleuth">10.1.2. spring-cloud-sleuth</a></li><li><a href="#1013-zipkin-%E4%BD%BF%E7%94%A8">10.1.3. zipkin 使用</a></li><li><a href="#1014-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B">10.1.4. 使用案例</a></li></ul></li><li><a href="#102-skywalking">10.2. skyWalking</a></li></ul></li><li><a href="#11-%E4%B8%9A%E5%8A%A1%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86">11. 业务日志收集</a><ul><li><a href="#111-%E6%97%A5%E5%BF%97%E6%80%8E%E4%B9%88%E6%90%9C%E7%B4%A2-elasticsearch">11.1. 日志怎么搜索 elasticSearch</a></li><li><a href="#112-%E6%97%A5%E5%BF%97%E6%80%8E%E4%B9%88%E6%94%B6%E9%9B%86">11.2. 日志怎么收集</a></li><li><a href="#113-%E6%97%A5%E5%BF%97%E6%80%8E%E4%B9%88%E5%B1%95%E7%A4%BA">11.3. 日志怎么展示</a></li></ul></li><li><a href="#12-%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF">12. 消息总线</a><ul><li><a href="#121-spring-cloud-bus">12.1. Spring-Cloud-Bus</a></li><li><a href="#122-alibaba-nacos-%E4%BD%9C%E4%B8%BA%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF">12.2. alibaba nacos 作为消息总线</a></li></ul></li><li><a href="#13-spring-cloud-stream-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8">13. spring-cloud-stream 消息驱动</a></li><li><a href="#14-spring-cloud-data-flow">14. spring-cloud-data-flow</a></li><li><a href="#15-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-seata">15. 分布式事务 seata</a></li><li><a href="#16-spring-cloud-alibaba-%E9%85%8D%E5%90%88-dubbo">16. spring cloud alibaba 配合 dubbo</a></li><li><a href="#17-%E5%AE%9E%E9%99%85%E8%AE%BE%E8%AE%A1%E6%A1%88%E4%BE%8B-%E7%A5%A8%E5%8A%A1%E7%BD%91%E7%AB%99">17. 实际设计案例 票务网站</a><ul><li><a href="#171-%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84">17.1. 业务架构</a></li><li><a href="#172-%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84">17.2. 应用架构</a></li><li><a href="#173-%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84">17.3. 技术架构</a></li><li><a href="#174-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84">17.4. 数据库架构</a></li><li><a href="#175-%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86">17.5. 项目管理</a></li></ul></li><li><a href="#18-%E6%A1%88%E4%BE%8B-%E5%9C%A8%E7%BA%BF%E6%95%99%E8%82%B2">18. 案例 在线教育</a><ul><li><a href="#181-%E8%A1%8C%E4%B8%9A%E8%83%8C%E6%99%AF-and-%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F">18.1. 行业背景 and 商业模式</a></li></ul></li><li><a href="#19-%E6%A1%88%E4%BE%8B-%E8%81%9A%E5%90%88%E6%94%AF%E4%BB%98">19. 案例 聚合支付</a><ul><li><a href="#191-%E8%81%9A%E5%90%88%E6%94%AF%E4%BB%98%E6%A6%82%E5%BF%B5">19.1. 聚合支付概念</a></li><li><a href="#192-%E9%9B%86%E5%90%88%E6%94%AF%E4%BB%98%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84">19.2. 集合支付项目架构</a></li><li><a href="#193-%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B">19.3. 支付业务流程</a></li></ul></li><li><a href="#20-%E6%A1%88%E4%BE%8B-%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F">20. 案例 广告系统</a><ul><li><a href="#201-%E5%B9%BF%E5%91%8A%E6%A6%82%E5%BF%B5">20.1. 广告概念</a></li><li><a href="#202-%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90">20.2. 系统组成</a></li><li><a href="#203-%E5%B9%BF%E5%91%8A%E7%9A%84%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B">20.3. 广告的核心业务流程</a></li><li><a href="#204-%E6%8A%80%E6%9C%AF%E9%9A%BE%E7%82%B9">20.4. 技术难点</a><ul><li><a href="#2041-%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AD%98%E5%82%A8">20.4.1. 广告数据的存储</a></li><li><a href="#2042-%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2">20.4.2. 广告数据检索</a></li><li><a href="#2043-%E8%AE%A1%E8%B4%B9%E5%B9%B3%E5%8F%B0%E7%9A%84%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88">20.4.3. 计费平台的技术方案</a></li></ul></li><li><a href="#205-%E5%B9%BF%E5%91%8A%E8%A1%A8%E8%AE%BE%E8%AE%A1">20.5. 广告表设计</a></li><li><a href="#206-mysql-%E7%9A%84-binlog-%E5%AE%9E%E7%8E%B0%E5%A2%9E%E9%87%8F%E7%B4%A2%E5%BC%95">20.6. MySQL 的 binlog 实现增量索引</a><ul><li><a href="#2061-java-%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E7%9B%91%E6%8E%A7">20.6.1. java 组件实现监控</a></li><li><a href="#2062-binlog-%E9%85%8D%E7%BD%AE-sql">20.6.2. binlog 配置 SQL</a></li></ul></li></ul></li><li><a href="#21-%E6%A1%88%E4%BE%8B-%E7%94%B5%E5%95%86%E7%B1%BB%E7%BD%91%E7%AB%99">21. 案例 电商类网站</a><ul><li><a href="#211-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">21.1. 开发环境搭建</a></li><li><a href="#212-%E8%A1%8C%E4%B8%9A%E6%9C%AF%E8%AF%AD">21.2. 行业术语</a></li><li><a href="#213-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">21.3. 业务流程分析</a><ul><li><a href="#2131-%E5%95%86%E5%93%81%E6%96%B0%E5%A2%9E">21.3.1. 商品新增</a></li><li><a href="#2132-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6">21.3.2. 商品上架</a></li></ul></li><li><a href="#214-elasticsearch-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%88%86%E6%9E%90">21.4. elasticsearch 数据建模分析</a></li><li><a href="#215-%E7%BC%93%E5%AD%98%E5%88%86%E6%9E%90">21.5. 缓存分析</a></li><li><a href="#216-%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90">21.6. 部署架构分析</a></li><li><a href="#217-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E5%88%86%E6%9E%90">21.7. 异步处理分析</a><ul><li><a href="#2171-mq">21.7.1. mq</a></li></ul></li></ul></li><li><a href="#22-%E6%A1%88%E4%BE%8B-%E7%89%A9%E8%81%94%E7%BD%91%E5%B9%B3%E5%8F%B0">22. 案例 物联网平台</a></li></ul><h1>spring boot 和 spring cloud 搭配选型</h1><p><a href="https://start.spring.io/actuator/info" target="_blank" rel="noopener noreferrer">https://start.spring.io/actuator/info</a> 返回的 json 可以看到官方推荐的搭配</p><h1>微服务核心要素和 spring cloud 工作流程</h1><p>Spring Cloud主要的要素/组件:</p><ul><li><p>service registry/find (client, server)</p></li><li><p>distributed configuration management (server , client)</p></li><li><p>http/rpc, load balance</p></li><li><p>circuit breaker</p></li><li><p>gateway</p></li></ul><p>以及它的访问流程:</p><ul><li><p>外部或者内部的非Spring Cloud项目都统一通过API网关（Zuul）来访问内部服务.</p></li><li><p>网关接收到请求后，从注册中心（Eureka）获取可用服务</p></li><li><p>由Ribbon进行均衡负载后，分发到后端的具体实例</p></li><li><p>微服务之间通过Feign进行通信处理业务</p></li><li><p>Hystrix负责处理服务超时熔断</p></li><li><p>Turbine监控服务间的调用和熔断相关指标</p></li></ul><h1>和dubbo-zookeeper对比</h1><p>dubbo是用来跨系统通信的，是一个 rpc 框架。</p><p>zookeeper 是一个分布式系统节点管理, 可以做注册中心</p><p>一个系统用作客户端，一个系统则充当服务端。服务端要把自己的接口定义提供给客户端，客户端将接口定义在spring中的bean。客户端可以直接使用这个bean，就好像这些接口的实现也是在自己代码里一样。
客户端和服务端启动的时候都会把自己的机器IP注册到zookeeper上。客户端会把zk上的服务端ip拉到磁盘上，并记录哪些ip提供哪些服务（服务端启动的时候暴露给zk）。然后调用的时候客户端会根据ip调用服务端的服务，这时候即使zk挂掉也没关系。</p><p>springcloud 是 dubbo 的超集;</p><p>可以自定义名字 , 位置;</p><h1>配置中心</h1><p>使用了配置中心后, 在各个 config client 需要用 bootstrap application context, 对应的 配置文件 bootstrap.yml, 用于配置不会经常变化的 配置, 如 app name, config server addr</p><p>先于 application.yml 读取, 应用于更加早期配置信息读取，如可以使用来配置application.yml中使用到参数等</p><p>如使用 Spring Cloud Config Server 的时候，在 bootstrap.yml 里面指定 spring.application.name 和 spring.cloud.config.server.git.uri</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">bootstrap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 禁用 bootstrap 过程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8888</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fail-fast</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CONFIG_SERVER_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">retry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">initial-interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">multiplier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-attempts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-config">Spring-Cloud-Config<a href="#spring-cloud-config" class="hash-link" aria-label="Direct link to Spring-Cloud-Config" title="Direct link to Spring-Cloud-Config">​</a></h2><p>进入 maintenance</p><p>包含了Client和Server两个部分, server自动将存储的配置文件发布成REST接口, client通过接口获取数据、并依据此数据初始化自己的应用</p><p>客户端完全透明(但是需要在 client 的 bootstrap.properties 中配置server端信息, 至少需要 <code>spring.cloud.config.server.git.uri</code>, 同时可以配置搜索目录 <code>spring.cloud.config.search-paths</code>), server 需要开启 <code>@enableConfigServer</code></p><p>Spring cloud使用git或svn存放配置文件，默认情况下使用git;</p><p>和 eureka 配合后, config server端api接口使用规则:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/{application}/{profile}[/{label}]          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # application -  [主文件名] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # profile 为 文件名profile 后缀, 没有则为 default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # label(分支名)可选,默认为master, 返回结构化的json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/{application}-{profile}.yml                # 直接返回property source文件内的文本内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/{application}-{profile}.properties         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/{label}/{application}-{profile}.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/{label}/{application}-{profile}.properties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>git repo config file 默认命名规则: 对于 git repo 中的配置文件 &#x27;config-client-dev.yml&#x27;, config-client 为client端 spring.application.name 的值, dev 为 client 激活的 profiles</p><p>如果希望自定义 git repo config file 命名, 可以在 config client 配置 <code>spring.cloud.config.name/profile/label/</code>, name 是主文件名, profile 是后缀名</p><p>client 的刷新功能: 最好通过 spring cloud bus 实现; 但是基本的 refresh 也实现了, <code>curl -d{} http://localhost:8080/refresh</code> 之后 client 才会使用新的配置, <a href="https://www.jianshu.com/p/8fcb88ea4458" target="_blank" rel="noopener noreferrer">如果开启了 actuator , 则会出现 404</a>, 需要配置 <code>management.endpoints.web.exposure.include=refresh,info,health</code> (默认值只有 info , health. 如果是 yml , 则值需要加单引号), 然后 <code>curl -d{} http://xxx:xxx/actuator/refresh</code>, 涉及到刷新的类, 需要 <code>@RefreshScope</code> (to support config refresh; 原理是 config server 修改了配置, 这个 controller bean 会销毁重新生成)</p><p>引入 配置中心后, client 端的 application.yml 需要 rename 为 bootstrap.yml, 最先读取, 会被后面读取的配置覆盖, 所以优先级低于 config server 中的配置</p><p>config server 修改配置后, commit(git 仓库在本地) 或者 push (git 库在远程) 后 client 端即可生效</p><p>多服务公用配置文件 (公共配置文件): </p><ul><li><p>方法1: 在配置文件仓库增加配置文件 application.properties 作为公共文件即可. serviceA 无法在自己的配置文件 (如 serviceA.properties, serviceA-dev.properties) 找到配置项, 会到 公共文件中找</p></li><li><p>方法2: 新建 common.properties 作为公共文件, 到每个 client 端 修改 <code>spring.cloud.config.name=ServiceA,common</code> 配置多个配置文件名</p></li></ul><p>重要的配置</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># server </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.port=8888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 本地的git repo 就这么设置 file://${user.home}/config-repo(Linux) file:///${user.home}/config-repo (windows), 最新版本无需如此设置了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果是 remote git repo, 还需要 username, password, basedir (clone to here), search-path(properties source 路径)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.config.server.git.uri=${user.home}/Desktop/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.application.name=reservation-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 一般在 bootstrap.yml 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 还有 label(master), profile(default to `default`), fail-first(default to false), name(file name in remote config repo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.config.uri=http://localhost:8888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># config refresh required: curl -d{} http://localhost:8000/actuator/refresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">management.endpoints.web.exposure.include=refresh,info,health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="apolo">apolo<a href="#apolo" class="hash-link" aria-label="Direct link to apolo" title="Direct link to apolo">​</a></h2><p>来自携程</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alibaba-nacos-作为配置中心">alibaba nacos 作为配置中心<a href="#alibaba-nacos-作为配置中心" class="hash-link" aria-label="Direct link to alibaba nacos 作为配置中心" title="Direct link to alibaba nacos 作为配置中心">​</a></h2><ul><li><p>namespace 命名空间</p><p>若不配置, 则 App 默认读取 public 下的配置; {spring.application.name}.yml/properties </p><p>常用的隔离方案有两个: 如 每个 sub module 拥有一个 namespace, 每个 namespace 里面分 dev.yml, prod.yml... ; 或者有三个 namespace: dev, prod, test. 每个 namespace 下有 sub-module1.yml, sub-module2.yml, sub-module3.yml...</p></li><li><p>data-id 配置集, 可将一个配置文件分拆为多个配置文件, 每个配置集都有位于 extension-configs 下的 data-id, group, refresh(需要 @NacosValue(value = &quot;${aa.bb}&quot;, autoRefreshed = true) 配合)</p><p>若不配置, 默认读取 {spring.application.name}.yml/properties</p><p>一般项目中的配置文件会拆分为多个配置集, 如 datasource.yml, mybatis.yml...</p><p>必须配置为 文件全名(即包括后缀, xml, json, properties, yml)</p></li><li><p>group 配置的分组</p><p>若不配置, 加载时, 默认每次都加载某 namespace 下属于 DEFAULT_GROUP 分组的配置文件</p><p>一般用来区分环境, 如 dev , prod , test . 场景: 双十一临时使用 分组 11-11 下的配置文件, 可以方便的切换</p></li></ul><h1>注册中心</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="注册中心选型">注册中心选型<a href="#注册中心选型" class="hash-link" aria-label="Direct link to 注册中心选型" title="Direct link to 注册中心选型">​</a></h2><p><a href="https://blog.csdn.net/fly910905/article/details/100023415" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/fly910905/article/details/100023415</a></p><p><a href="https://yq.aliyun.com/articles/599997" target="_blank" rel="noopener noreferrer">阿里巴巴为什么不使用 zk 作为 registry center</a></p><p>Eureka, consul (golang), zookeeper; 新出的 nacos</p><p>eureka就是个servlet程序，跑在servlet容器中; Consul则是go编写而成。</p><p>cap 支持不同:</p><ul><li><p>Consul优先保证强一致性(C), 服务注册相比Eureka会稍慢一些。因为Consul的raft协议要求必须过半数的节点都写入成功才认为注册成功; Leader挂掉时，重新选举期间整个consul不可用。保证了强一致性但牺牲了可用性。</p></li><li><p>Eureka优先保证高可用(A), 但是会保证最终一致性, 服务注册相对要快，因为不需要等注册信息replicate到其他节点; 当数据出现不一致时，虽然A, B上的注册信息不完全相同，但每个Eureka节点依然能够正常对外提供服务，这会出现查询服务信息时如果请求A查不到，但请求B就能查到。如此保证了可用性但牺牲了一致性</p></li><li><p>zookeeper 优先保证 c , client 没有心跳, 立即删除该节点</p></li><li><p>nacos 是用于替代 eureka, 特性和 eureka 类似, 保证 ap, 也支持控制台</p></li></ul><p>对外暴露的接口情况不同:</p><ul><li><p>consul 和 eureka 支持 http</p></li><li><p>zookeeper 只提供了 client, 需要通过 client 交互</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eureka">eureka<a href="#eureka" class="hash-link" aria-label="Direct link to eureka" title="Direct link to eureka">​</a></h2><p>目前 maintenance</p><p>默认下, eureka client 加入 class path 后, 应用会自动注册到 eureka server (默认 defaultZone 为 http://localhost:8761/eureka); 作为 eureka server, eureka client 依赖不需要引入了</p><p>client 端连接 server, 如果自定义 eureka 地址, client 需要配置 <code>eureka.client.serviceUrl</code>(map 类型), 增加 defaultZone (大小写敏感, 默认值为 localhost:8761/eureka) 属性, 用来定位 server 地址, 然后 @EnableDiscoveryClient // compared with @EnableEurekaClient, more comprehensive</p><p>提供服务注册和发现, Eureka的工作过程: </p><p>每个 service 都包含一个 Eureka client 组件, 将 机器ip, 监听端口上报给 Eureka server, Eureka server 中保存有一个注册表, application name 和 ip 端口 一一对应, Eureka client 会从 Eureka server 拉去注册表缓存在本地, </p><p>注册中心是比较重要的基础组件， 仅仅使用“单点”还不够， 更多使用“集群”（通过运行多个实例，并进行互相注册的方式来实现高可用的部署）; </p><p>自我保护机制: 某一时刻有大量节点的心跳无法被某个 eureka 节点接收到, eureka 会认为发生了网络分区故障 (比如 延时 卡顿 拥挤), eureka 不会立即清除这些节点, 而是会保持一段时间 (保证 ap, 牺牲掉了 cp), </p><p>控制台显示信息优化: 默认 eureka 控制台 ui 中, 已注册节点 table 的 status 列会显示主机名, <code>eureka.instance.instance-id</code> 可以定制显示的 实例名, 一般和 application name 相同或者是 <code>${spring.cloud.client.ip-address}:${server.port}</code>, 还有 <code>eureka.instance.prefer-ip-address=true</code>(超链接显示 ip),  这两个都是针对 eureka client 的配置</p><p>重要的配置</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># server </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自我保护模式, default  true, 若希望保证一致性, 不要可用性, 可以关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If set this to true, the registration info cannot be changed if register/remove frequently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.server.enable-self-preservation: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Remove invalid service instance info every xxx ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 续期时间，即扫描失效服务的间隔时间（缺省为60*1000ms）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.server.eviction-interval-timer-in-ms: 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The time that server wait between two heartbeats, if the second heartbeat arrives late, then remove the instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Have to &gt; 客户端的 lease-renewal-interval-in-seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.instance.lease-expiration-duration-in-seconds: 90 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置是否将自己作为客户端注册到注册中心（缺省true）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 其实查看@EnableEurekaServer注解的源码，会发现它间接用到了@EnableDiscoveryClient）, so server 端无需引入 client 依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.client.register-with-eureka=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要注册到的地址 , serviceUrl 是一个 map, defaultZone 无法使用 &#x27;-&#x27;, yml 文件 map 为 `{xxx: yyy}`, list 为 `- xxx: yyy`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果单点就是注册到自己, 高可用就需要配置为注册到别的 eureka 节点, 注册到多个 eureka 用 `,` 分开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.client.serviceUrl.defaultZone=http://localhost:${server.port}/eureka/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 是否同步其他已经注册的 service 数据, 单点需要 false (default 为 true, 集群必须为true, 否则 ribbon不可用)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.client.fetch-registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># depend on spring-boot-starter-actuator, default to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.client.health-check.enabled=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># fetch info from eureka server interval, default 30s (clients have an copy of registration info from server)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.client.registry-fetch-interval-seconds=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the Frequency that client send heartbeat to server, default 30s (心跳时间 / 服务续约间隔时间)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.instance.lease-renewal-interval-in-seconds=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># server 在受到最后一次心跳后的等待时间 (default to 90s), 超时则删除节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.instance.lease-expiration-duration-in-seconds=90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 定制 ui 页中的 status 列显示什么 (主机名称:服务名称修改)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.instance.instance-id=xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  ui 页中的访问路径可以显示 ip 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eureka.instance.prefer-id-address=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>eureka 集群配置:</p><p>修改机器 hosts</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1 eureka001.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1 eureka002.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1 eureka003.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>为 eureka 加上安全校验:</p><p>引入 <code>spring-boot-starter-security</code>, <code>security.user.name=你的用户名</code> 和 <code>security.user.password=你的密码</code></p><p><code>eureka.client.serviceUrl.defaultZone=http://${security.user.name}:${security.user.password}@127.0.0.1:${server.port}/eureka/</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consul">consul<a href="#consul" class="hash-link" aria-label="Direct link to consul" title="Direct link to consul">​</a></h2><p>功能比 Eureka 多 (还能做 配置中心, 消息总线bus), 作为注册中心, 区别在于: Eureka保证 AP (自我保护机制导致 ap), Consul为CP。</p><p>目前，Consul  已经取代 Eureka 成为 Spring Cloud 的缺省服务注册发现组件</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zookeeper">zookeeper<a href="#zookeeper" class="hash-link" aria-label="Direct link to zookeeper" title="Direct link to zookeeper">​</a></h2><p>业界使用暂时不多, 原生不带 ui 界面</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-作为注册中心">nacos 作为注册中心<a href="#nacos-作为注册中心" class="hash-link" aria-label="Direct link to nacos 作为注册中心" title="Direct link to nacos 作为注册中心">​</a></h2><p>完美替代 eureka</p><p><a href="https://www.jianshu.com/p/6b6cf891ac6a" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/6b6cf891ac6a</a>  扩展Ribbon支持Nacos权重的三种方式</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="etcd">etcd<a href="#etcd" class="hash-link" aria-label="Direct link to etcd" title="Direct link to etcd">​</a></h2><p>TODO golang 实现</p><h1>服务相互调用</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="手动实现调用框架">手动实现调用框架<a href="#手动实现调用框架" class="hash-link" aria-label="Direct link to 手动实现调用框架" title="Direct link to 手动实现调用框架">​</a></h2><p><a href="https://zhuanlan.zhihu.com/p/29348799" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/29348799</a>
<a href="https://github.com/xwjie/MyRestUtil" target="_blank" rel="noopener noreferrer">https://github.com/xwjie/MyRestUtil</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="feign">feign<a href="#feign" class="hash-link" aria-label="Direct link to feign" title="Direct link to feign">​</a></h2><p>进入 maintenance, 不推荐使用</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openfeign">OpenFeign<a href="#openfeign" class="hash-link" aria-label="Direct link to OpenFeign" title="Direct link to OpenFeign">​</a></h2><p>声明式的rest client, 底层是通过 ribbon 实现负载均衡 (相当于 RestTemplate + ribbon)</p><p>包含了 hystrix 依赖</p><ul><li><p>使用feign时默认提供了Ribbon 的load balancing</p></li><li><p>使用 Feign 时也引入了 hystrix, 默认不开启 (hystrix 一般是作用在服务调用即客户端这一端, 也就是常常和Feign一起使用)</p></li><li><p>一个client 就是一个接口, feign 针对这个接口实现了代理类 (动态代理)</p></li></ul><p><code> @EnableFeignClients</code></p><p><code>@FeignClient</code>(also support &#x27;url&#x27;, 用于无 eureka 的情况; fallback 为 class type , 是当前 client interface 的实现类, 需要 @component, 在实现的方法中做降级回调逻辑, configuration 当前 feign client 的配置类,可以自定义Feign的Encoder、Decoder、LogLevel、Contract ; path: 定义当前FeignClient的统一前缀)</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># enable hystrix support, default to false, 也可以使用 @EnableCircuitBreaker </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign.hystrix.enabled: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本使用">基本使用<a href="#基本使用" class="hash-link" aria-label="Direct link to 基本使用" title="Direct link to 基本使用">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="超时综合配置">超时综合配置<a href="#超时综合配置" class="hash-link" aria-label="Direct link to 超时综合配置" title="Direct link to 超时综合配置">​</a></h3><p>各种超时配置，如果都存在，则时间小的配置生效</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">最常用的配置配置原则:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 开启Feign的hystrix开关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 hystrix超时时长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 配置ribbon的ConnectTimeout时长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 配置ribbon的ReadTimeout 时长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># hystrix可配置的部分 (feign 默认 关闭 hystrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hystrix.command.default.execution.timeout.enable=true //为false则超时控制有ribbon控制，为true则hystrix超时和ribbon超时都是用，但是谁小谁生效，默认为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=3000//熔断器的超时时长默认1秒，最常修改的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circuitBreaker.requestVolumeThreshold=20 //触发熔断的最小请求次数，默认为20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circuitBreaker.sleepWindowInMilliseconds=5000 //休眠时长，默认为5秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circuitBreaker.errorThresholdPercentage=50 //触发熔断的失败请求最小占比，默认50%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ribbon的可配置部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ribbon.ReadTimeout=1000 //处理请求的超时时间，默认为1秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ribbon.ConnectTimeout=1000 //连接建立的超时时长，默认1秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ribbon.MaxAutoRetries=1 //同一台实例的最大重试次数，但是不包括首次调用，默认为1次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ribbon.MaxAutoRetriesNextServer=0 //重试负载均衡其他实例的最大重试次数，不包括首次调用，默认为0次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ribbon.OkToRetryOnAllOperations=false //是否对所有操作都重试，默认false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Feign的可配置部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign.hystrix.enabled=false //Feign是否启用断路器,默认为false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default为全局配置，如果要单独配置每个服务，改为服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign.client.config.default.connectTimeout=10000 //Feign的连接建立超时时间，默认为10秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign.client.config.default.readTimeout=60000 //Feign的请求处理超时时间，默认为60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign.client.config.default.retryer=feign.Retryer.Default //Feign使用默认的超时配置，在该类源码中可见，默认单次请求最大时长1秒，重试5次</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feign-client-interceptor">feign client interceptor<a href="#feign-client-interceptor" class="hash-link" aria-label="Direct link to feign client interceptor" title="Direct link to feign client interceptor">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FeignBasicAuthRequestInterceptor implements RequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger logger = LoggerFactory.getLogger(FeignBasicAuthRequestInterceptor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void apply(RequestTemplate requestTemplate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .getRequestAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpServletRequest request = attributes.getRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (headerNames != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (headerNames.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String name = headerNames.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String values = request.getHeader(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestTemplate.header(name, values);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;String&gt; bodyNames = request.getParameterNames();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuffer body =new StringBuffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bodyNames != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (bodyNames.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String name = bodyNames.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String values = request.getParameter(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                body.append(name).append(&quot;=&quot;).append(values).append(&quot;&amp;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(body.length()!=0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            body.deleteCharAt(body.length()-1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestTemplate.body(body.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;feign interceptor body:{}&quot;,body.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">配置 让所有 FeignClient，使用 FeignBasicAuthRequestInterceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connectTimeout: 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readTimeout: 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loggerLevel: basic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestInterceptors: com.leparts.config.FeignBasicAuthR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">也可以配置让 某个 FeignClient 使用这个 FeignBasicAuthRequestInterceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feign:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      xxxx: # 远程服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connectTimeout: 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readTimeout: 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loggerLevel: basic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestInterceptors: com.leparts.config.FeignBasicAuthR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在转发Feign的请求头的时候, 如果开启了Hystrix, Hystrix的默认隔离策略是Thread(线程隔离策略), 因此转发拦截器内是无法获取到请求的请求头信息的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">可以自定义 hystrix 隔离策略</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="日志配置">日志配置<a href="#日志配置" class="hash-link" aria-label="Direct link to 日志配置" title="Direct link to 日志配置">​</a></h3><p>了解 http 请求细节</p><p>日志级别:</p><ul><li><p>none: 默认, 不显示日志</p></li><li><p>basic 仅仅记录请求方法, url, response status code, 响应时间</p></li><li><p>headers: 增加了 header 信息</p></li><li><p>full: 增加了 请求响应体</p></li></ul><p>配置类中增加</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FeignConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Logger.Level feignLoggerLevel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Logger.Level.FULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后配置文件中, 指定监控的 feign client 接口以及日志级别 <code>logging.level.io.github.xiaoyu.xxx.ReservationResource=debug</code></p><h1>负载均衡</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="集中式负载均衡和客户端负载均衡">集中式负载均衡和客户端负载均衡<a href="#集中式负载均衡和客户端负载均衡" class="hash-link" aria-label="Direct link to 集中式负载均衡和客户端负载均衡" title="Direct link to 集中式负载均衡和客户端负载均衡">​</a></h2><p>在 consumer 和 provider 间使用独立的设施, 如 nginx, 将请求以某种策略进行分发, 发送到多个 provider 实例 </p><p>下面都是 client side LoadBalance</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ribbon">ribbon<a href="#ribbon" class="hash-link" aria-label="Direct link to ribbon" title="Direct link to ribbon">​</a></h2><p>进入  maintenance, 但是 spring cloud 官方还在用, 只是日志中会推荐使用 spring cloud loadbalancer</p><p>或者叫 进程式负载均衡, 就是 将 负载均衡逻辑集成到consumer, consumer从注册中心的 client 端获知有那些地址可以用,然后自己再从这些地址中选择出一个合适的 provider</p><p>Ribbon: (client side) load balancing; ribbon可以将请求均匀的分配到各个机器上, 必须和 注册中心一起使用 (eureka client 依赖包含了 ribbon 依赖)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用-ribbon">如何使用 ribbon<a href="#如何使用-ribbon" class="hash-link" aria-label="Direct link to 如何使用 ribbon" title="Direct link to 如何使用 ribbon">​</a></h3><p>一种方法是 <code>@LoadBalanced </code> + restTemplate:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableDiscoveryClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RibbonDemoApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RestTemplate restTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String hello() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Spring Cloud Ribbon有一个拦截器，它能够在这里进行实际调用的时候，自动的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 去选取服务实例，并将实际要请求的IP地址和端口替换这里的服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return restTemplate.getForObject(&quot;http://eureka-single-client/hah&quot;, String.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplication.run(RibbonDemoApplication.class, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @LoadBalanced  // ribbon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RestTemplate restTemplate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RestTemplate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还有一种就是 配合 openFeign: (推荐)</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@FeignClient(&quot;reservation-service&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // also support &#x27;url&#x27; ( outside eureka)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface ReservationResources {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(&quot;/reservations&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CollectionModel&lt;Reservation&gt; reservations();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(&quot;/message&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String message();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="负载均衡算法">负载均衡算法<a href="#负载均衡算法" class="hash-link" aria-label="Direct link to 负载均衡算法" title="Direct link to 负载均衡算法">​</a></h3><p>ribbon 提供的负载均衡算法</p><ul><li><p>默认使用Round Robin轮询算法 (请求将依次分发到1~n台机器, 如果还没分发完, 再次从第一台机器开始循环); </p><p>算法实现: 每次计算出 instance index 后都对其进行记录, 下一次请求过来在上次 index 基础上增加一, 如果下标超出 instance 个数, 使用 instance count 取余</p></li><li><p>响应时间权重算法, 即根据每个 provider 的 response time 为该 provider 实例分配一个权重, response time 越长, 权重越小, 被选中的几率越低</p></li><li><p>随机</p></li><li><p>最少并发数策略: 选择这样的 provider, 它的正在处理的并发数最少, 并且这个 provider 没有处于熔断中</p></li></ul><p>如何替换 ribbon 提供的算法, 做个性化配置? </p><p>自定义一个 配置类, 将 选定的 规则 bean 注入 spring, <code>@RibbonClient(name = &quot;target-service&quot;, configuration = {RibbonRuleConfig.class})</code> (意思是对名为 target-service 的服务端以 RibbonRuleConfig 中配置的策略做负载均衡, 即 service 和 rule 的映射)</p><p>自定义 ribbon 配置类不要放在 <code>@componentScan</code> 扫的 package 下, 否则这个自定义配置中的 rule bean 会被所有 ribbon client 共享</p><p>分析 <code>RoundRobinRule</code> 源码:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Server choose(ILoadBalancer lb, Object key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (lb == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.warn(&quot;no load balancer&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Server server = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从 loadBalancer 获取 allServer, 重试 10 次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (server == null &amp;&amp; count++ &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Server&gt; allServers = lb.getAllServers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int upCount = reachableServers.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int serverCount = allServers.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((upCount == 0) || (serverCount == 0)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;No up servers available from load balancer: &quot; + lb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int nextServerIndex = incrementAndGetModulo(serverCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server = allServers.get(nextServerIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (server == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /* Transient. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.yield();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (server.isAlive() &amp;&amp; (server.isReadyToServe())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (server);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Next.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (count &gt;= 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.warn(&quot;No available alive servers after 10 tries from load balancer: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + lb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Inspired by the implementation of {@link AtomicInteger#incrementAndGet()}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @param modulo The modulo to bound the value of the counter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @return The next value.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private int incrementAndGetModulo(int modulo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // cas + 自旋</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // nextServerCyclicCounter 是上次选中的 instance index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (;;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int current = nextServerCyclicCounter.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int next = (current + 1) % modulo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nextServerCyclicCounter.compareAndSet(current, next))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return next;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-loadbalancer">spring cloud loadBalancer<a href="#spring-cloud-loadbalancer" class="hash-link" aria-label="Direct link to spring cloud loadBalancer" title="Direct link to spring cloud loadBalancer">​</a></h2><p>Spring Cloud Load Balancer并不是一个独立的项目，而是spring-cloud-commons其中的一个模块
项目中用了Eureka以及相关的 starter，想完全剔除Ribbon的相关依赖基本是不可能的，Spring 社区的人也是看到了这一点，所以给出的做法是: 通过配置<code>spring.cloud.loadbalancer.ribbon.enabled=false</code>去关闭Ribbon, 自动就启用了 Spring-Cloud-LoadBalancer, 成为默认的负载均衡器。 (<a href="https://www.yht7.com/news/92837" target="_blank" rel="noopener noreferrer">https://www.yht7.com/news/92837</a>)</p><h1>熔断器</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix">hystrix<a href="#hystrix" class="hash-link" aria-label="Direct link to hystrix" title="Direct link to hystrix">​</a></h2><p>进入 maintenance, 但是设计理念值得学习</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-原理">hystrix 原理<a href="#hystrix-原理" class="hash-link" aria-label="Direct link to hystrix 原理" title="Direct link to hystrix 原理">​</a></h3><p>Hystrix: 隔离, 熔断(防止故障扩散, <a href="https://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener noreferrer">circuit breaker</a>), 降级, 限流, 实时的监控</p><p>为什么需要 CircuitBreaker? 防止 cascading failure (服务雪崩)</p><p>服务雪崩效应: 在一个 micro service system 里, 会涉及到服务的 级联调用, 如果下游的 service 异常, 上游的 service 也会卡住(然后超时异常), 上游 service 卡住的请求多了 线程等资源会耗尽, 进而这个上游 service 也会异常, 由于连锁反应, 最后整条调用链上的服务都会异常; <code>而实际上上游 service 是可以在下游 service 挂掉后单独提供服务的, 比如 订单服务 和 积分服务</code></p><p>hystrix 是 熔断器的一个实现, 消费侧,服务侧都可使用</p><p>熔断器（CircuitBreaker）: (熔断器模式就像是那些容易导致错误的操作的一种代理。这种代理能够记录最近调用发生错误的次数，然后决定使用允许操作继续，或者立即返回错误) 熔断器就是保护服务高可用的最后一道防线。</p><p>原理: 当前 service 调用其他不同的 service, 都有一个独立的 thread pool (<code>隔离</code>), 防止线程资源由于某个 service 故障而被耗尽; 将函数调用包装在一个 circuit breaker 对象中, 对调用失败次数进行监控, 达到设定的阈值, 直接返回错误而不访问原始函数 (<code>熔断</code>), 同时有一个回调函数, 进行额外动作(<code>降级</code>)</p><p>熔断只是作用在服务调用这一端(consumer 组件端)</p><p>Hystrix特性:</p><ul><li><p>熔断机制 : 当Hystrix Command请求后端服务失败数量超过一定比例(<code>默认50%</code>), 断路器会切换到开路状态(Open). 这时所有请求会直接失败而不会发送到后端服务, 在一个 时间窗口期内 (默认 5s) , fallback 成为主逻辑, 当休眠时间窗到期, , 自动切换到半开路状态(HALF-OPEN). 这时会判断下一次请求的返回情况, 如果请求成功, 断路器切回闭路状态(CLOSED), 否则重新切换到开路状态(OPEN), 时间窗重新计时. </p></li><li><p>Fallback: 降级操作. </p><p>对于查询操作, 可以实现一个fallback方法, 当请求后端服务出现异常的时候, 可以使用fallback方法返回值. fallback方法的返回值一般是设置的默认值或者来自缓存.</p><p>什么时候需要降级? 超时, 异常, 熔断, 线程池/信号量 打满</p></li><li><p>资源隔离: 在Hystrix中, 主要通过线程池来实现资源隔离; 通常在使用的时候我们会根据调用的远程服务划分出多个线程池. 例如调用产品服务的Command放入A线程池, 调用账户服务的Command放入B线程池. 这样做的主要优点是运行环境被隔离开了. 这样就算调用服务的代码存在bug或者由于其他原因导致自己所在线程池被耗尽时, 不会对系统的其他服务造成影响. 但是带来的代价就是维护多个线程池会对系统带来额外的性能开销. 如果是对性能有严格要求而且确信自己调用服务的客户端代码不会出问题的话, 可以使用Hystrix的信号模式(Semaphores)来隔离资源.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-降级使用">hystrix 降级使用<a href="#hystrix-降级使用" class="hash-link" aria-label="Direct link to hystrix 降级使用" title="Direct link to hystrix 降级使用">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="单独使用">单独使用<a href="#单独使用" class="hash-link" aria-label="Direct link to 单独使用" title="Direct link to 单独使用">​</a></h4><p>一种使用方法: <code>@HystrixCommand(fallbackMethod = &quot;defaultHah&quot;)</code> , defaultHah 方法可以多一个参数表示异常; 然后 <code>@EnableCircuitBreaker</code>/<code>@EnableHystrix</code> (后者包含了前者)</p><p>熔断条件配置, 可以在配置文件</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">circuitBreaker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 符合这些条件, 打开</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># When calls to a particular service exceed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">requestVolumeThreshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># failure percentage is greater than</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">errorThresholdPercentage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 50%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rollingStats</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># in a rolling window defined by ..,  the circuit opens and the call is not made</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">timeInMilliseconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以直接在注解上配置:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@HystrixCommand(fallbackMethod = &quot;fallback&quot;, commandProperties = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;3000&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/reservations/names&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ResponseEntity&lt;Collection&lt;String&gt;&gt; names() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 超时或者异常 都走 fallback 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if (enableErr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //     throw new RuntimeException(&quot;some error produced&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread.sleep(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ResponseEntity&lt;&gt;(reservationResources.reservations().getContent().stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .map(Reservation::getName).collect(Collectors.toList()), HttpStatus.OK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>类级别的(全局的)降级: 类级别的注解 <code>@DefaultProperties(defaultFallback = &quot;defaultFallback&quot;)</code>, defaultFallback 是当前类的一个方法</p><p>配置参数及默认值在 <code>HystrixCommandProperties</code> 可以查看</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@HystrixCommand(fallbackMethod = &quot;fallback&quot;, commandProperties = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;, value = &quot;true&quot;), // 是否开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @HystrixProperty(name = &quot;circuitBreakerVolumeThreshold&quot;, value = &quot;10&quot;),// 请求次数, 默认 20 次, 超过才会打开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliSeconds&quot;, value = &quot;5000&quot;),// 睡眠时间窗口 (这段时间后进入半开状态), 默认 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;, value = &quot;60&quot;)// 失败率限额, 超过则断开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @HystrixProperty(name = &quot;metrics.rollingStats.timeInMilliseconds&quot;, value = &quot;10000&quot;)// 滚动统计时间窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/reservations/names&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ResponseEntity&lt;Collection&lt;String&gt;&gt; names() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 超时或者异常 都走 fallback 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if (enableErr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //     throw new RuntimeException(&quot;some error produced&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread.sleep(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ResponseEntity&lt;&gt;(reservationResources.reservations().getContent().stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .map(Reservation::getName).collect(Collectors.toList()), HttpStatus.OK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配合-openfeign">配合 openFeign<a href="#配合-openfeign" class="hash-link" aria-label="Direct link to 配合 openFeign" title="Direct link to 配合 openFeign">​</a></h4><p>第二种使用方法: 一般是配合 openFeign 进行降级</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@FeignClient(value = &quot;reservation-service&quot;, fallback = ReservationResourcesFallback.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // also support &#x27;url&#x27; ( outside eureka)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface ReservationResources {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(&quot;/reservations&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CollectionModel&lt;Reservation&gt; reservations();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(&quot;/message&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String message();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ReservationResourcesFallback implements ReservationResources {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CollectionModel&lt;Reservation&gt; reservations() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String message() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="熔断监控hystrix-dashboard和turbine">熔断监控Hystrix-Dashboard和Turbine<a href="#熔断监控hystrix-dashboard和turbine" class="hash-link" aria-label="Direct link to 熔断监控Hystrix-Dashboard和Turbine" title="Direct link to 熔断监控Hystrix-Dashboard和Turbine">​</a></h3><p>Hystrix-dashboard是一款针对Hystrix进行实时监控的工具, 各Hystrix Command的请求响应时间, 请求成功率等数据。(实时监控, 历史熔断数据无法查看)</p><p>但是只使用Hystrix Dashboard的话, 你只能看到单个应用内的服务信息, 这明显不够. 我们需要一个工具能让我们汇总系统内多个服务的数据并显示到Hystrix Dashboard上, 这个工具就是Turbine.</p><ul><li><p>Hystrix-Dashboard 可以直接 app 中集成, 监控其所在的那个 app; turbine 新启了一个独立项目, 专门负责监控所有的node;</p></li><li><p>Netflix提供了一个开源项目（Turbine）来提供把多个hystrix.stream的内容聚合为一个数据源供Dashboard展示</p></li><li><p>每个使用了 hystrix 的 app 会发布一个接口 http://app-uri/actuator/hystrix.stream (需要引入 actuator, 配置 management.endpoints.web.exposure.include=hystrix.stream, 直接配置为 &quot;*&quot; 暴露全部亦可), 返回 hystrix steam 数据, 在 hystrix dashboard (http://dashboard-uri/hystrix) 输入前面的steam地址呈现图形界面; 查看 Hystrix Dashboard Wiki 可知晓监控画面的含义</p></li><li><p>访问 http://localhost:8001/turbine.stream 出现stream数据界面(纯数据字符); 访问http://localhost:8001/hystrix 接着输入stream地址, 呈现图形界面;</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义隔离策略">自定义隔离策略<a href="#自定义隔离策略" class="hash-link" aria-label="Direct link to 自定义隔离策略" title="Direct link to 自定义隔离策略">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FeignHystrixConcurrencyStrategy extends HystrixConcurrencyStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory.getLogger(FeignHystrixConcurrencyStrategy.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HystrixConcurrencyStrategy delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.delegate instanceof FeignHystrixConcurrencyStrategy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Welcome to singleton hell...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixCommandExecutionHook commandExecutionHook =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    HystrixPlugins.getInstance().getCommandExecutionHook();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixEventNotifier eventNotifier = HystrixPlugins.getInstance().getEventNotifier();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixMetricsPublisher metricsPublisher = HystrixPlugins.getInstance().getMetricsPublisher();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixPropertiesStrategy propertiesStrategy =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    HystrixPlugins.getInstance().getPropertiesStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.logCurrentStateOfHystrixPlugins(eventNotifier, metricsPublisher, propertiesStrategy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixPlugins.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HystrixPlugins instance = HystrixPlugins.getInstance();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.registerConcurrencyStrategy(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.registerCommandExecutionHook(commandExecutionHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.registerEventNotifier(eventNotifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.registerMetricsPublisher(metricsPublisher);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.registerPropertiesStrategy(propertiesStrategy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;Failed to register Sleuth Hystrix Concurrency Strategy&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void logCurrentStateOfHystrixPlugins(HystrixEventNotifier eventNotifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 HystrixMetricsPublisher metricsPublisher,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 HystrixPropertiesStrategy propertiesStrategy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;Current Hystrix plugins configuration is [&quot; + &quot;concurrencyStrategy [&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + this.delegate + &quot;],&quot; + &quot;eventNotifier [&quot; + eventNotifier + &quot;],&quot; + &quot;metricPublisher [&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + metricsPublisher + &quot;],&quot; + &quot;propertiesStrategy [&quot; + propertiesStrategy + &quot;],&quot; + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;Registering Sleuth Hystrix Concurrency Strategy.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; Callable&lt;T&gt; wrapCallable(Callable&lt;T&gt; callable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WrappedCallable&lt;&gt;(callable, requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ThreadPoolExecutor getThreadPool(HystrixThreadPoolKey threadPoolKey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            HystrixProperty&lt;Integer&gt; corePoolSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            HystrixProperty&lt;Integer&gt; maximumPoolSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            HystrixProperty&lt;Integer&gt; keepAliveTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.delegate.getThreadPool(threadPoolKey, corePoolSize, maximumPoolSize, keepAliveTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                unit, workQueue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ThreadPoolExecutor getThreadPool(HystrixThreadPoolKey threadPoolKey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            HystrixThreadPoolProperties threadPoolProperties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.delegate.getThreadPool(threadPoolKey, threadPoolProperties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BlockingQueue&lt;Runnable&gt; getBlockingQueue(int maxQueueSize) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.delegate.getBlockingQueue(maxQueueSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; HystrixRequestVariable&lt;T&gt; getRequestVariable(HystrixRequestVariableLifecycle&lt;T&gt; rv) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.delegate.getRequestVariable(rv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class WrappedCallable&lt;T&gt; implements Callable&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Callable&lt;T&gt; target;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final RequestAttributes requestAttributes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WrappedCallable(Callable&lt;T&gt; target, RequestAttributes requestAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.target = target;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.requestAttributes = requestAttributes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public T call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RequestContextHolder.setRequestAttributes(requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return target.call();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RequestContextHolder.resetRequestAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-alibaba-sentinel">spring cloud alibaba sentinel<a href="#spring-cloud-alibaba-sentinel" class="hash-link" aria-label="Direct link to spring cloud alibaba sentinel" title="Direct link to spring cloud alibaba sentinel">​</a></h2><p>国内使用多</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resilience4j">resilience4j<a href="#resilience4j" class="hash-link" aria-label="Direct link to resilience4j" title="Direct link to resilience4j">​</a></h2><p>国外使用多, 基于Java 8开发的，并且只使用了vavr库 </p><p><a href="https://segmentfault.com/a/1190000019617975" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000019617975</a></p><h1>服务网关</h1><p>zuul, spring-cloud gateway</p><p>用于路由. 前端请求通过网关, 转发给后端具体的 service, 集中进行统一的降级, 限流, 认证授权</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网关选型">网关选型<a href="#网关选型" class="hash-link" aria-label="Direct link to 网关选型" title="Direct link to 网关选型">​</a></h2><p><a href="https://codeantenna.com/a/HYlbT1VZT7" target="_blank" rel="noopener noreferrer">https://codeantenna.com/a/HYlbT1VZT7</a></p><p>API 网关的好处: </p><ul><li><p>简化客户端调用复杂度 (也就是路由功能): 在微服务架构模式下后端服务的实例数一般是动态的，对于客户端而言很难发现动态改变的服务实例的访问地址信息;</p></li><li><p>数据转换以及聚合: API Gateway可以对通用性的响应数据进行裁剪以适应不同客户端的使用需求。同时还可以将多个API调用逻辑进行聚合，从而减少客户端的请求数，优化客户端用户体验</p></li><li><p>集中做一些功能: 鉴权, 限流, 监控, 日志</p></li><li><p>遗留系统的微服务化改造</p></li></ul><p>Zuul 1.x 构建于 Servlet 2.5，兼容 3.x，使用的是阻塞式的 API，不支持长连接，比如 websockets。但是 2.x 版本已经支持异步无阻塞 api (基于netty)</p><p>Spring Cloud Gateway构建于 Spring 5+，基于 Spring Boot 2.x 响应式的、非阻塞式的 API。同时，它支持 websockets，和 Spring 框架紧密集成。推荐</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网关高可用">网关高可用<a href="#网关高可用" class="hash-link" aria-label="Direct link to 网关高可用" title="Direct link to 网关高可用">​</a></h2><p><a href="https://blog.csdn.net/yangwenpei116/article/details/104250006/" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/yangwenpei116/article/details/104250006/</a>
<a href="https://www.cnblogs.com/SimpleWu/p/11004902.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/SimpleWu/p/11004902.html</a>
TODO</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nodejs">nodejs<a href="#nodejs" class="hash-link" aria-label="Direct link to nodejs" title="Direct link to nodejs">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kong">kong<a href="#kong" class="hash-link" aria-label="Direct link to kong" title="Direct link to kong">​</a></h2><p>需要 lua 脚本开发</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openresty">openResty<a href="#openresty" class="hash-link" aria-label="Direct link to openResty" title="Direct link to openResty">​</a></h2><p>就是 nginx + lua</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zuul">zuul<a href="#zuul" class="hash-link" aria-label="Direct link to zuul" title="Direct link to zuul">​</a></h2><p>进入 maintenance</p><p>zuul2 本来有改进, 但是用的不多</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是zuul">什么是zuul<a href="#什么是zuul" class="hash-link" aria-label="Direct link to 什么是zuul" title="Direct link to 什么是zuul">​</a></h3><p>在Spring Cloud体系中， Spring Cloud Zuul就是提供负载均衡、反向代理、权限认证的一个API gateway。(提供动态路由，监控，弹性，安全等的边缘服务。Zuul是Netflix出品的一个基于JVM路由和服务端的负载均衡器。)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本使用-1">基本使用<a href="#基本使用-1" class="hash-link" aria-label="Direct link to 基本使用" title="Direct link to 基本使用">​</a></h3><p>一般是配合注册中心一起使用, 在 eureka 的配合下, 只需要在某个 eureka client 下使用 <code>@EnableZuulProxy</code> (可看作 @EnableZuulServer 的增强), 即可代理所有 eureka 上的服务, 支持负载均衡</p><p>网关的默认路由规则: 默认情况下，Zuul会代理所有注册到Eureka Server的微服务，并且Zuul的路由规则如下：<code>http://ZUUL_HOST:ZUUL_PORT/serviceId/**</code> 会被转发到 serviceId 对应的 path。</p><p>自定义路由规则： <code>http://ZUUL_HOST:ZUUL_PORT/zuul.routes.xxx.path/**</code> 会被转发到 <code>zuul.routes.xxx.url/**</code></p><p><a href="http://www.ityouknow.com/springcloud/2018/01/20/spring-cloud-zuul.html" target="_blank" rel="noopener noreferrer">http://www.ityouknow.com/springcloud/2018/01/20/spring-cloud-zuul.html</a>
<a href="http://www.ityouknow.com/springcloud/2018/02/02/spring-cloud-sleuth-zipkin.html" target="_blank" rel="noopener noreferrer">http://www.ityouknow.com/springcloud/2018/02/02/spring-cloud-sleuth-zipkin.html</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-gateway">spring-cloud-gateway<a href="#spring-cloud-gateway" class="hash-link" aria-label="Direct link to spring-cloud-gateway" title="Direct link to spring-cloud-gateway">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="简单介绍">简单介绍<a href="#简单介绍" class="hash-link" aria-label="Direct link to 简单介绍" title="Direct link to 简单介绍">​</a></h3><p>Spring Cloud Gateway requires the Netty runtime provided by Spring Boot and Spring Webflux. It does not work in a traditional Servlet Container or built as a WAR (使用 netty+webflux 实现因此不需要再引入 web 模块, 不能使用 servlet container)</p><p>包括三个大的要素:</p><ul><li><p>route: 将 request 转发到具体的某个 service , 包含 (id, destination Uri, collection)</p><p>route有两种配置方式, 通过yml,或者 通过@bean自定义 RouteLocator; </p><p>一个请求满足多个路由的谓词条件时，请求只会被首个成功匹配的路由转发 (就近匹配); </p><p>注册到 registration center 后, 通过配置, 可以自动路由所有已注册的服务</p></li></ul><ul><li><p>predicate: 就是Java8中引入的的 Predicate, 输入是 ServerWebExchange, 可以获取 request, header, params</p><p>所有 predicate 返回true, 则当前 route matched </p></li><li><p>filter: GatewayFilter 实例, 可以修改请求和响应, 生命周期分为 &quot;pre&quot; 和 &quot;post&quot;</p><p>filter 分为: GatewayFilter 与 GlobalFilter。GlobalFilter 会应用到所有的路由上(无需配置)，而 GatewayFilter 将应用到单个路由或者一个分组的路由上(需要跟Route绑定使用，不能在application.yml文件中配置使用),GatewayFilter  亦可 通过 AbstractGatewayFilterFactory, 在内部实现, 不写单独的 Java类(这种方式同样要配置 route)</p><p>集成了 Hystrix, 自动进行负载均衡, 集成了 Spring Cloud DiscoveryClient, </p></li></ul><p>工作流程: 请求进来, 如果在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler, Handler 再通过指定的过滤器链来将请求发送到实际的服务执行业务逻辑，然后返回。</p><p>和 注册中心 一起使用 (动态路由), 需要打开开关, 默认的自动代理请求格式: http://网关地址/服务中心注册 serviceId/具体的path, 如: http://localhost:8888/EUREKA-SINGLE-CLIENT/hah (service name 可以配置小写), 如果路由的service有多个节点, 会自动负载均衡</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="有哪些内置-route-predicate-factory">有哪些内置 route predicate factory<a href="#有哪些内置-route-predicate-factory" class="hash-link" aria-label="Direct link to 有哪些内置 route predicate factory" title="Direct link to 有哪些内置 route predicate factory">​</a></h3><ul><li><p>Before, After, Between: 通过时间匹配; 某个时间点前, 某个时间点后, 某段时间内 的request才匹配</p><p>时间字符串怎么获得: Java8 的时间 api, ZonedDateTime.now() ...</p></li><li><p>Cookie: 通过验证指定cookie 的值来匹配; 接受2个参数, Cookie 的name, cookie 的值</p></li><li><p>Header: 通过验证指定 Header 的值来匹配; 接受2个参数(headerName, regexPattern)</p></li><li><p>Host: 通过指定 host (还是属于Header验证) 来匹配(多个host 用 &quot;.&quot; 分隔, 支持 <code>**</code> 通配符, 如 <code>**.github.io</code>)</p></li><li><p>Method: 通过http方法匹配</p></li><li><p>Path: 通过请求路径匹配, 支持 &quot;/foo/{segment}&quot; 的形式, 支持模板占位符 <code>{xxx}</code>, 在 filter 中可以使用占位符中的变量</p></li><li><p>Query: 通过请求参数匹配, 2个参数(paramName, paramValue(参数值, 或者是regex)), 参数2可选</p></li><li><p>RemoteAddr: 通过请求ip匹配, 如 &quot;192.168.1.1/24&quot;</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="有哪些-内置-filter">有哪些 内置 filter<a href="#有哪些-内置-filter" class="hash-link" aria-label="Direct link to 有哪些 内置 filter" title="Direct link to 有哪些 内置 filter">​</a></h3><p><a href="https://docs.spring.io/spring-cloud-gateway/docs/2.2.5.RELEASE/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring-cloud-gateway/docs/2.2.5.RELEASE/reference/html/#gatewayfilter-factories</a></p><ul><li>AddRequestFilter</li><li>SetPath 可以使用 Path 中的占位符变量</li><li>RewritePath</li><li>PrefixPath</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义-filter">自定义 filter<a href="#自定义-filter" class="hash-link" aria-label="Direct link to 自定义 filter" title="Direct link to 自定义 filter">​</a></h3><ul><li><p>接口 GlobalFilter (定义全局 filter, 需要 <code>@component</code>), 影响所有 route; Ordered 接口定义顺序</p></li><li><p>GatewayFilter (普通filter, 需要在 route 中使用代码硬编码配置 <code>xxx.filters(new MyFilter())</code> 无需 component), Ordered 顺序</p><ul><li><p>如果希望在配置文件中配置Gateway Filter, 自定义过滤器工厂实现; </p><p>AbstractGatewayFilterFactory (继承抽象类实现 apply(config), config 为自定义参数)</p></li></ul></li></ul><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> custom</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">filter</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/service/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> RewritePath=/service(</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">&lt;segment</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">.</span><span class="token important">*)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> $\</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">segment</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#简单配置, 但是这样就需要额外重写覆盖方法 shortcutFieldOrder()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#- Logging=My Custom Message, true, true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">baseMessage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> My Custom Message helloxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">preLogger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">postLogger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="gateway-filter">gateway filter<a href="#gateway-filter" class="hash-link" aria-label="Direct link to gateway filter" title="Direct link to gateway filter">​</a></h4><p>实现自定义的Gateway Filter我们需要GatewayFilter、Ordered两个接口</p><p>定义好MyFilter以后，其需要跟Route绑定使用，不能在application.yml文件中配置使用</p><p>很多时候我们更希望在配置文件中配置Gateway Filter,所以我们可以自定义过滤器工厂实现。
自定义过滤器工厂需要继承AbstractGatewayFilterFactory</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="全局-filter">全局 filter<a href="#全局-filter" class="hash-link" aria-label="Direct link to 全局 filter" title="Direct link to 全局 filter">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TimeRecordGlobalFilter implements GlobalFilter, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String TIME_BEGIN = &quot;time begin&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(TIME_BEGIN, System.currentTimeMillis());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Long timeBegin = exchange.getAttribute(TIME_BEGIN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (timeBegin == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException(&quot;&gt;&gt;&gt; Error when get begin time&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;&gt;&gt;&gt; &quot; + exchange.getRequest().getURI().getRawPath()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + &quot;: &quot; + (System.currentTimeMillis() - timeBegin) + &quot;ms&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getOrder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //可以为负数, 小即首先进入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>普通 filter, 在代码中配 route 使用:</p><p>普通 filter, 在配置文件中使用:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizeGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;AuthorizeGatewayFilterFactory.Config&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Log logger = LogFactory.getLog(AuthorizeGatewayFilterFactory.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String AUTHORIZE_TOKEN = &quot;token&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String AUTHORIZE_UID = &quot;uid&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StringRedisTemplate stringRedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AuthorizeGatewayFilterFactory() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(Config.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;Loaded GatewayFilterFactory [Authorize]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; shortcutFieldOrder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(&quot;enabled&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GatewayFilter apply(AuthorizeGatewayFilterFactory.Config config) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (exchange, chain) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!config.isEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return chain.filter(exchange);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpRequest request = exchange.getRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpHeaders headers = request.getHeaders();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String token = headers.getFirst(AUTHORIZE_TOKEN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String uid = headers.getFirst(AUTHORIZE_UID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (token == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                token = request.getQueryParams().getFirst(AUTHORIZE_TOKEN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (uid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                uid = request.getQueryParams().getFirst(AUTHORIZE_UID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpResponse response = exchange.getResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isEmpty(token) || StringUtils.isEmpty(uid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response.setComplete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String authToken = stringRedisTemplate.opsForValue().get(uid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (authToken == null || !authToken.equals(token)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response.setComplete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.filter(exchange);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 控制是否开启认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Config() {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(boolean enabled) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">配置:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cloud:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gateway:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      routes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id: user-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uri: http://localhost:8077/api/user/list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        predicates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Path=/user/list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 关键在下面一句，值为true则开启认证，false则不开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 这种配置方式和spring cloud gateway内置的GatewayFilterFactory一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Authorize=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gateway-配置方法">gateway 配置方法<a href="#gateway-配置方法" class="hash-link" aria-label="Direct link to gateway 配置方法" title="Direct link to gateway 配置方法">​</a></h3><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># enable gateway, default to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.enabled=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># route all services that registered in eureka server, default to false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.discovery.locator.enabled=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 具体的路由配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># , spring.cloud.gateway.routes 是一个 list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 比如</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># route 的 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.routes[0].id=demo-route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Destination uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># if you visit localhost:8080/hah then the request would be forward to cn.bing.com/hah</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 负载均衡 How to apply the filters to every node of one service? -&gt; lb://spring-cloud-producer, 格式为：lb://应用注册服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.routes[0].uri=cn.bing.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 是一个 map, spring.cloud.gateway.routes[0].predicates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 还有很多, 如 After=2019-07-04T05:50:53.346Z, Method...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.routes[0].predicates[0].name=Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.routes[0].predicates[0].args</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># add parameter xxx=yyy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.gateway.routes[0].filters.AddRequestParameter=xxx, yyy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更推荐 yaml 的配置:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloud</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">discovery</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">locator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># route all services that registered in eureka server, default to false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 自动代理可以使用小写的 service name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">lower-case-service-id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># enable gateway, default to true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># config route rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Destination uri, if you visit localhost:8080/Path then the request would be forward to cn.bing.com/Path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/hah/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Method=GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">#- After=2019-07-04T05:50:53.346Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># add parameter xxx=yyy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestParameter=xxx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yyy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># How to apply the filters to every node of one service? -&gt; lb://spring-cloud-producer, 格式为：lb://应用注册服务名, 这里其实默认使用了全局过滤器 LoadBalancerClient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apply_filter_to_all_node_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//eureka</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">single</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># PrefixPath Filter: add prefix to path, eg: - PrefixPath=/mypath</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># StripPrefix Filter: split path, eg: /name/bar/foo -&gt; /foo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 可以利用这个功能来做特殊业务的转发。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> split_request_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//eureka</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">single</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/name/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic"># element num to be split</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> StripPrefix=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Retry GatewayFilter:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> retry_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloud</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">producer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">#  retry times, default to 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">retries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic"># http response status, ref to org.springframework.http.HttpStatus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">statuses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BAD_GATEWAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic"># which http method should retry, default to GET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">methods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#3  hystrix 不带 fallback 的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hystrix_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//example.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># gateway 将使用 myCommandName 作为名称生成 HystrixCommand 对象来进行熔断管理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Hystrix=myCommandName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># hystrix 带 fallback 的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hystrix_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloud</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">producer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/consumingserviceendpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hystrix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fallbackcmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># 当调用 Hystrix 的 fallback 被调用时，请求将转发到/incaseoffailureuset这个 URI。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">fallbackUri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> forward</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/incaseoffailureusethis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># RequestRateLimiter Filter, work with redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 配合 redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request_rate_limiter_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//example.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RequestRateLimiter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Handing 10 request every second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">redis-rate-limiter.replenishRate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Finishing 20 request every second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">redis-rate-limiter.burstCapacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># reference bean with beanName using SpEL grammar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">key-resolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#{@userKeyResolver}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Method=GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过代码硬编码配置路由:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class GatewayConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RouteLocator routeLocator(RouteLocatorBuilder builder) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return builder.routes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //         .route(&quot;baidu_guonei&quot;, predicateSpec -&gt; predicateSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //                 .path(&quot;/guonei&quot;).uri(&quot;http://news.baidu.com/guonei&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //         .route(&quot;baidu_guoji&quot;, predicateSpec -&gt; predicateSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //                 .path(&quot;/guoji&quot;).uri(&quot;http://news.baidu.com/guoji&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //         .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return builder.routes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .route(&quot;baidu_guonei&quot;, predicateSpec -&gt; predicateSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .path(&quot;/**&quot;).uri(&quot;http://news.baidu.com&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="网关监控">网关监控<a href="#网关监控" class="hash-link" aria-label="Direct link to 网关监控" title="Direct link to 网关监控">​</a></h3><p>spring-boot-starter-actuator</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">management</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">web</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">exposure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">include</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> health</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">gateway</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>调用链路追踪</h1><p>分布式系统下, 某个前端请求可能对应多个后端service, 如何定位这些service呢?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sleuth-和-zipkin">sleuth 和 zipkin<a href="#sleuth-和-zipkin" class="hash-link" aria-label="Direct link to sleuth 和 zipkin" title="Direct link to sleuth 和 zipkin">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式追踪">分布式追踪<a href="#分布式追踪" class="hash-link" aria-label="Direct link to 分布式追踪" title="Direct link to 分布式追踪">​</a></h3><p><a href="https://toutiao.io/posts/eaiifaf/preview" target="_blank" rel="noopener noreferrer">https://toutiao.io/posts/eaiifaf/preview</a></p><p>spring-cloud-sleuth  +  Zipkin (from twitter, <a href="https://zipkin.io/pages/quickstart.html" target="_blank" rel="noopener noreferrer">https://zipkin.io/pages/quickstart.html</a>)</p><p>分布式服务追踪理论基础来自 <a href="https://research.google.com/pubs/pub36356.html" target="_blank" rel="noopener noreferrer">Google 的一篇论文</a></p><p>spring-cloud-sleuth: 提供链路追踪, 记录成功与否, 耗时; 一个完整的请求响应链路记录为一个 &quot;trace&quot;, 可能包含多个 service调用, 称为 &quot;span&quot;, 多个有序的 span 组成一个 trace (通过 parent id 联系起来); 如果仅仅引入 sleuth, 跟踪日志只会打到控制台 (引入即可, 自动记录, 如果只引入了 sleuth, 那么默认打到 控制台); 作为 zipkin 的信息收集器, 只是一个开源实现之一</p><p>Zipkin: 利用 zipkin 的存储来存储信息，利用zipkin ui来展示数据。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-sleuth">spring-cloud-sleuth<a href="#spring-cloud-sleuth" class="hash-link" aria-label="Direct link to spring-cloud-sleuth" title="Direct link to spring-cloud-sleuth">​</a></h3><p>Trace：由一组 Trace Id 相同的 Span 串联形成一个树状结构。为了实现请求跟踪，当请求到达分布式系统的入口端点时，只需要服务跟踪框架为该请求创建一个唯一的标识（即TraceId）</p><p>Span：代表了一组基本的工作单元。为了统计各处理单元的延迟，当请求到达各个服务组件的时候, 通过SpanId 的开始和结束时间戳，就能统计该 span 的调用时间, spanId 也用来区分树结构中同层级节点的先后调用关系</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="zipkin-使用">zipkin 使用<a href="#zipkin-使用" class="hash-link" aria-label="Direct link to zipkin 使用" title="Direct link to zipkin 使用">​</a></h3><ul><li><p>zipkin 的使用分为两部分</p><p>每个 service 需要引入 zipkin client (spring-cloud-starter-zipkin, 已经包含 sleuth), 配置 zipkin server 地址和采样比例 (默认抽样 0.1 即 10%)</p><p>第二部分 zipkin server (<code>zipkin-server, zipkin-autoconfigure-ui</code>), 配合 <code>@EnableZipkinServer</code>, 最新版的 spring cloud 已经无需构建 zipkin server 了, 只需要启动 jar 包 (zipkin-server-xxx-exec.jar, from zipkin.io) 即可</p></li><li><p>如果 zipkin 和 spring cloud stream, kafka 都在 classpath, 默认会将跟踪记录打到 kafka, <code>spring.zipkin.sender.type=web</code> 才会打到服务器日志</p><p>追踪日志打到 kafka 更好, 相比使用  http 连 zipkin server, 会 更加稳定(因为消息中间件能够抗住短时间的大日志量), 会更解耦合</p></li><li><p>数据库支持 In-Memory (默认, 测试用)、MySql, Cassandra 以及 Elasticsearch (生产推荐)</p></li></ul><p>链路跟踪有自己的线程池, 对业务线程不会有太大的影响</p><p>重要的配置:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 指定了Zipkin服务器的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">base-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sleuth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 采样比例设置为1.0，也就是全部都需要。默认的采样比例为: 0.1(即10%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">percentage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用案例">使用案例<a href="#使用案例" class="hash-link" aria-label="Direct link to 使用案例" title="Direct link to 使用案例">​</a></h3><p><a href="https://www.extlight.com/sleuth-basic.html" target="_blank" rel="noopener noreferrer">https://www.extlight.com/sleuth-basic.html</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="skywalking">skyWalking<a href="#skywalking" class="hash-link" aria-label="Direct link to skyWalking" title="Direct link to skyWalking">​</a></h2><p>//todo</p><h1>业务日志收集</h1><p>elk (elasticSearch, logstash, kibana) + kafka</p><p>通过 logstash</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="日志怎么搜索-elasticsearch">日志怎么搜索 elasticSearch<a href="#日志怎么搜索-elasticsearch" class="hash-link" aria-label="Direct link to 日志怎么搜索 elasticSearch" title="Direct link to 日志怎么搜索 elasticSearch">​</a></h2><p>底层是使用的 lucene 库, 实现全文搜索引擎</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="日志怎么收集">日志怎么收集<a href="#日志怎么收集" class="hash-link" aria-label="Direct link to 日志怎么收集" title="Direct link to 日志怎么收集">​</a></h2><p>logstash</p><p>又有新的替代方案:  <a href="https://www.cnblogs.com/richaaaard/p/6109595.html" target="_blank" rel="noopener noreferrer">filebeat</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="日志怎么展示">日志怎么展示<a href="#日志怎么展示" class="hash-link" aria-label="Direct link to 日志怎么展示" title="Direct link to 日志怎么展示">​</a></h2><p>Kibana</p><p>kibana虽灵活，但需学习lucene语法，操作繁锁</p><h1>消息总线</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-cloud-bus">Spring-Cloud-Bus<a href="#spring-cloud-bus" class="hash-link" aria-label="Direct link to Spring-Cloud-Bus" title="Direct link to Spring-Cloud-Bus">​</a></h2><p>是一个整合消息中间件进入分布式系统的框架，利用了MQ的广播机制在分布式的系统中传播消息，目前仅仅支持 Kafka 和 RabbitMQ 。</p><p>在应用之间传递状态变化 比如可以自己定义事件, 主动刷新缓存</p><p>和 spring cloud stream 区别: bus 一般用于基础设施的开发, 如管理配置的动态刷新, stream 用于业务功能的开发.</p><p>利用 bus 的机制可以做很多的事情:</p><ul><li><p>配置中心客户端做动态刷新, 也就是全局广播 (可以避免动态刷新配置时, 对高可用部署的每个 service instance 执行 refresh post 请求), 以及热部署</p></li><li><p>定点通知/局部刷新  (就是指定更新某个具体 service), <code>http://config-server-address/actuator/bus-refresh/{destination}</code>, 通过 destination 指定需要更新的 service 或者某个 instance</p><ul><li><p>如果希望只是通知 serviceA 的所有 instance, destination 即为 serviceA</p></li><li><p>如果只是希望通知 serviceA 的某个 instance (这个实例端口为 8000), destination 为 serviceA:8000</p></li></ul></li></ul><p>和配置中心配合的原理图: (不够好)</p><p>1、提交代码触发post给客户端A发送bus/refresh
2、客户端A接收到请求从Server端更新配置并且发送给Spring Cloud Bus
3、Spring Cloud bus接到消息并通知给其它客户端 (前提是所有节点都订阅二了同一个 topic, 默认是 springCloudBus)
4、其它客户端接收到通知，请求Server端获取最新配置
5、全部客户端均获取到最新的配置</p><p>更新git中的数据后, 访问client, 任然是旧的数据, 这时候, 向任意client实例发送一个 /actuator/bus-refresh 的post请求 <code>curl -X POST http://....</code>, 然后访问任意client, 数据均为latest的了</p><p>但这种方式并不优雅。原因如下：</p><ul><li><p>打破了微服务的职责单一性。微服务本身是业务模块，它本不应该承担配置刷新的职责。</p></li><li><p>破坏了微服务各节点的对等性。</p></li><li><p>有一定的局限性。例如，微服务在迁移时，它的网络地址常常会发生变化，此时如果想要做到自动刷新，那就不得不修改 WebHook 的配置 (即 refresh post 发送给的对象地址会变化, 不得不修改))</p></li></ul><p>现在将架构模式改成这样: (client引入mq支持消息总线, server端也要引入消息总线), 改为向 config server 发送 refresh 请求</p><p>和 spring cloud config 整合详细步骤: 在 config server 和每个 client 引入 spring cloud starter bus amqp (kafka 则就是 spring cloud starter bus kafka ), 有如下的默认配置, 如果自定义需要修改</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.host=localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.username=guest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.password=guest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.port=5672</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>config server 还需 引入 <code>spring boot starter actuator</code> 然后配置如下以暴露 refresh 端点</p><div class="language-props codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-props codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 如果是 yml 则需要加单引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># health,info,bus-refresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">management.endpoints.web.exposure.include=*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>怎么验证生效了呢? git repo 中 application.yml 中配置 common.aaa=hah, 启动 eureka, serviceA, serviceB, config server, 修改 common.aaa, 然后 commit/push, 向 config server 发送 <code>curl -X POST http://config-server-address/actuator/bus-refresh</code>, 然后分别通过两个 service 获取 common.aaa (注意类上加上 <code>@refreshScope</code>), 发现已经更新了.</p><p>跟踪总线事件: 只需设置spring.cloud.bus.trace.enabled=true，这样在/bus/refresh端点被请求后，访问/trace端点就可获得类似如下的结果：...</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alibaba-nacos-作为消息总线">alibaba nacos 作为消息总线<a href="#alibaba-nacos-作为消息总线" class="hash-link" aria-label="Direct link to alibaba nacos 作为消息总线" title="Direct link to alibaba nacos 作为消息总线">​</a></h2><h1>spring-cloud-stream 消息驱动</h1><p>是一个构建消息驱动微服务的框架, 将项目和具体的某个消息中间件解耦(如 rabbitqm, Kafka), 屏蔽底层消息中间件细节, 就像使用 jdbc 的 api 之后, 不必关心使用哪种具体的数据库</p><p>目前仅仅支持 rabbitmq, kafka</p><p>原理: 应用通过 spring cloud stream 提供的 input Chanel (app 通过它从 mq 中接收消息) 和 output Chanel (向 mq 发送消息) 来和 binder 交互. 有多种具体的 binder 实现, 分别对应不同的 mq; </p><p>遵循发布订阅模式, 通过 topic 进行广播 (topic 相当于 rabbit 中的 exchange, Kafka 中的 topic),</p><p>通过 <code>@Input</code>, <code>@output</code> 表示输入输出通道, 消费者使用 <code>@streamListener</code> 监听队列进行消息接收(用在方法上), <code>@enableBinding</code> 实现 Chanel 和 exchange 的绑定 (发送和接受的类上都有, 使用 <code>Souce.class</code> 发送源和 <code>Sink.class</code>接收区分)</p><p>使用细节 (以 rabbit 为例): 引入 <code>spring-cloud-starter-stream-rabbit</code>, </p><p>解决消息重复消费:</p><p>消息持久化:</p><p>动态创建通道</p><h1>spring-cloud-data-flow</h1><h1>分布式事务 seata</h1><h1>spring cloud alibaba 配合 dubbo</h1><p><a href="https://www.cnblogs.com/babycomeon/p/11546737.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/babycomeon/p/11546737.html</a> rpc + restful 优雅的实现</p><p><a href="https://www.bilibili.com/video/BV1B5411h71j" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1B5411h71j</a></p><h1>实际设计案例 票务网站</h1><p>票务类网站 (比如猫眼电影)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="业务架构">业务架构<a href="#业务架构" class="hash-link" aria-label="Direct link to 业务架构" title="Direct link to 业务架构">​</a></h2><p>梳理功能</p><p>使用者: 面向海量的互联网用户</p><p>划分的模块: 支付, 用户, 商品, 订单, 排期... (以业务划分模块)</p><ul><li>用户: 注册, 登录, 注销</li><li>商品: 搜索, 详情, 排期, 选座</li><li>订单: 生成, 取消</li><li>支付: 微信/支付宝支付</li><li>排期</li><li>基础模块 (如 区域, 图片)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="应用架构">应用架构<a href="#应用架构" class="hash-link" aria-label="Direct link to 应用架构" title="Direct link to 应用架构">​</a></h2><p>划分职责, 拆分模块, 每个 module 有自己独立的 git 仓库, 独立的负责团队</p><ul><li><p>前端应用</p></li><li><p>反向代理组件 (nginx)</p></li><li><p>网关</p></li><li><p>消费者app (消费应用) , 如 用户消费, 订单消费...</p></li><li><p>生产者app (服务应用), 如 用户服务, 订单服务...</p></li><li><p>微服务基础服务</p><p>如 注册中心, 配置中心, 链路跟踪中心, 限流中心</p></li><li><p>基础公共模块, 环境支持组件</p><p>如 缓存, 持续集成, 部署, 数据库, 日志, 消息 ... redis, jenkins, MySQL, nexus, elk, rabbitmq, kafka, nginx</p></li></ul><p><code>为什么后台要分 消费者应用 和 服务提供者应用</code>? 比如 用户模块会分为 用户消费模块和用户服务模块</p><p>如果不区分消费者module 和 service provider  module 会造成:</p><ul><li><p>调用关系混乱 (会相互调用)</p></li><li><p>某个module崩了, 会连累其他module</p></li></ul><p>每个业务模块区分为 provider 和 consumer 后, 前端只和所有 consumer 交互</p><p>会有哪些好处:</p><ul><li><p>调用关系清晰, 没有相互调用</p></li><li><p>消除了 某个 module 崩了带来的级联影响 </p><p>比如 user service consumer 挂了, 还有 user service provider , 其他的 consumer 还能正常工作</p><p>(consumer 直接面向 外界, 出错几率大, provider 和数据库打交道, 出错几率小)</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术架构">技术架构<a href="#技术架构" class="hash-link" aria-label="Direct link to 技术架构" title="Direct link to 技术架构">​</a></h2><p>在应用架构基础上落地具体的技术</p><p>框架组件: spring boot, mybatis, MySQL</p><p>技术点: spring cloud技术栈, elk+kafka (日志), elasticSearch (搜索), rabbitmq (分布式事务), redis(缓存, setnx分布式锁), mycat (分库分表), docker+Jenkins (持续集成)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据库架构">数据库架构<a href="#数据库架构" class="hash-link" aria-label="Direct link to 数据库架构" title="Direct link to 数据库架构">​</a></h2><ul><li>基础库: 区域表, 图片表</li><li>节目库: 节目表, 提供方表, 类型表</li><li>订单库: 订单表, 订单联系人表; 订单表分库分表 order1, order2, order3</li><li>支付库: 交易表</li><li>排期库: 排期表, 座位表, 排期座位表</li><li>用户库: 用户表, 联系人表</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="项目管理">项目管理<a href="#项目管理" class="hash-link" aria-label="Direct link to 项目管理" title="Direct link to 项目管理">​</a></h2><p>git</p><p>sonarQube 代码缺陷, 规范</p><p>scrum 敏捷开发, 多个工期, 层层迭代, 持续交付</p><h1>案例 在线教育</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="行业背景-and-商业模式">行业背景 and 商业模式<a href="#行业背景-and-商业模式" class="hash-link" aria-label="Direct link to 行业背景 and 商业模式" title="Direct link to 行业背景 and 商业模式">​</a></h2><ul><li>c2c , 系统作为交易平台, 有视频提供者 (可能是个人提供者, 或者是专业的课程制作公司), 视频学习者, 如 51cto, 腾讯课堂</li><li>b2c, 系统自己制作课程, 上传系统, 给学习者学习, </li><li>垂直领域, 专供一个方向的学习课程, 如 网易云课堂的微专业</li><li>直播/互动 (一对多模式), 为老师提供直播服务</li><li>1 对 1 模式, 如vipkid, 学而思</li><li>免费增值, 通过提供免费课程, 吸引用户, 通过提供一些增值服务赚钱, 如制作学位证书</li></ul><h1>案例 聚合支付</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="聚合支付概念">聚合支付概念<a href="#聚合支付概念" class="hash-link" aria-label="Direct link to 聚合支付概念" title="Direct link to 聚合支付概念">​</a></h2><p>对接 微信, 支付宝, 银联, 提供统一的支付入口</p><p>主要做法/商业模式有这么几种: </p><ul><li>提供线上聚合收银台(开放 api)  </li><li>线下提供一码多付(消费者扫一个二维码就能微信支付宝...), 或者反过来商家扫码消费者完成支付</li><li>以 SaaS 服务交付给商户使用, 提供 订单管理, /门店管理/财务数据统计等基础服务, 以支付为入口, 提供 支付页广告营销/金融贷款...等服务</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="集合支付项目架构">集合支付项目架构<a href="#集合支付项目架构" class="hash-link" aria-label="Direct link to 集合支付项目架构" title="Direct link to 集合支付项目架构">​</a></h2><p>包括这些子系统: 官网/开放平台, 商户系统, 运营系统</p><p>架构:</p><ul><li>用户层: app, h5, pc</li><li>cdn: 分发静态资源, 如 js, css, 图片, 视频</li><li>load balance: 4 层负载均衡, 7 层负载均衡</li><li>UI 层: 前端页面</li><li>接入层: 网关, oauth2</li><li>服务层: 基础服务, 业务服务</li><li>数据层: MySQL,  缓存, 队列, 索引(es), 文件存储</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="支付业务流程">支付业务流程<a href="#支付业务流程" class="hash-link" aria-label="Direct link to 支付业务流程" title="Direct link to 支付业务流程">​</a></h2><ol><li>商户注册</li><li>后台审核 (查资质, 营业执照...)</li></ol><ul><li>通过则放行</li><li>不通过则通知申请商户</li></ul><ol><li>商户购买套餐, 创建应用(即在聚合支付平台创建一个业务标识, 表示支付服务要用到什么业务), 填写支付渠道参数(若商户涉及到自己开发应用, 还需要集成)</li><li>商户测试/上线</li><li>消费者消费支付给商户</li></ol><h1>案例 广告系统</h1><p><a href="https://www.modb.pro/db/32755" target="_blank" rel="noopener noreferrer">https://www.modb.pro/db/32755</a>
<a href="https://www.cnblogs.com/zhangpan1244/category/1522751.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/zhangpan1244/category/1522751.html</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="广告概念">广告概念<a href="#广告概念" class="hash-link" aria-label="Direct link to 广告概念" title="Direct link to 广告概念">​</a></h2><p>ad system: 终端根据条件数据请求广告系统, 返回合适的广告数据, 展示给浏览者</p><p>角色: 平台方, 广告主, 媒体方, 广告消费者</p><p>因为媒体数量会不断增长，因此广告投放系统是具有高并发、低延迟的特点</p><p>功能:</p><ul><li>广告主的广告投放, 如<ul><li>用户账户, 如宝马公司</li><li>推广计划, 如广告主制定了一个计划, 宝马 x6 推广计划, 这个推广计划包含多个推广单元</li><li>推广单元, 用来做限制动作, 请求命中一个推广单元后, 会返回一个/多个创意物料<ul><li>关键词推广单元, 如, 只有包含指定关键词的请求才会命中这个广告单元</li><li>地域推广单元, 如只有来自指定区域的请求才会命中广告单元</li><li>兴趣推广单元, </li><li>人群推广单元</li></ul></li><li>创意物料, 文本, 图片, 视频..., 每个创意都可以添加到一个/多个推广单元上</li></ul></li><li>媒体方的广告曝光 (排序: 平台方收益依次减少, 广告主收益一次增加); <ul><li>cpt 按时间收费 cost per time (<a href="https://zhuanlan.zhihu.com/p/146391463" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/146391463</a> 概念梳理, <a href="https://zhuanlan.zhihu.com/p/25265028" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/25265028</a> 投放经验)</li><li>cpm 按千次展现收费 cost per mille</li><li>cpc 按点击收费 cost per click<ul><li>超投: 对于CPC广告来说，即使计费系统及时发出下线反馈，但那些已经投放出去、尚未产生点击的广告仍然会可能产生超投。因此超投只能控制在一定范围之内，并不能完全杜绝</li><li><a href="https://www.infoq.cn/article/using-kafka-streams-api-for-predictive-budgeting/" target="_blank" rel="noopener noreferrer">基于Kafka Streams构建广告消耗预测系统</a></li><li>对预算将近的广告计划，投放系统也应该降低投放频率，使预算极可能平滑地达到上限。</li></ul></li><li>cpa 按行为收费 如注册.下载</li></ul></li></ul><blockquote><p>之所以有不同的结算方式，其实也是随着广告市场的发展逐渐衍生出来的，最开始流量稀缺，平台占优势，再到今天逐渐成了买方市场，广告主作为需求方的谈判权变大。
按CPA结算时对广告主最有利，但是对平台最不利。结算方式演进到今天，其实也是一种平衡，所以处于平衡点附近的CPM和CPC是最常见的结算方式。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="系统组成">系统组成<a href="#系统组成" class="hash-link" aria-label="Direct link to 系统组成" title="Direct link to 系统组成">​</a></h2><ul><li>投放系统, 最前端, 给广告主使用; <ul><li>会员续费、广告库管理、设定推广条件、设置广告出价、查看投放效果</li></ul></li><li>检索系统, 负责承接C端的流量请求，从海量广告库中筛选出最合适的前N个广告，并在几十毫秒内返回结果，它是一个多级筛选和排序的过程。<ul><li>媒体方使用, 比如 app, 地铁通道大屏, 网页边栏 </li><li>关注请求响应时间</li><li>倒排索引: 主要用于各个广告限制维度的检索; 如, 对于 table(unit_id, province, city), 根据地域 province/city 找到 unitID;<ul><li>初期考虑存在 redis, 广告数据多了, 上 elasticsearch  </li></ul></li><li>索引维护方式: 全量索引 + 增量索引; 检索系统启动, 加载全量索引(启动时间点前的数据全部导出到文件中成为全量索引), 之后检索系统运行过程中不断添加增量索引(各个表的写操作)</li></ul></li><li>计费系统, 核心任务是保证广告投放在预算范围之内，尽可能地避免发生超投 强调数据实时性<ul><li>广告主需要预先充值一定的预算, 扣光了就不给他展现广告了</li><li>面向C端/媒体方，负责实时扣费，和收入直接挂钩，可用性要求高</li></ul></li><li>结算系统, 结算系统提供的是广告平台与广告主之间费用结算服务，强调数据准确度, 包括充值、冻结、扣费等。<ul><li>一般会以离线数据为基础进行计算，首先，这样可以以较少的成本保证数据完整性，因为如果像计费系统那样一来实时流计算，就不可避免地要面临服务可用性问题</li><li>结算系统与计费系统虽然都提供了费用计算的功能，但侧重点不同。</li><li>通常会引入“反作弊”的功能（比如一个用户短时间内多次点击，只收取一次点击的费用）</li></ul></li><li>曝光检测系统, 给两拨人看的, 包含有我们自身的检测系统和第三方的监测系统 (可能广告主不信任平台, 需要请第三方参与监控, 对比第三方和我们自己的监测, 差别不大才会心甘情愿付费  )</li><li>运营后台, 给运营人员查看效果报表系统, 如展示了多少, 曝光了多少, 有多少广告请求没有检索到广告数据, 再就是<ul><li>核心功能包括广告位管理、广告策略管理、以及各种运营工具</li></ul></li><li>AB实验平台, 广告业务的稳定器，任何广告策略上的调整均可以通过此平台进行灰度实验，观察收入指标的变化</li><li>大数据平台: 整个广告系统的底盘，需要聚合各种异构数据源，完成离线和实时数据分析和统计，产出业务报表，生产模型特征等</li></ul><p>拓展:</p><ul><li>添加更多的广告检索维度, 如地域, 兴趣</li><li>用户画像</li><li>ai</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="广告的核心业务流程">广告的核心业务流程<a href="#广告的核心业务流程" class="hash-link" aria-label="Direct link to 广告的核心业务流程" title="Direct link to 广告的核心业务流程">​</a></h2><p>精准定向以及实时竞价是目前最主流的业务形态, 随着平台流量以及广告主规模进一步增大，往往会从「自营型竞价网络」逐渐向「联盟广告以及RTB实时竞价」方向发展，类似于阿里妈妈、腾讯广点通、头条巨量引擎</p><ol><li>广告主先通过投放平台发布广告，可设置一系列的定向条件，比如投放城市、投放时间段、人群标签、出价等</li><li>投放动作完成后，广告会被存放到广告库、同时进入索引库，以便能被广告检索系统检索。</li><li>C端请求过来后，广告检索系统会完成召回、算法策略、竞价排序等一系列的逻辑，最终筛选出Top N个广告，实现广告的千人千面</li></ol><ul><li>媒体方需要先行在广告检索系统中注册, 请求时, 携带这些参数: 媒体方标识, 匹配信息 (地域/兴趣/关键字, 逻辑操作符 and/or), 基本信息(请求 id, 设备信息, 广告位信息...)</li><li>响应: 广告创意(一个或多个)</li></ul><ol><li>用户点击广告后，会触发广告扣费流程，这时候平台才算真正获得收益</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术难点">技术难点<a href="#技术难点" class="hash-link" aria-label="Direct link to 技术难点" title="Direct link to 技术难点">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="广告数据的存储">广告数据的存储<a href="#广告数据的存储" class="hash-link" aria-label="Direct link to 广告数据的存储" title="Direct link to 广告数据的存储">​</a></h3><ul><li>OLTP场景, 存储在支持事务的 db 中，包括广告库、创意库、会员库、广告产品库、广告策略库等，这些都存储在MySQL中，数据规模较大的广告库和创意库，按照广告主ID Hash做分库分表。</li><li>OLAP场景，涉及到非常多的报表，聚合维度多，单表的记录数可能达到百亿级别，底层采用HDFS和HBase存储。</li><li>面向广告检索场景的索引数据，包括正排索引和倒排索引，采用Redis和ES来存储</li><li>广告的同步问题。广告投放完成后，首先会存储在MySQL数据库中，接下来需要把广告实时传输到检索系统中，完成正排索引以及倒排索引的更新<ul><li>各个业务系统在推广、余额等信息变更时，发MQ消息，索引更新服务订阅MQ来感知变化，完成增量同步</li><li>变更的消息体中，不传递实际变更的字段，仅通知有变化的广告ID，索引更新服务实时读取最新数据完成更新，这样可以有效的解决消息乱序引起的数据不一致问题</li><li>当更新索引的并发达到一定量级后，可通过合并相同广告的变更、或者将倒排和正排更新分离的方式来提升整体的更新速度。</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="广告数据检索">广告数据检索<a href="#广告数据检索" class="hash-link" aria-label="Direct link to 广告数据检索" title="Direct link to 广告数据检索">​</a></h3><ul><li><p>采用Redis缓存，缓存可按业务规划多套，进行分流。精简RPC返回结果或者Redis缓存对象的结构，去掉不必要的字段，减少IO数据包大小。</p></li><li><p>热点数据建立本地索引 (即内存 map, 使用 concurrentmap)，比如广告位的配置信息以及策略配置信息，在服务启动时就可以预加载到本地，然后定时进行同步。(启动时, 加载全量索引, 运行中, 不断加载增量索引)</p><ul><li>增量索引: 订阅 MySQL 的 binglog </li></ul></li><li><p>采用多线程并行化某些子流程，比如多路召回逻辑、多模型打分逻辑</p></li><li><p>和主流程无关的逻辑异步执行，比如扣费信息缓存、召回结果缓存等</p></li><li><p>非核心流程设置超时熔断走降级逻辑，比如溢价策略（不溢价只是少赚了，不影响广告检索召回）。</p></li><li><p>GC优化，包括JVM堆内存的设置、垃圾收集器的选择、GC频次优化和GC耗时优化。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="计费平台的技术方案">计费平台的技术方案<a href="#计费平台的技术方案" class="hash-link" aria-label="Direct link to 计费平台的技术方案" title="Direct link to 计费平台的技术方案">​</a></h3><ul><li>扣费流程做了异步化处理，当收到实时扣费请求后，系统先将扣费时用到的信息缓存到Redis，然后发送MQ消息，这两步完成后扣费动作就算结束了, 利用MQ的可靠性投递和重试机制确保整个扣费流程的最终一致性</li><li>为了提高可用性，针对Redis和MQ不可用的情况均采用了降级方案。Redis不可用时，切换到TiKV(分布式键值对存储数据库)进行持久化；MQ投递失败时，改成线程池异步处理。</li><li>每次有效点击都需要生成1条扣费订单，面临大数据量的存储问题。目前我们采用的是MySQL分库分表; 后期考虑使用HBase等分布式存储</li><li>订单和结算系统数据同步, 通过Hive任务完成对账和监控。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="广告表设计">广告表设计<a href="#广告表设计" class="hash-link" aria-label="Direct link to 广告表设计" title="Direct link to 广告表设计">​</a></h2><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MjM5MDc3OTMzMQ==&amp;action=getalbum&amp;album_id=1557571829207187456&amp;scene=173&amp;from_msgid=2649744188&amp;from_itemidx=1&amp;count=3#wechat_redirect" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MjM5MDc3OTMzMQ==&amp;action=getalbum&amp;album_id=1557571829207187456&amp;scene=173&amp;from_msgid=2649744188&amp;from_itemidx=1&amp;count=3#wechat_redirect</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-的-binlog-实现增量索引">MySQL 的 binlog 实现增量索引<a href="#mysql-的-binlog-实现增量索引" class="hash-link" aria-label="Direct link to MySQL 的 binlog 实现增量索引" title="Direct link to MySQL 的 binlog 实现增量索引">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="java-组件实现监控">java 组件实现监控<a href="#java-组件实现监控" class="hash-link" aria-label="Direct link to java 组件实现监控" title="Direct link to java 组件实现监控">​</a></h3><p>mysql-binlog-connector-java</p><p>相关: </p><p><a href="https://github.com/zendesk/maxwell" target="_blank" rel="noopener noreferrer">https://github.com/zendesk/maxwell</a>  a mysql-to-json kafka producer 这个也不错, 可以通过 kafka 实现分发</p><p><a href="https://github.com/apache/nifi" target="_blank" rel="noopener noreferrer">https://github.com/apache/nifi</a>  process and distribute data</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="binlog-配置-sql">binlog 配置 SQL<a href="#binlog-配置-sql" class="hash-link" aria-label="Direct link to binlog 配置 SQL" title="Direct link to binlog 配置 SQL">​</a></h3><p>MySQL 配置文件中:</p><ul><li><p>log_bin , binlog switch, <code>show variables like &#x27;log_bin&#x27;</code></p></li><li><p>binlog_format , binglog format, <code>show variables like &#x27;binlog_format&#x27;  </code></p><ul><li><p>ROW , binlog 会记录每行数据修改的细节, 如前后的值, 不记录 SQL;</p><p>binlog 巨大</p><p>数据一定可以被恢复</p></li><li><p>statement , 记录写操作的 SQL, </p><p>binlog 不大</p><p>SQL 中某些涉及到上下文的 函数/触发器 在恢复数据的时候可能出现问题</p></li><li><p>mixed, 两者的混合</p></li></ul></li></ul><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> master logs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- check binlog list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 常用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> master </span><span class="token keyword" style="color:#00009f">status</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- check number of the last binlog file and view the position where the last event ended</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flush logs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- generate a new binlog with a new number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reset master</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- clear all binlogs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Event_type 列 (常用的Binlog event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">query_event 数据无关的操作, 如drop table, truncate table...</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">table_map_event 记录后续操作涉及到的表信息, 如dbname, tblname</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">xid_event 标记事务提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">write_rows_event 插入操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">update_rows_event 更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">delete_rows_event 删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> binlog events</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- view the first binlog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> binlog events </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;binlog.00030&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- view specified binlog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> binlog events </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;binlog.00030&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">931</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- view specified binlog start from specified position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> binlog events </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;binlog.00030&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">931</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- view specified binlog start from specified position and limit 2 lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> binlog events </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;binlog.00030&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">931</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- view specified binlog start from specified position and limit 2 lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>案例 电商类网站</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发环境搭建">开发环境搭建<a href="#开发环境搭建" class="hash-link" aria-label="Direct link to 开发环境搭建" title="Direct link to 开发环境搭建">​</a></h2><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 我是用的 respberrypi, MySQL 镜像需要使用 hypriot/rpi-mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -v /mydata/mysql/log:/var/log/mysql -v /mydata/mysql/data:/var/lib/mysql -v /mydata/mysql/conf:/etc/mysql hypriot/rpi-mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># docker run -d --name nacos -p 8848:8848 -e MODE=standalone -v ~/docker_data/nacos/logs:/home/nacos/logs -v ~/docker_data/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties  nacos/nacos-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name nacos -p 8848:8848 -e MODE=standalone -v ~/docker_data/nacos/logs:/home/nacos/logs  nacos/nacos-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 先创建 /mydata/redis/conf/redis.conf, 否则 文件挂载时 redis.conf 被识别为 目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /docker-data/reids/conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">touch  /docker-data/reids/conf/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run -d --name redis -p 6379:6379 -v /mydata/redis/data:/data -v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf redis /etc/redis/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># redis 可视化管理界面</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name redis-cmder -p 8079:8081 --link redis:re -e REDIS_HOSTS=re:6379 rediscommander/redis-commander</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="行业术语">行业术语<a href="#行业术语" class="hash-link" aria-label="Direct link to 行业术语" title="Direct link to 行业术语">​</a></h2><ul><li>spu (standard product unit) 标准化产品单元, 是一组商品特性的集合, 是商品信息聚合的最小单位, 通俗说就是商品名称, 如 iPhone X,  Mi 8 , 类比 Java 中的 class</li><li>sku (stock keeping unit) 库存单元, 是库存计量的基本单位, 是销售属性的集合(颜色, 内存..., 其他属性属于通用属性如网络, 像素..可以直接和 spu 关联), 如 iPhone X 64G 黑色, Mi8+64G+黑色, 类比 Java 中的 实例对象, 同个 spu 有多个不同 sku; 可以决定价格</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="业务流程分析">业务流程分析<a href="#业务流程分析" class="hash-link" aria-label="Direct link to 业务流程分析" title="Direct link to 业务流程分析">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="商品新增">商品新增<a href="#商品新增" class="hash-link" aria-label="Direct link to 商品新增" title="Direct link to 商品新增">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="商品上架">商品上架<a href="#商品上架" class="hash-link" aria-label="Direct link to 商品上架" title="Direct link to 商品上架">​</a></h3><p>给定一个 spu id, 将相关数据存入 es, 以便检索</p><p>哪些数据进入 es?</p><ul><li>spu, 商品规格(普通属性)检索时需要, 分类检索时也需要</li><li>sku, 进入商品主页, 选择颜色, 屏幕 是需要检索, 此外还要检索 sku标题, 价格, 销量  </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="elasticsearch-数据建模分析">elasticsearch 数据建模分析<a href="#elasticsearch-数据建模分析" class="hash-link" aria-label="Direct link to elasticsearch 数据建模分析" title="Direct link to elasticsearch 数据建模分析">​</a></h2><p>商品上架: spu 相关信息会被存储到 es, 如 颜色, 内存, ram, 标题</p><p>比较分析:</p><ul><li>对于 模型 1: 若有 100万商品, 每个商品基本属性占用存储 2kb, 1000000 <em> 0.002mb == 2000mb == 2000 </em> 0.001 G == 2G, 就是加一个内存条的事儿, 完全可以接受</li><li>对于 模型 2: 假如某个人搜索小米, 向 es 发送一个请求, 可能会出现很多 spu, 如 手机/电器/路由器/床垫..., 假设有 4000 个 spu, 接下来根据 spuId 查对应 基础属性显示在过滤栏位, 4000spuId <em> 每个id 是 Long 类型 8 个字节 == 4000 </em> 8 byte == 32000 byte == 32 kb. 即一个请求至少会向 es 发送 32kb 数据, 假设 10000 人并发检索小米, 10000*32kb === 320mb, 百万人并发就直接是 32G 了, 这完全不可接受</li></ul><p>所以选择模型 1, 以空间换时间</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 模型 1: 只有一个索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 方便检索, 但是有数据冗余, 如 同一个 spu 下不同的 spu 商品的 attr 都相同</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;spuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 如 iPhone X</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;skuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 64G, 黑色</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;skuTitle&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;iPhone x 64G 黑色&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;price&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;saleCount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;attrs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;尺寸&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4.5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;CPU&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;高通&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;分辨率&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;高清&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 模型 2: 分为两个索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 没有数据冗余, 但是检索时更耗时, 因为数据传输量大大增加了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// sku 索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;spuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 如 iPhone X</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;skuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 64G, 黑色</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;skuTitle&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;iPhone x 64G 黑色&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;price&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;saleCount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// attr 索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;spuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 如 iPhone X</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;attrs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;尺寸&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4.5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;CPU&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;高通&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;分辨率&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;高清&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终 product index 导入是这样的:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT product</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token property" style="color:#36acaa">&quot;mapping&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token property" style="color:#36acaa">&quot;properties&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;skuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;spuId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token comment" style="color:#999988;font-style:italic">// 类似 text, 不分词</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;skuTitle&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//分词</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;analyzer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;ik_smart&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;skuPrice&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;skuImg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token comment" style="color:#999988;font-style:italic">// 图片链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;index&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// // 不可检索</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;doc_values&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 不需要 聚合操作, 省空间, 默认 true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;saleCount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token comment" style="color:#999988;font-style:italic">// 销量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;hasStock&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;boolean&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;hotScore&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;brandId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;categoryId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;brandName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;index&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;doc_values&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;brandImg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;index&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;doc_values&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;categoryName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;index&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;doc_values&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token property" style="color:#36acaa">&quot;attrs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;nested&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 这属性是嵌入式的, 表示 attrs 是一个 对象 or 对象组成的数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// 如果不指定的话 es 会将这个属性扁平化处理, 将对象内的属性抽取到外层形成多个这样的属性 attrs.attrId,  attrs.attrName, ....</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token property" style="color:#36acaa">&quot;properties&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">&quot;attrId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;long&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">&quot;attrName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token property" style="color:#36acaa">&quot;index&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token property" style="color:#36acaa">&quot;doc_values&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">&quot;attrValue&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;keyword&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="缓存分析">缓存分析<a href="#缓存分析" class="hash-link" aria-label="Direct link to 缓存分析" title="Direct link to 缓存分析">​</a></h2><p>哪些数据适合放入缓存? (不经常改变, 访问量大, 一致性要求不高的数据), 失效时间根据业务需求定</p><ul><li>商品分类, 商品列表</li></ul><p>缓存一致性方案:</p><ul><li>对于用户相关的数据(订单数据, 个人信息...), 并发读写几率很小, 基本上没有缓存不一致问题, 采用设置缓存过期的策略</li><li>首页菜单, 商品介绍这类数据, 能够容忍一定的不一致, 使用 canal订阅 binlog 的方式</li><li>通过加读写锁, 保证并发读写</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署架构分析">部署架构分析<a href="#部署架构分析" class="hash-link" aria-label="Direct link to 部署架构分析" title="Direct link to 部署架构分析">​</a></h2><p>client(browser...) --&gt; nginx --&gt; 网关集群 --&gt; services</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="异步处理分析">异步处理分析<a href="#异步处理分析" class="hash-link" aria-label="Direct link to 异步处理分析" title="Direct link to 异步处理分析">​</a></h2><p>一个是可以通过 completableFuture </p><p>一个是通过 mq</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mq">mq<a href="#mq" class="hash-link" aria-label="Direct link to mq" title="Direct link to mq">​</a></h3><ul><li><p>异步: 处理注册流程 (异步发送短信)</p></li><li><p>解耦: 下单后的出库操作, 通过 mq 调用减库存接口, 使得订单系统和库存系统解耦</p></li><li><p>流量控制: 对于瞬时大量请求, 先堆积在 mq, 后面慢慢处理</p></li></ul><h1>案例 物联网平台</h1><p><a href="https://github.com/jetlinks/jetlinks-community" target="_blank" rel="noopener noreferrer">https://github.com/jetlinks/jetlinks-community</a>
<a href="https://open.iot.10086.cn/" target="_blank" rel="noopener noreferrer">https://open.iot.10086.cn/</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/docs/tags/springcloud">springcloud</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xiaoyureed/xiaoyureed.github.io/tree/main/docs/springcloud-note.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/spring-note"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/springmvc-note"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring MVC</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spring-cloud-config" class="table-of-contents__link toc-highlight">Spring-Cloud-Config</a></li><li><a href="#apolo" class="table-of-contents__link toc-highlight">apolo</a></li><li><a href="#alibaba-nacos-作为配置中心" class="table-of-contents__link toc-highlight">alibaba nacos 作为配置中心</a></li><li><a href="#注册中心选型" class="table-of-contents__link toc-highlight">注册中心选型</a></li><li><a href="#eureka" class="table-of-contents__link toc-highlight">eureka</a></li><li><a href="#consul" class="table-of-contents__link toc-highlight">consul</a></li><li><a href="#zookeeper" class="table-of-contents__link toc-highlight">zookeeper</a></li><li><a href="#nacos-作为注册中心" class="table-of-contents__link toc-highlight">nacos 作为注册中心</a></li><li><a href="#etcd" class="table-of-contents__link toc-highlight">etcd</a></li><li><a href="#手动实现调用框架" class="table-of-contents__link toc-highlight">手动实现调用框架</a></li><li><a href="#feign" class="table-of-contents__link toc-highlight">feign</a></li><li><a href="#openfeign" class="table-of-contents__link toc-highlight">OpenFeign</a><ul><li><a href="#基本使用" class="table-of-contents__link toc-highlight">基本使用</a></li><li><a href="#超时综合配置" class="table-of-contents__link toc-highlight">超时综合配置</a></li><li><a href="#feign-client-interceptor" class="table-of-contents__link toc-highlight">feign client interceptor</a></li><li><a href="#日志配置" class="table-of-contents__link toc-highlight">日志配置</a></li></ul></li><li><a href="#集中式负载均衡和客户端负载均衡" class="table-of-contents__link toc-highlight">集中式负载均衡和客户端负载均衡</a></li><li><a href="#ribbon" class="table-of-contents__link toc-highlight">ribbon</a><ul><li><a href="#如何使用-ribbon" class="table-of-contents__link toc-highlight">如何使用 ribbon</a></li><li><a href="#负载均衡算法" class="table-of-contents__link toc-highlight">负载均衡算法</a></li></ul></li><li><a href="#spring-cloud-loadbalancer" class="table-of-contents__link toc-highlight">spring cloud loadBalancer</a></li><li><a href="#hystrix" class="table-of-contents__link toc-highlight">hystrix</a><ul><li><a href="#hystrix-原理" class="table-of-contents__link toc-highlight">hystrix 原理</a></li><li><a href="#hystrix-降级使用" class="table-of-contents__link toc-highlight">hystrix 降级使用</a><ul><li><a href="#单独使用" class="table-of-contents__link toc-highlight">单独使用</a></li><li><a href="#配合-openfeign" class="table-of-contents__link toc-highlight">配合 openFeign</a></li></ul></li><li><a href="#熔断监控hystrix-dashboard和turbine" class="table-of-contents__link toc-highlight">熔断监控Hystrix-Dashboard和Turbine</a></li><li><a href="#自定义隔离策略" class="table-of-contents__link toc-highlight">自定义隔离策略</a></li></ul></li><li><a href="#spring-cloud-alibaba-sentinel" class="table-of-contents__link toc-highlight">spring cloud alibaba sentinel</a></li><li><a href="#resilience4j" class="table-of-contents__link toc-highlight">resilience4j</a></li><li><a href="#网关选型" class="table-of-contents__link toc-highlight">网关选型</a></li><li><a href="#网关高可用" class="table-of-contents__link toc-highlight">网关高可用</a></li><li><a href="#nodejs" class="table-of-contents__link toc-highlight">nodejs</a></li><li><a href="#kong" class="table-of-contents__link toc-highlight">kong</a></li><li><a href="#openresty" class="table-of-contents__link toc-highlight">openResty</a></li><li><a href="#zuul" class="table-of-contents__link toc-highlight">zuul</a><ul><li><a href="#什么是zuul" class="table-of-contents__link toc-highlight">什么是zuul</a></li><li><a href="#基本使用-1" class="table-of-contents__link toc-highlight">基本使用</a></li></ul></li><li><a href="#spring-cloud-gateway" class="table-of-contents__link toc-highlight">spring-cloud-gateway</a><ul><li><a href="#简单介绍" class="table-of-contents__link toc-highlight">简单介绍</a></li><li><a href="#有哪些内置-route-predicate-factory" class="table-of-contents__link toc-highlight">有哪些内置 route predicate factory</a></li><li><a href="#有哪些-内置-filter" class="table-of-contents__link toc-highlight">有哪些 内置 filter</a></li><li><a href="#自定义-filter" class="table-of-contents__link toc-highlight">自定义 filter</a><ul><li><a href="#gateway-filter" class="table-of-contents__link toc-highlight">gateway filter</a></li><li><a href="#全局-filter" class="table-of-contents__link toc-highlight">全局 filter</a></li></ul></li><li><a href="#gateway-配置方法" class="table-of-contents__link toc-highlight">gateway 配置方法</a></li><li><a href="#网关监控" class="table-of-contents__link toc-highlight">网关监控</a></li></ul></li><li><a href="#sleuth-和-zipkin" class="table-of-contents__link toc-highlight">sleuth 和 zipkin</a><ul><li><a href="#分布式追踪" class="table-of-contents__link toc-highlight">分布式追踪</a></li><li><a href="#spring-cloud-sleuth" class="table-of-contents__link toc-highlight">spring-cloud-sleuth</a></li><li><a href="#zipkin-使用" class="table-of-contents__link toc-highlight">zipkin 使用</a></li><li><a href="#使用案例" class="table-of-contents__link toc-highlight">使用案例</a></li></ul></li><li><a href="#skywalking" class="table-of-contents__link toc-highlight">skyWalking</a></li><li><a href="#日志怎么搜索-elasticsearch" class="table-of-contents__link toc-highlight">日志怎么搜索 elasticSearch</a></li><li><a href="#日志怎么收集" class="table-of-contents__link toc-highlight">日志怎么收集</a></li><li><a href="#日志怎么展示" class="table-of-contents__link toc-highlight">日志怎么展示</a></li><li><a href="#spring-cloud-bus" class="table-of-contents__link toc-highlight">Spring-Cloud-Bus</a></li><li><a href="#alibaba-nacos-作为消息总线" class="table-of-contents__link toc-highlight">alibaba nacos 作为消息总线</a></li><li><a href="#业务架构" class="table-of-contents__link toc-highlight">业务架构</a></li><li><a href="#应用架构" class="table-of-contents__link toc-highlight">应用架构</a></li><li><a href="#技术架构" class="table-of-contents__link toc-highlight">技术架构</a></li><li><a href="#数据库架构" class="table-of-contents__link toc-highlight">数据库架构</a></li><li><a href="#项目管理" class="table-of-contents__link toc-highlight">项目管理</a></li><li><a href="#行业背景-and-商业模式" class="table-of-contents__link toc-highlight">行业背景 and 商业模式</a></li><li><a href="#聚合支付概念" class="table-of-contents__link toc-highlight">聚合支付概念</a></li><li><a href="#集合支付项目架构" class="table-of-contents__link toc-highlight">集合支付项目架构</a></li><li><a href="#支付业务流程" class="table-of-contents__link toc-highlight">支付业务流程</a></li><li><a href="#广告概念" class="table-of-contents__link toc-highlight">广告概念</a></li><li><a href="#系统组成" class="table-of-contents__link toc-highlight">系统组成</a></li><li><a href="#广告的核心业务流程" class="table-of-contents__link toc-highlight">广告的核心业务流程</a></li><li><a href="#技术难点" class="table-of-contents__link toc-highlight">技术难点</a><ul><li><a href="#广告数据的存储" class="table-of-contents__link toc-highlight">广告数据的存储</a></li><li><a href="#广告数据检索" class="table-of-contents__link toc-highlight">广告数据检索</a></li><li><a href="#计费平台的技术方案" class="table-of-contents__link toc-highlight">计费平台的技术方案</a></li></ul></li><li><a href="#广告表设计" class="table-of-contents__link toc-highlight">广告表设计</a></li><li><a href="#mysql-的-binlog-实现增量索引" class="table-of-contents__link toc-highlight">MySQL 的 binlog 实现增量索引</a><ul><li><a href="#java-组件实现监控" class="table-of-contents__link toc-highlight">java 组件实现监控</a></li><li><a href="#binlog-配置-sql" class="table-of-contents__link toc-highlight">binlog 配置 SQL</a></li></ul></li><li><a href="#开发环境搭建" class="table-of-contents__link toc-highlight">开发环境搭建</a></li><li><a href="#行业术语" class="table-of-contents__link toc-highlight">行业术语</a></li><li><a href="#业务流程分析" class="table-of-contents__link toc-highlight">业务流程分析</a><ul><li><a href="#商品新增" class="table-of-contents__link toc-highlight">商品新增</a></li><li><a href="#商品上架" class="table-of-contents__link toc-highlight">商品上架</a></li></ul></li><li><a href="#elasticsearch-数据建模分析" class="table-of-contents__link toc-highlight">elasticsearch 数据建模分析</a></li><li><a href="#缓存分析" class="table-of-contents__link toc-highlight">缓存分析</a></li><li><a href="#部署架构分析" class="table-of-contents__link toc-highlight">部署架构分析</a></li><li><a href="#异步处理分析" class="table-of-contents__link toc-highlight">异步处理分析</a><ul><li><a href="#mq" class="table-of-contents__link toc-highlight">mq</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.b94328d8.js"></script>
<script src="/en/assets/js/main.fc98d8e0.js"></script>
</body>
</html>